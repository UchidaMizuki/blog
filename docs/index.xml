<?xml version="1.0" encoding="UTF-8"?>
<rss  xmlns:atom="http://www.w3.org/2005/Atom" 
      xmlns:media="http://search.yahoo.com/mrss/" 
      xmlns:content="http://purl.org/rss/1.0/modules/content/" 
      xmlns:dc="http://purl.org/dc/elements/1.1/" 
      version="2.0">
<channel>
<title>UchidaMizuki</title>
<link>https://uchidamizuki.quarto.pub/blog/</link>
<atom:link href="https://uchidamizuki.quarto.pub/blog/index.xml" rel="self" type="application/rss+xml"/>
<description></description>
<generator>quarto-1.4.549</generator>
<lastBuildDate>Fri, 22 Mar 2024 15:00:00 GMT</lastBuildDate>
<item>
  <title>平均が正規分布に従う正規分布の周辺分布を求める</title>
  <link>https://uchidamizuki.quarto.pub/blog/posts/2024/03/normal-distribution-with-mean-following-a-normal-distribution.html</link>
  <description><![CDATA[ 





<p>平均<img src="https://latex.codecogs.com/png.latex?%5Ctheta">・分散<img src="https://latex.codecogs.com/png.latex?%5Ctau%5E2">の正規分布に従う確率変数<img src="https://latex.codecogs.com/png.latex?Y">があり，かつ<img src="https://latex.codecogs.com/png.latex?%5Ctheta">が平均<img src="https://latex.codecogs.com/png.latex?%5Cmu">・分散<img src="https://latex.codecogs.com/png.latex?%5Csigma%5E2">の正規分布に従うとします．</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign%7D%0AY%20%5Cmid%20%5Ctheta%20%5Csim%20%5Cmathcal%7BN%7D%20(%20%5Ctheta,%20%5Ctau%5E2%20)%20&amp;%5Ciff%0Ap(%20y%20%5Cmid%20%5Ctheta%20)%20=%20%5Cfrac%7B1%7D%7B%5Csqrt%7B2%20%5Cpi%7D%20%5Ctau%7D%0A%5Cexp%20%5Cleft%5B%0A%7B-%5Cfrac%7B1%7D%7B2%7D%7D%20%5Cleft(%0A%5Cfrac%7By%20-%20%5Ctheta%7D%7B%5Ctau%7D%0A%5Cright)%20%5E2%0A%5Cright%5D%20%5C%5C%0A%5Ctheta%20%5Csim%20%5Cmathcal%7BN%7D%20(%5Cmu,%20%5Csigma%5E2)%20&amp;%5Ciff%0Ap(%20%5Ctheta%20)%20=%20%5Cfrac%7B1%7D%7B%5Csqrt%7B2%20%5Cpi%7D%20%5Csigma%7D%0A%5Cexp%20%5Cleft%5B%0A%7B-%5Cfrac%7B1%7D%7B2%7D%7D%20%5Cleft(%0A%5Cfrac%7B%5Ctheta%20-%20%5Cmu%7D%7B%5Csigma%7D%0A%5Cright)%20%5E2%0A%5Cright%5D%0A%5Cend%7Balign%7D%0A"></p>
<p>このとき，<img src="https://latex.codecogs.com/png.latex?Y">の周辺分布は，平均<img src="https://latex.codecogs.com/png.latex?%5Cmu">・分散<img src="https://latex.codecogs.com/png.latex?%5Csigma%5E2%20+%20%5Ctau%5E2">の正規分布に従うことが知られています． この記事では，この性質を導出する過程を備忘録として記載します（実際にはもっとスマートな導出方法があるかもしれません）．</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AY%20%5Csim%20%5Cmathcal%7BN%7D%20%5Cleft(%20%5Cmu,%20%5Csigma%5E2%20+%20%5Ctau%5E2%20%5Cright)%0A"></p>
<p><img src="https://latex.codecogs.com/png.latex?Y">の周辺確率密度関数<img src="https://latex.codecogs.com/png.latex?p(y)">は以下のような積分で求められます．平方完成を用いることで，積分の対象となる<img src="https://latex.codecogs.com/png.latex?p(%20y%20%5Cmid%20%5Ctheta%20)%20p%20(%20%5Ctheta%20)">を以下のように変形できます．</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign%7D%0Ap(y)%0A&amp;=%20%5Cint_%7B-%5Cinfty%7D%5E%7B%5Cinfty%7D%0Ap(%20y,%20%5Ctheta%20)%0Ad%5Ctheta%20%5C%5C%0A&amp;=%20%5Cint_%7B-%5Cinfty%7D%5E%7B%5Cinfty%7D%0Ap(%20y%20%5Cmid%20%5Ctheta%20)%20p%20(%20%5Ctheta%20)%0Ad%5Ctheta%20%5C%5C%0A%5Cend%7Balign%7D%0A"></p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign%7D%0Ap(%20y%20%5Cmid%20%5Ctheta%20)%20p%20(%20%5Ctheta%20)%0A&amp;=%20%5Cfrac%7B1%7D%7B2%20%5Cpi%20%5Ctau%20%5Csigma%7D%0A%5Cexp%20%5Cleft%5B%0A-%5Cfrac%7B1%7D%7B2%7D%0A%5Cfrac%7B%0A%5Csigma%5E2%20%5Cleft(%20y%20-%20%5Ctheta%20%5Cright)%5E2%20+%0A%5Ctau%5E2%20%5Cleft(%20%5Ctheta%20-%20%5Cmu%20%5Cright)%5E2%0A%7D%7B%5Ctau%5E2%20%5Csigma%5E2%7D%0A%5Cright%5D%20%5C%5C%0A&amp;=%20%5Cfrac%7B1%7D%7B2%20%5Cpi%20%5Ctau%20%5Csigma%7D%0A%5Cexp%20%5Cleft%5B%0A-%5Cfrac%7B1%7D%7B2%7D%0A%5Cfrac%7B%0A%5Cleft(%20%5Csigma%5E2%20+%20%5Ctau%5E2%20%5Cright)%20%5Ctheta%5E2%20-%0A2%20%5Cleft(%20%5Csigma%5E2%20y%20+%20%5Ctau%5E2%20%5Cmu%20%5Cright)%20%5Ctheta%20+%0A%5Cleft(%20%5Csigma%5E2%20y%5E2%20+%20%5Ctau%5E2%20%5Cmu%5E2%20%5Cright)%0A%7D%7B%5Ctau%5E2%20%5Csigma%5E2%7D%0A%5Cright%5D%20%5C%5C%0A&amp;=%20%5Cfrac%7B1%7D%7B2%20%5Cpi%20%5Ctau%20%5Csigma%7D%0A%5Cexp%20%5Cleft%5B%0A-%5Cfrac%7B1%7D%7B2%7D%20%5Cleft(%0A%5Cfrac%7B%5Csqrt%7B%5Csigma%5E2%20+%20%5Ctau%5E2%7D%7D%7B%5Ctau%20%5Csigma%7D%20%5Ctheta%20-%0A%5Cfrac%7B%5Csigma%5E2%20y%20+%20%5Ctau%5E2%20%5Cmu%7D%7B%5Ctau%20%5Csigma%20%5Csqrt%7B%5Csigma%5E2%20+%20%5Ctau%5E2%7D%7D%0A%5Cright)%5E2%20-%0A%5Cfrac%7B1%7D%7B2%7D%20%5Cfrac%7B%5Cleft(%20y%20-%20%5Cmu%20%5Cright)%5E2%7D%7B%5Csigma%5E2%20+%20%5Ctau%5E2%7D%0A%5Cright%5D%20%5Cquad%20%5Cleft(%20%5Cbecause%20%5Ctheta%E3%81%AB%E5%AF%BE%E3%81%99%E3%82%8B%E5%B9%B3%E6%96%B9%E5%AE%8C%E6%88%90%20%5Cright)%20%5C%5C%0A&amp;=%20%5Cfrac%7B1%7D%7B2%20%5Cpi%20%5Ctau%20%5Csigma%7D%0A%5Cexp%20%5Cleft%5B%0A-%5Cfrac%7B1%7D%7B2%7D%20%5Cleft(%0A%5Cfrac%7By%20-%20%5Cmu%7D%7B%5Csqrt%7B%5Csigma%5E2%20+%20%5Ctau%5E2%7D%7D%0A%5Cright)%5E2%0A%5Cright%5D%0A%5Cexp%20%5Cleft%5B%0A-%5Cfrac%7B1%7D%7B2%7D%20%5Cleft(%0A%5Cfrac%7B%5Ctheta%20-%20%5Cfrac%7B%5Csigma%5E2%20y%20+%20%5Ctau%5E2%20%5Cmu%7D%7B%5Csigma%5E2%20+%20%5Ctau%5E2%7D%7D%7B%5Cfrac%7B%5Ctau%20%5Csigma%7D%7B%5Csqrt%7B%5Csigma%5E2%20+%20%5Ctau%5E2%7D%7D%7D%0A%5Cright)%5E2%0A%5Cright%5D%20%5C%5C%0A%5Cend%7Balign%7D%0A"></p>
<p><img src="https://latex.codecogs.com/png.latex?p(%20y%20%5Cmid%20%5Ctheta%20)%20p%20(%20%5Ctheta%20)">を積分すると，<img src="https://latex.codecogs.com/png.latex?%5Ctheta">に関する正規分布のカーネルの積分が現れます．そのため，積分を正規化係数の逆数で置き換えることができます．最終的に，<img src="https://latex.codecogs.com/png.latex?Y">の周辺確率密度関数<img src="https://latex.codecogs.com/png.latex?p(y)">が，平均<img src="https://latex.codecogs.com/png.latex?%5Cmu">・分散<img src="https://latex.codecogs.com/png.latex?%5Csigma%5E2%20+%20%5Ctau%5E2">の正規分布に従っていることが導出されます．</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign%7D%0Ap(y)%0A&amp;=%20%5Cint_%7B-%5Cinfty%7D%5E%7B%5Cinfty%7D%0Ap(%20y%20%5Cmid%20%5Ctheta%20)%20p%20(%20%5Ctheta%20)%0Ad%5Ctheta%20%5C%5C%0A&amp;=%20%5Cfrac%7B1%7D%7B2%20%5Cpi%20%5Ctau%20%5Csigma%7D%0A%5Cexp%20%5Cleft%5B%0A-%5Cfrac%7B1%7D%7B2%7D%20%5Cleft(%0A%5Cfrac%7By%20-%20%5Cmu%7D%7B%5Csqrt%7B%5Csigma%5E2%20+%20%5Ctau%5E2%7D%7D%0A%5Cright)%5E2%0A%5Cright%5D%0A%5Cint_%7B-%5Cinfty%7D%5E%7B%5Cinfty%7D%0A%5Cexp%20%5Cleft%5B%0A-%5Cfrac%7B1%7D%7B2%7D%20%5Cleft(%0A%5Cfrac%7B%5Ctheta%20-%20%5Cfrac%7B%5Csigma%5E2%20y%20+%20%5Ctau%5E2%20%5Cmu%7D%7B%5Csigma%5E2%20+%20%5Ctau%5E2%7D%7D%7B%5Cfrac%7B%5Ctau%20%5Csigma%7D%7B%5Csqrt%7B%5Csigma%5E2%20+%20%5Ctau%5E2%7D%7D%7D%0A%5Cright)%5E2%0A%5Cright%5D%0Ad%5Ctheta%20%5C%5C%0A&amp;=%20%5Cfrac%7B1%7D%7B2%20%5Cpi%20%5Ctau%20%5Csigma%7D%0A%5Cexp%20%5Cleft%5B%0A-%5Cfrac%7B1%7D%7B2%7D%20%5Cleft(%0A%5Cfrac%7By%20-%20%5Cmu%7D%7B%5Csqrt%7B%5Csigma%5E2%20+%20%5Ctau%5E2%7D%7D%0A%5Cright)%5E2%0A%5Cright%5D%0A%5Csqrt%7B2%20%5Cpi%7D%20%5Cfrac%7B%5Ctau%20%5Csigma%7D%7B%5Csqrt%7B%5Csigma%5E2%20+%20%5Ctau%5E2%7D%7D%0A%5Cquad%20%5Cleft(%20%5Cbecause%20%E5%88%86%E6%95%A3%20%5Cfrac%7B%5Ctau%5E2%20%5Csigma%5E2%7D%7B%5Csigma%5E2%20+%20%5Ctau%5E2%7D%20%E3%81%AE%E6%AD%A3%E8%A6%8F%E5%88%86%E5%B8%83%E3%81%AE%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%81%AE%E7%A9%8D%E5%88%86%20%5Cright)%20%5C%5C%0A&amp;=%20%5Cfrac%7B1%7D%7B%5Csqrt%7B2%20%5Cpi%7D%20%5Csqrt%7B%5Csigma%5E2%20+%20%5Ctau%5E2%7D%7D%0A%5Cexp%20%5Cleft%5B%0A-%5Cfrac%7B1%7D%7B2%7D%20%5Cleft(%0A%5Cfrac%7By%20-%20%5Cmu%7D%7B%5Csqrt%7B%5Csigma%5E2%20+%20%5Ctau%5E2%7D%7D%0A%5Cright)%5E2%0A%5Cright%5D%20%5Ciff%20Y%20%5Csim%20%5Cmathcal%7BN%7D%20%5Cleft(%20%5Cmu,%20%5Csigma%5E2%20+%20%5Ctau%5E2%20%5Cright)%5C%5C%0A%5Cend%7Balign%7D%0A"></p>



 ]]></description>
  <category>Japanese</category>
  <category>Distribution</category>
  <guid>https://uchidamizuki.quarto.pub/blog/posts/2024/03/normal-distribution-with-mean-following-a-normal-distribution.html</guid>
  <pubDate>Fri, 22 Mar 2024 15:00:00 GMT</pubDate>
</item>
<item>
  <title>LiNGAMによる因果探索では関数形に注意しよう</title>
  <link>https://uchidamizuki.quarto.pub/blog/posts/2024/03/be-careful-with-function-forms-in-lingam.html</link>
  <description><![CDATA[ 





<section id="lingamによる因果探索" class="level2">
<h2 class="anchored" data-anchor-id="lingamによる因果探索">LiNGAMによる因果探索</h2>
<p>LiNGAM（Linear Non-Gaussian Acyclic Model）は代表的な因果探索手法の一つで，近年は市販のソフトウェア等にも実装されるなど実務での活用が進んでいるようです．LiNGAMは，その名の通り，関数形が線形かつ誤差項がガウス分布（正規分布）以外に従う場合に，データから因果関係を明らかにすることができる手法です．</p>
<p>LiNGAMは，PythonのlingamパッケージやRのpcalgパッケージで利用することができ，これらのパッケージで提供される関数にデータフレームを入力すれば，簡単に因果グラフを推定することができます．因果グラフとは，観測変数をノード，因果関係を矢印に見立てて構築されるネットワーク構造のことです．特に，因果探索では，因果グラフとしてDAG（Directed Acyclic Graph）と呼ばれる有向非巡回グラフを推定することが一般的です．</p>
<p>因果グラフの例として，以下にレストラン経営に関する因果グラフを作成してみました．実務においては，曜日・天気・出店地域などの様々な要因によって利益が 変動すると考えられ，さらに複雑な因果関係が分析対象となることが想定されます．</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">flowchart LR
  食材の質 --&gt; 料理の美味しさ
  食材の質 --&gt; 原価
  料理人の腕 --&gt; 料理の美味しさ
  料理人の腕 --&gt; 給与
  料理の美味しさ --&gt; 来客数
  料理の美味しさ --&gt; 客単価
  来客数 --&gt; 売上
  客単価 --&gt; 売上
  売上 --&gt; 利益
  原価 --&gt; 費用
  給与 --&gt; 費用
  固定費用 --&gt; 費用
  費用 --&gt; 利益
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</section>
<section id="関数形がlingamの推定に与える影響について" class="level2">
<h2 class="anchored" data-anchor-id="関数形がlingamの推定に与える影響について">関数形がLiNGAMの推定に与える影響について</h2>
<p>LiNGAMは，関数形が線形かつ誤差項がガウス分布以外に従うという前提のもとで因果関係を推定する手法です．そのため，関数形が線形でない（線形近似が難しい）場合には，誤った因果関係が推定される可能性があります．パッケージや市販のソフトウェアを使えばLiNGAMを簡単に実行することができてしまいますが，利用者はこうした前提があることを理解してLiNGAMを使う必要があると思われます．</p>
<p>ここでは，上に挙げた因果グラフよりも簡単な以下のような因果関係をもつデータに対してLiNGAMを適用してみましょう．具体的には， 以下のフローチャートの<code>fun</code>に，非線形な関数が入ったときにLiNGAMの結果がどのように変わるかを確認します．</p>
<p>ただし，この記事では最も一般的なLiNGAMであるDirect LiNGAM，誤差項として非ガウス分布の一様分布を用いています． また，係数の絶対値が0.001未満の因果関係は無視するものとしました．</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">flowchart LR
  x11 --&gt; add1(+)
  x12 --&gt; add1
  add1 --&gt; x21
  x21 --&gt; fun2(fun)
  x22 --&gt; fun2
  fun2 --&gt; x31
style fun2 stroke:red,color:red
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<p>因果グラフの推定に先立って<code>x11</code>・<code>x12</code>・<code>x22</code>列をもつ1,000行のデータフレームおよび因果探索用の関数を用意しておきましょう．</p>
<div id="bbad07ff" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>コード</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pandas <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pd</span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> lingam</span>
<span id="cb1-5"></span>
<span id="cb1-6">rng <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.random.default_rng(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1234</span>)</span>
<span id="cb1-7"></span>
<span id="cb1-8">n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span></span>
<span id="cb1-9">data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.DataFrame({</span>
<span id="cb1-10">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'x11'</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> rng.random(n),</span>
<span id="cb1-11">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'x12'</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> rng.random(n),</span>
<span id="cb1-12">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'x22'</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> rng.random(n)</span>
<span id="cb1-13">})</span>
<span id="cb1-14"></span>
<span id="cb1-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># DirectLiNGAMの結果をデータフレームとして返す関数</span></span>
<span id="cb1-16"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> discover_causality(data):</span>
<span id="cb1-17">  model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> lingam.DirectLiNGAM()</span>
<span id="cb1-18">  model.fit(data)</span>
<span id="cb1-19"></span>
<span id="cb1-20">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> pd.DataFrame(</span>
<span id="cb1-21">    model.adjacency_matrix_,</span>
<span id="cb1-22">    columns<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>data.columns,</span>
<span id="cb1-23">    index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>data.columns</span>
<span id="cb1-24">  )<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb1-25">  .reset_index(names <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'node_to'</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb1-26">  .melt(</span>
<span id="cb1-27">    id_vars<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'node_to'</span>,</span>
<span id="cb1-28">    var_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'node_from'</span></span>
<span id="cb1-29">  )<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb1-30">  .pipe(<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">lambda</span> df: df[np.logical_not(np.isclose(df.value, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, rtol<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, atol<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-3</span>))])<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb1-31">  .reindex(columns<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'node_from'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'node_to'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'value'</span>])</span>
<span id="cb1-32"></span>
<span id="cb1-33"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># mermaidファイルを出力する関数</span></span>
<span id="cb1-34"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> write_mermaid(df, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">file</span>):</span>
<span id="cb1-35">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">with</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">file</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'w'</span>) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> f:</span>
<span id="cb1-36">    f.write(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'flowchart LR</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span>
<span id="cb1-37">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> row <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> df.itertuples():</span>
<span id="cb1-38">      f.write(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'  </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">--&gt;|</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{:.3f}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">|</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{}</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">format</span>(row.node_from, row.value, row.node_to))</span>
<span id="cb1-39"></span>
<span id="cb1-40"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 出力先のフォルダ</span></span>
<span id="cb1-41"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dir</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'be-careful-with-function-forms-in-lingam'</span></span>
<span id="cb1-42"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">not</span> os.path.exists(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dir</span>):</span>
<span id="cb1-43">  os.makedirs(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dir</span>)</span></code></pre></div>
</details>
</div>
<section id="因果グラフに掛け算が含まれるケースfunが" class="level3">
<h3 class="anchored" data-anchor-id="因果グラフに掛け算が含まれるケースfunが">因果グラフに掛け算が含まれるケース（<code>fun</code>が<code>*</code>）</h3>
<p><code>fun</code>が掛け算（<code>*</code>）のときにDirect LiNGAMの推定結果がどのようになるかを見てみましょう． 推定された因果グラフは真の因果グラフと同等の構造をもっており，今回のケースでは，因果グラフが正しく推定されていることがわかります． このように，足し算（線形）でなく掛け算のケースでも因果関係の推定がうまくいくケースがあるようです． ただし，観測変数の数やデータ数によっては状況が大きく異なるかもしれません．</p>
<div id="d8e74b08" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1">data_nonlinear_prod <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb2-2"> .assign(</span>
<span id="cb2-3">    x21<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">lambda</span> df: df.x11 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> df.x12 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> rng.random(n),</span>
<span id="cb2-4">    x31<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">lambda</span> df: df.x21 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> df.x22 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> rng.random(n),</span>
<span id="cb2-5">  )</span>
<span id="cb2-6"></span>
<span id="cb2-7">causality_nonlinear_prod <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> discover_causality(data_nonlinear_prod)</span>
<span id="cb2-8"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(causality_nonlinear_prod)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   node_from node_to     value
3        x11     x21  0.975641
8        x12     x21  0.999905
14       x22     x31  4.524066
19       x21     x31  3.477884</code></pre>
</div>
</div>
<div id="27f1f988" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>コード</summary>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1">write_mermaid(causality_nonlinear_prod, os.path.join(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dir</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'dag_lingam_nonlinear_prod.mmd'</span>))</span></code></pre></div>
</details>
</div>
<div class="cell" data-file="be-careful-with-function-forms-in-lingam/dag_lingam_nonlinear_prod.mmd" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">flowchart LR
  x11--&gt;|0.976|x21
  x12--&gt;|1.000|x21
  x22--&gt;|4.524|x31
  x21--&gt;|3.478|x31
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</section>
<section id="因果グラフにべき乗が含まれるケースfunが" class="level3">
<h3 class="anchored" data-anchor-id="因果グラフにべき乗が含まれるケースfunが">因果グラフにべき乗が含まれるケース（<code>fun</code>が<code>**</code>）</h3>
<p>次に，<code>fun</code>がべき乗（<code>**</code>）のときにDirect LiNGAMの推定結果がどのようになるかを見てみましょう． 推定された因果グラフは真の因果グラフと異なる構造をもっており，もともと因果関係が存在しない上流の観測変数間にも誤った因果関係が推定されていることがわかります．このように，Direct LiNGAMに非線形な関数が含まれる場合には，その関数と直接関係しない観測変数間においても，誤った因果関係が推定されてしまうリスクがあることがわかります．</p>
<div id="62827ab5" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1">data_nonlinear_power <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb5-2"> .assign(</span>
<span id="cb5-3">    x21<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">lambda</span> df: df.x11 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> df.x12 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> rng.random(n),</span>
<span id="cb5-4">    x31<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">lambda</span> df: df.x21 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span> df.x22 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> rng.random(n),</span>
<span id="cb5-5">  )</span>
<span id="cb5-6"></span>
<span id="cb5-7">causality_nonlinear_power <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> discover_causality(data_nonlinear_power)</span>
<span id="cb5-8"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(causality_nonlinear_power)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   node_from node_to     value
1        x11     x12 -0.147973
3        x11     x21  0.832946
8        x12     x21  0.798157
17       x21     x22 -0.400541
22       x31     x22  0.002306</code></pre>
</div>
</div>
<div id="3fa4e5b0" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>コード</summary>
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1">write_mermaid(causality_nonlinear_power, os.path.join(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dir</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'dag_lingam_nonlinear_power.mmd'</span>))</span></code></pre></div>
</details>
</div>
<div class="cell" data-file="be-careful-with-function-forms-in-lingam/dag_lingam_nonlinear_power.mmd" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">flowchart LR
  x11--&gt;|-0.148|x12
  x11--&gt;|0.833|x21
  x12--&gt;|0.798|x21
  x21--&gt;|-0.401|x22
  x31--&gt;|0.002|x22
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</section>
</section>
<section id="まとめ" class="level2">
<h2 class="anchored" data-anchor-id="まとめ">まとめ</h2>
<p>この記事では，非線形な関数をもつデータに対してLiNGAMを適用すると，誤った因果関係が推定される可能性があることを示しました． そのため，LiNGAMの適用にあたっては，因果関係が線形で表せることを確認することが重要です．</p>
<p>一方で，因果関係がわからない状況なのに，因果関係が線形で表せることがわかるという状況はまれであると思われます． そのため，事後的な線形性の確認や実験などを通じて，慎重に因果関係を特定することが求められます．</p>


</section>

 ]]></description>
  <category>R</category>
  <category>Japanese</category>
  <guid>https://uchidamizuki.quarto.pub/blog/posts/2024/03/be-careful-with-function-forms-in-lingam.html</guid>
  <pubDate>Sat, 09 Mar 2024 15:00:00 GMT</pubDate>
</item>
<item>
  <title>Scraping dynamic sites with rvest (without Selenium)</title>
  <link>https://uchidamizuki.quarto.pub/blog/posts/2024/02/scraping-dynamic-sites-with-rvest-en.html</link>
  <description><![CDATA[ 





<p>Note: This article is translated from <a href="https://uchidamizuki.quarto.pub/blog/posts/2024/02/scraping-dynamic-sites-with-rvest.html">my Japanese article</a>.</p>
<section id="web-scraping-for-dynamic-sites-in-r" class="level2">
<h2 class="anchored" data-anchor-id="web-scraping-for-dynamic-sites-in-r">Web scraping for dynamic sites in R</h2>
<p>rvest is a popular package for web scraping in R, bur it could not be used for dynamic sites where the contents changes with the operations on the browser.</p>
<p>Therefore, for scraping dynamic sites in R, you needed to use other packages such as RSelenium with rvest and had the following issues.</p>
<ul>
<li><p>When using Selenium, it is troublesome to set up the environment (e.g., you need to download the driver in advance, etc.).</p></li>
<li><p>We couldn’t seamlessly apply rvest functions to HTML from other packages.</p></li>
</ul>
<p>In <a href="https://cran.r-project.org/web/packages/rvest/news/news.html">rvest 1.0.4</a>, however, a new <a href="https://rvest.tidyverse.org/reference/read_html_live.html"><code>read_html_live()</code></a> function has been added to allow dynamic site scraping with rvest alone. By using <code>read_html_live()</code>, you can automate browser operations with methods such as <code>$click()</code> and <code>$type()</code>. Not only that, but you can seamlessly call rvest functions such as <code>html_elements()</code> and <code>html_attr()</code> with <code>read_html_live()</code>.</p>
<p><code>read_html_live()</code> uses <a href="https://rstudio.github.io/chromote/">chromote</a> package for Google Chrome automation internally. Therefore to use the function, you need to install Google Chrome (browser) and chromote (R package) beforehand.</p>
</section>
<section id="lets-use-read_html_live" class="level2">
<h2 class="anchored" data-anchor-id="lets-use-read_html_live">Let’s use <code>read_html_live()</code></h2>
<p>From here, let’s use <code>read_html_live()</code> to perform the same process in <a href="https://joshuamccrain.com/tutorials/web_scraping_R_selenium.html">this RSelenium tutorial</a>.</p>
<p>This tutorial automates the process of collecting information from local TV stations in <a href="https://www.fcc.gov/media/engineering/dtvmaps">this site</a>. This process requires a search for U.S. zip codes.</p>
<p>By using <code>read_html_live()</code>, the code to access the site in RSelenium can be rewritten in rvest as follows.</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># RSelenium</span></span>
<span id="cb1-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Source: https://joshuamccrain.com/tutorials/web_scraping_R_selenium.html</span></span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(RSelenium)</span>
<span id="cb1-4"></span>
<span id="cb1-5">rD <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rsDriver</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">browser=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"firefox"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">port=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4545</span>L, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">verbose=</span>F)</span>
<span id="cb1-6">remDr <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> rD[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"client"</span>]]</span>
<span id="cb1-7">remDr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">navigate</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://www.fcc.gov/media/engineering/dtvmaps"</span>)</span></code></pre></div>
<p>⏬</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># rvest</span></span>
<span id="cb2-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(rvest)</span>
<span id="cb2-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse)</span>
<span id="cb2-4"></span>
<span id="cb2-5">html <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_html_live</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://www.fcc.gov/media/engineering/dtvmaps"</span>)</span></code></pre></div>
</div>
<p>You can use the <code>$view()</code> method to see the LiveHTML object. You can also select elements on the site by <code>Ctrl+Shift+C</code> and then right-click⏩<code>Copy</code>⏩<code>Copy selector</code> to copy the CSS selector, and use it as an argument to <code>$type()</code> or <code>$click()</code>.</p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># rvest</span></span>
<span id="cb3-2">html<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">view</span>()</span></code></pre></div>
<p><img src="https://uchidamizuki.quarto.pub/blog/posts/2024/02/scraping-dynamic-sites-with-rvest/html-view.png" class="img-fluid"></p>
<p>Next, enter the zip code in the center form and click the <code>Go!</code> button. Here, the code in RSelenium can be rewritten in rvest as follows.</p>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># RSelenium</span></span>
<span id="cb4-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Source: https://joshuamccrain.com/tutorials/web_scraping_R_selenium.html</span></span>
<span id="cb4-3">zip <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"30308"</span></span>
<span id="cb4-4">remDr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">findElement</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">using =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"id"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">value =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"startpoint"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sendKeysToElement</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(zip))</span>
<span id="cb4-5">remDr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">findElements</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"id"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"btnSub"</span>)[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">clickElement</span>()</span></code></pre></div>
<p>⏬</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># rvest</span></span>
<span id="cb5-2">zip <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"30308"</span></span>
<span id="cb5-3">html<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">type</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#startpoint"</span>, zip)</span>
<span id="cb5-4">html<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">click</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#btnSub"</span>)</span></code></pre></div>
</div>
<p>Finally, let’s check we got the same data as in the RSelenium tutorial above.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># rvest</span></span>
<span id="cb6-2">html <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">html_elements</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"table.tbl_mapReception"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">insistently</span>(chuck)(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">html_table</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, IA)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename_with</span>(str_to_lower) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ch_num =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ch#</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">slice_tail</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(callsign <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>)</span></code></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["callsign"],"name":[1],"type":["chr"],"align":["left"]},{"label":["network"],"name":[2],"type":["chr"],"align":["left"]},{"label":["ch_num"],"name":[3],"type":["chr"],"align":["left"]},{"label":["band"],"name":[4],"type":["chr"],"align":["left"]}],"data":[{"1":"WXIA-TV","2":"NBC","3":"11","4":"Hi-V"},{"1":"WSB-TV","2":"ABC","3":"2","4":"UHF"},{"1":"WUVG-DT","2":"UNIV","3":"34","4":"UHF"},{"1":"WHSG-TV","2":"TRIN","3":"63","4":"UHF"},{"1":"WAGA-TV","2":"FOX","3":"5","4":"UHF"},{"1":"WANF","2":"CBS","3":"46","4":"UHF"},{"1":"WUPA","2":"THE","3":"69","4":"UHF"},{"1":"WPCH-TV","2":"IND","3":"17","4":"UHF"},{"1":"WATL","2":"MY N","3":"36","4":"UHF"},{"1":"WIRE-CD","2":"","3":"","4":"UHF"},{"1":"WABE-TV","2":"PBS","3":"30","4":"UHF"},{"1":"WATC-DT","2":"ETV","3":"57","4":"UHF"},{"1":"WYGA-CD","2":"","3":"","4":"UHF"},{"1":"WGTV","2":"PBS","3":"8","4":"Hi-V"},{"1":"WANN-CD","2":"","3":"","4":"UHF"},{"1":"WPXA-TV","2":"ION","3":"14","4":"UHF"},{"1":"WKTB-CD","2":"","3":"","4":"UHF"},{"1":"WSKC-CD","2":"","3":"","4":"UHF"},{"1":"WNGH-TV","2":"PBS","3":"18","4":"Lo-V"},{"1":"WJSP-TV","2":"PBS","3":"28","4":"Lo-V"},{"1":"WCIQ","2":"PBS","3":"7","4":"Hi-V"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
</section>
<section id="summary" class="level2">
<h2 class="anchored" data-anchor-id="summary">Summary</h2>
<p>As above, by using <code>read_html_live()</code> that was added in rvest 1.0.4, we found that seamless scraping of static and dynamic sites is possible with rvest alone. In addition, it should be noted that rvest’s code was simpler than RSelenium’s.</p>
<p>In addition to rvest, a web scraping package called <a href="https://ashbythorpe.github.io/selenider/">selenider</a> is also being developed for R. It is expected that the development of such packages will make web scraping in R even more convenient!</p>


</section>

 ]]></description>
  <category>rvest</category>
  <category>R</category>
  <category>English</category>
  <guid>https://uchidamizuki.quarto.pub/blog/posts/2024/02/scraping-dynamic-sites-with-rvest-en.html</guid>
  <pubDate>Wed, 14 Feb 2024 15:00:00 GMT</pubDate>
  <media:content url="https://uchidamizuki.quarto.pub/blog/posts/2024/02/scraping-dynamic-sites-with-rvest/html-view.png" medium="image" type="image/png" height="94" width="144"/>
</item>
<item>
  <title>rvestで動的サイトをスクレイピングする（Seleniumを使わずに）</title>
  <link>https://uchidamizuki.quarto.pub/blog/posts/2024/02/scraping-dynamic-sites-with-rvest.html</link>
  <description><![CDATA[ 





<section id="rにおけるwebスクレイピングのこれまで" class="level2">
<h2 class="anchored" data-anchor-id="rにおけるwebスクレイピングのこれまで">RにおけるWebスクレイピングのこれまで</h2>
<p>RにおけるWebスクレイピングの定番パッケージにrvestがありますが，これまでブラウザ上の操作によってコンテンツが変化する動的サイトのスクレイピングにはrvestを用いることができませんでした．そのため，Rで動的サイトのスクレイピングには，RSeleniumなどの他のパッケージと組み合わせて利用する必要があり，以下のような課題が生じていました．</p>
<ul>
<li>Seleniumを用いる場合には，事前にドライバをダウンロードする必要があるなど環境構築が面倒</li>
<li>他のパッケージで取得したHTMLに対してrvestの関数をシームレスに適用できない</li>
</ul>
<p>しかし，<a href="https://cran.r-project.org/web/packages/rvest/news/news.html">rvest 1.0.4</a>では，<a href="https://rvest.tidyverse.org/reference/read_html_live.html"><code>read_html_live()</code></a>という新たな関数が追加され，動的サイトのスクレイピングが可能となりました．<code>read_html_live()</code>を用いることで，<code>$click()</code>や<code>$type()</code>などのメソッドを用いたブラウザ上の操作の自動化が可能となるだけでなく，<code>html_elements()</code>や<code>html_attr()</code>などの一般的なrvestの関数をシームレスに呼ぶことができるようになります．</p>
<p><code>read_html_live()</code>は，Google Chromeの自動化を行う<a href="https://rstudio.github.io/chromote/">chromote</a>というパッケージを利用しています．そのため，<code>read_html_live()</code>を使うには，事前にGoogle Chrome（ブラウザ）とchromote（Rパッケージ）をインストールしておく必要があります．</p>
</section>
<section id="read_html_liveを使ってみよう" class="level2">
<h2 class="anchored" data-anchor-id="read_html_liveを使ってみよう"><code>read_html_live()</code>を使ってみよう</h2>
<p>ここからは，<a href="https://joshuamccrain.com/tutorials/web_scraping_R_selenium.html">こちらのRSeleniumのチュートリアル</a>で紹介されているものと同じ処理を<code>read_html_live()</code>で行ってみましょう．</p>
<p>こちらのチュートリアルでは，<a href="https://www.fcc.gov/media/engineering/dtvmaps">こちらのサイト</a>にアメリカの郵便番号（ZIP code）を入力して地元テレビ局の情報を取得するという一連の処理を自動化しています． <code>read_html_live()</code>を使えば，RSeleniumでのサイトのアクセスを以下のように書き換えられます．</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># RSelenium</span></span>
<span id="cb1-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Source: https://joshuamccrain.com/tutorials/web_scraping_R_selenium.html</span></span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(RSelenium)</span>
<span id="cb1-4"></span>
<span id="cb1-5">rD <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rsDriver</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">browser=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"firefox"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">port=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4545</span>L, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">verbose=</span>F)</span>
<span id="cb1-6">remDr <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> rD[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"client"</span>]]</span>
<span id="cb1-7">remDr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">navigate</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://www.fcc.gov/media/engineering/dtvmaps"</span>)</span></code></pre></div>
<p>⏬</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># rvest</span></span>
<span id="cb2-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(rvest)</span>
<span id="cb2-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse)</span>
<span id="cb2-4"></span>
<span id="cb2-5">html <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_html_live</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://www.fcc.gov/media/engineering/dtvmaps"</span>)</span></code></pre></div>
</div>
<p>読み込まれたオブジェクトは，<code>$view()</code>でブラウザで確認することができます．サイト上のエレメントを選択（<code>Ctrl+Shift+C</code>）したのち，該当箇所を右クリック⏩<code>Copy</code>⏩<code>Copy selector</code>でCSSセレクタをコピーすれば，<code>$type()</code>や<code>$click()</code>の引数として使うことができます．</p>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># rvest</span></span>
<span id="cb3-2">html<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">view</span>()</span></code></pre></div>
<p><img src="https://uchidamizuki.quarto.pub/blog/posts/2024/02/scraping-dynamic-sites-with-rvest/html-view.png" class="img-fluid"></p>
<p>次に，中央のフォームに郵便番号（ZIP code）を入力⏩<code>Go!</code>ボタンをクリックし地元テレビ局の情報を表示させるコードは以下のように書き換えられます．</p>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># RSelenium</span></span>
<span id="cb4-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Source: https://joshuamccrain.com/tutorials/web_scraping_R_selenium.html</span></span>
<span id="cb4-3">zip <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"30308"</span></span>
<span id="cb4-4">remDr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">findElement</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">using =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"id"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">value =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"startpoint"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sendKeysToElement</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(zip))</span>
<span id="cb4-5">remDr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">findElements</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"id"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"btnSub"</span>)[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">clickElement</span>()</span></code></pre></div>
<p>⏬</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># rvest</span></span>
<span id="cb5-2">zip <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"30308"</span></span>
<span id="cb5-3">html<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">type</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#startpoint"</span>, zip)</span>
<span id="cb5-4">html<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">click</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#btnSub"</span>)</span></code></pre></div>
</div>
<p>最後に，上記のRSeleniumのチュートリアルと同じデータが取得できたことを確認しましょう．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># rvest</span></span>
<span id="cb6-2">html <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">html_elements</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"table.tbl_mapReception"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">insistently</span>(chuck)(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">html_table</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, IA)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename_with</span>(str_to_lower) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ch_num =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ch#</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">slice_tail</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(callsign <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>)</span></code></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["callsign"],"name":[1],"type":["chr"],"align":["left"]},{"label":["network"],"name":[2],"type":["chr"],"align":["left"]},{"label":["ch_num"],"name":[3],"type":["chr"],"align":["left"]},{"label":["band"],"name":[4],"type":["chr"],"align":["left"]}],"data":[{"1":"WXIA-TV","2":"NBC","3":"11","4":"Hi-V"},{"1":"WSB-TV","2":"ABC","3":"2","4":"UHF"},{"1":"WUVG-DT","2":"UNIV","3":"34","4":"UHF"},{"1":"WHSG-TV","2":"TRIN","3":"63","4":"UHF"},{"1":"WAGA-TV","2":"FOX","3":"5","4":"UHF"},{"1":"WANF","2":"CBS","3":"46","4":"UHF"},{"1":"WUPA","2":"THE","3":"69","4":"UHF"},{"1":"WPCH-TV","2":"IND","3":"17","4":"UHF"},{"1":"WATL","2":"MY N","3":"36","4":"UHF"},{"1":"WIRE-CD","2":"","3":"","4":"UHF"},{"1":"WABE-TV","2":"PBS","3":"30","4":"UHF"},{"1":"WATC-DT","2":"ETV","3":"57","4":"UHF"},{"1":"WYGA-CD","2":"","3":"","4":"UHF"},{"1":"WGTV","2":"PBS","3":"8","4":"Hi-V"},{"1":"WANN-CD","2":"","3":"","4":"UHF"},{"1":"WPXA-TV","2":"ION","3":"14","4":"UHF"},{"1":"WKTB-CD","2":"","3":"","4":"UHF"},{"1":"WSKC-CD","2":"","3":"","4":"UHF"},{"1":"WNGH-TV","2":"PBS","3":"18","4":"Lo-V"},{"1":"WJSP-TV","2":"PBS","3":"28","4":"Lo-V"},{"1":"WCIQ","2":"PBS","3":"7","4":"Hi-V"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
</section>
<section id="まとめ" class="level2">
<h2 class="anchored" data-anchor-id="まとめ">まとめ</h2>
<p>以上のようにrvest 1.0.4で追加された<code>read_html_live()</code>を使うことで，rvestだけでシームレスに静的サイトと動的サイトのスクレイピングが可能となるだけでなく，RSeleniumと比べてシンプルなコードでブラウザ上の操作を再現することができることがわかりました．</p>
<p>Rには，rvestの他にも<a href="https://ashbythorpe.github.io/selenider/">selenider</a>というWebスクレイピング用のパッケージも開発されているようです．こういったパッケージの開発が進むことで，RでのWebスクレイピングがさらに便利になることが期待されます．</p>


</section>

 ]]></description>
  <category>rvest</category>
  <category>R</category>
  <category>Japanese</category>
  <guid>https://uchidamizuki.quarto.pub/blog/posts/2024/02/scraping-dynamic-sites-with-rvest.html</guid>
  <pubDate>Wed, 14 Feb 2024 15:00:00 GMT</pubDate>
  <media:content url="https://uchidamizuki.quarto.pub/blog/posts/2024/02/scraping-dynamic-sites-with-rvest/html-view.png" medium="image" type="image/png" height="94" width="144"/>
</item>
<item>
  <title>Improve the quality of data preprocessing with R’s dm package</title>
  <link>https://uchidamizuki.quarto.pub/blog/posts/2024/01/relational-data-models-with-r-s-dm-en.html</link>
  <description><![CDATA[ 





<p>Note: This article is a machine-translated translation of <a href="https://uchidamizuki.quarto.pub/blog/posts/2024/01/relational-data-models-with-r-s-dm.html">my Japanese article</a> with simple modifications.</p>
<section id="how-do-we-reduce-errors-in-data-preprocessing" class="level2">
<h2 class="anchored" data-anchor-id="how-do-we-reduce-errors-in-data-preprocessing">How do we reduce errors in data preprocessing?</h2>
<p>It is said that 80% of the time required for data analysis is spent on preprocessing. Even though preprocessing determines the quality of subsequent data analysis, the more time spent on pre-processing means the probability of making mistakes is also high.</p>
<p>Preprocessing tasks include “extraction,” “aggregation,” and “joining (merging)” of data frames. Among these, data joining is a task that tends to make the code longer and more prone to errors. And since the data frames needed for analysis are rarely combined into one, joining data frames is a widespread process.</p>
<p>Typical mistakes that tend to occur when joining data frames are as follows<sup>1</sup>,</p>
<ul>
<li>The keys of the data frame to be joined are not “<a href="https://en.wikipedia.org/wiki/MECE_principle">MECE</a>”</li>
<li>Mistaken keys to join data frames</li>
</ul>
<p>If you have experienced any mistakes or near-misses in joining data frames, you may be better off relying on some sort of package instead of letting them go unattended. Besides, even if there were no mistakes, we tend to be skeptical about whether we did the right thing in the past.</p>
<p>This article introduces the R dm package, a powerful solution to the problems of errors and skepticism in joining data frames.</p>
</section>
<section id="relational-data-model-with-dm" class="level2">
<h2 class="anchored" data-anchor-id="relational-data-model-with-dm">Relational data model with dm</h2>
<p>The relational data model provided by dm manages the relationships among multiple data on our behalf.</p>
<p>This article describes the use and advantages of the relational data model provided by dm. the Star Wars data set provided by the repurrrsive package. For this purpose, let’s use the Star Wars dataset provided by the repurrrsive package. tidyverse, dm, and repurrrsive packages must be pre-loaded.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse)</span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dm)</span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(repurrrsive)</span></code></pre></div>
</div>
<p>The Star Wars dataset provided by repurrrsive includes the followings<sup>2</sup>.</p>
<div class="cell">
<details class="code-fold">
<summary>StarWars dataset provided by repurrrsive</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">package =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"repurrrsive"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb2-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">chuck</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"results"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb2-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_tibble</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb2-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_starts</span>(Item, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sw_"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb2-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pull</span>(Item)</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "sw_films"     "sw_people"    "sw_planets"   "sw_species"   "sw_starships"
[6] "sw_vehicles" </code></pre>
</div>
</div>
<p>This article will illustrate the use of the relational data model through the following two analytical examples. These examples require dealing with relationships among multiple data sets.</p>
<ol type="1">
<li>Basic: Building a relational data model with dm</li>
<li>Application: Extending the model and validating keys with dm</li>
</ol>
<section id="basic-building-a-relational-data-model-with-dm" class="level3">
<h3 class="anchored" data-anchor-id="basic-building-a-relational-data-model-with-dm">1. Basic: Building a relational data model with dm</h3>
<p>As a basic example, let us build a relational data model to determine the composition ratio of the home planets of the characters in Star Wars movies. To perform this analysis, three data frames, <code>films</code>, <code>people</code>, and <code>planets</code>, are prepared as shown below. Here, only the necessary data are selected to simplify the analysis<sup>3</sup>．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">films <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">film =</span> sw_films) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb4-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unnest_wider</span>(film) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb4-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(url, title, characters)</span>
<span id="cb4-4">people <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">person =</span> sw_people) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb4-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unnest_wider</span>(person) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb4-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(url, name, homeworld, species)</span>
<span id="cb4-7">planets <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">planet =</span> sw_planets) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb4-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unnest_wider</span>(planet) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb4-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(url, name)</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1">films</span></code></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["url"],"name":[1],"type":["chr"],"align":["left"]},{"label":["title"],"name":[2],"type":["chr"],"align":["left"]},{"label":["characters"],"name":[3],"type":["list"],"align":["right"]}],"data":[{"1":"http://swapi.co/api/films/1/","2":"A New Hope","3":"<chr [18]>"},{"1":"http://swapi.co/api/films/5/","2":"Attack of the Clones","3":"<chr [40]>"},{"1":"http://swapi.co/api/films/4/","2":"The Phantom Menace","3":"<chr [34]>"},{"1":"http://swapi.co/api/films/6/","2":"Revenge of the Sith","3":"<chr [34]>"},{"1":"http://swapi.co/api/films/3/","2":"Return of the Jedi","3":"<chr [20]>"},{"1":"http://swapi.co/api/films/2/","2":"The Empire Strikes Back","3":"<chr [16]>"},{"1":"http://swapi.co/api/films/7/","2":"The Force Awakens","3":"<chr [11]>"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1">people</span></code></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["url"],"name":[1],"type":["chr"],"align":["left"]},{"label":["name"],"name":[2],"type":["chr"],"align":["left"]},{"label":["homeworld"],"name":[3],"type":["chr"],"align":["left"]},{"label":["species"],"name":[4],"type":["chr"],"align":["left"]}],"data":[{"1":"http://swapi.co/api/people/1/","2":"Luke Skywalker","3":"http://swapi.co/api/planets/1/","4":"http://swapi.co/api/species/1/"},{"1":"http://swapi.co/api/people/2/","2":"C-3PO","3":"http://swapi.co/api/planets/1/","4":"http://swapi.co/api/species/2/"},{"1":"http://swapi.co/api/people/3/","2":"R2-D2","3":"http://swapi.co/api/planets/8/","4":"http://swapi.co/api/species/2/"},{"1":"http://swapi.co/api/people/4/","2":"Darth Vader","3":"http://swapi.co/api/planets/1/","4":"http://swapi.co/api/species/1/"},{"1":"http://swapi.co/api/people/5/","2":"Leia Organa","3":"http://swapi.co/api/planets/2/","4":"http://swapi.co/api/species/1/"},{"1":"http://swapi.co/api/people/6/","2":"Owen Lars","3":"http://swapi.co/api/planets/1/","4":"http://swapi.co/api/species/1/"},{"1":"http://swapi.co/api/people/7/","2":"Beru Whitesun lars","3":"http://swapi.co/api/planets/1/","4":"http://swapi.co/api/species/1/"},{"1":"http://swapi.co/api/people/8/","2":"R5-D4","3":"http://swapi.co/api/planets/1/","4":"http://swapi.co/api/species/2/"},{"1":"http://swapi.co/api/people/9/","2":"Biggs Darklighter","3":"http://swapi.co/api/planets/1/","4":"http://swapi.co/api/species/1/"},{"1":"http://swapi.co/api/people/10/","2":"Obi-Wan Kenobi","3":"http://swapi.co/api/planets/20/","4":"http://swapi.co/api/species/1/"},{"1":"http://swapi.co/api/people/11/","2":"Anakin Skywalker","3":"http://swapi.co/api/planets/1/","4":"http://swapi.co/api/species/1/"},{"1":"http://swapi.co/api/people/12/","2":"Wilhuff Tarkin","3":"http://swapi.co/api/planets/21/","4":"http://swapi.co/api/species/1/"},{"1":"http://swapi.co/api/people/13/","2":"Chewbacca","3":"http://swapi.co/api/planets/14/","4":"http://swapi.co/api/species/3/"},{"1":"http://swapi.co/api/people/14/","2":"Han Solo","3":"http://swapi.co/api/planets/22/","4":"http://swapi.co/api/species/1/"},{"1":"http://swapi.co/api/people/15/","2":"Greedo","3":"http://swapi.co/api/planets/23/","4":"http://swapi.co/api/species/4/"},{"1":"http://swapi.co/api/people/16/","2":"Jabba Desilijic Tiure","3":"http://swapi.co/api/planets/24/","4":"http://swapi.co/api/species/5/"},{"1":"http://swapi.co/api/people/18/","2":"Wedge Antilles","3":"http://swapi.co/api/planets/22/","4":"http://swapi.co/api/species/1/"},{"1":"http://swapi.co/api/people/19/","2":"Jek Tono Porkins","3":"http://swapi.co/api/planets/26/","4":"http://swapi.co/api/species/1/"},{"1":"http://swapi.co/api/people/20/","2":"Yoda","3":"http://swapi.co/api/planets/28/","4":"http://swapi.co/api/species/6/"},{"1":"http://swapi.co/api/people/21/","2":"Palpatine","3":"http://swapi.co/api/planets/8/","4":"http://swapi.co/api/species/1/"},{"1":"http://swapi.co/api/people/22/","2":"Boba Fett","3":"http://swapi.co/api/planets/10/","4":"http://swapi.co/api/species/1/"},{"1":"http://swapi.co/api/people/23/","2":"IG-88","3":"http://swapi.co/api/planets/28/","4":"http://swapi.co/api/species/2/"},{"1":"http://swapi.co/api/people/24/","2":"Bossk","3":"http://swapi.co/api/planets/29/","4":"http://swapi.co/api/species/7/"},{"1":"http://swapi.co/api/people/25/","2":"Lando Calrissian","3":"http://swapi.co/api/planets/30/","4":"http://swapi.co/api/species/1/"},{"1":"http://swapi.co/api/people/26/","2":"Lobot","3":"http://swapi.co/api/planets/6/","4":"http://swapi.co/api/species/1/"},{"1":"http://swapi.co/api/people/27/","2":"Ackbar","3":"http://swapi.co/api/planets/31/","4":"http://swapi.co/api/species/8/"},{"1":"http://swapi.co/api/people/28/","2":"Mon Mothma","3":"http://swapi.co/api/planets/32/","4":"http://swapi.co/api/species/1/"},{"1":"http://swapi.co/api/people/29/","2":"Arvel Crynyd","3":"http://swapi.co/api/planets/28/","4":"http://swapi.co/api/species/1/"},{"1":"http://swapi.co/api/people/30/","2":"Wicket Systri Warrick","3":"http://swapi.co/api/planets/7/","4":"http://swapi.co/api/species/9/"},{"1":"http://swapi.co/api/people/31/","2":"Nien Nunb","3":"http://swapi.co/api/planets/33/","4":"http://swapi.co/api/species/10/"},{"1":"http://swapi.co/api/people/32/","2":"Qui-Gon Jinn","3":"http://swapi.co/api/planets/28/","4":"http://swapi.co/api/species/1/"},{"1":"http://swapi.co/api/people/33/","2":"Nute Gunray","3":"http://swapi.co/api/planets/18/","4":"http://swapi.co/api/species/11/"},{"1":"http://swapi.co/api/people/34/","2":"Finis Valorum","3":"http://swapi.co/api/planets/9/","4":"http://swapi.co/api/species/1/"},{"1":"http://swapi.co/api/people/36/","2":"Jar Jar Binks","3":"http://swapi.co/api/planets/8/","4":"http://swapi.co/api/species/12/"},{"1":"http://swapi.co/api/people/37/","2":"Roos Tarpals","3":"http://swapi.co/api/planets/8/","4":"http://swapi.co/api/species/12/"},{"1":"http://swapi.co/api/people/38/","2":"Rugor Nass","3":"http://swapi.co/api/planets/8/","4":"http://swapi.co/api/species/12/"},{"1":"http://swapi.co/api/people/39/","2":"Ric Olié","3":"http://swapi.co/api/planets/8/","4":"NA"},{"1":"http://swapi.co/api/people/40/","2":"Watto","3":"http://swapi.co/api/planets/34/","4":"http://swapi.co/api/species/13/"},{"1":"http://swapi.co/api/people/41/","2":"Sebulba","3":"http://swapi.co/api/planets/35/","4":"http://swapi.co/api/species/14/"},{"1":"http://swapi.co/api/people/42/","2":"Quarsh Panaka","3":"http://swapi.co/api/planets/8/","4":"NA"},{"1":"http://swapi.co/api/people/43/","2":"Shmi Skywalker","3":"http://swapi.co/api/planets/1/","4":"http://swapi.co/api/species/1/"},{"1":"http://swapi.co/api/people/44/","2":"Darth Maul","3":"http://swapi.co/api/planets/36/","4":"http://swapi.co/api/species/22/"},{"1":"http://swapi.co/api/people/45/","2":"Bib Fortuna","3":"http://swapi.co/api/planets/37/","4":"http://swapi.co/api/species/15/"},{"1":"http://swapi.co/api/people/46/","2":"Ayla Secura","3":"http://swapi.co/api/planets/37/","4":"http://swapi.co/api/species/15/"},{"1":"http://swapi.co/api/people/48/","2":"Dud Bolt","3":"http://swapi.co/api/planets/39/","4":"http://swapi.co/api/species/17/"},{"1":"http://swapi.co/api/people/49/","2":"Gasgano","3":"http://swapi.co/api/planets/40/","4":"http://swapi.co/api/species/18/"},{"1":"http://swapi.co/api/people/50/","2":"Ben Quadinaros","3":"http://swapi.co/api/planets/41/","4":"http://swapi.co/api/species/19/"},{"1":"http://swapi.co/api/people/51/","2":"Mace Windu","3":"http://swapi.co/api/planets/42/","4":"http://swapi.co/api/species/1/"},{"1":"http://swapi.co/api/people/52/","2":"Ki-Adi-Mundi","3":"http://swapi.co/api/planets/43/","4":"http://swapi.co/api/species/20/"},{"1":"http://swapi.co/api/people/53/","2":"Kit Fisto","3":"http://swapi.co/api/planets/44/","4":"http://swapi.co/api/species/21/"},{"1":"http://swapi.co/api/people/54/","2":"Eeth Koth","3":"http://swapi.co/api/planets/45/","4":"http://swapi.co/api/species/22/"},{"1":"http://swapi.co/api/people/55/","2":"Adi Gallia","3":"http://swapi.co/api/planets/9/","4":"http://swapi.co/api/species/23/"},{"1":"http://swapi.co/api/people/56/","2":"Saesee Tiin","3":"http://swapi.co/api/planets/47/","4":"http://swapi.co/api/species/24/"},{"1":"http://swapi.co/api/people/57/","2":"Yarael Poof","3":"http://swapi.co/api/planets/48/","4":"http://swapi.co/api/species/25/"},{"1":"http://swapi.co/api/people/58/","2":"Plo Koon","3":"http://swapi.co/api/planets/49/","4":"http://swapi.co/api/species/26/"},{"1":"http://swapi.co/api/people/59/","2":"Mas Amedda","3":"http://swapi.co/api/planets/50/","4":"http://swapi.co/api/species/27/"},{"1":"http://swapi.co/api/people/60/","2":"Gregar Typho","3":"http://swapi.co/api/planets/8/","4":"http://swapi.co/api/species/1/"},{"1":"http://swapi.co/api/people/61/","2":"Cordé","3":"http://swapi.co/api/planets/8/","4":"http://swapi.co/api/species/1/"},{"1":"http://swapi.co/api/people/62/","2":"Cliegg Lars","3":"http://swapi.co/api/planets/1/","4":"http://swapi.co/api/species/1/"},{"1":"http://swapi.co/api/people/63/","2":"Poggle the Lesser","3":"http://swapi.co/api/planets/11/","4":"http://swapi.co/api/species/28/"},{"1":"http://swapi.co/api/people/64/","2":"Luminara Unduli","3":"http://swapi.co/api/planets/51/","4":"http://swapi.co/api/species/29/"},{"1":"http://swapi.co/api/people/65/","2":"Barriss Offee","3":"http://swapi.co/api/planets/51/","4":"http://swapi.co/api/species/29/"},{"1":"http://swapi.co/api/people/66/","2":"Dormé","3":"http://swapi.co/api/planets/8/","4":"http://swapi.co/api/species/1/"},{"1":"http://swapi.co/api/people/67/","2":"Dooku","3":"http://swapi.co/api/planets/52/","4":"http://swapi.co/api/species/1/"},{"1":"http://swapi.co/api/people/68/","2":"Bail Prestor Organa","3":"http://swapi.co/api/planets/2/","4":"http://swapi.co/api/species/1/"},{"1":"http://swapi.co/api/people/69/","2":"Jango Fett","3":"http://swapi.co/api/planets/53/","4":"http://swapi.co/api/species/1/"},{"1":"http://swapi.co/api/people/70/","2":"Zam Wesell","3":"http://swapi.co/api/planets/54/","4":"http://swapi.co/api/species/30/"},{"1":"http://swapi.co/api/people/71/","2":"Dexter Jettster","3":"http://swapi.co/api/planets/55/","4":"http://swapi.co/api/species/31/"},{"1":"http://swapi.co/api/people/72/","2":"Lama Su","3":"http://swapi.co/api/planets/10/","4":"http://swapi.co/api/species/32/"},{"1":"http://swapi.co/api/people/73/","2":"Taun We","3":"http://swapi.co/api/planets/10/","4":"http://swapi.co/api/species/32/"},{"1":"http://swapi.co/api/people/74/","2":"Jocasta Nu","3":"http://swapi.co/api/planets/9/","4":"http://swapi.co/api/species/1/"},{"1":"http://swapi.co/api/people/47/","2":"Ratts Tyerell","3":"http://swapi.co/api/planets/38/","4":"http://swapi.co/api/species/16/"},{"1":"http://swapi.co/api/people/75/","2":"R4-P17","3":"http://swapi.co/api/planets/28/","4":"NA"},{"1":"http://swapi.co/api/people/76/","2":"Wat Tambor","3":"http://swapi.co/api/planets/56/","4":"http://swapi.co/api/species/33/"},{"1":"http://swapi.co/api/people/77/","2":"San Hill","3":"http://swapi.co/api/planets/57/","4":"http://swapi.co/api/species/34/"},{"1":"http://swapi.co/api/people/78/","2":"Shaak Ti","3":"http://swapi.co/api/planets/58/","4":"http://swapi.co/api/species/35/"},{"1":"http://swapi.co/api/people/79/","2":"Grievous","3":"http://swapi.co/api/planets/59/","4":"http://swapi.co/api/species/36/"},{"1":"http://swapi.co/api/people/80/","2":"Tarfful","3":"http://swapi.co/api/planets/14/","4":"http://swapi.co/api/species/3/"},{"1":"http://swapi.co/api/people/81/","2":"Raymus Antilles","3":"http://swapi.co/api/planets/2/","4":"http://swapi.co/api/species/1/"},{"1":"http://swapi.co/api/people/82/","2":"Sly Moore","3":"http://swapi.co/api/planets/60/","4":"NA"},{"1":"http://swapi.co/api/people/83/","2":"Tion Medon","3":"http://swapi.co/api/planets/12/","4":"http://swapi.co/api/species/37/"},{"1":"http://swapi.co/api/people/84/","2":"Finn","3":"http://swapi.co/api/planets/28/","4":"http://swapi.co/api/species/1/"},{"1":"http://swapi.co/api/people/85/","2":"Rey","3":"http://swapi.co/api/planets/28/","4":"http://swapi.co/api/species/1/"},{"1":"http://swapi.co/api/people/86/","2":"Poe Dameron","3":"http://swapi.co/api/planets/28/","4":"http://swapi.co/api/species/1/"},{"1":"http://swapi.co/api/people/87/","2":"BB8","3":"http://swapi.co/api/planets/28/","4":"http://swapi.co/api/species/2/"},{"1":"http://swapi.co/api/people/88/","2":"Captain Phasma","3":"http://swapi.co/api/planets/28/","4":"NA"},{"1":"http://swapi.co/api/people/35/","2":"Padmé Amidala","3":"http://swapi.co/api/planets/8/","4":"http://swapi.co/api/species/1/"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1">planets</span></code></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["url"],"name":[1],"type":["chr"],"align":["left"]},{"label":["name"],"name":[2],"type":["chr"],"align":["left"]}],"data":[{"1":"http://swapi.co/api/planets/2/","2":"Alderaan"},{"1":"http://swapi.co/api/planets/3/","2":"Yavin IV"},{"1":"http://swapi.co/api/planets/4/","2":"Hoth"},{"1":"http://swapi.co/api/planets/5/","2":"Dagobah"},{"1":"http://swapi.co/api/planets/6/","2":"Bespin"},{"1":"http://swapi.co/api/planets/7/","2":"Endor"},{"1":"http://swapi.co/api/planets/8/","2":"Naboo"},{"1":"http://swapi.co/api/planets/9/","2":"Coruscant"},{"1":"http://swapi.co/api/planets/10/","2":"Kamino"},{"1":"http://swapi.co/api/planets/11/","2":"Geonosis"},{"1":"http://swapi.co/api/planets/12/","2":"Utapau"},{"1":"http://swapi.co/api/planets/13/","2":"Mustafar"},{"1":"http://swapi.co/api/planets/14/","2":"Kashyyyk"},{"1":"http://swapi.co/api/planets/15/","2":"Polis Massa"},{"1":"http://swapi.co/api/planets/16/","2":"Mygeeto"},{"1":"http://swapi.co/api/planets/17/","2":"Felucia"},{"1":"http://swapi.co/api/planets/18/","2":"Cato Neimoidia"},{"1":"http://swapi.co/api/planets/19/","2":"Saleucami"},{"1":"http://swapi.co/api/planets/20/","2":"Stewjon"},{"1":"http://swapi.co/api/planets/21/","2":"Eriadu"},{"1":"http://swapi.co/api/planets/22/","2":"Corellia"},{"1":"http://swapi.co/api/planets/23/","2":"Rodia"},{"1":"http://swapi.co/api/planets/24/","2":"Nal Hutta"},{"1":"http://swapi.co/api/planets/25/","2":"Dantooine"},{"1":"http://swapi.co/api/planets/26/","2":"Bestine IV"},{"1":"http://swapi.co/api/planets/27/","2":"Ord Mantell"},{"1":"http://swapi.co/api/planets/28/","2":"unknown"},{"1":"http://swapi.co/api/planets/29/","2":"Trandosha"},{"1":"http://swapi.co/api/planets/30/","2":"Socorro"},{"1":"http://swapi.co/api/planets/31/","2":"Mon Cala"},{"1":"http://swapi.co/api/planets/32/","2":"Chandrila"},{"1":"http://swapi.co/api/planets/33/","2":"Sullust"},{"1":"http://swapi.co/api/planets/34/","2":"Toydaria"},{"1":"http://swapi.co/api/planets/35/","2":"Malastare"},{"1":"http://swapi.co/api/planets/36/","2":"Dathomir"},{"1":"http://swapi.co/api/planets/37/","2":"Ryloth"},{"1":"http://swapi.co/api/planets/38/","2":"Aleen Minor"},{"1":"http://swapi.co/api/planets/39/","2":"Vulpter"},{"1":"http://swapi.co/api/planets/40/","2":"Troiken"},{"1":"http://swapi.co/api/planets/41/","2":"Tund"},{"1":"http://swapi.co/api/planets/42/","2":"Haruun Kal"},{"1":"http://swapi.co/api/planets/43/","2":"Cerea"},{"1":"http://swapi.co/api/planets/44/","2":"Glee Anselm"},{"1":"http://swapi.co/api/planets/45/","2":"Iridonia"},{"1":"http://swapi.co/api/planets/46/","2":"Tholoth"},{"1":"http://swapi.co/api/planets/47/","2":"Iktotch"},{"1":"http://swapi.co/api/planets/48/","2":"Quermia"},{"1":"http://swapi.co/api/planets/49/","2":"Dorin"},{"1":"http://swapi.co/api/planets/50/","2":"Champala"},{"1":"http://swapi.co/api/planets/51/","2":"Mirial"},{"1":"http://swapi.co/api/planets/52/","2":"Serenno"},{"1":"http://swapi.co/api/planets/53/","2":"Concord Dawn"},{"1":"http://swapi.co/api/planets/54/","2":"Zolan"},{"1":"http://swapi.co/api/planets/55/","2":"Ojom"},{"1":"http://swapi.co/api/planets/56/","2":"Skako"},{"1":"http://swapi.co/api/planets/57/","2":"Muunilinst"},{"1":"http://swapi.co/api/planets/58/","2":"Shili"},{"1":"http://swapi.co/api/planets/59/","2":"Kalee"},{"1":"http://swapi.co/api/planets/60/","2":"Umbara"},{"1":"http://swapi.co/api/planets/1/","2":"Tatooine"},{"1":"http://swapi.co/api/planets/61/","2":"Jakku"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>Checking the prepared data frames, we can see that <code>url</code> column of each data frame is used as a key, so the relationship between the data frames can be summarized as shown in the following figure<sup>4</sup>.</p>
<p>Since it is common for a film to have multiple characters, it is important to note that <code>characters</code> column of <code>films</code> is a list of characters, so it isn’t possible to join <code>characters</code> column of <code>films</code> to <code>url</code> column of <code>people</code>.</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">flowchart TB
  films.characters --&gt; people.url
  people.homeworld --&gt; planets.url
  subgraph films
    films.url[url]
    films.title[title]
    films.characters[List of characters] 
  end
  subgraph people
    people.url[url]
    people.name[name]
    people.homeworld[homeworld]
  end
  subgraph planets
    planets.url[url]
    planets.name[name]
  end
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<p>Therefore, we consider creating a new data file, <code>films_x_characters</code>, that represents the relationship between <code>films</code> and <code>people</code>, i.e., which characters appear in which films<sup>5</sup>．Through <code>films_x_characters</code>, the relationship between data can be summarized as shown in the following figure.</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">flowchart TB
  films_x_characters.url --&gt; films.url
  films_x_characters.characters ---&gt; people.url
  people.homeworld --&gt; planets.url
  subgraph films_x_characters
    films_x_characters.url[url]
    films_x_characters.characters[characters]
  end
  subgraph films
    films.url[url]
    films.title[title]
  end
  subgraph people
    people.url[url]
    people.name[name]
    people.homeworld[homeworld]
  end
  subgraph planets
    planets.url[url]
    planets.name[name]
  end
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<p>Now, let’s build a relational data model according to the above image. First, create <code>films_x_characters</code> using <code>url</code> and <code>characters</code> columns of <code>films</code>. In addition, I delete the unnecessary <code>characters</code> column from <code>films</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create films_x_characters and remove characters column from films</span></span>
<span id="cb8-2">films_x_characters <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> films <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb8-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(url, characters) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb8-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unnest_longer</span>(characters)</span>
<span id="cb8-5">films <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> films <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb8-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>characters)</span>
<span id="cb8-7"></span>
<span id="cb8-8">films_x_characters</span></code></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["url"],"name":[1],"type":["chr"],"align":["left"]},{"label":["characters"],"name":[2],"type":["chr"],"align":["left"]}],"data":[{"1":"http://swapi.co/api/films/1/","2":"http://swapi.co/api/people/1/"},{"1":"http://swapi.co/api/films/1/","2":"http://swapi.co/api/people/2/"},{"1":"http://swapi.co/api/films/1/","2":"http://swapi.co/api/people/3/"},{"1":"http://swapi.co/api/films/1/","2":"http://swapi.co/api/people/4/"},{"1":"http://swapi.co/api/films/1/","2":"http://swapi.co/api/people/5/"},{"1":"http://swapi.co/api/films/1/","2":"http://swapi.co/api/people/6/"},{"1":"http://swapi.co/api/films/1/","2":"http://swapi.co/api/people/7/"},{"1":"http://swapi.co/api/films/1/","2":"http://swapi.co/api/people/8/"},{"1":"http://swapi.co/api/films/1/","2":"http://swapi.co/api/people/9/"},{"1":"http://swapi.co/api/films/1/","2":"http://swapi.co/api/people/10/"},{"1":"http://swapi.co/api/films/1/","2":"http://swapi.co/api/people/12/"},{"1":"http://swapi.co/api/films/1/","2":"http://swapi.co/api/people/13/"},{"1":"http://swapi.co/api/films/1/","2":"http://swapi.co/api/people/14/"},{"1":"http://swapi.co/api/films/1/","2":"http://swapi.co/api/people/15/"},{"1":"http://swapi.co/api/films/1/","2":"http://swapi.co/api/people/16/"},{"1":"http://swapi.co/api/films/1/","2":"http://swapi.co/api/people/18/"},{"1":"http://swapi.co/api/films/1/","2":"http://swapi.co/api/people/19/"},{"1":"http://swapi.co/api/films/1/","2":"http://swapi.co/api/people/81/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/2/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/3/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/6/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/7/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/10/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/11/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/20/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/21/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/22/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/33/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/36/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/40/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/43/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/46/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/51/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/52/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/53/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/58/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/59/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/60/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/61/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/62/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/63/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/64/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/65/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/66/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/67/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/68/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/69/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/70/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/71/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/72/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/73/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/74/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/75/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/76/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/77/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/78/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/82/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/35/"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/2/"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/3/"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/10/"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/11/"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/16/"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/20/"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/21/"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/32/"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/33/"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/34/"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/36/"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/37/"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/38/"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/39/"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/40/"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/41/"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/42/"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/43/"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/44/"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/46/"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/48/"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/49/"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/50/"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/51/"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/52/"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/53/"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/54/"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/55/"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/56/"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/57/"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/58/"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/59/"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/47/"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/35/"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/1/"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/2/"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/3/"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/4/"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/5/"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/6/"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/7/"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/10/"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/11/"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/12/"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/13/"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/20/"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/21/"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/33/"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/46/"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/51/"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/52/"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/53/"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/54/"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/55/"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/56/"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/58/"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/63/"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/64/"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/67/"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/68/"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/75/"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/78/"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/79/"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/80/"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/81/"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/82/"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/83/"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/35/"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/1/"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/2/"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/3/"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/4/"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/5/"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/10/"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/13/"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/14/"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/16/"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/18/"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/20/"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/21/"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/22/"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/25/"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/27/"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/28/"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/29/"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/30/"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/31/"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/45/"},{"1":"http://swapi.co/api/films/2/","2":"http://swapi.co/api/people/1/"},{"1":"http://swapi.co/api/films/2/","2":"http://swapi.co/api/people/2/"},{"1":"http://swapi.co/api/films/2/","2":"http://swapi.co/api/people/3/"},{"1":"http://swapi.co/api/films/2/","2":"http://swapi.co/api/people/4/"},{"1":"http://swapi.co/api/films/2/","2":"http://swapi.co/api/people/5/"},{"1":"http://swapi.co/api/films/2/","2":"http://swapi.co/api/people/10/"},{"1":"http://swapi.co/api/films/2/","2":"http://swapi.co/api/people/13/"},{"1":"http://swapi.co/api/films/2/","2":"http://swapi.co/api/people/14/"},{"1":"http://swapi.co/api/films/2/","2":"http://swapi.co/api/people/18/"},{"1":"http://swapi.co/api/films/2/","2":"http://swapi.co/api/people/20/"},{"1":"http://swapi.co/api/films/2/","2":"http://swapi.co/api/people/21/"},{"1":"http://swapi.co/api/films/2/","2":"http://swapi.co/api/people/22/"},{"1":"http://swapi.co/api/films/2/","2":"http://swapi.co/api/people/23/"},{"1":"http://swapi.co/api/films/2/","2":"http://swapi.co/api/people/24/"},{"1":"http://swapi.co/api/films/2/","2":"http://swapi.co/api/people/25/"},{"1":"http://swapi.co/api/films/2/","2":"http://swapi.co/api/people/26/"},{"1":"http://swapi.co/api/films/7/","2":"http://swapi.co/api/people/1/"},{"1":"http://swapi.co/api/films/7/","2":"http://swapi.co/api/people/3/"},{"1":"http://swapi.co/api/films/7/","2":"http://swapi.co/api/people/5/"},{"1":"http://swapi.co/api/films/7/","2":"http://swapi.co/api/people/13/"},{"1":"http://swapi.co/api/films/7/","2":"http://swapi.co/api/people/14/"},{"1":"http://swapi.co/api/films/7/","2":"http://swapi.co/api/people/27/"},{"1":"http://swapi.co/api/films/7/","2":"http://swapi.co/api/people/84/"},{"1":"http://swapi.co/api/films/7/","2":"http://swapi.co/api/people/85/"},{"1":"http://swapi.co/api/films/7/","2":"http://swapi.co/api/people/86/"},{"1":"http://swapi.co/api/films/7/","2":"http://swapi.co/api/people/87/"},{"1":"http://swapi.co/api/films/7/","2":"http://swapi.co/api/people/88/"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>Finally, after passing the prepared <code>films</code>, <code>people</code>, <code>planets</code>, and <code>films_x_characters</code> to <code>dm()</code>, a relational data model can be built by adding primary keys and foreign keys.</p>
<p>In dm, primary keys are set with <code>dm_add_pk()</code><sup>6</sup> and foreign keys with <code>dm_add_fk()</code><sup>7</sup>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1">dm_starwars_1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dm</span>(films, people, planets, films_x_characters) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb9-2">  </span>
<span id="cb9-3">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 1. Add primary keys</span></span>
<span id="cb9-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dm_add_pk</span>(films, url) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb9-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dm_add_pk</span>(people, url) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb9-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dm_add_pk</span>(planets, url) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb9-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dm_add_pk</span>(films_x_characters, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(url, characters)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb9-8">  </span>
<span id="cb9-9">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 2. Add foreign keys</span></span>
<span id="cb9-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dm_add_fk</span>(films_x_characters, url, films) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb9-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dm_add_fk</span>(films_x_characters, characters, people) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb9-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dm_add_fk</span>(people, homeworld, planets) </span>
<span id="cb9-13"></span>
<span id="cb9-14">dm_starwars_1</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>── Metadata ────────────────────────────────────────────────────────────────────
Tables: `films`, `people`, `planets`, `films_x_characters`
Columns: 10
Primary keys: 4
Foreign keys: 3</code></pre>
</div>
</div>
<p>The relational data model can be drawn using <code>dm_draw()</code>. The drawing reveals that the same relationships are built as in the image above.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dm_draw</span>(dm_starwars_1)</span></code></pre></div>
<div class="cell-output-display">
<div class="grViz html-widget html-fill-item" id="htmlwidget-8d508afbb5911858ec56" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-8d508afbb5911858ec56">{"x":{"diagram":"#data_model\ndigraph {\ngraph [rankdir=LR tooltip=\"Data Model\" ]\n\nnode [margin=0 fontcolor = \"#444444\" ]\n\nedge [color = \"#555555\", arrowsize = 1, ]\n\npack=true\npackmode= \"node\"\n\n  \"films\" [id = \"films\", label = <<TABLE ALIGN=\"LEFT\" BORDER=\"1\" CELLBORDER=\"0\" CELLSPACING=\"0\" COLOR=\"#555555\">\n    <TR>\n      <TD COLSPAN=\"1\" BGCOLOR=\"#EFEBDD\" BORDER=\"0\"><FONT COLOR=\"#000000\">films<\/FONT>\n<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"url\"><U>url<\/U><\/TD>\n    <\/TR>\n  <\/TABLE>>, shape = \"plaintext\"] \n\n  \"films_x_characters\" [id = \"films_x_characters\", label = <<TABLE ALIGN=\"LEFT\" BORDER=\"1\" CELLBORDER=\"0\" CELLSPACING=\"0\" COLOR=\"#555555\">\n    <TR>\n      <TD COLSPAN=\"1\" BGCOLOR=\"#EFEBDD\" BORDER=\"0\"><FONT COLOR=\"#000000\">films_x_characters<\/FONT>\n<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"url\">url<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"characters\">characters<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"url, characters\"><U>url, characters<\/U><\/TD>\n    <\/TR>\n  <\/TABLE>>, shape = \"plaintext\"] \n\n  \"people\" [id = \"people\", label = <<TABLE ALIGN=\"LEFT\" BORDER=\"1\" CELLBORDER=\"0\" CELLSPACING=\"0\" COLOR=\"#555555\">\n    <TR>\n      <TD COLSPAN=\"1\" BGCOLOR=\"#EFEBDD\" BORDER=\"0\"><FONT COLOR=\"#000000\">people<\/FONT>\n<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"url\"><U>url<\/U><\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"homeworld\">homeworld<\/TD>\n    <\/TR>\n  <\/TABLE>>, shape = \"plaintext\"] \n\n  \"planets\" [id = \"planets\", label = <<TABLE ALIGN=\"LEFT\" BORDER=\"1\" CELLBORDER=\"0\" CELLSPACING=\"0\" COLOR=\"#555555\">\n    <TR>\n      <TD COLSPAN=\"1\" BGCOLOR=\"#EFEBDD\" BORDER=\"0\"><FONT COLOR=\"#000000\">planets<\/FONT>\n<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"url\"><U>url<\/U><\/TD>\n    <\/TR>\n  <\/TABLE>>, shape = \"plaintext\"] \n\n\"films_x_characters\":\"url\"->\"films\":\"url\" [id=\"films_x_characters_1\"]\n\"films_x_characters\":\"characters\"->\"people\":\"url\" [id=\"films_x_characters_2\"]\n\"people\":\"homeworld\"->\"planets\":\"url\" [id=\"people_1\"]\n}","config":{"engine":null,"options":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>By using <code>dm_flatten_to_tbl()</code> as shown below, a data frame can be created by joining <code>films_x_characters</code> data with <code>films</code>/<code>people</code>/<code>planets</code> data. In this case, if the same column names exist between different data, the column names are automatically renamed according to the data names. In this way, the relational data model manages the relationships between data on our behalf, allowing us to automatically join data frames based on the relationships among other data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1">data_films_x_characters_1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> dm_starwars_1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb12-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dm_flatten_to_tbl</span>(films_x_characters,</span>
<span id="cb12-3">                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.recursive =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) </span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Renaming ambiguous columns: %&gt;%
  dm_rename(people, name.people = name) %&gt;%
  dm_rename(planets, name.planets = name)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1">data_films_x_characters_1</span></code></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["url"],"name":[1],"type":["chr"],"align":["left"]},{"label":["characters"],"name":[2],"type":["chr"],"align":["left"]},{"label":["title"],"name":[3],"type":["chr"],"align":["left"]},{"label":["name.people"],"name":[4],"type":["chr"],"align":["left"]},{"label":["homeworld"],"name":[5],"type":["chr"],"align":["left"]},{"label":["species"],"name":[6],"type":["chr"],"align":["left"]},{"label":["name.planets"],"name":[7],"type":["chr"],"align":["left"]}],"data":[{"1":"http://swapi.co/api/films/1/","2":"http://swapi.co/api/people/1/","3":"A New Hope","4":"Luke Skywalker","5":"http://swapi.co/api/planets/1/","6":"http://swapi.co/api/species/1/","7":"Tatooine"},{"1":"http://swapi.co/api/films/1/","2":"http://swapi.co/api/people/2/","3":"A New Hope","4":"C-3PO","5":"http://swapi.co/api/planets/1/","6":"http://swapi.co/api/species/2/","7":"Tatooine"},{"1":"http://swapi.co/api/films/1/","2":"http://swapi.co/api/people/3/","3":"A New Hope","4":"R2-D2","5":"http://swapi.co/api/planets/8/","6":"http://swapi.co/api/species/2/","7":"Naboo"},{"1":"http://swapi.co/api/films/1/","2":"http://swapi.co/api/people/4/","3":"A New Hope","4":"Darth Vader","5":"http://swapi.co/api/planets/1/","6":"http://swapi.co/api/species/1/","7":"Tatooine"},{"1":"http://swapi.co/api/films/1/","2":"http://swapi.co/api/people/5/","3":"A New Hope","4":"Leia Organa","5":"http://swapi.co/api/planets/2/","6":"http://swapi.co/api/species/1/","7":"Alderaan"},{"1":"http://swapi.co/api/films/1/","2":"http://swapi.co/api/people/6/","3":"A New Hope","4":"Owen Lars","5":"http://swapi.co/api/planets/1/","6":"http://swapi.co/api/species/1/","7":"Tatooine"},{"1":"http://swapi.co/api/films/1/","2":"http://swapi.co/api/people/7/","3":"A New Hope","4":"Beru Whitesun lars","5":"http://swapi.co/api/planets/1/","6":"http://swapi.co/api/species/1/","7":"Tatooine"},{"1":"http://swapi.co/api/films/1/","2":"http://swapi.co/api/people/8/","3":"A New Hope","4":"R5-D4","5":"http://swapi.co/api/planets/1/","6":"http://swapi.co/api/species/2/","7":"Tatooine"},{"1":"http://swapi.co/api/films/1/","2":"http://swapi.co/api/people/9/","3":"A New Hope","4":"Biggs Darklighter","5":"http://swapi.co/api/planets/1/","6":"http://swapi.co/api/species/1/","7":"Tatooine"},{"1":"http://swapi.co/api/films/1/","2":"http://swapi.co/api/people/10/","3":"A New Hope","4":"Obi-Wan Kenobi","5":"http://swapi.co/api/planets/20/","6":"http://swapi.co/api/species/1/","7":"Stewjon"},{"1":"http://swapi.co/api/films/1/","2":"http://swapi.co/api/people/12/","3":"A New Hope","4":"Wilhuff Tarkin","5":"http://swapi.co/api/planets/21/","6":"http://swapi.co/api/species/1/","7":"Eriadu"},{"1":"http://swapi.co/api/films/1/","2":"http://swapi.co/api/people/13/","3":"A New Hope","4":"Chewbacca","5":"http://swapi.co/api/planets/14/","6":"http://swapi.co/api/species/3/","7":"Kashyyyk"},{"1":"http://swapi.co/api/films/1/","2":"http://swapi.co/api/people/14/","3":"A New Hope","4":"Han Solo","5":"http://swapi.co/api/planets/22/","6":"http://swapi.co/api/species/1/","7":"Corellia"},{"1":"http://swapi.co/api/films/1/","2":"http://swapi.co/api/people/15/","3":"A New Hope","4":"Greedo","5":"http://swapi.co/api/planets/23/","6":"http://swapi.co/api/species/4/","7":"Rodia"},{"1":"http://swapi.co/api/films/1/","2":"http://swapi.co/api/people/16/","3":"A New Hope","4":"Jabba Desilijic Tiure","5":"http://swapi.co/api/planets/24/","6":"http://swapi.co/api/species/5/","7":"Nal Hutta"},{"1":"http://swapi.co/api/films/1/","2":"http://swapi.co/api/people/18/","3":"A New Hope","4":"Wedge Antilles","5":"http://swapi.co/api/planets/22/","6":"http://swapi.co/api/species/1/","7":"Corellia"},{"1":"http://swapi.co/api/films/1/","2":"http://swapi.co/api/people/19/","3":"A New Hope","4":"Jek Tono Porkins","5":"http://swapi.co/api/planets/26/","6":"http://swapi.co/api/species/1/","7":"Bestine IV"},{"1":"http://swapi.co/api/films/1/","2":"http://swapi.co/api/people/81/","3":"A New Hope","4":"Raymus Antilles","5":"http://swapi.co/api/planets/2/","6":"http://swapi.co/api/species/1/","7":"Alderaan"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/2/","3":"Attack of the Clones","4":"C-3PO","5":"http://swapi.co/api/planets/1/","6":"http://swapi.co/api/species/2/","7":"Tatooine"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/3/","3":"Attack of the Clones","4":"R2-D2","5":"http://swapi.co/api/planets/8/","6":"http://swapi.co/api/species/2/","7":"Naboo"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/6/","3":"Attack of the Clones","4":"Owen Lars","5":"http://swapi.co/api/planets/1/","6":"http://swapi.co/api/species/1/","7":"Tatooine"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/7/","3":"Attack of the Clones","4":"Beru Whitesun lars","5":"http://swapi.co/api/planets/1/","6":"http://swapi.co/api/species/1/","7":"Tatooine"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/10/","3":"Attack of the Clones","4":"Obi-Wan Kenobi","5":"http://swapi.co/api/planets/20/","6":"http://swapi.co/api/species/1/","7":"Stewjon"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/11/","3":"Attack of the Clones","4":"Anakin Skywalker","5":"http://swapi.co/api/planets/1/","6":"http://swapi.co/api/species/1/","7":"Tatooine"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/20/","3":"Attack of the Clones","4":"Yoda","5":"http://swapi.co/api/planets/28/","6":"http://swapi.co/api/species/6/","7":"unknown"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/21/","3":"Attack of the Clones","4":"Palpatine","5":"http://swapi.co/api/planets/8/","6":"http://swapi.co/api/species/1/","7":"Naboo"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/22/","3":"Attack of the Clones","4":"Boba Fett","5":"http://swapi.co/api/planets/10/","6":"http://swapi.co/api/species/1/","7":"Kamino"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/33/","3":"Attack of the Clones","4":"Nute Gunray","5":"http://swapi.co/api/planets/18/","6":"http://swapi.co/api/species/11/","7":"Cato Neimoidia"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/36/","3":"Attack of the Clones","4":"Jar Jar Binks","5":"http://swapi.co/api/planets/8/","6":"http://swapi.co/api/species/12/","7":"Naboo"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/40/","3":"Attack of the Clones","4":"Watto","5":"http://swapi.co/api/planets/34/","6":"http://swapi.co/api/species/13/","7":"Toydaria"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/43/","3":"Attack of the Clones","4":"Shmi Skywalker","5":"http://swapi.co/api/planets/1/","6":"http://swapi.co/api/species/1/","7":"Tatooine"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/46/","3":"Attack of the Clones","4":"Ayla Secura","5":"http://swapi.co/api/planets/37/","6":"http://swapi.co/api/species/15/","7":"Ryloth"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/51/","3":"Attack of the Clones","4":"Mace Windu","5":"http://swapi.co/api/planets/42/","6":"http://swapi.co/api/species/1/","7":"Haruun Kal"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/52/","3":"Attack of the Clones","4":"Ki-Adi-Mundi","5":"http://swapi.co/api/planets/43/","6":"http://swapi.co/api/species/20/","7":"Cerea"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/53/","3":"Attack of the Clones","4":"Kit Fisto","5":"http://swapi.co/api/planets/44/","6":"http://swapi.co/api/species/21/","7":"Glee Anselm"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/58/","3":"Attack of the Clones","4":"Plo Koon","5":"http://swapi.co/api/planets/49/","6":"http://swapi.co/api/species/26/","7":"Dorin"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/59/","3":"Attack of the Clones","4":"Mas Amedda","5":"http://swapi.co/api/planets/50/","6":"http://swapi.co/api/species/27/","7":"Champala"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/60/","3":"Attack of the Clones","4":"Gregar Typho","5":"http://swapi.co/api/planets/8/","6":"http://swapi.co/api/species/1/","7":"Naboo"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/61/","3":"Attack of the Clones","4":"Cordé","5":"http://swapi.co/api/planets/8/","6":"http://swapi.co/api/species/1/","7":"Naboo"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/62/","3":"Attack of the Clones","4":"Cliegg Lars","5":"http://swapi.co/api/planets/1/","6":"http://swapi.co/api/species/1/","7":"Tatooine"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/63/","3":"Attack of the Clones","4":"Poggle the Lesser","5":"http://swapi.co/api/planets/11/","6":"http://swapi.co/api/species/28/","7":"Geonosis"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/64/","3":"Attack of the Clones","4":"Luminara Unduli","5":"http://swapi.co/api/planets/51/","6":"http://swapi.co/api/species/29/","7":"Mirial"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/65/","3":"Attack of the Clones","4":"Barriss Offee","5":"http://swapi.co/api/planets/51/","6":"http://swapi.co/api/species/29/","7":"Mirial"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/66/","3":"Attack of the Clones","4":"Dormé","5":"http://swapi.co/api/planets/8/","6":"http://swapi.co/api/species/1/","7":"Naboo"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/67/","3":"Attack of the Clones","4":"Dooku","5":"http://swapi.co/api/planets/52/","6":"http://swapi.co/api/species/1/","7":"Serenno"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/68/","3":"Attack of the Clones","4":"Bail Prestor Organa","5":"http://swapi.co/api/planets/2/","6":"http://swapi.co/api/species/1/","7":"Alderaan"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/69/","3":"Attack of the Clones","4":"Jango Fett","5":"http://swapi.co/api/planets/53/","6":"http://swapi.co/api/species/1/","7":"Concord Dawn"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/70/","3":"Attack of the Clones","4":"Zam Wesell","5":"http://swapi.co/api/planets/54/","6":"http://swapi.co/api/species/30/","7":"Zolan"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/71/","3":"Attack of the Clones","4":"Dexter Jettster","5":"http://swapi.co/api/planets/55/","6":"http://swapi.co/api/species/31/","7":"Ojom"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/72/","3":"Attack of the Clones","4":"Lama Su","5":"http://swapi.co/api/planets/10/","6":"http://swapi.co/api/species/32/","7":"Kamino"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/73/","3":"Attack of the Clones","4":"Taun We","5":"http://swapi.co/api/planets/10/","6":"http://swapi.co/api/species/32/","7":"Kamino"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/74/","3":"Attack of the Clones","4":"Jocasta Nu","5":"http://swapi.co/api/planets/9/","6":"http://swapi.co/api/species/1/","7":"Coruscant"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/75/","3":"Attack of the Clones","4":"R4-P17","5":"http://swapi.co/api/planets/28/","6":"NA","7":"unknown"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/76/","3":"Attack of the Clones","4":"Wat Tambor","5":"http://swapi.co/api/planets/56/","6":"http://swapi.co/api/species/33/","7":"Skako"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/77/","3":"Attack of the Clones","4":"San Hill","5":"http://swapi.co/api/planets/57/","6":"http://swapi.co/api/species/34/","7":"Muunilinst"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/78/","3":"Attack of the Clones","4":"Shaak Ti","5":"http://swapi.co/api/planets/58/","6":"http://swapi.co/api/species/35/","7":"Shili"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/82/","3":"Attack of the Clones","4":"Sly Moore","5":"http://swapi.co/api/planets/60/","6":"NA","7":"Umbara"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/35/","3":"Attack of the Clones","4":"Padmé Amidala","5":"http://swapi.co/api/planets/8/","6":"http://swapi.co/api/species/1/","7":"Naboo"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/2/","3":"The Phantom Menace","4":"C-3PO","5":"http://swapi.co/api/planets/1/","6":"http://swapi.co/api/species/2/","7":"Tatooine"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/3/","3":"The Phantom Menace","4":"R2-D2","5":"http://swapi.co/api/planets/8/","6":"http://swapi.co/api/species/2/","7":"Naboo"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/10/","3":"The Phantom Menace","4":"Obi-Wan Kenobi","5":"http://swapi.co/api/planets/20/","6":"http://swapi.co/api/species/1/","7":"Stewjon"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/11/","3":"The Phantom Menace","4":"Anakin Skywalker","5":"http://swapi.co/api/planets/1/","6":"http://swapi.co/api/species/1/","7":"Tatooine"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/16/","3":"The Phantom Menace","4":"Jabba Desilijic Tiure","5":"http://swapi.co/api/planets/24/","6":"http://swapi.co/api/species/5/","7":"Nal Hutta"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/20/","3":"The Phantom Menace","4":"Yoda","5":"http://swapi.co/api/planets/28/","6":"http://swapi.co/api/species/6/","7":"unknown"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/21/","3":"The Phantom Menace","4":"Palpatine","5":"http://swapi.co/api/planets/8/","6":"http://swapi.co/api/species/1/","7":"Naboo"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/32/","3":"The Phantom Menace","4":"Qui-Gon Jinn","5":"http://swapi.co/api/planets/28/","6":"http://swapi.co/api/species/1/","7":"unknown"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/33/","3":"The Phantom Menace","4":"Nute Gunray","5":"http://swapi.co/api/planets/18/","6":"http://swapi.co/api/species/11/","7":"Cato Neimoidia"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/34/","3":"The Phantom Menace","4":"Finis Valorum","5":"http://swapi.co/api/planets/9/","6":"http://swapi.co/api/species/1/","7":"Coruscant"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/36/","3":"The Phantom Menace","4":"Jar Jar Binks","5":"http://swapi.co/api/planets/8/","6":"http://swapi.co/api/species/12/","7":"Naboo"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/37/","3":"The Phantom Menace","4":"Roos Tarpals","5":"http://swapi.co/api/planets/8/","6":"http://swapi.co/api/species/12/","7":"Naboo"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/38/","3":"The Phantom Menace","4":"Rugor Nass","5":"http://swapi.co/api/planets/8/","6":"http://swapi.co/api/species/12/","7":"Naboo"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/39/","3":"The Phantom Menace","4":"Ric Olié","5":"http://swapi.co/api/planets/8/","6":"NA","7":"Naboo"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/40/","3":"The Phantom Menace","4":"Watto","5":"http://swapi.co/api/planets/34/","6":"http://swapi.co/api/species/13/","7":"Toydaria"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/41/","3":"The Phantom Menace","4":"Sebulba","5":"http://swapi.co/api/planets/35/","6":"http://swapi.co/api/species/14/","7":"Malastare"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/42/","3":"The Phantom Menace","4":"Quarsh Panaka","5":"http://swapi.co/api/planets/8/","6":"NA","7":"Naboo"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/43/","3":"The Phantom Menace","4":"Shmi Skywalker","5":"http://swapi.co/api/planets/1/","6":"http://swapi.co/api/species/1/","7":"Tatooine"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/44/","3":"The Phantom Menace","4":"Darth Maul","5":"http://swapi.co/api/planets/36/","6":"http://swapi.co/api/species/22/","7":"Dathomir"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/46/","3":"The Phantom Menace","4":"Ayla Secura","5":"http://swapi.co/api/planets/37/","6":"http://swapi.co/api/species/15/","7":"Ryloth"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/48/","3":"The Phantom Menace","4":"Dud Bolt","5":"http://swapi.co/api/planets/39/","6":"http://swapi.co/api/species/17/","7":"Vulpter"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/49/","3":"The Phantom Menace","4":"Gasgano","5":"http://swapi.co/api/planets/40/","6":"http://swapi.co/api/species/18/","7":"Troiken"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/50/","3":"The Phantom Menace","4":"Ben Quadinaros","5":"http://swapi.co/api/planets/41/","6":"http://swapi.co/api/species/19/","7":"Tund"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/51/","3":"The Phantom Menace","4":"Mace Windu","5":"http://swapi.co/api/planets/42/","6":"http://swapi.co/api/species/1/","7":"Haruun Kal"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/52/","3":"The Phantom Menace","4":"Ki-Adi-Mundi","5":"http://swapi.co/api/planets/43/","6":"http://swapi.co/api/species/20/","7":"Cerea"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/53/","3":"The Phantom Menace","4":"Kit Fisto","5":"http://swapi.co/api/planets/44/","6":"http://swapi.co/api/species/21/","7":"Glee Anselm"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/54/","3":"The Phantom Menace","4":"Eeth Koth","5":"http://swapi.co/api/planets/45/","6":"http://swapi.co/api/species/22/","7":"Iridonia"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/55/","3":"The Phantom Menace","4":"Adi Gallia","5":"http://swapi.co/api/planets/9/","6":"http://swapi.co/api/species/23/","7":"Coruscant"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/56/","3":"The Phantom Menace","4":"Saesee Tiin","5":"http://swapi.co/api/planets/47/","6":"http://swapi.co/api/species/24/","7":"Iktotch"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/57/","3":"The Phantom Menace","4":"Yarael Poof","5":"http://swapi.co/api/planets/48/","6":"http://swapi.co/api/species/25/","7":"Quermia"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/58/","3":"The Phantom Menace","4":"Plo Koon","5":"http://swapi.co/api/planets/49/","6":"http://swapi.co/api/species/26/","7":"Dorin"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/59/","3":"The Phantom Menace","4":"Mas Amedda","5":"http://swapi.co/api/planets/50/","6":"http://swapi.co/api/species/27/","7":"Champala"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/47/","3":"The Phantom Menace","4":"Ratts Tyerell","5":"http://swapi.co/api/planets/38/","6":"http://swapi.co/api/species/16/","7":"Aleen Minor"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/35/","3":"The Phantom Menace","4":"Padmé Amidala","5":"http://swapi.co/api/planets/8/","6":"http://swapi.co/api/species/1/","7":"Naboo"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/1/","3":"Revenge of the Sith","4":"Luke Skywalker","5":"http://swapi.co/api/planets/1/","6":"http://swapi.co/api/species/1/","7":"Tatooine"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/2/","3":"Revenge of the Sith","4":"C-3PO","5":"http://swapi.co/api/planets/1/","6":"http://swapi.co/api/species/2/","7":"Tatooine"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/3/","3":"Revenge of the Sith","4":"R2-D2","5":"http://swapi.co/api/planets/8/","6":"http://swapi.co/api/species/2/","7":"Naboo"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/4/","3":"Revenge of the Sith","4":"Darth Vader","5":"http://swapi.co/api/planets/1/","6":"http://swapi.co/api/species/1/","7":"Tatooine"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/5/","3":"Revenge of the Sith","4":"Leia Organa","5":"http://swapi.co/api/planets/2/","6":"http://swapi.co/api/species/1/","7":"Alderaan"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/6/","3":"Revenge of the Sith","4":"Owen Lars","5":"http://swapi.co/api/planets/1/","6":"http://swapi.co/api/species/1/","7":"Tatooine"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/7/","3":"Revenge of the Sith","4":"Beru Whitesun lars","5":"http://swapi.co/api/planets/1/","6":"http://swapi.co/api/species/1/","7":"Tatooine"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/10/","3":"Revenge of the Sith","4":"Obi-Wan Kenobi","5":"http://swapi.co/api/planets/20/","6":"http://swapi.co/api/species/1/","7":"Stewjon"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/11/","3":"Revenge of the Sith","4":"Anakin Skywalker","5":"http://swapi.co/api/planets/1/","6":"http://swapi.co/api/species/1/","7":"Tatooine"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/12/","3":"Revenge of the Sith","4":"Wilhuff Tarkin","5":"http://swapi.co/api/planets/21/","6":"http://swapi.co/api/species/1/","7":"Eriadu"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/13/","3":"Revenge of the Sith","4":"Chewbacca","5":"http://swapi.co/api/planets/14/","6":"http://swapi.co/api/species/3/","7":"Kashyyyk"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/20/","3":"Revenge of the Sith","4":"Yoda","5":"http://swapi.co/api/planets/28/","6":"http://swapi.co/api/species/6/","7":"unknown"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/21/","3":"Revenge of the Sith","4":"Palpatine","5":"http://swapi.co/api/planets/8/","6":"http://swapi.co/api/species/1/","7":"Naboo"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/33/","3":"Revenge of the Sith","4":"Nute Gunray","5":"http://swapi.co/api/planets/18/","6":"http://swapi.co/api/species/11/","7":"Cato Neimoidia"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/46/","3":"Revenge of the Sith","4":"Ayla Secura","5":"http://swapi.co/api/planets/37/","6":"http://swapi.co/api/species/15/","7":"Ryloth"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/51/","3":"Revenge of the Sith","4":"Mace Windu","5":"http://swapi.co/api/planets/42/","6":"http://swapi.co/api/species/1/","7":"Haruun Kal"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/52/","3":"Revenge of the Sith","4":"Ki-Adi-Mundi","5":"http://swapi.co/api/planets/43/","6":"http://swapi.co/api/species/20/","7":"Cerea"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/53/","3":"Revenge of the Sith","4":"Kit Fisto","5":"http://swapi.co/api/planets/44/","6":"http://swapi.co/api/species/21/","7":"Glee Anselm"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/54/","3":"Revenge of the Sith","4":"Eeth Koth","5":"http://swapi.co/api/planets/45/","6":"http://swapi.co/api/species/22/","7":"Iridonia"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/55/","3":"Revenge of the Sith","4":"Adi Gallia","5":"http://swapi.co/api/planets/9/","6":"http://swapi.co/api/species/23/","7":"Coruscant"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/56/","3":"Revenge of the Sith","4":"Saesee Tiin","5":"http://swapi.co/api/planets/47/","6":"http://swapi.co/api/species/24/","7":"Iktotch"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/58/","3":"Revenge of the Sith","4":"Plo Koon","5":"http://swapi.co/api/planets/49/","6":"http://swapi.co/api/species/26/","7":"Dorin"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/63/","3":"Revenge of the Sith","4":"Poggle the Lesser","5":"http://swapi.co/api/planets/11/","6":"http://swapi.co/api/species/28/","7":"Geonosis"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/64/","3":"Revenge of the Sith","4":"Luminara Unduli","5":"http://swapi.co/api/planets/51/","6":"http://swapi.co/api/species/29/","7":"Mirial"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/67/","3":"Revenge of the Sith","4":"Dooku","5":"http://swapi.co/api/planets/52/","6":"http://swapi.co/api/species/1/","7":"Serenno"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/68/","3":"Revenge of the Sith","4":"Bail Prestor Organa","5":"http://swapi.co/api/planets/2/","6":"http://swapi.co/api/species/1/","7":"Alderaan"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/75/","3":"Revenge of the Sith","4":"R4-P17","5":"http://swapi.co/api/planets/28/","6":"NA","7":"unknown"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/78/","3":"Revenge of the Sith","4":"Shaak Ti","5":"http://swapi.co/api/planets/58/","6":"http://swapi.co/api/species/35/","7":"Shili"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/79/","3":"Revenge of the Sith","4":"Grievous","5":"http://swapi.co/api/planets/59/","6":"http://swapi.co/api/species/36/","7":"Kalee"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/80/","3":"Revenge of the Sith","4":"Tarfful","5":"http://swapi.co/api/planets/14/","6":"http://swapi.co/api/species/3/","7":"Kashyyyk"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/81/","3":"Revenge of the Sith","4":"Raymus Antilles","5":"http://swapi.co/api/planets/2/","6":"http://swapi.co/api/species/1/","7":"Alderaan"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/82/","3":"Revenge of the Sith","4":"Sly Moore","5":"http://swapi.co/api/planets/60/","6":"NA","7":"Umbara"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/83/","3":"Revenge of the Sith","4":"Tion Medon","5":"http://swapi.co/api/planets/12/","6":"http://swapi.co/api/species/37/","7":"Utapau"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/35/","3":"Revenge of the Sith","4":"Padmé Amidala","5":"http://swapi.co/api/planets/8/","6":"http://swapi.co/api/species/1/","7":"Naboo"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/1/","3":"Return of the Jedi","4":"Luke Skywalker","5":"http://swapi.co/api/planets/1/","6":"http://swapi.co/api/species/1/","7":"Tatooine"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/2/","3":"Return of the Jedi","4":"C-3PO","5":"http://swapi.co/api/planets/1/","6":"http://swapi.co/api/species/2/","7":"Tatooine"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/3/","3":"Return of the Jedi","4":"R2-D2","5":"http://swapi.co/api/planets/8/","6":"http://swapi.co/api/species/2/","7":"Naboo"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/4/","3":"Return of the Jedi","4":"Darth Vader","5":"http://swapi.co/api/planets/1/","6":"http://swapi.co/api/species/1/","7":"Tatooine"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/5/","3":"Return of the Jedi","4":"Leia Organa","5":"http://swapi.co/api/planets/2/","6":"http://swapi.co/api/species/1/","7":"Alderaan"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/10/","3":"Return of the Jedi","4":"Obi-Wan Kenobi","5":"http://swapi.co/api/planets/20/","6":"http://swapi.co/api/species/1/","7":"Stewjon"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/13/","3":"Return of the Jedi","4":"Chewbacca","5":"http://swapi.co/api/planets/14/","6":"http://swapi.co/api/species/3/","7":"Kashyyyk"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/14/","3":"Return of the Jedi","4":"Han Solo","5":"http://swapi.co/api/planets/22/","6":"http://swapi.co/api/species/1/","7":"Corellia"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/16/","3":"Return of the Jedi","4":"Jabba Desilijic Tiure","5":"http://swapi.co/api/planets/24/","6":"http://swapi.co/api/species/5/","7":"Nal Hutta"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/18/","3":"Return of the Jedi","4":"Wedge Antilles","5":"http://swapi.co/api/planets/22/","6":"http://swapi.co/api/species/1/","7":"Corellia"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/20/","3":"Return of the Jedi","4":"Yoda","5":"http://swapi.co/api/planets/28/","6":"http://swapi.co/api/species/6/","7":"unknown"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/21/","3":"Return of the Jedi","4":"Palpatine","5":"http://swapi.co/api/planets/8/","6":"http://swapi.co/api/species/1/","7":"Naboo"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/22/","3":"Return of the Jedi","4":"Boba Fett","5":"http://swapi.co/api/planets/10/","6":"http://swapi.co/api/species/1/","7":"Kamino"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/25/","3":"Return of the Jedi","4":"Lando Calrissian","5":"http://swapi.co/api/planets/30/","6":"http://swapi.co/api/species/1/","7":"Socorro"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/27/","3":"Return of the Jedi","4":"Ackbar","5":"http://swapi.co/api/planets/31/","6":"http://swapi.co/api/species/8/","7":"Mon Cala"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/28/","3":"Return of the Jedi","4":"Mon Mothma","5":"http://swapi.co/api/planets/32/","6":"http://swapi.co/api/species/1/","7":"Chandrila"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/29/","3":"Return of the Jedi","4":"Arvel Crynyd","5":"http://swapi.co/api/planets/28/","6":"http://swapi.co/api/species/1/","7":"unknown"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/30/","3":"Return of the Jedi","4":"Wicket Systri Warrick","5":"http://swapi.co/api/planets/7/","6":"http://swapi.co/api/species/9/","7":"Endor"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/31/","3":"Return of the Jedi","4":"Nien Nunb","5":"http://swapi.co/api/planets/33/","6":"http://swapi.co/api/species/10/","7":"Sullust"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/45/","3":"Return of the Jedi","4":"Bib Fortuna","5":"http://swapi.co/api/planets/37/","6":"http://swapi.co/api/species/15/","7":"Ryloth"},{"1":"http://swapi.co/api/films/2/","2":"http://swapi.co/api/people/1/","3":"The Empire Strikes Back","4":"Luke Skywalker","5":"http://swapi.co/api/planets/1/","6":"http://swapi.co/api/species/1/","7":"Tatooine"},{"1":"http://swapi.co/api/films/2/","2":"http://swapi.co/api/people/2/","3":"The Empire Strikes Back","4":"C-3PO","5":"http://swapi.co/api/planets/1/","6":"http://swapi.co/api/species/2/","7":"Tatooine"},{"1":"http://swapi.co/api/films/2/","2":"http://swapi.co/api/people/3/","3":"The Empire Strikes Back","4":"R2-D2","5":"http://swapi.co/api/planets/8/","6":"http://swapi.co/api/species/2/","7":"Naboo"},{"1":"http://swapi.co/api/films/2/","2":"http://swapi.co/api/people/4/","3":"The Empire Strikes Back","4":"Darth Vader","5":"http://swapi.co/api/planets/1/","6":"http://swapi.co/api/species/1/","7":"Tatooine"},{"1":"http://swapi.co/api/films/2/","2":"http://swapi.co/api/people/5/","3":"The Empire Strikes Back","4":"Leia Organa","5":"http://swapi.co/api/planets/2/","6":"http://swapi.co/api/species/1/","7":"Alderaan"},{"1":"http://swapi.co/api/films/2/","2":"http://swapi.co/api/people/10/","3":"The Empire Strikes Back","4":"Obi-Wan Kenobi","5":"http://swapi.co/api/planets/20/","6":"http://swapi.co/api/species/1/","7":"Stewjon"},{"1":"http://swapi.co/api/films/2/","2":"http://swapi.co/api/people/13/","3":"The Empire Strikes Back","4":"Chewbacca","5":"http://swapi.co/api/planets/14/","6":"http://swapi.co/api/species/3/","7":"Kashyyyk"},{"1":"http://swapi.co/api/films/2/","2":"http://swapi.co/api/people/14/","3":"The Empire Strikes Back","4":"Han Solo","5":"http://swapi.co/api/planets/22/","6":"http://swapi.co/api/species/1/","7":"Corellia"},{"1":"http://swapi.co/api/films/2/","2":"http://swapi.co/api/people/18/","3":"The Empire Strikes Back","4":"Wedge Antilles","5":"http://swapi.co/api/planets/22/","6":"http://swapi.co/api/species/1/","7":"Corellia"},{"1":"http://swapi.co/api/films/2/","2":"http://swapi.co/api/people/20/","3":"The Empire Strikes Back","4":"Yoda","5":"http://swapi.co/api/planets/28/","6":"http://swapi.co/api/species/6/","7":"unknown"},{"1":"http://swapi.co/api/films/2/","2":"http://swapi.co/api/people/21/","3":"The Empire Strikes Back","4":"Palpatine","5":"http://swapi.co/api/planets/8/","6":"http://swapi.co/api/species/1/","7":"Naboo"},{"1":"http://swapi.co/api/films/2/","2":"http://swapi.co/api/people/22/","3":"The Empire Strikes Back","4":"Boba Fett","5":"http://swapi.co/api/planets/10/","6":"http://swapi.co/api/species/1/","7":"Kamino"},{"1":"http://swapi.co/api/films/2/","2":"http://swapi.co/api/people/23/","3":"The Empire Strikes Back","4":"IG-88","5":"http://swapi.co/api/planets/28/","6":"http://swapi.co/api/species/2/","7":"unknown"},{"1":"http://swapi.co/api/films/2/","2":"http://swapi.co/api/people/24/","3":"The Empire Strikes Back","4":"Bossk","5":"http://swapi.co/api/planets/29/","6":"http://swapi.co/api/species/7/","7":"Trandosha"},{"1":"http://swapi.co/api/films/2/","2":"http://swapi.co/api/people/25/","3":"The Empire Strikes Back","4":"Lando Calrissian","5":"http://swapi.co/api/planets/30/","6":"http://swapi.co/api/species/1/","7":"Socorro"},{"1":"http://swapi.co/api/films/2/","2":"http://swapi.co/api/people/26/","3":"The Empire Strikes Back","4":"Lobot","5":"http://swapi.co/api/planets/6/","6":"http://swapi.co/api/species/1/","7":"Bespin"},{"1":"http://swapi.co/api/films/7/","2":"http://swapi.co/api/people/1/","3":"The Force Awakens","4":"Luke Skywalker","5":"http://swapi.co/api/planets/1/","6":"http://swapi.co/api/species/1/","7":"Tatooine"},{"1":"http://swapi.co/api/films/7/","2":"http://swapi.co/api/people/3/","3":"The Force Awakens","4":"R2-D2","5":"http://swapi.co/api/planets/8/","6":"http://swapi.co/api/species/2/","7":"Naboo"},{"1":"http://swapi.co/api/films/7/","2":"http://swapi.co/api/people/5/","3":"The Force Awakens","4":"Leia Organa","5":"http://swapi.co/api/planets/2/","6":"http://swapi.co/api/species/1/","7":"Alderaan"},{"1":"http://swapi.co/api/films/7/","2":"http://swapi.co/api/people/13/","3":"The Force Awakens","4":"Chewbacca","5":"http://swapi.co/api/planets/14/","6":"http://swapi.co/api/species/3/","7":"Kashyyyk"},{"1":"http://swapi.co/api/films/7/","2":"http://swapi.co/api/people/14/","3":"The Force Awakens","4":"Han Solo","5":"http://swapi.co/api/planets/22/","6":"http://swapi.co/api/species/1/","7":"Corellia"},{"1":"http://swapi.co/api/films/7/","2":"http://swapi.co/api/people/27/","3":"The Force Awakens","4":"Ackbar","5":"http://swapi.co/api/planets/31/","6":"http://swapi.co/api/species/8/","7":"Mon Cala"},{"1":"http://swapi.co/api/films/7/","2":"http://swapi.co/api/people/84/","3":"The Force Awakens","4":"Finn","5":"http://swapi.co/api/planets/28/","6":"http://swapi.co/api/species/1/","7":"unknown"},{"1":"http://swapi.co/api/films/7/","2":"http://swapi.co/api/people/85/","3":"The Force Awakens","4":"Rey","5":"http://swapi.co/api/planets/28/","6":"http://swapi.co/api/species/1/","7":"unknown"},{"1":"http://swapi.co/api/films/7/","2":"http://swapi.co/api/people/86/","3":"The Force Awakens","4":"Poe Dameron","5":"http://swapi.co/api/planets/28/","6":"http://swapi.co/api/species/1/","7":"unknown"},{"1":"http://swapi.co/api/films/7/","2":"http://swapi.co/api/people/87/","3":"The Force Awakens","4":"BB8","5":"http://swapi.co/api/planets/28/","6":"http://swapi.co/api/species/2/","7":"unknown"},{"1":"http://swapi.co/api/films/7/","2":"http://swapi.co/api/people/88/","3":"The Force Awakens","4":"Captain Phasma","5":"http://swapi.co/api/planets/28/","6":"NA","7":"unknown"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>The <code>data_films_x_characters_1</code> can be used to plot the composition ratio of the characters’ home planets, as shown below. We will not discuss this plot further. However, we have confirmed that the relational data model can be used to automate the joining of data frames.</p>
<p>In the above analysis, it is easy to join data frames using <code>left_join()</code>, and you may not see the advantage of using a relational data model. In the application section, we will consider a more complex situation where a relational data model prevails.</p>
<div class="cell">
<details class="code-fold">
<summary>Plot of the composition of the characters’ home planets</summary>
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1">data_films_x_characters_1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb15-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">name.planets =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_lump_n</span>(name.planets, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>,</span>
<span id="cb15-3">                                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ties.method =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"first"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb15-4">           <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_relevel</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Other"</span>, </span>
<span id="cb15-5">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">after =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">Inf</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb15-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">count</span>(title, name.planets) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb15-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prop =</span> n <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(n),</span>
<span id="cb15-8">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.by =</span> title,</span>
<span id="cb15-9">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.keep =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"unused"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb15-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_rev</span>(title), prop,</span>
<span id="cb15-11">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> name.planets)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_col</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">position =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">position_stack</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">reverse =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_text</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">if_else</span>(prop <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5e-2</span>, </span>
<span id="cb15-14">                                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>,</span>
<span id="cb15-15">                                scales<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">label_percent</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">accuracy =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)(prop))),</span>
<span id="cb15-16">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">position =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">position_stack</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">vjust =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>,</span>
<span id="cb15-17">                                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">reverse =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_discrete</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Title"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_y_continuous</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Composition of the characters' home planets"</span>,</span>
<span id="cb15-20">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> scales<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>percent) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_brewer</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Planet Name"</span>,</span>
<span id="cb15-22">                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">palette =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Set2"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-23">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_flip</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-24">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bottom"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-25">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guides</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guide_legend</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,</span>
<span id="cb15-26">                             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">byrow =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>))</span></code></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://uchidamizuki.quarto.pub/blog/posts/2024/01/relational-data-models-with-r-s-dm-en_files/figure-html/plot-starwars-1-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="application-extending-the-model-and-validating-keys-with-dm" class="level3">
<h3 class="anchored" data-anchor-id="application-extending-the-model-and-validating-keys-with-dm">2. Application: Extending the model and validating keys with dm</h3>
<p>In the application, we will examine the composition ratio of the species of the characters in Star Wars movies. The difficulty level of this analysis is not much different from that of the basic analysis. However, as the amount of data to be handled increases, the code tends to become more complicated, and the advantages of using a relational data model are significant. In addition, the advantages of the relational data model include the following,</p>
<ul>
<li>New data can be added to the existing relational data model</li>
<li>Possible to check key constraints defined to join data frames</li>
</ul>
<p>We prepare in advance the <code>species</code> data needed for this analysis.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1">species <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">species =</span> sw_species) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb16-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unnest_wider</span>(species) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb16-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(url, name)</span>
<span id="cb16-4"></span>
<span id="cb16-5">species</span></code></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["url"],"name":[1],"type":["chr"],"align":["left"]},{"label":["name"],"name":[2],"type":["chr"],"align":["left"]}],"data":[{"1":"http://swapi.co/api/species/5/","2":"Hutt"},{"1":"http://swapi.co/api/species/6/","2":"Yoda's species"},{"1":"http://swapi.co/api/species/7/","2":"Trandoshan"},{"1":"http://swapi.co/api/species/8/","2":"Mon Calamari"},{"1":"http://swapi.co/api/species/9/","2":"Ewok"},{"1":"http://swapi.co/api/species/10/","2":"Sullustan"},{"1":"http://swapi.co/api/species/11/","2":"Neimodian"},{"1":"http://swapi.co/api/species/12/","2":"Gungan"},{"1":"http://swapi.co/api/species/13/","2":"Toydarian"},{"1":"http://swapi.co/api/species/14/","2":"Dug"},{"1":"http://swapi.co/api/species/15/","2":"Twi'lek"},{"1":"http://swapi.co/api/species/16/","2":"Aleena"},{"1":"http://swapi.co/api/species/17/","2":"Vulptereen"},{"1":"http://swapi.co/api/species/18/","2":"Xexto"},{"1":"http://swapi.co/api/species/19/","2":"Toong"},{"1":"http://swapi.co/api/species/20/","2":"Cerean"},{"1":"http://swapi.co/api/species/21/","2":"Nautolan"},{"1":"http://swapi.co/api/species/22/","2":"Zabrak"},{"1":"http://swapi.co/api/species/23/","2":"Tholothian"},{"1":"http://swapi.co/api/species/24/","2":"Iktotchi"},{"1":"http://swapi.co/api/species/25/","2":"Quermian"},{"1":"http://swapi.co/api/species/26/","2":"Kel Dor"},{"1":"http://swapi.co/api/species/27/","2":"Chagrian"},{"1":"http://swapi.co/api/species/28/","2":"Geonosian"},{"1":"http://swapi.co/api/species/29/","2":"Mirialan"},{"1":"http://swapi.co/api/species/30/","2":"Clawdite"},{"1":"http://swapi.co/api/species/31/","2":"Besalisk"},{"1":"http://swapi.co/api/species/32/","2":"Kaminoan"},{"1":"http://swapi.co/api/species/33/","2":"Skakoan"},{"1":"http://swapi.co/api/species/34/","2":"Muun"},{"1":"http://swapi.co/api/species/35/","2":"Togruta"},{"1":"http://swapi.co/api/species/36/","2":"Kaleesh"},{"1":"http://swapi.co/api/species/37/","2":"Pau'an"},{"1":"http://swapi.co/api/species/3/","2":"Wookiee"},{"1":"http://swapi.co/api/species/2/","2":"Droid"},{"1":"http://swapi.co/api/species/1/","2":"Human"},{"1":"http://swapi.co/api/species/4/","2":"Rodian"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>In dm, we can add new data to the relational data model using <code>dm()</code>. In this example, let’s build <code>dm_starwars_2</code> by adding the <code>species</code> data to <code>dm_starwars_1</code>. By using <code>dm_draw()</code>, we can see that the model has been updated.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1">dm_starwars_2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> dm_starwars_1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb17-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dm</span>(species) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb17-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dm_add_pk</span>(species, url) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb17-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dm_add_fk</span>(people, species, species)</span>
<span id="cb17-5"></span>
<span id="cb17-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dm_draw</span>(dm_starwars_2)</span></code></pre></div>
<div class="cell-output-display">
<div class="grViz html-widget html-fill-item" id="htmlwidget-d5c6320d67aa1865f6ac" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-d5c6320d67aa1865f6ac">{"x":{"diagram":"#data_model\ndigraph {\ngraph [rankdir=LR tooltip=\"Data Model\" ]\n\nnode [margin=0 fontcolor = \"#444444\" ]\n\nedge [color = \"#555555\", arrowsize = 1, ]\n\npack=true\npackmode= \"node\"\n\n  \"films\" [id = \"films\", label = <<TABLE ALIGN=\"LEFT\" BORDER=\"1\" CELLBORDER=\"0\" CELLSPACING=\"0\" COLOR=\"#555555\">\n    <TR>\n      <TD COLSPAN=\"1\" BGCOLOR=\"#EFEBDD\" BORDER=\"0\"><FONT COLOR=\"#000000\">films<\/FONT>\n<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"url\"><U>url<\/U><\/TD>\n    <\/TR>\n  <\/TABLE>>, shape = \"plaintext\"] \n\n  \"films_x_characters\" [id = \"films_x_characters\", label = <<TABLE ALIGN=\"LEFT\" BORDER=\"1\" CELLBORDER=\"0\" CELLSPACING=\"0\" COLOR=\"#555555\">\n    <TR>\n      <TD COLSPAN=\"1\" BGCOLOR=\"#EFEBDD\" BORDER=\"0\"><FONT COLOR=\"#000000\">films_x_characters<\/FONT>\n<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"url\">url<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"characters\">characters<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"url, characters\"><U>url, characters<\/U><\/TD>\n    <\/TR>\n  <\/TABLE>>, shape = \"plaintext\"] \n\n  \"people\" [id = \"people\", label = <<TABLE ALIGN=\"LEFT\" BORDER=\"1\" CELLBORDER=\"0\" CELLSPACING=\"0\" COLOR=\"#555555\">\n    <TR>\n      <TD COLSPAN=\"1\" BGCOLOR=\"#EFEBDD\" BORDER=\"0\"><FONT COLOR=\"#000000\">people<\/FONT>\n<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"url\"><U>url<\/U><\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"homeworld\">homeworld<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"species\">species<\/TD>\n    <\/TR>\n  <\/TABLE>>, shape = \"plaintext\"] \n\n  \"planets\" [id = \"planets\", label = <<TABLE ALIGN=\"LEFT\" BORDER=\"1\" CELLBORDER=\"0\" CELLSPACING=\"0\" COLOR=\"#555555\">\n    <TR>\n      <TD COLSPAN=\"1\" BGCOLOR=\"#EFEBDD\" BORDER=\"0\"><FONT COLOR=\"#000000\">planets<\/FONT>\n<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"url\"><U>url<\/U><\/TD>\n    <\/TR>\n  <\/TABLE>>, shape = \"plaintext\"] \n\n  \"species\" [id = \"species\", label = <<TABLE ALIGN=\"LEFT\" BORDER=\"1\" CELLBORDER=\"0\" CELLSPACING=\"0\" COLOR=\"#555555\">\n    <TR>\n      <TD COLSPAN=\"1\" BGCOLOR=\"#EFEBDD\" BORDER=\"0\"><FONT COLOR=\"#000000\">species<\/FONT>\n<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"url\"><U>url<\/U><\/TD>\n    <\/TR>\n  <\/TABLE>>, shape = \"plaintext\"] \n\n\"films_x_characters\":\"url\"->\"films\":\"url\" [id=\"films_x_characters_1\"]\n\"films_x_characters\":\"characters\"->\"people\":\"url\" [id=\"films_x_characters_2\"]\n\"people\":\"homeworld\"->\"planets\":\"url\" [id=\"people_1\"]\n\"people\":\"species\"->\"species\":\"url\" [id=\"people_2\"]\n}","config":{"engine":null,"options":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>Next, let us check key constraints to join data frames. This can be done using <code>dm_examine_constraints()</code>. Let’s check the behavior of <code>dm_examine_constraints()</code> by building a model that contains the two types of mistakes mentioned above as common mistakes. Here, <code>dm_starwars_2_strong_data</code> is data in which the first row of the <code>species</code> data has been deleted and the data is not “MECE”. <code>dm_starwars_2_wrong_pk</code> is the data with the wrong primary key in the <code>species</code> data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1">dm_starwars_2_wrong_data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> dm_starwars_1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb18-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dm</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">species =</span> species <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb18-3">       <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">slice</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb18-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dm_add_pk</span>(species, url) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb18-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dm_add_fk</span>(people, species, species)</span>
<span id="cb18-6"></span>
<span id="cb18-7">dm_starwars_2_wrong_pk <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> dm_starwars_1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb18-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dm</span>(species) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb18-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dm_add_pk</span>(species, name) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb18-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dm_add_fk</span>(people, species, species)</span></code></pre></div>
</div>
<p>Let’s look at the result of <code>dm_examine_constraints()</code>. For the correct model, <code>dm_starwars_2</code>, the message <code>ℹ All constraints satisfied.</code> is displayed. On the other hand, <code>dm_starwars_2_strong_data</code> and <code>dm_starwars_2_strong_pk</code> show the message <code>! Unsatisfied constraints:</code> is displayed. This is because the primary key of the <code>species</code> data does not contain data that should be included. Thus, we see that <code>dm_examine_constraints()</code> can be used to easily check the key constraints.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dm_examine_constraints</span>(dm_starwars_2))</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>ℹ All constraints satisfied.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dm_examine_constraints</span>(dm_starwars_2_wrong_data))</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>! Unsatisfied constraints:</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>• Table `people`: foreign key `species` into table `species`: values of `people$species` not in `species$url`: http://swapi.co/api/species/5/ (1)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dm_examine_constraints</span>(dm_starwars_2_wrong_pk))</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>! Unsatisfied constraints:</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>• Table `people`: foreign key `species` into table `species`: values of `people$species` not in `species$name`: http://swapi.co/api/species/1/ (35), http://swapi.co/api/species/2/ (5), http://swapi.co/api/species/12/ (3), http://swapi.co/api/species/15/ (2), http://swapi.co/api/species/22/ (2), …</code></pre>
</div>
</div>
<p>As described above, we have seen that we can add new data to the relational data model with <code>dm()</code> and check key constraints with <code>dm_examine_constraints()</code>. Finally, the following figure shows a composition of the species of the characters in the Star Wars films using <code>dm_starwars_2</code>. Again, we omit the discussion of the plots.</p>
<div class="cell">
<details class="code-fold">
<summary>Plot of the composition of the characters’ races</summary>
<div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1">dm_starwars_2 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb27-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dm_flatten_to_tbl</span>(films_x_characters,</span>
<span id="cb27-3">                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.recursive =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb27-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">name.species =</span> name.species <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb27-5">           <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_na_value_to_level</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Other"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb27-6">           <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_lump_n</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>,</span>
<span id="cb27-7">                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ties.method =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"first"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb27-8">           <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_relevel</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Other"</span>, </span>
<span id="cb27-9">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">after =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">Inf</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb27-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">count</span>(title, name.species) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb27-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prop =</span> n <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(n),</span>
<span id="cb27-12">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.by =</span> title,</span>
<span id="cb27-13">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.keep =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"unused"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb27-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_rev</span>(title), prop,</span>
<span id="cb27-15">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> name.species)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb27-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_col</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">position =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">position_stack</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">reverse =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb27-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_text</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">if_else</span>(prop <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5e-2</span>, </span>
<span id="cb27-18">                                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>,</span>
<span id="cb27-19">                                scales<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">label_percent</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">accuracy =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)(prop))),</span>
<span id="cb27-20">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">position =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">position_stack</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">vjust =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>,</span>
<span id="cb27-21">                                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">reverse =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb27-22">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_discrete</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Title"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb27-23">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_y_continuous</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Composition of the characters' races"</span>,</span>
<span id="cb27-24">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> scales<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>percent) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb27-25">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_brewer</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Species name"</span>,</span>
<span id="cb27-26">                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">palette =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Set2"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb27-27">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_flip</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb27-28">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bottom"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb27-29">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guides</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guide_legend</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,</span>
<span id="cb27-30">                             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">byrow =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>))</span></code></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://uchidamizuki.quarto.pub/blog/posts/2024/01/relational-data-models-with-r-s-dm-en_files/figure-html/plot-starwars-2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="summary" class="level2">
<h2 class="anchored" data-anchor-id="summary">Summary</h2>
<p>In this article, we have shown how to build a relational data model using dm. Once a relational data model is built using dm, it is no longer necessary to manage relationships among data by oneself, and data can be automatically joined using <code>dm_flatten_to_tbl()</code>. In addition, dm provides other useful functions to enhance the quality of data preprocessing, such as adding data to the model with <code>dm()</code> and checking key constraints with <code>dm_examine_constraints()</code>.</p>
</section>
<section id="references" class="level2">
<h2 class="anchored" data-anchor-id="references">References</h2>
<ul>
<li><a href="https://dm.cynkra.com/index.html">dm package site</a></li>
<li><a href="https://gihyo.jp/book/2018/978-4-7741-9647-3">Preprocessing Compendium [Practical SQL/R/Python techniques for data analysis] (in Japanese)</a></li>
<li><a href="https://pkg.garrickadenbuie.com/starwarsdb/">starwarsdb</a>
<ul>
<li>Star Wars relational data model available for download from CRAN</li>
</ul></li>
</ul>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Fortunately, recent versions of dplyr warn against duplicate keys when joining data frames.↩︎</p></li>
<li id="fn2"><p>Among the data exported by repurrrsive, the data whose name begins with <code>sw_</code> are related to StarWars, and the part after <code>sw_</code> represents the content of the data.↩︎</p></li>
<li id="fn3"><p>The <code>species</code> column of <code>sw_people</code> is not needed here, but is selected for use in the next analysis.↩︎</p></li>
<li id="fn4"><p>Here, I used mermaid to illustrate the relationship between data frames.↩︎</p></li>
<li id="fn5"><p>There is no clear hierarchical relationship between works and characters, so the name <code>characters_x_films</code> is acceptable.↩︎</p></li>
<li id="fn6"><p>For <code>films</code>, <code>people</code>, and <code>planets</code>, the <code>url</code> column is the primary key, and for <code>films_x_characters</code>, <code>url</code> and <code>characters</code> are the primary keys.↩︎</p></li>
<li id="fn7"><p>Following the arrows in the image above, I set foreign keys.↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>dm</category>
  <category>R</category>
  <category>English</category>
  <guid>https://uchidamizuki.quarto.pub/blog/posts/2024/01/relational-data-models-with-r-s-dm-en.html</guid>
  <pubDate>Sat, 27 Jan 2024 15:00:00 GMT</pubDate>
  <media:content url="https://uchidamizuki.quarto.pub/blog/posts/2024/01/relational-data-models-with-r-s-dm/mermaid-figure-2.png" medium="image" type="image/png" height="118" width="144"/>
</item>
<item>
  <title>Rのdmパッケージでデータ前処理の質を高めよう</title>
  <link>https://uchidamizuki.quarto.pub/blog/posts/2024/01/relational-data-models-with-r-s-dm.html</link>
  <description><![CDATA[ 





<section id="データ前処理の作業ミスをなくすために" class="level2">
<h2 class="anchored" data-anchor-id="データ前処理の作業ミスをなくすために">データ前処理の作業ミスをなくすために</h2>
<p>データ分析に要する時間のうち，8割は前処理に費やされているといわれています．前処理は，その後のデータ分析の質を左右しますから非常に重要な一方で，前処理に膨大な時間を要するということは，作業ミスが起こる確率もそれだけ高くなるということを意味しています．</p>
<p>一般的な（データ構造に対する）前処理には，データフレームの”抽出”・”集約”・”結合”がありますが，なかでも”結合”は，コードが長くなりやすく，作業ミスが起こりやすい作業であると思われます．また，分析で必要となるデータフレームが1つにまとまっていることは稀ですから，データフレームの結合は特に頻出する処理でもあります．</p>
<p>データフレームの”結合”で起こりがちな典型的なミスとして，以下のようなものがあります<sup>1</sup>．</p>
<ul>
<li>結合対象となるデータフレームのキーが”MECE”（「漏れなく・ダブりなく」）でない</li>
<li>結合のためのキーを取り違える，または，データ形式が異なる</li>
</ul>
<p>もしも，これまでデータフレームの結合において，何らかの作業ミスや”ヒヤリ・ハット”を経験したことがあるのであれば，それらを放置せず何らかのパッケージに頼るほうが得策かもしれません．また，仮に作業ミスがなかったとしても，私たちは過去の作業が正しかったかについて疑心暗鬼になりがちです<sup>2</sup>．</p>
<p>この記事では，データフレームの”結合”における作業ミスや疑心暗鬼の解決策として有力なRのdmパッケージを紹介します．</p>
</section>
<section id="dmによるリレーショナルデータモデル" class="level2">
<h2 class="anchored" data-anchor-id="dmによるリレーショナルデータモデル">dmによるリレーショナルデータモデル</h2>
<p>dmの提供するリレーショナルデータモデルは，複数のデータ間の関係性を私たちの代わりに管理してくれます．</p>
<p>この記事では，repurrrsiveパッケージで提供されているStar Warsのデータセットを通じて，dmの提供するリレーショナルデータモデルの使い方や利点について説明します．あらかじめ，tidyverse，dm，repurrrsiveの3つのパッケージを読み込んでおきます．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse)</span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dm)</span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(repurrrsive)</span></code></pre></div>
</div>
<p>repurrrsiveで提供されているStar Warsのデータセットには，以下のようなものが含まれています<sup>3</sup>．</p>
<div class="cell">
<details class="code-fold">
<summary>repurrrsiveで提供されているStar Warsのデータセット</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">package =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"repurrrsive"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb2-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">chuck</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"results"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb2-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_tibble</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb2-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_starts</span>(Item, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sw_"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb2-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pull</span>(Item)</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "sw_films"     "sw_people"    "sw_planets"   "sw_species"   "sw_starships"
[6] "sw_vehicles" </code></pre>
</div>
</div>
<p>複数のデータ間の関係を扱う必要のある，以下の2つの分析事例を通じて，リレーショナルデータモデルを活用する方法を見ていきましょう．</p>
<ol type="1">
<li>基礎編：dmでリレーショナルデータモデルを構築する</li>
<li>応用編：dmでモデルを拡張したりキーを検証したりする</li>
</ol>
<section id="基礎編dmでリレーショナルデータモデルを構築する" class="level3">
<h3 class="anchored" data-anchor-id="基礎編dmでリレーショナルデータモデルを構築する">1. 基礎編：dmでリレーショナルデータモデルを構築する</h3>
<p>基礎編として，Star Wars作品の登場人物の故郷の惑星の構成比を調べるためのリレーショナルデータモデルを構築してみしょう．この分析を行うために，以下のように3つのデータフレーム<code>films</code>・<code>people</code>・<code>planets</code>を準備しておきます<sup>4</sup>．ここでは，分析をシンプルにするため，必要なデータのみを<code>select</code>しました<sup>5</sup>．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">films <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">film =</span> sw_films) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb4-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unnest_wider</span>(film) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb4-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(url, title, characters)</span>
<span id="cb4-4">people <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">person =</span> sw_people) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb4-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unnest_wider</span>(person) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb4-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(url, name, homeworld, species)</span>
<span id="cb4-7">planets <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">planet =</span> sw_planets) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb4-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unnest_wider</span>(planet) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb4-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(url, name)</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1">films</span></code></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["url"],"name":[1],"type":["chr"],"align":["left"]},{"label":["title"],"name":[2],"type":["chr"],"align":["left"]},{"label":["characters"],"name":[3],"type":["list"],"align":["right"]}],"data":[{"1":"http://swapi.co/api/films/1/","2":"A New Hope","3":"<chr [18]>"},{"1":"http://swapi.co/api/films/5/","2":"Attack of the Clones","3":"<chr [40]>"},{"1":"http://swapi.co/api/films/4/","2":"The Phantom Menace","3":"<chr [34]>"},{"1":"http://swapi.co/api/films/6/","2":"Revenge of the Sith","3":"<chr [34]>"},{"1":"http://swapi.co/api/films/3/","2":"Return of the Jedi","3":"<chr [20]>"},{"1":"http://swapi.co/api/films/2/","2":"The Empire Strikes Back","3":"<chr [16]>"},{"1":"http://swapi.co/api/films/7/","2":"The Force Awakens","3":"<chr [11]>"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1">people</span></code></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["url"],"name":[1],"type":["chr"],"align":["left"]},{"label":["name"],"name":[2],"type":["chr"],"align":["left"]},{"label":["homeworld"],"name":[3],"type":["chr"],"align":["left"]},{"label":["species"],"name":[4],"type":["chr"],"align":["left"]}],"data":[{"1":"http://swapi.co/api/people/1/","2":"Luke Skywalker","3":"http://swapi.co/api/planets/1/","4":"http://swapi.co/api/species/1/"},{"1":"http://swapi.co/api/people/2/","2":"C-3PO","3":"http://swapi.co/api/planets/1/","4":"http://swapi.co/api/species/2/"},{"1":"http://swapi.co/api/people/3/","2":"R2-D2","3":"http://swapi.co/api/planets/8/","4":"http://swapi.co/api/species/2/"},{"1":"http://swapi.co/api/people/4/","2":"Darth Vader","3":"http://swapi.co/api/planets/1/","4":"http://swapi.co/api/species/1/"},{"1":"http://swapi.co/api/people/5/","2":"Leia Organa","3":"http://swapi.co/api/planets/2/","4":"http://swapi.co/api/species/1/"},{"1":"http://swapi.co/api/people/6/","2":"Owen Lars","3":"http://swapi.co/api/planets/1/","4":"http://swapi.co/api/species/1/"},{"1":"http://swapi.co/api/people/7/","2":"Beru Whitesun lars","3":"http://swapi.co/api/planets/1/","4":"http://swapi.co/api/species/1/"},{"1":"http://swapi.co/api/people/8/","2":"R5-D4","3":"http://swapi.co/api/planets/1/","4":"http://swapi.co/api/species/2/"},{"1":"http://swapi.co/api/people/9/","2":"Biggs Darklighter","3":"http://swapi.co/api/planets/1/","4":"http://swapi.co/api/species/1/"},{"1":"http://swapi.co/api/people/10/","2":"Obi-Wan Kenobi","3":"http://swapi.co/api/planets/20/","4":"http://swapi.co/api/species/1/"},{"1":"http://swapi.co/api/people/11/","2":"Anakin Skywalker","3":"http://swapi.co/api/planets/1/","4":"http://swapi.co/api/species/1/"},{"1":"http://swapi.co/api/people/12/","2":"Wilhuff Tarkin","3":"http://swapi.co/api/planets/21/","4":"http://swapi.co/api/species/1/"},{"1":"http://swapi.co/api/people/13/","2":"Chewbacca","3":"http://swapi.co/api/planets/14/","4":"http://swapi.co/api/species/3/"},{"1":"http://swapi.co/api/people/14/","2":"Han Solo","3":"http://swapi.co/api/planets/22/","4":"http://swapi.co/api/species/1/"},{"1":"http://swapi.co/api/people/15/","2":"Greedo","3":"http://swapi.co/api/planets/23/","4":"http://swapi.co/api/species/4/"},{"1":"http://swapi.co/api/people/16/","2":"Jabba Desilijic Tiure","3":"http://swapi.co/api/planets/24/","4":"http://swapi.co/api/species/5/"},{"1":"http://swapi.co/api/people/18/","2":"Wedge Antilles","3":"http://swapi.co/api/planets/22/","4":"http://swapi.co/api/species/1/"},{"1":"http://swapi.co/api/people/19/","2":"Jek Tono Porkins","3":"http://swapi.co/api/planets/26/","4":"http://swapi.co/api/species/1/"},{"1":"http://swapi.co/api/people/20/","2":"Yoda","3":"http://swapi.co/api/planets/28/","4":"http://swapi.co/api/species/6/"},{"1":"http://swapi.co/api/people/21/","2":"Palpatine","3":"http://swapi.co/api/planets/8/","4":"http://swapi.co/api/species/1/"},{"1":"http://swapi.co/api/people/22/","2":"Boba Fett","3":"http://swapi.co/api/planets/10/","4":"http://swapi.co/api/species/1/"},{"1":"http://swapi.co/api/people/23/","2":"IG-88","3":"http://swapi.co/api/planets/28/","4":"http://swapi.co/api/species/2/"},{"1":"http://swapi.co/api/people/24/","2":"Bossk","3":"http://swapi.co/api/planets/29/","4":"http://swapi.co/api/species/7/"},{"1":"http://swapi.co/api/people/25/","2":"Lando Calrissian","3":"http://swapi.co/api/planets/30/","4":"http://swapi.co/api/species/1/"},{"1":"http://swapi.co/api/people/26/","2":"Lobot","3":"http://swapi.co/api/planets/6/","4":"http://swapi.co/api/species/1/"},{"1":"http://swapi.co/api/people/27/","2":"Ackbar","3":"http://swapi.co/api/planets/31/","4":"http://swapi.co/api/species/8/"},{"1":"http://swapi.co/api/people/28/","2":"Mon Mothma","3":"http://swapi.co/api/planets/32/","4":"http://swapi.co/api/species/1/"},{"1":"http://swapi.co/api/people/29/","2":"Arvel Crynyd","3":"http://swapi.co/api/planets/28/","4":"http://swapi.co/api/species/1/"},{"1":"http://swapi.co/api/people/30/","2":"Wicket Systri Warrick","3":"http://swapi.co/api/planets/7/","4":"http://swapi.co/api/species/9/"},{"1":"http://swapi.co/api/people/31/","2":"Nien Nunb","3":"http://swapi.co/api/planets/33/","4":"http://swapi.co/api/species/10/"},{"1":"http://swapi.co/api/people/32/","2":"Qui-Gon Jinn","3":"http://swapi.co/api/planets/28/","4":"http://swapi.co/api/species/1/"},{"1":"http://swapi.co/api/people/33/","2":"Nute Gunray","3":"http://swapi.co/api/planets/18/","4":"http://swapi.co/api/species/11/"},{"1":"http://swapi.co/api/people/34/","2":"Finis Valorum","3":"http://swapi.co/api/planets/9/","4":"http://swapi.co/api/species/1/"},{"1":"http://swapi.co/api/people/36/","2":"Jar Jar Binks","3":"http://swapi.co/api/planets/8/","4":"http://swapi.co/api/species/12/"},{"1":"http://swapi.co/api/people/37/","2":"Roos Tarpals","3":"http://swapi.co/api/planets/8/","4":"http://swapi.co/api/species/12/"},{"1":"http://swapi.co/api/people/38/","2":"Rugor Nass","3":"http://swapi.co/api/planets/8/","4":"http://swapi.co/api/species/12/"},{"1":"http://swapi.co/api/people/39/","2":"Ric Olié","3":"http://swapi.co/api/planets/8/","4":"NA"},{"1":"http://swapi.co/api/people/40/","2":"Watto","3":"http://swapi.co/api/planets/34/","4":"http://swapi.co/api/species/13/"},{"1":"http://swapi.co/api/people/41/","2":"Sebulba","3":"http://swapi.co/api/planets/35/","4":"http://swapi.co/api/species/14/"},{"1":"http://swapi.co/api/people/42/","2":"Quarsh Panaka","3":"http://swapi.co/api/planets/8/","4":"NA"},{"1":"http://swapi.co/api/people/43/","2":"Shmi Skywalker","3":"http://swapi.co/api/planets/1/","4":"http://swapi.co/api/species/1/"},{"1":"http://swapi.co/api/people/44/","2":"Darth Maul","3":"http://swapi.co/api/planets/36/","4":"http://swapi.co/api/species/22/"},{"1":"http://swapi.co/api/people/45/","2":"Bib Fortuna","3":"http://swapi.co/api/planets/37/","4":"http://swapi.co/api/species/15/"},{"1":"http://swapi.co/api/people/46/","2":"Ayla Secura","3":"http://swapi.co/api/planets/37/","4":"http://swapi.co/api/species/15/"},{"1":"http://swapi.co/api/people/48/","2":"Dud Bolt","3":"http://swapi.co/api/planets/39/","4":"http://swapi.co/api/species/17/"},{"1":"http://swapi.co/api/people/49/","2":"Gasgano","3":"http://swapi.co/api/planets/40/","4":"http://swapi.co/api/species/18/"},{"1":"http://swapi.co/api/people/50/","2":"Ben Quadinaros","3":"http://swapi.co/api/planets/41/","4":"http://swapi.co/api/species/19/"},{"1":"http://swapi.co/api/people/51/","2":"Mace Windu","3":"http://swapi.co/api/planets/42/","4":"http://swapi.co/api/species/1/"},{"1":"http://swapi.co/api/people/52/","2":"Ki-Adi-Mundi","3":"http://swapi.co/api/planets/43/","4":"http://swapi.co/api/species/20/"},{"1":"http://swapi.co/api/people/53/","2":"Kit Fisto","3":"http://swapi.co/api/planets/44/","4":"http://swapi.co/api/species/21/"},{"1":"http://swapi.co/api/people/54/","2":"Eeth Koth","3":"http://swapi.co/api/planets/45/","4":"http://swapi.co/api/species/22/"},{"1":"http://swapi.co/api/people/55/","2":"Adi Gallia","3":"http://swapi.co/api/planets/9/","4":"http://swapi.co/api/species/23/"},{"1":"http://swapi.co/api/people/56/","2":"Saesee Tiin","3":"http://swapi.co/api/planets/47/","4":"http://swapi.co/api/species/24/"},{"1":"http://swapi.co/api/people/57/","2":"Yarael Poof","3":"http://swapi.co/api/planets/48/","4":"http://swapi.co/api/species/25/"},{"1":"http://swapi.co/api/people/58/","2":"Plo Koon","3":"http://swapi.co/api/planets/49/","4":"http://swapi.co/api/species/26/"},{"1":"http://swapi.co/api/people/59/","2":"Mas Amedda","3":"http://swapi.co/api/planets/50/","4":"http://swapi.co/api/species/27/"},{"1":"http://swapi.co/api/people/60/","2":"Gregar Typho","3":"http://swapi.co/api/planets/8/","4":"http://swapi.co/api/species/1/"},{"1":"http://swapi.co/api/people/61/","2":"Cordé","3":"http://swapi.co/api/planets/8/","4":"http://swapi.co/api/species/1/"},{"1":"http://swapi.co/api/people/62/","2":"Cliegg Lars","3":"http://swapi.co/api/planets/1/","4":"http://swapi.co/api/species/1/"},{"1":"http://swapi.co/api/people/63/","2":"Poggle the Lesser","3":"http://swapi.co/api/planets/11/","4":"http://swapi.co/api/species/28/"},{"1":"http://swapi.co/api/people/64/","2":"Luminara Unduli","3":"http://swapi.co/api/planets/51/","4":"http://swapi.co/api/species/29/"},{"1":"http://swapi.co/api/people/65/","2":"Barriss Offee","3":"http://swapi.co/api/planets/51/","4":"http://swapi.co/api/species/29/"},{"1":"http://swapi.co/api/people/66/","2":"Dormé","3":"http://swapi.co/api/planets/8/","4":"http://swapi.co/api/species/1/"},{"1":"http://swapi.co/api/people/67/","2":"Dooku","3":"http://swapi.co/api/planets/52/","4":"http://swapi.co/api/species/1/"},{"1":"http://swapi.co/api/people/68/","2":"Bail Prestor Organa","3":"http://swapi.co/api/planets/2/","4":"http://swapi.co/api/species/1/"},{"1":"http://swapi.co/api/people/69/","2":"Jango Fett","3":"http://swapi.co/api/planets/53/","4":"http://swapi.co/api/species/1/"},{"1":"http://swapi.co/api/people/70/","2":"Zam Wesell","3":"http://swapi.co/api/planets/54/","4":"http://swapi.co/api/species/30/"},{"1":"http://swapi.co/api/people/71/","2":"Dexter Jettster","3":"http://swapi.co/api/planets/55/","4":"http://swapi.co/api/species/31/"},{"1":"http://swapi.co/api/people/72/","2":"Lama Su","3":"http://swapi.co/api/planets/10/","4":"http://swapi.co/api/species/32/"},{"1":"http://swapi.co/api/people/73/","2":"Taun We","3":"http://swapi.co/api/planets/10/","4":"http://swapi.co/api/species/32/"},{"1":"http://swapi.co/api/people/74/","2":"Jocasta Nu","3":"http://swapi.co/api/planets/9/","4":"http://swapi.co/api/species/1/"},{"1":"http://swapi.co/api/people/47/","2":"Ratts Tyerell","3":"http://swapi.co/api/planets/38/","4":"http://swapi.co/api/species/16/"},{"1":"http://swapi.co/api/people/75/","2":"R4-P17","3":"http://swapi.co/api/planets/28/","4":"NA"},{"1":"http://swapi.co/api/people/76/","2":"Wat Tambor","3":"http://swapi.co/api/planets/56/","4":"http://swapi.co/api/species/33/"},{"1":"http://swapi.co/api/people/77/","2":"San Hill","3":"http://swapi.co/api/planets/57/","4":"http://swapi.co/api/species/34/"},{"1":"http://swapi.co/api/people/78/","2":"Shaak Ti","3":"http://swapi.co/api/planets/58/","4":"http://swapi.co/api/species/35/"},{"1":"http://swapi.co/api/people/79/","2":"Grievous","3":"http://swapi.co/api/planets/59/","4":"http://swapi.co/api/species/36/"},{"1":"http://swapi.co/api/people/80/","2":"Tarfful","3":"http://swapi.co/api/planets/14/","4":"http://swapi.co/api/species/3/"},{"1":"http://swapi.co/api/people/81/","2":"Raymus Antilles","3":"http://swapi.co/api/planets/2/","4":"http://swapi.co/api/species/1/"},{"1":"http://swapi.co/api/people/82/","2":"Sly Moore","3":"http://swapi.co/api/planets/60/","4":"NA"},{"1":"http://swapi.co/api/people/83/","2":"Tion Medon","3":"http://swapi.co/api/planets/12/","4":"http://swapi.co/api/species/37/"},{"1":"http://swapi.co/api/people/84/","2":"Finn","3":"http://swapi.co/api/planets/28/","4":"http://swapi.co/api/species/1/"},{"1":"http://swapi.co/api/people/85/","2":"Rey","3":"http://swapi.co/api/planets/28/","4":"http://swapi.co/api/species/1/"},{"1":"http://swapi.co/api/people/86/","2":"Poe Dameron","3":"http://swapi.co/api/planets/28/","4":"http://swapi.co/api/species/1/"},{"1":"http://swapi.co/api/people/87/","2":"BB8","3":"http://swapi.co/api/planets/28/","4":"http://swapi.co/api/species/2/"},{"1":"http://swapi.co/api/people/88/","2":"Captain Phasma","3":"http://swapi.co/api/planets/28/","4":"NA"},{"1":"http://swapi.co/api/people/35/","2":"Padmé Amidala","3":"http://swapi.co/api/planets/8/","4":"http://swapi.co/api/species/1/"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1">planets</span></code></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["url"],"name":[1],"type":["chr"],"align":["left"]},{"label":["name"],"name":[2],"type":["chr"],"align":["left"]}],"data":[{"1":"http://swapi.co/api/planets/2/","2":"Alderaan"},{"1":"http://swapi.co/api/planets/3/","2":"Yavin IV"},{"1":"http://swapi.co/api/planets/4/","2":"Hoth"},{"1":"http://swapi.co/api/planets/5/","2":"Dagobah"},{"1":"http://swapi.co/api/planets/6/","2":"Bespin"},{"1":"http://swapi.co/api/planets/7/","2":"Endor"},{"1":"http://swapi.co/api/planets/8/","2":"Naboo"},{"1":"http://swapi.co/api/planets/9/","2":"Coruscant"},{"1":"http://swapi.co/api/planets/10/","2":"Kamino"},{"1":"http://swapi.co/api/planets/11/","2":"Geonosis"},{"1":"http://swapi.co/api/planets/12/","2":"Utapau"},{"1":"http://swapi.co/api/planets/13/","2":"Mustafar"},{"1":"http://swapi.co/api/planets/14/","2":"Kashyyyk"},{"1":"http://swapi.co/api/planets/15/","2":"Polis Massa"},{"1":"http://swapi.co/api/planets/16/","2":"Mygeeto"},{"1":"http://swapi.co/api/planets/17/","2":"Felucia"},{"1":"http://swapi.co/api/planets/18/","2":"Cato Neimoidia"},{"1":"http://swapi.co/api/planets/19/","2":"Saleucami"},{"1":"http://swapi.co/api/planets/20/","2":"Stewjon"},{"1":"http://swapi.co/api/planets/21/","2":"Eriadu"},{"1":"http://swapi.co/api/planets/22/","2":"Corellia"},{"1":"http://swapi.co/api/planets/23/","2":"Rodia"},{"1":"http://swapi.co/api/planets/24/","2":"Nal Hutta"},{"1":"http://swapi.co/api/planets/25/","2":"Dantooine"},{"1":"http://swapi.co/api/planets/26/","2":"Bestine IV"},{"1":"http://swapi.co/api/planets/27/","2":"Ord Mantell"},{"1":"http://swapi.co/api/planets/28/","2":"unknown"},{"1":"http://swapi.co/api/planets/29/","2":"Trandosha"},{"1":"http://swapi.co/api/planets/30/","2":"Socorro"},{"1":"http://swapi.co/api/planets/31/","2":"Mon Cala"},{"1":"http://swapi.co/api/planets/32/","2":"Chandrila"},{"1":"http://swapi.co/api/planets/33/","2":"Sullust"},{"1":"http://swapi.co/api/planets/34/","2":"Toydaria"},{"1":"http://swapi.co/api/planets/35/","2":"Malastare"},{"1":"http://swapi.co/api/planets/36/","2":"Dathomir"},{"1":"http://swapi.co/api/planets/37/","2":"Ryloth"},{"1":"http://swapi.co/api/planets/38/","2":"Aleen Minor"},{"1":"http://swapi.co/api/planets/39/","2":"Vulpter"},{"1":"http://swapi.co/api/planets/40/","2":"Troiken"},{"1":"http://swapi.co/api/planets/41/","2":"Tund"},{"1":"http://swapi.co/api/planets/42/","2":"Haruun Kal"},{"1":"http://swapi.co/api/planets/43/","2":"Cerea"},{"1":"http://swapi.co/api/planets/44/","2":"Glee Anselm"},{"1":"http://swapi.co/api/planets/45/","2":"Iridonia"},{"1":"http://swapi.co/api/planets/46/","2":"Tholoth"},{"1":"http://swapi.co/api/planets/47/","2":"Iktotch"},{"1":"http://swapi.co/api/planets/48/","2":"Quermia"},{"1":"http://swapi.co/api/planets/49/","2":"Dorin"},{"1":"http://swapi.co/api/planets/50/","2":"Champala"},{"1":"http://swapi.co/api/planets/51/","2":"Mirial"},{"1":"http://swapi.co/api/planets/52/","2":"Serenno"},{"1":"http://swapi.co/api/planets/53/","2":"Concord Dawn"},{"1":"http://swapi.co/api/planets/54/","2":"Zolan"},{"1":"http://swapi.co/api/planets/55/","2":"Ojom"},{"1":"http://swapi.co/api/planets/56/","2":"Skako"},{"1":"http://swapi.co/api/planets/57/","2":"Muunilinst"},{"1":"http://swapi.co/api/planets/58/","2":"Shili"},{"1":"http://swapi.co/api/planets/59/","2":"Kalee"},{"1":"http://swapi.co/api/planets/60/","2":"Umbara"},{"1":"http://swapi.co/api/planets/1/","2":"Tatooine"},{"1":"http://swapi.co/api/planets/61/","2":"Jakku"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>準備したデータフレームを確認すると，各データフレームの<code>url</code>列がキーとして用いられていることがわかりますので，データフレーム間の関係は以下の図のようにまとめることができます<sup>6</sup>．特に，1つの映画作品には複数の登場人物が登場することが一般的ですので，<code>films</code>の<code>characters</code>列が登場人物のリストになっていることに注意が必要です．そのため，このままでは，<code>films</code>の<code>characters</code>列を<code>people</code>の<code>url</code>列と対応付けることができません．</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">flowchart TB
  films.characters --&gt; people.url
  people.homeworld --&gt; planets.url
  subgraph films
    films.url[url]
    films.title[title]
    films.characters[List of characters] 
  end
  subgraph people
    people.url[url]
    people.name[name]
    people.homeworld[homeworld]
  end
  subgraph planets
    planets.url[url]
    planets.name[name]
  end
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<p>そこで，<code>films</code>と<code>people</code>の関係，すなわち，どの作品にどの登場人物が登場するかを表すデータ<code>films_x_characters</code>を新たに作成することを考えます<sup>7</sup>．<code>films_x_characters</code>を介すことで，データ間の関係を以下の図のようにまとめることができます．</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">flowchart TB
  films_x_characters.url --&gt; films.url
  films_x_characters.characters ---&gt; people.url
  people.homeworld --&gt; planets.url
  subgraph films_x_characters
    films_x_characters.url[url]
    films_x_characters.characters[characters]
  end
  subgraph films
    films.url[url]
    films.title[title]
  end
  subgraph people
    people.url[url]
    people.name[name]
    people.homeworld[homeworld]
  end
  subgraph planets
    planets.url[url]
    planets.name[name]
  end
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<p>それでは，上のイメージに従って，実際にリレーショナルデータモデルを構築してみましょう．まず，<code>films</code>の<code>url</code>・<code>characters</code>列を使って<code>films_x_characters</code>を作成します．ついでに<code>films</code>から不要となった<code>characters</code>列を削除しておきます．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create films_x_characters and remove characters column from films</span></span>
<span id="cb8-2">films_x_characters <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> films <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb8-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(url, characters) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb8-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unnest_longer</span>(characters)</span>
<span id="cb8-5">films <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> films <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb8-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>characters)</span>
<span id="cb8-7"></span>
<span id="cb8-8">films_x_characters</span></code></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["url"],"name":[1],"type":["chr"],"align":["left"]},{"label":["characters"],"name":[2],"type":["chr"],"align":["left"]}],"data":[{"1":"http://swapi.co/api/films/1/","2":"http://swapi.co/api/people/1/"},{"1":"http://swapi.co/api/films/1/","2":"http://swapi.co/api/people/2/"},{"1":"http://swapi.co/api/films/1/","2":"http://swapi.co/api/people/3/"},{"1":"http://swapi.co/api/films/1/","2":"http://swapi.co/api/people/4/"},{"1":"http://swapi.co/api/films/1/","2":"http://swapi.co/api/people/5/"},{"1":"http://swapi.co/api/films/1/","2":"http://swapi.co/api/people/6/"},{"1":"http://swapi.co/api/films/1/","2":"http://swapi.co/api/people/7/"},{"1":"http://swapi.co/api/films/1/","2":"http://swapi.co/api/people/8/"},{"1":"http://swapi.co/api/films/1/","2":"http://swapi.co/api/people/9/"},{"1":"http://swapi.co/api/films/1/","2":"http://swapi.co/api/people/10/"},{"1":"http://swapi.co/api/films/1/","2":"http://swapi.co/api/people/12/"},{"1":"http://swapi.co/api/films/1/","2":"http://swapi.co/api/people/13/"},{"1":"http://swapi.co/api/films/1/","2":"http://swapi.co/api/people/14/"},{"1":"http://swapi.co/api/films/1/","2":"http://swapi.co/api/people/15/"},{"1":"http://swapi.co/api/films/1/","2":"http://swapi.co/api/people/16/"},{"1":"http://swapi.co/api/films/1/","2":"http://swapi.co/api/people/18/"},{"1":"http://swapi.co/api/films/1/","2":"http://swapi.co/api/people/19/"},{"1":"http://swapi.co/api/films/1/","2":"http://swapi.co/api/people/81/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/2/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/3/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/6/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/7/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/10/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/11/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/20/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/21/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/22/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/33/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/36/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/40/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/43/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/46/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/51/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/52/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/53/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/58/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/59/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/60/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/61/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/62/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/63/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/64/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/65/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/66/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/67/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/68/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/69/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/70/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/71/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/72/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/73/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/74/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/75/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/76/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/77/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/78/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/82/"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/35/"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/2/"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/3/"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/10/"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/11/"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/16/"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/20/"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/21/"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/32/"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/33/"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/34/"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/36/"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/37/"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/38/"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/39/"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/40/"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/41/"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/42/"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/43/"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/44/"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/46/"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/48/"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/49/"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/50/"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/51/"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/52/"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/53/"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/54/"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/55/"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/56/"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/57/"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/58/"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/59/"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/47/"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/35/"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/1/"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/2/"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/3/"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/4/"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/5/"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/6/"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/7/"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/10/"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/11/"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/12/"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/13/"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/20/"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/21/"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/33/"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/46/"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/51/"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/52/"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/53/"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/54/"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/55/"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/56/"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/58/"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/63/"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/64/"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/67/"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/68/"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/75/"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/78/"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/79/"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/80/"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/81/"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/82/"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/83/"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/35/"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/1/"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/2/"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/3/"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/4/"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/5/"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/10/"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/13/"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/14/"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/16/"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/18/"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/20/"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/21/"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/22/"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/25/"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/27/"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/28/"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/29/"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/30/"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/31/"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/45/"},{"1":"http://swapi.co/api/films/2/","2":"http://swapi.co/api/people/1/"},{"1":"http://swapi.co/api/films/2/","2":"http://swapi.co/api/people/2/"},{"1":"http://swapi.co/api/films/2/","2":"http://swapi.co/api/people/3/"},{"1":"http://swapi.co/api/films/2/","2":"http://swapi.co/api/people/4/"},{"1":"http://swapi.co/api/films/2/","2":"http://swapi.co/api/people/5/"},{"1":"http://swapi.co/api/films/2/","2":"http://swapi.co/api/people/10/"},{"1":"http://swapi.co/api/films/2/","2":"http://swapi.co/api/people/13/"},{"1":"http://swapi.co/api/films/2/","2":"http://swapi.co/api/people/14/"},{"1":"http://swapi.co/api/films/2/","2":"http://swapi.co/api/people/18/"},{"1":"http://swapi.co/api/films/2/","2":"http://swapi.co/api/people/20/"},{"1":"http://swapi.co/api/films/2/","2":"http://swapi.co/api/people/21/"},{"1":"http://swapi.co/api/films/2/","2":"http://swapi.co/api/people/22/"},{"1":"http://swapi.co/api/films/2/","2":"http://swapi.co/api/people/23/"},{"1":"http://swapi.co/api/films/2/","2":"http://swapi.co/api/people/24/"},{"1":"http://swapi.co/api/films/2/","2":"http://swapi.co/api/people/25/"},{"1":"http://swapi.co/api/films/2/","2":"http://swapi.co/api/people/26/"},{"1":"http://swapi.co/api/films/7/","2":"http://swapi.co/api/people/1/"},{"1":"http://swapi.co/api/films/7/","2":"http://swapi.co/api/people/3/"},{"1":"http://swapi.co/api/films/7/","2":"http://swapi.co/api/people/5/"},{"1":"http://swapi.co/api/films/7/","2":"http://swapi.co/api/people/13/"},{"1":"http://swapi.co/api/films/7/","2":"http://swapi.co/api/people/14/"},{"1":"http://swapi.co/api/films/7/","2":"http://swapi.co/api/people/27/"},{"1":"http://swapi.co/api/films/7/","2":"http://swapi.co/api/people/84/"},{"1":"http://swapi.co/api/films/7/","2":"http://swapi.co/api/people/85/"},{"1":"http://swapi.co/api/films/7/","2":"http://swapi.co/api/people/86/"},{"1":"http://swapi.co/api/films/7/","2":"http://swapi.co/api/people/87/"},{"1":"http://swapi.co/api/films/7/","2":"http://swapi.co/api/people/88/"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>最後に，<code>dm()</code>に準備した<code>films</code>・<code>people</code>・<code>planets</code>・<code>films_x_characters</code>を渡した後，主キー（primary keys）と外部キー（foreign keys）を追加することで，リレーショナルデータモデルを構築することができます．</p>
<p>dmでは，主キーを<code>dm_add_pk()</code>で<sup>8</sup>，外部キーを<code>dm_add_fk()</code>で設定します<sup>9</sup>．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1">dm_starwars_1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dm</span>(films, people, planets, films_x_characters) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb9-2">  </span>
<span id="cb9-3">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 1. Add primary keys</span></span>
<span id="cb9-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dm_add_pk</span>(films, url) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb9-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dm_add_pk</span>(people, url) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb9-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dm_add_pk</span>(planets, url) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb9-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dm_add_pk</span>(films_x_characters, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(url, characters)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb9-8">  </span>
<span id="cb9-9">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 2. Add foreign keys</span></span>
<span id="cb9-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dm_add_fk</span>(films_x_characters, url, films) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb9-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dm_add_fk</span>(films_x_characters, characters, people) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb9-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dm_add_fk</span>(people, homeworld, planets) </span>
<span id="cb9-13"></span>
<span id="cb9-14">dm_starwars_1</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>── Metadata ────────────────────────────────────────────────────────────────────
Tables: `films`, `people`, `planets`, `films_x_characters`
Columns: 10
Primary keys: 4
Foreign keys: 3</code></pre>
</div>
</div>
<p><code>dm_draw()</code>を用いて，リレーショナルデータモデルを描画することもできます．描画してみると，上のイメージと同様の関係が構築されていることがわかります．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dm_draw</span>(dm_starwars_1)</span></code></pre></div>
<div class="cell-output-display">
<div class="grViz html-widget html-fill-item" id="htmlwidget-ecf8b3e34d5553d05736" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-ecf8b3e34d5553d05736">{"x":{"diagram":"#data_model\ndigraph {\ngraph [rankdir=LR tooltip=\"Data Model\" ]\n\nnode [margin=0 fontcolor = \"#444444\" ]\n\nedge [color = \"#555555\", arrowsize = 1, ]\n\npack=true\npackmode= \"node\"\n\n  \"films\" [id = \"films\", label = <<TABLE ALIGN=\"LEFT\" BORDER=\"1\" CELLBORDER=\"0\" CELLSPACING=\"0\" COLOR=\"#555555\">\n    <TR>\n      <TD COLSPAN=\"1\" BGCOLOR=\"#EFEBDD\" BORDER=\"0\"><FONT COLOR=\"#000000\">films<\/FONT>\n<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"url\"><U>url<\/U><\/TD>\n    <\/TR>\n  <\/TABLE>>, shape = \"plaintext\"] \n\n  \"films_x_characters\" [id = \"films_x_characters\", label = <<TABLE ALIGN=\"LEFT\" BORDER=\"1\" CELLBORDER=\"0\" CELLSPACING=\"0\" COLOR=\"#555555\">\n    <TR>\n      <TD COLSPAN=\"1\" BGCOLOR=\"#EFEBDD\" BORDER=\"0\"><FONT COLOR=\"#000000\">films_x_characters<\/FONT>\n<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"url\">url<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"characters\">characters<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"url, characters\"><U>url, characters<\/U><\/TD>\n    <\/TR>\n  <\/TABLE>>, shape = \"plaintext\"] \n\n  \"people\" [id = \"people\", label = <<TABLE ALIGN=\"LEFT\" BORDER=\"1\" CELLBORDER=\"0\" CELLSPACING=\"0\" COLOR=\"#555555\">\n    <TR>\n      <TD COLSPAN=\"1\" BGCOLOR=\"#EFEBDD\" BORDER=\"0\"><FONT COLOR=\"#000000\">people<\/FONT>\n<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"url\"><U>url<\/U><\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"homeworld\">homeworld<\/TD>\n    <\/TR>\n  <\/TABLE>>, shape = \"plaintext\"] \n\n  \"planets\" [id = \"planets\", label = <<TABLE ALIGN=\"LEFT\" BORDER=\"1\" CELLBORDER=\"0\" CELLSPACING=\"0\" COLOR=\"#555555\">\n    <TR>\n      <TD COLSPAN=\"1\" BGCOLOR=\"#EFEBDD\" BORDER=\"0\"><FONT COLOR=\"#000000\">planets<\/FONT>\n<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"url\"><U>url<\/U><\/TD>\n    <\/TR>\n  <\/TABLE>>, shape = \"plaintext\"] \n\n\"films_x_characters\":\"url\"->\"films\":\"url\" [id=\"films_x_characters_1\"]\n\"films_x_characters\":\"characters\"->\"people\":\"url\" [id=\"films_x_characters_2\"]\n\"people\":\"homeworld\"->\"planets\":\"url\" [id=\"people_1\"]\n}","config":{"engine":null,"options":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>以下のように<code>dm_flatten_to_tbl()</code>を用いることで，<code>films_x_characters</code>データに<code>films</code>・<code>people</code>・<code>planets</code>データを結合したデータフレームを作成することができます<sup>10</sup>．この際，異なるデータ間で同名の列名が存在する場合には，データ名に応じて自動的に列名が変更されます．このように，リレーショナルデータモデルが私たちの代わりにデータ間の関係を管理してくれるおかげで，他のデータ間との関係に基づいて自動的にデータフレームを結合することができます．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1">data_films_x_characters_1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> dm_starwars_1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb12-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dm_flatten_to_tbl</span>(films_x_characters,</span>
<span id="cb12-3">                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.recursive =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) </span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Renaming ambiguous columns: %&gt;%
  dm_rename(people, name.people = name) %&gt;%
  dm_rename(planets, name.planets = name)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1">data_films_x_characters_1</span></code></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["url"],"name":[1],"type":["chr"],"align":["left"]},{"label":["characters"],"name":[2],"type":["chr"],"align":["left"]},{"label":["title"],"name":[3],"type":["chr"],"align":["left"]},{"label":["name.people"],"name":[4],"type":["chr"],"align":["left"]},{"label":["homeworld"],"name":[5],"type":["chr"],"align":["left"]},{"label":["species"],"name":[6],"type":["chr"],"align":["left"]},{"label":["name.planets"],"name":[7],"type":["chr"],"align":["left"]}],"data":[{"1":"http://swapi.co/api/films/1/","2":"http://swapi.co/api/people/1/","3":"A New Hope","4":"Luke Skywalker","5":"http://swapi.co/api/planets/1/","6":"http://swapi.co/api/species/1/","7":"Tatooine"},{"1":"http://swapi.co/api/films/1/","2":"http://swapi.co/api/people/2/","3":"A New Hope","4":"C-3PO","5":"http://swapi.co/api/planets/1/","6":"http://swapi.co/api/species/2/","7":"Tatooine"},{"1":"http://swapi.co/api/films/1/","2":"http://swapi.co/api/people/3/","3":"A New Hope","4":"R2-D2","5":"http://swapi.co/api/planets/8/","6":"http://swapi.co/api/species/2/","7":"Naboo"},{"1":"http://swapi.co/api/films/1/","2":"http://swapi.co/api/people/4/","3":"A New Hope","4":"Darth Vader","5":"http://swapi.co/api/planets/1/","6":"http://swapi.co/api/species/1/","7":"Tatooine"},{"1":"http://swapi.co/api/films/1/","2":"http://swapi.co/api/people/5/","3":"A New Hope","4":"Leia Organa","5":"http://swapi.co/api/planets/2/","6":"http://swapi.co/api/species/1/","7":"Alderaan"},{"1":"http://swapi.co/api/films/1/","2":"http://swapi.co/api/people/6/","3":"A New Hope","4":"Owen Lars","5":"http://swapi.co/api/planets/1/","6":"http://swapi.co/api/species/1/","7":"Tatooine"},{"1":"http://swapi.co/api/films/1/","2":"http://swapi.co/api/people/7/","3":"A New Hope","4":"Beru Whitesun lars","5":"http://swapi.co/api/planets/1/","6":"http://swapi.co/api/species/1/","7":"Tatooine"},{"1":"http://swapi.co/api/films/1/","2":"http://swapi.co/api/people/8/","3":"A New Hope","4":"R5-D4","5":"http://swapi.co/api/planets/1/","6":"http://swapi.co/api/species/2/","7":"Tatooine"},{"1":"http://swapi.co/api/films/1/","2":"http://swapi.co/api/people/9/","3":"A New Hope","4":"Biggs Darklighter","5":"http://swapi.co/api/planets/1/","6":"http://swapi.co/api/species/1/","7":"Tatooine"},{"1":"http://swapi.co/api/films/1/","2":"http://swapi.co/api/people/10/","3":"A New Hope","4":"Obi-Wan Kenobi","5":"http://swapi.co/api/planets/20/","6":"http://swapi.co/api/species/1/","7":"Stewjon"},{"1":"http://swapi.co/api/films/1/","2":"http://swapi.co/api/people/12/","3":"A New Hope","4":"Wilhuff Tarkin","5":"http://swapi.co/api/planets/21/","6":"http://swapi.co/api/species/1/","7":"Eriadu"},{"1":"http://swapi.co/api/films/1/","2":"http://swapi.co/api/people/13/","3":"A New Hope","4":"Chewbacca","5":"http://swapi.co/api/planets/14/","6":"http://swapi.co/api/species/3/","7":"Kashyyyk"},{"1":"http://swapi.co/api/films/1/","2":"http://swapi.co/api/people/14/","3":"A New Hope","4":"Han Solo","5":"http://swapi.co/api/planets/22/","6":"http://swapi.co/api/species/1/","7":"Corellia"},{"1":"http://swapi.co/api/films/1/","2":"http://swapi.co/api/people/15/","3":"A New Hope","4":"Greedo","5":"http://swapi.co/api/planets/23/","6":"http://swapi.co/api/species/4/","7":"Rodia"},{"1":"http://swapi.co/api/films/1/","2":"http://swapi.co/api/people/16/","3":"A New Hope","4":"Jabba Desilijic Tiure","5":"http://swapi.co/api/planets/24/","6":"http://swapi.co/api/species/5/","7":"Nal Hutta"},{"1":"http://swapi.co/api/films/1/","2":"http://swapi.co/api/people/18/","3":"A New Hope","4":"Wedge Antilles","5":"http://swapi.co/api/planets/22/","6":"http://swapi.co/api/species/1/","7":"Corellia"},{"1":"http://swapi.co/api/films/1/","2":"http://swapi.co/api/people/19/","3":"A New Hope","4":"Jek Tono Porkins","5":"http://swapi.co/api/planets/26/","6":"http://swapi.co/api/species/1/","7":"Bestine IV"},{"1":"http://swapi.co/api/films/1/","2":"http://swapi.co/api/people/81/","3":"A New Hope","4":"Raymus Antilles","5":"http://swapi.co/api/planets/2/","6":"http://swapi.co/api/species/1/","7":"Alderaan"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/2/","3":"Attack of the Clones","4":"C-3PO","5":"http://swapi.co/api/planets/1/","6":"http://swapi.co/api/species/2/","7":"Tatooine"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/3/","3":"Attack of the Clones","4":"R2-D2","5":"http://swapi.co/api/planets/8/","6":"http://swapi.co/api/species/2/","7":"Naboo"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/6/","3":"Attack of the Clones","4":"Owen Lars","5":"http://swapi.co/api/planets/1/","6":"http://swapi.co/api/species/1/","7":"Tatooine"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/7/","3":"Attack of the Clones","4":"Beru Whitesun lars","5":"http://swapi.co/api/planets/1/","6":"http://swapi.co/api/species/1/","7":"Tatooine"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/10/","3":"Attack of the Clones","4":"Obi-Wan Kenobi","5":"http://swapi.co/api/planets/20/","6":"http://swapi.co/api/species/1/","7":"Stewjon"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/11/","3":"Attack of the Clones","4":"Anakin Skywalker","5":"http://swapi.co/api/planets/1/","6":"http://swapi.co/api/species/1/","7":"Tatooine"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/20/","3":"Attack of the Clones","4":"Yoda","5":"http://swapi.co/api/planets/28/","6":"http://swapi.co/api/species/6/","7":"unknown"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/21/","3":"Attack of the Clones","4":"Palpatine","5":"http://swapi.co/api/planets/8/","6":"http://swapi.co/api/species/1/","7":"Naboo"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/22/","3":"Attack of the Clones","4":"Boba Fett","5":"http://swapi.co/api/planets/10/","6":"http://swapi.co/api/species/1/","7":"Kamino"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/33/","3":"Attack of the Clones","4":"Nute Gunray","5":"http://swapi.co/api/planets/18/","6":"http://swapi.co/api/species/11/","7":"Cato Neimoidia"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/36/","3":"Attack of the Clones","4":"Jar Jar Binks","5":"http://swapi.co/api/planets/8/","6":"http://swapi.co/api/species/12/","7":"Naboo"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/40/","3":"Attack of the Clones","4":"Watto","5":"http://swapi.co/api/planets/34/","6":"http://swapi.co/api/species/13/","7":"Toydaria"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/43/","3":"Attack of the Clones","4":"Shmi Skywalker","5":"http://swapi.co/api/planets/1/","6":"http://swapi.co/api/species/1/","7":"Tatooine"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/46/","3":"Attack of the Clones","4":"Ayla Secura","5":"http://swapi.co/api/planets/37/","6":"http://swapi.co/api/species/15/","7":"Ryloth"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/51/","3":"Attack of the Clones","4":"Mace Windu","5":"http://swapi.co/api/planets/42/","6":"http://swapi.co/api/species/1/","7":"Haruun Kal"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/52/","3":"Attack of the Clones","4":"Ki-Adi-Mundi","5":"http://swapi.co/api/planets/43/","6":"http://swapi.co/api/species/20/","7":"Cerea"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/53/","3":"Attack of the Clones","4":"Kit Fisto","5":"http://swapi.co/api/planets/44/","6":"http://swapi.co/api/species/21/","7":"Glee Anselm"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/58/","3":"Attack of the Clones","4":"Plo Koon","5":"http://swapi.co/api/planets/49/","6":"http://swapi.co/api/species/26/","7":"Dorin"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/59/","3":"Attack of the Clones","4":"Mas Amedda","5":"http://swapi.co/api/planets/50/","6":"http://swapi.co/api/species/27/","7":"Champala"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/60/","3":"Attack of the Clones","4":"Gregar Typho","5":"http://swapi.co/api/planets/8/","6":"http://swapi.co/api/species/1/","7":"Naboo"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/61/","3":"Attack of the Clones","4":"Cordé","5":"http://swapi.co/api/planets/8/","6":"http://swapi.co/api/species/1/","7":"Naboo"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/62/","3":"Attack of the Clones","4":"Cliegg Lars","5":"http://swapi.co/api/planets/1/","6":"http://swapi.co/api/species/1/","7":"Tatooine"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/63/","3":"Attack of the Clones","4":"Poggle the Lesser","5":"http://swapi.co/api/planets/11/","6":"http://swapi.co/api/species/28/","7":"Geonosis"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/64/","3":"Attack of the Clones","4":"Luminara Unduli","5":"http://swapi.co/api/planets/51/","6":"http://swapi.co/api/species/29/","7":"Mirial"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/65/","3":"Attack of the Clones","4":"Barriss Offee","5":"http://swapi.co/api/planets/51/","6":"http://swapi.co/api/species/29/","7":"Mirial"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/66/","3":"Attack of the Clones","4":"Dormé","5":"http://swapi.co/api/planets/8/","6":"http://swapi.co/api/species/1/","7":"Naboo"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/67/","3":"Attack of the Clones","4":"Dooku","5":"http://swapi.co/api/planets/52/","6":"http://swapi.co/api/species/1/","7":"Serenno"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/68/","3":"Attack of the Clones","4":"Bail Prestor Organa","5":"http://swapi.co/api/planets/2/","6":"http://swapi.co/api/species/1/","7":"Alderaan"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/69/","3":"Attack of the Clones","4":"Jango Fett","5":"http://swapi.co/api/planets/53/","6":"http://swapi.co/api/species/1/","7":"Concord Dawn"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/70/","3":"Attack of the Clones","4":"Zam Wesell","5":"http://swapi.co/api/planets/54/","6":"http://swapi.co/api/species/30/","7":"Zolan"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/71/","3":"Attack of the Clones","4":"Dexter Jettster","5":"http://swapi.co/api/planets/55/","6":"http://swapi.co/api/species/31/","7":"Ojom"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/72/","3":"Attack of the Clones","4":"Lama Su","5":"http://swapi.co/api/planets/10/","6":"http://swapi.co/api/species/32/","7":"Kamino"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/73/","3":"Attack of the Clones","4":"Taun We","5":"http://swapi.co/api/planets/10/","6":"http://swapi.co/api/species/32/","7":"Kamino"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/74/","3":"Attack of the Clones","4":"Jocasta Nu","5":"http://swapi.co/api/planets/9/","6":"http://swapi.co/api/species/1/","7":"Coruscant"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/75/","3":"Attack of the Clones","4":"R4-P17","5":"http://swapi.co/api/planets/28/","6":"NA","7":"unknown"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/76/","3":"Attack of the Clones","4":"Wat Tambor","5":"http://swapi.co/api/planets/56/","6":"http://swapi.co/api/species/33/","7":"Skako"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/77/","3":"Attack of the Clones","4":"San Hill","5":"http://swapi.co/api/planets/57/","6":"http://swapi.co/api/species/34/","7":"Muunilinst"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/78/","3":"Attack of the Clones","4":"Shaak Ti","5":"http://swapi.co/api/planets/58/","6":"http://swapi.co/api/species/35/","7":"Shili"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/82/","3":"Attack of the Clones","4":"Sly Moore","5":"http://swapi.co/api/planets/60/","6":"NA","7":"Umbara"},{"1":"http://swapi.co/api/films/5/","2":"http://swapi.co/api/people/35/","3":"Attack of the Clones","4":"Padmé Amidala","5":"http://swapi.co/api/planets/8/","6":"http://swapi.co/api/species/1/","7":"Naboo"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/2/","3":"The Phantom Menace","4":"C-3PO","5":"http://swapi.co/api/planets/1/","6":"http://swapi.co/api/species/2/","7":"Tatooine"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/3/","3":"The Phantom Menace","4":"R2-D2","5":"http://swapi.co/api/planets/8/","6":"http://swapi.co/api/species/2/","7":"Naboo"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/10/","3":"The Phantom Menace","4":"Obi-Wan Kenobi","5":"http://swapi.co/api/planets/20/","6":"http://swapi.co/api/species/1/","7":"Stewjon"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/11/","3":"The Phantom Menace","4":"Anakin Skywalker","5":"http://swapi.co/api/planets/1/","6":"http://swapi.co/api/species/1/","7":"Tatooine"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/16/","3":"The Phantom Menace","4":"Jabba Desilijic Tiure","5":"http://swapi.co/api/planets/24/","6":"http://swapi.co/api/species/5/","7":"Nal Hutta"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/20/","3":"The Phantom Menace","4":"Yoda","5":"http://swapi.co/api/planets/28/","6":"http://swapi.co/api/species/6/","7":"unknown"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/21/","3":"The Phantom Menace","4":"Palpatine","5":"http://swapi.co/api/planets/8/","6":"http://swapi.co/api/species/1/","7":"Naboo"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/32/","3":"The Phantom Menace","4":"Qui-Gon Jinn","5":"http://swapi.co/api/planets/28/","6":"http://swapi.co/api/species/1/","7":"unknown"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/33/","3":"The Phantom Menace","4":"Nute Gunray","5":"http://swapi.co/api/planets/18/","6":"http://swapi.co/api/species/11/","7":"Cato Neimoidia"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/34/","3":"The Phantom Menace","4":"Finis Valorum","5":"http://swapi.co/api/planets/9/","6":"http://swapi.co/api/species/1/","7":"Coruscant"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/36/","3":"The Phantom Menace","4":"Jar Jar Binks","5":"http://swapi.co/api/planets/8/","6":"http://swapi.co/api/species/12/","7":"Naboo"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/37/","3":"The Phantom Menace","4":"Roos Tarpals","5":"http://swapi.co/api/planets/8/","6":"http://swapi.co/api/species/12/","7":"Naboo"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/38/","3":"The Phantom Menace","4":"Rugor Nass","5":"http://swapi.co/api/planets/8/","6":"http://swapi.co/api/species/12/","7":"Naboo"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/39/","3":"The Phantom Menace","4":"Ric Olié","5":"http://swapi.co/api/planets/8/","6":"NA","7":"Naboo"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/40/","3":"The Phantom Menace","4":"Watto","5":"http://swapi.co/api/planets/34/","6":"http://swapi.co/api/species/13/","7":"Toydaria"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/41/","3":"The Phantom Menace","4":"Sebulba","5":"http://swapi.co/api/planets/35/","6":"http://swapi.co/api/species/14/","7":"Malastare"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/42/","3":"The Phantom Menace","4":"Quarsh Panaka","5":"http://swapi.co/api/planets/8/","6":"NA","7":"Naboo"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/43/","3":"The Phantom Menace","4":"Shmi Skywalker","5":"http://swapi.co/api/planets/1/","6":"http://swapi.co/api/species/1/","7":"Tatooine"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/44/","3":"The Phantom Menace","4":"Darth Maul","5":"http://swapi.co/api/planets/36/","6":"http://swapi.co/api/species/22/","7":"Dathomir"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/46/","3":"The Phantom Menace","4":"Ayla Secura","5":"http://swapi.co/api/planets/37/","6":"http://swapi.co/api/species/15/","7":"Ryloth"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/48/","3":"The Phantom Menace","4":"Dud Bolt","5":"http://swapi.co/api/planets/39/","6":"http://swapi.co/api/species/17/","7":"Vulpter"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/49/","3":"The Phantom Menace","4":"Gasgano","5":"http://swapi.co/api/planets/40/","6":"http://swapi.co/api/species/18/","7":"Troiken"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/50/","3":"The Phantom Menace","4":"Ben Quadinaros","5":"http://swapi.co/api/planets/41/","6":"http://swapi.co/api/species/19/","7":"Tund"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/51/","3":"The Phantom Menace","4":"Mace Windu","5":"http://swapi.co/api/planets/42/","6":"http://swapi.co/api/species/1/","7":"Haruun Kal"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/52/","3":"The Phantom Menace","4":"Ki-Adi-Mundi","5":"http://swapi.co/api/planets/43/","6":"http://swapi.co/api/species/20/","7":"Cerea"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/53/","3":"The Phantom Menace","4":"Kit Fisto","5":"http://swapi.co/api/planets/44/","6":"http://swapi.co/api/species/21/","7":"Glee Anselm"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/54/","3":"The Phantom Menace","4":"Eeth Koth","5":"http://swapi.co/api/planets/45/","6":"http://swapi.co/api/species/22/","7":"Iridonia"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/55/","3":"The Phantom Menace","4":"Adi Gallia","5":"http://swapi.co/api/planets/9/","6":"http://swapi.co/api/species/23/","7":"Coruscant"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/56/","3":"The Phantom Menace","4":"Saesee Tiin","5":"http://swapi.co/api/planets/47/","6":"http://swapi.co/api/species/24/","7":"Iktotch"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/57/","3":"The Phantom Menace","4":"Yarael Poof","5":"http://swapi.co/api/planets/48/","6":"http://swapi.co/api/species/25/","7":"Quermia"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/58/","3":"The Phantom Menace","4":"Plo Koon","5":"http://swapi.co/api/planets/49/","6":"http://swapi.co/api/species/26/","7":"Dorin"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/59/","3":"The Phantom Menace","4":"Mas Amedda","5":"http://swapi.co/api/planets/50/","6":"http://swapi.co/api/species/27/","7":"Champala"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/47/","3":"The Phantom Menace","4":"Ratts Tyerell","5":"http://swapi.co/api/planets/38/","6":"http://swapi.co/api/species/16/","7":"Aleen Minor"},{"1":"http://swapi.co/api/films/4/","2":"http://swapi.co/api/people/35/","3":"The Phantom Menace","4":"Padmé Amidala","5":"http://swapi.co/api/planets/8/","6":"http://swapi.co/api/species/1/","7":"Naboo"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/1/","3":"Revenge of the Sith","4":"Luke Skywalker","5":"http://swapi.co/api/planets/1/","6":"http://swapi.co/api/species/1/","7":"Tatooine"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/2/","3":"Revenge of the Sith","4":"C-3PO","5":"http://swapi.co/api/planets/1/","6":"http://swapi.co/api/species/2/","7":"Tatooine"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/3/","3":"Revenge of the Sith","4":"R2-D2","5":"http://swapi.co/api/planets/8/","6":"http://swapi.co/api/species/2/","7":"Naboo"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/4/","3":"Revenge of the Sith","4":"Darth Vader","5":"http://swapi.co/api/planets/1/","6":"http://swapi.co/api/species/1/","7":"Tatooine"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/5/","3":"Revenge of the Sith","4":"Leia Organa","5":"http://swapi.co/api/planets/2/","6":"http://swapi.co/api/species/1/","7":"Alderaan"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/6/","3":"Revenge of the Sith","4":"Owen Lars","5":"http://swapi.co/api/planets/1/","6":"http://swapi.co/api/species/1/","7":"Tatooine"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/7/","3":"Revenge of the Sith","4":"Beru Whitesun lars","5":"http://swapi.co/api/planets/1/","6":"http://swapi.co/api/species/1/","7":"Tatooine"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/10/","3":"Revenge of the Sith","4":"Obi-Wan Kenobi","5":"http://swapi.co/api/planets/20/","6":"http://swapi.co/api/species/1/","7":"Stewjon"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/11/","3":"Revenge of the Sith","4":"Anakin Skywalker","5":"http://swapi.co/api/planets/1/","6":"http://swapi.co/api/species/1/","7":"Tatooine"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/12/","3":"Revenge of the Sith","4":"Wilhuff Tarkin","5":"http://swapi.co/api/planets/21/","6":"http://swapi.co/api/species/1/","7":"Eriadu"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/13/","3":"Revenge of the Sith","4":"Chewbacca","5":"http://swapi.co/api/planets/14/","6":"http://swapi.co/api/species/3/","7":"Kashyyyk"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/20/","3":"Revenge of the Sith","4":"Yoda","5":"http://swapi.co/api/planets/28/","6":"http://swapi.co/api/species/6/","7":"unknown"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/21/","3":"Revenge of the Sith","4":"Palpatine","5":"http://swapi.co/api/planets/8/","6":"http://swapi.co/api/species/1/","7":"Naboo"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/33/","3":"Revenge of the Sith","4":"Nute Gunray","5":"http://swapi.co/api/planets/18/","6":"http://swapi.co/api/species/11/","7":"Cato Neimoidia"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/46/","3":"Revenge of the Sith","4":"Ayla Secura","5":"http://swapi.co/api/planets/37/","6":"http://swapi.co/api/species/15/","7":"Ryloth"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/51/","3":"Revenge of the Sith","4":"Mace Windu","5":"http://swapi.co/api/planets/42/","6":"http://swapi.co/api/species/1/","7":"Haruun Kal"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/52/","3":"Revenge of the Sith","4":"Ki-Adi-Mundi","5":"http://swapi.co/api/planets/43/","6":"http://swapi.co/api/species/20/","7":"Cerea"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/53/","3":"Revenge of the Sith","4":"Kit Fisto","5":"http://swapi.co/api/planets/44/","6":"http://swapi.co/api/species/21/","7":"Glee Anselm"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/54/","3":"Revenge of the Sith","4":"Eeth Koth","5":"http://swapi.co/api/planets/45/","6":"http://swapi.co/api/species/22/","7":"Iridonia"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/55/","3":"Revenge of the Sith","4":"Adi Gallia","5":"http://swapi.co/api/planets/9/","6":"http://swapi.co/api/species/23/","7":"Coruscant"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/56/","3":"Revenge of the Sith","4":"Saesee Tiin","5":"http://swapi.co/api/planets/47/","6":"http://swapi.co/api/species/24/","7":"Iktotch"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/58/","3":"Revenge of the Sith","4":"Plo Koon","5":"http://swapi.co/api/planets/49/","6":"http://swapi.co/api/species/26/","7":"Dorin"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/63/","3":"Revenge of the Sith","4":"Poggle the Lesser","5":"http://swapi.co/api/planets/11/","6":"http://swapi.co/api/species/28/","7":"Geonosis"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/64/","3":"Revenge of the Sith","4":"Luminara Unduli","5":"http://swapi.co/api/planets/51/","6":"http://swapi.co/api/species/29/","7":"Mirial"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/67/","3":"Revenge of the Sith","4":"Dooku","5":"http://swapi.co/api/planets/52/","6":"http://swapi.co/api/species/1/","7":"Serenno"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/68/","3":"Revenge of the Sith","4":"Bail Prestor Organa","5":"http://swapi.co/api/planets/2/","6":"http://swapi.co/api/species/1/","7":"Alderaan"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/75/","3":"Revenge of the Sith","4":"R4-P17","5":"http://swapi.co/api/planets/28/","6":"NA","7":"unknown"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/78/","3":"Revenge of the Sith","4":"Shaak Ti","5":"http://swapi.co/api/planets/58/","6":"http://swapi.co/api/species/35/","7":"Shili"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/79/","3":"Revenge of the Sith","4":"Grievous","5":"http://swapi.co/api/planets/59/","6":"http://swapi.co/api/species/36/","7":"Kalee"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/80/","3":"Revenge of the Sith","4":"Tarfful","5":"http://swapi.co/api/planets/14/","6":"http://swapi.co/api/species/3/","7":"Kashyyyk"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/81/","3":"Revenge of the Sith","4":"Raymus Antilles","5":"http://swapi.co/api/planets/2/","6":"http://swapi.co/api/species/1/","7":"Alderaan"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/82/","3":"Revenge of the Sith","4":"Sly Moore","5":"http://swapi.co/api/planets/60/","6":"NA","7":"Umbara"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/83/","3":"Revenge of the Sith","4":"Tion Medon","5":"http://swapi.co/api/planets/12/","6":"http://swapi.co/api/species/37/","7":"Utapau"},{"1":"http://swapi.co/api/films/6/","2":"http://swapi.co/api/people/35/","3":"Revenge of the Sith","4":"Padmé Amidala","5":"http://swapi.co/api/planets/8/","6":"http://swapi.co/api/species/1/","7":"Naboo"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/1/","3":"Return of the Jedi","4":"Luke Skywalker","5":"http://swapi.co/api/planets/1/","6":"http://swapi.co/api/species/1/","7":"Tatooine"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/2/","3":"Return of the Jedi","4":"C-3PO","5":"http://swapi.co/api/planets/1/","6":"http://swapi.co/api/species/2/","7":"Tatooine"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/3/","3":"Return of the Jedi","4":"R2-D2","5":"http://swapi.co/api/planets/8/","6":"http://swapi.co/api/species/2/","7":"Naboo"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/4/","3":"Return of the Jedi","4":"Darth Vader","5":"http://swapi.co/api/planets/1/","6":"http://swapi.co/api/species/1/","7":"Tatooine"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/5/","3":"Return of the Jedi","4":"Leia Organa","5":"http://swapi.co/api/planets/2/","6":"http://swapi.co/api/species/1/","7":"Alderaan"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/10/","3":"Return of the Jedi","4":"Obi-Wan Kenobi","5":"http://swapi.co/api/planets/20/","6":"http://swapi.co/api/species/1/","7":"Stewjon"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/13/","3":"Return of the Jedi","4":"Chewbacca","5":"http://swapi.co/api/planets/14/","6":"http://swapi.co/api/species/3/","7":"Kashyyyk"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/14/","3":"Return of the Jedi","4":"Han Solo","5":"http://swapi.co/api/planets/22/","6":"http://swapi.co/api/species/1/","7":"Corellia"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/16/","3":"Return of the Jedi","4":"Jabba Desilijic Tiure","5":"http://swapi.co/api/planets/24/","6":"http://swapi.co/api/species/5/","7":"Nal Hutta"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/18/","3":"Return of the Jedi","4":"Wedge Antilles","5":"http://swapi.co/api/planets/22/","6":"http://swapi.co/api/species/1/","7":"Corellia"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/20/","3":"Return of the Jedi","4":"Yoda","5":"http://swapi.co/api/planets/28/","6":"http://swapi.co/api/species/6/","7":"unknown"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/21/","3":"Return of the Jedi","4":"Palpatine","5":"http://swapi.co/api/planets/8/","6":"http://swapi.co/api/species/1/","7":"Naboo"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/22/","3":"Return of the Jedi","4":"Boba Fett","5":"http://swapi.co/api/planets/10/","6":"http://swapi.co/api/species/1/","7":"Kamino"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/25/","3":"Return of the Jedi","4":"Lando Calrissian","5":"http://swapi.co/api/planets/30/","6":"http://swapi.co/api/species/1/","7":"Socorro"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/27/","3":"Return of the Jedi","4":"Ackbar","5":"http://swapi.co/api/planets/31/","6":"http://swapi.co/api/species/8/","7":"Mon Cala"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/28/","3":"Return of the Jedi","4":"Mon Mothma","5":"http://swapi.co/api/planets/32/","6":"http://swapi.co/api/species/1/","7":"Chandrila"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/29/","3":"Return of the Jedi","4":"Arvel Crynyd","5":"http://swapi.co/api/planets/28/","6":"http://swapi.co/api/species/1/","7":"unknown"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/30/","3":"Return of the Jedi","4":"Wicket Systri Warrick","5":"http://swapi.co/api/planets/7/","6":"http://swapi.co/api/species/9/","7":"Endor"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/31/","3":"Return of the Jedi","4":"Nien Nunb","5":"http://swapi.co/api/planets/33/","6":"http://swapi.co/api/species/10/","7":"Sullust"},{"1":"http://swapi.co/api/films/3/","2":"http://swapi.co/api/people/45/","3":"Return of the Jedi","4":"Bib Fortuna","5":"http://swapi.co/api/planets/37/","6":"http://swapi.co/api/species/15/","7":"Ryloth"},{"1":"http://swapi.co/api/films/2/","2":"http://swapi.co/api/people/1/","3":"The Empire Strikes Back","4":"Luke Skywalker","5":"http://swapi.co/api/planets/1/","6":"http://swapi.co/api/species/1/","7":"Tatooine"},{"1":"http://swapi.co/api/films/2/","2":"http://swapi.co/api/people/2/","3":"The Empire Strikes Back","4":"C-3PO","5":"http://swapi.co/api/planets/1/","6":"http://swapi.co/api/species/2/","7":"Tatooine"},{"1":"http://swapi.co/api/films/2/","2":"http://swapi.co/api/people/3/","3":"The Empire Strikes Back","4":"R2-D2","5":"http://swapi.co/api/planets/8/","6":"http://swapi.co/api/species/2/","7":"Naboo"},{"1":"http://swapi.co/api/films/2/","2":"http://swapi.co/api/people/4/","3":"The Empire Strikes Back","4":"Darth Vader","5":"http://swapi.co/api/planets/1/","6":"http://swapi.co/api/species/1/","7":"Tatooine"},{"1":"http://swapi.co/api/films/2/","2":"http://swapi.co/api/people/5/","3":"The Empire Strikes Back","4":"Leia Organa","5":"http://swapi.co/api/planets/2/","6":"http://swapi.co/api/species/1/","7":"Alderaan"},{"1":"http://swapi.co/api/films/2/","2":"http://swapi.co/api/people/10/","3":"The Empire Strikes Back","4":"Obi-Wan Kenobi","5":"http://swapi.co/api/planets/20/","6":"http://swapi.co/api/species/1/","7":"Stewjon"},{"1":"http://swapi.co/api/films/2/","2":"http://swapi.co/api/people/13/","3":"The Empire Strikes Back","4":"Chewbacca","5":"http://swapi.co/api/planets/14/","6":"http://swapi.co/api/species/3/","7":"Kashyyyk"},{"1":"http://swapi.co/api/films/2/","2":"http://swapi.co/api/people/14/","3":"The Empire Strikes Back","4":"Han Solo","5":"http://swapi.co/api/planets/22/","6":"http://swapi.co/api/species/1/","7":"Corellia"},{"1":"http://swapi.co/api/films/2/","2":"http://swapi.co/api/people/18/","3":"The Empire Strikes Back","4":"Wedge Antilles","5":"http://swapi.co/api/planets/22/","6":"http://swapi.co/api/species/1/","7":"Corellia"},{"1":"http://swapi.co/api/films/2/","2":"http://swapi.co/api/people/20/","3":"The Empire Strikes Back","4":"Yoda","5":"http://swapi.co/api/planets/28/","6":"http://swapi.co/api/species/6/","7":"unknown"},{"1":"http://swapi.co/api/films/2/","2":"http://swapi.co/api/people/21/","3":"The Empire Strikes Back","4":"Palpatine","5":"http://swapi.co/api/planets/8/","6":"http://swapi.co/api/species/1/","7":"Naboo"},{"1":"http://swapi.co/api/films/2/","2":"http://swapi.co/api/people/22/","3":"The Empire Strikes Back","4":"Boba Fett","5":"http://swapi.co/api/planets/10/","6":"http://swapi.co/api/species/1/","7":"Kamino"},{"1":"http://swapi.co/api/films/2/","2":"http://swapi.co/api/people/23/","3":"The Empire Strikes Back","4":"IG-88","5":"http://swapi.co/api/planets/28/","6":"http://swapi.co/api/species/2/","7":"unknown"},{"1":"http://swapi.co/api/films/2/","2":"http://swapi.co/api/people/24/","3":"The Empire Strikes Back","4":"Bossk","5":"http://swapi.co/api/planets/29/","6":"http://swapi.co/api/species/7/","7":"Trandosha"},{"1":"http://swapi.co/api/films/2/","2":"http://swapi.co/api/people/25/","3":"The Empire Strikes Back","4":"Lando Calrissian","5":"http://swapi.co/api/planets/30/","6":"http://swapi.co/api/species/1/","7":"Socorro"},{"1":"http://swapi.co/api/films/2/","2":"http://swapi.co/api/people/26/","3":"The Empire Strikes Back","4":"Lobot","5":"http://swapi.co/api/planets/6/","6":"http://swapi.co/api/species/1/","7":"Bespin"},{"1":"http://swapi.co/api/films/7/","2":"http://swapi.co/api/people/1/","3":"The Force Awakens","4":"Luke Skywalker","5":"http://swapi.co/api/planets/1/","6":"http://swapi.co/api/species/1/","7":"Tatooine"},{"1":"http://swapi.co/api/films/7/","2":"http://swapi.co/api/people/3/","3":"The Force Awakens","4":"R2-D2","5":"http://swapi.co/api/planets/8/","6":"http://swapi.co/api/species/2/","7":"Naboo"},{"1":"http://swapi.co/api/films/7/","2":"http://swapi.co/api/people/5/","3":"The Force Awakens","4":"Leia Organa","5":"http://swapi.co/api/planets/2/","6":"http://swapi.co/api/species/1/","7":"Alderaan"},{"1":"http://swapi.co/api/films/7/","2":"http://swapi.co/api/people/13/","3":"The Force Awakens","4":"Chewbacca","5":"http://swapi.co/api/planets/14/","6":"http://swapi.co/api/species/3/","7":"Kashyyyk"},{"1":"http://swapi.co/api/films/7/","2":"http://swapi.co/api/people/14/","3":"The Force Awakens","4":"Han Solo","5":"http://swapi.co/api/planets/22/","6":"http://swapi.co/api/species/1/","7":"Corellia"},{"1":"http://swapi.co/api/films/7/","2":"http://swapi.co/api/people/27/","3":"The Force Awakens","4":"Ackbar","5":"http://swapi.co/api/planets/31/","6":"http://swapi.co/api/species/8/","7":"Mon Cala"},{"1":"http://swapi.co/api/films/7/","2":"http://swapi.co/api/people/84/","3":"The Force Awakens","4":"Finn","5":"http://swapi.co/api/planets/28/","6":"http://swapi.co/api/species/1/","7":"unknown"},{"1":"http://swapi.co/api/films/7/","2":"http://swapi.co/api/people/85/","3":"The Force Awakens","4":"Rey","5":"http://swapi.co/api/planets/28/","6":"http://swapi.co/api/species/1/","7":"unknown"},{"1":"http://swapi.co/api/films/7/","2":"http://swapi.co/api/people/86/","3":"The Force Awakens","4":"Poe Dameron","5":"http://swapi.co/api/planets/28/","6":"http://swapi.co/api/species/1/","7":"unknown"},{"1":"http://swapi.co/api/films/7/","2":"http://swapi.co/api/people/87/","3":"The Force Awakens","4":"BB8","5":"http://swapi.co/api/planets/28/","6":"http://swapi.co/api/species/2/","7":"unknown"},{"1":"http://swapi.co/api/films/7/","2":"http://swapi.co/api/people/88/","3":"The Force Awakens","4":"Captain Phasma","5":"http://swapi.co/api/planets/28/","6":"NA","7":"unknown"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>作成した<code>data_films_x_characters_1</code>を使うことで，以下のように，登場人物の故郷の惑星の構成比をグラフにすることができます． このグラフへの考察はひとまず措くとして，リレーショナルデータモデルを用いることでデータフレームの結合を自動化できることが確認できました．</p>
<p>しかし，上のような分析であれば，<code>left_join()</code>を用いてデータフレームを結合することも簡単で， あまりリレーショナルデータモデルを用いるメリットが感じられないかもしれません． そこで応用編では，リレーショナルデータモデルが本領を発揮する，より込み入った状況を考えてみます．</p>
<div class="cell">
<details class="code-fold">
<summary>登場人物の故郷の惑星の構成比のグラフ</summary>
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1">data_films_x_characters_1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb15-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">name.planets =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_lump_n</span>(name.planets, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>,</span>
<span id="cb15-3">                                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ties.method =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"first"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb15-4">           <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_relevel</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Other"</span>, </span>
<span id="cb15-5">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">after =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">Inf</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb15-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">count</span>(title, name.planets) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb15-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prop =</span> n <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(n),</span>
<span id="cb15-8">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.by =</span> title,</span>
<span id="cb15-9">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.keep =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"unused"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb15-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_rev</span>(title), prop,</span>
<span id="cb15-11">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> name.planets)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_col</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">position =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">position_stack</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">reverse =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_text</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">if_else</span>(prop <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5e-2</span>, </span>
<span id="cb15-14">                                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>,</span>
<span id="cb15-15">                                scales<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">label_percent</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">accuracy =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)(prop))),</span>
<span id="cb15-16">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">position =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">position_stack</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">vjust =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>,</span>
<span id="cb15-17">                                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">reverse =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_discrete</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"作品タイトル"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_y_continuous</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"登場人物の故郷の惑星の構成比"</span>,</span>
<span id="cb15-20">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> scales<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>percent) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_brewer</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"惑星名"</span>,</span>
<span id="cb15-22">                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">palette =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Set2"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-23">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_flip</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-24">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bottom"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-25">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guides</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guide_legend</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,</span>
<span id="cb15-26">                             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">byrow =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>))</span></code></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://uchidamizuki.quarto.pub/blog/posts/2024/01/relational-data-models-with-r-s-dm_files/figure-html/plot-starwars-1-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="応用編dmでモデルを拡張したりキーを検証したりする" class="level3">
<h3 class="anchored" data-anchor-id="応用編dmでモデルを拡張したりキーを検証したりする">2. 応用編：dmでモデルを拡張したりキーを検証したりする</h3>
<p>応用編では，Star Wars作品の登場人物の種族の構成比を調べてみます． この分析の難易度は基礎編とさほど変わりませんが，通常，扱うデータが増えるとコードが煩雑化しやすいため，リレーショナルデータモデルを使うメリットが大きくなります． さらに，リレーショナルデータモデルのメリットには，以下のようなものもあります．</p>
<ul>
<li>既存のリレーショナルデータモデルに新たなデータを追加することが可能</li>
<li>結合のためのキーの整合性を確認することが可能</li>
</ul>
<p>あらかじめ，この分析で必要となる<code>species</code>データを準備しておきます．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1">species <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">species =</span> sw_species) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb16-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unnest_wider</span>(species) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb16-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(url, name)</span>
<span id="cb16-4"></span>
<span id="cb16-5">species</span></code></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["url"],"name":[1],"type":["chr"],"align":["left"]},{"label":["name"],"name":[2],"type":["chr"],"align":["left"]}],"data":[{"1":"http://swapi.co/api/species/5/","2":"Hutt"},{"1":"http://swapi.co/api/species/6/","2":"Yoda's species"},{"1":"http://swapi.co/api/species/7/","2":"Trandoshan"},{"1":"http://swapi.co/api/species/8/","2":"Mon Calamari"},{"1":"http://swapi.co/api/species/9/","2":"Ewok"},{"1":"http://swapi.co/api/species/10/","2":"Sullustan"},{"1":"http://swapi.co/api/species/11/","2":"Neimodian"},{"1":"http://swapi.co/api/species/12/","2":"Gungan"},{"1":"http://swapi.co/api/species/13/","2":"Toydarian"},{"1":"http://swapi.co/api/species/14/","2":"Dug"},{"1":"http://swapi.co/api/species/15/","2":"Twi'lek"},{"1":"http://swapi.co/api/species/16/","2":"Aleena"},{"1":"http://swapi.co/api/species/17/","2":"Vulptereen"},{"1":"http://swapi.co/api/species/18/","2":"Xexto"},{"1":"http://swapi.co/api/species/19/","2":"Toong"},{"1":"http://swapi.co/api/species/20/","2":"Cerean"},{"1":"http://swapi.co/api/species/21/","2":"Nautolan"},{"1":"http://swapi.co/api/species/22/","2":"Zabrak"},{"1":"http://swapi.co/api/species/23/","2":"Tholothian"},{"1":"http://swapi.co/api/species/24/","2":"Iktotchi"},{"1":"http://swapi.co/api/species/25/","2":"Quermian"},{"1":"http://swapi.co/api/species/26/","2":"Kel Dor"},{"1":"http://swapi.co/api/species/27/","2":"Chagrian"},{"1":"http://swapi.co/api/species/28/","2":"Geonosian"},{"1":"http://swapi.co/api/species/29/","2":"Mirialan"},{"1":"http://swapi.co/api/species/30/","2":"Clawdite"},{"1":"http://swapi.co/api/species/31/","2":"Besalisk"},{"1":"http://swapi.co/api/species/32/","2":"Kaminoan"},{"1":"http://swapi.co/api/species/33/","2":"Skakoan"},{"1":"http://swapi.co/api/species/34/","2":"Muun"},{"1":"http://swapi.co/api/species/35/","2":"Togruta"},{"1":"http://swapi.co/api/species/36/","2":"Kaleesh"},{"1":"http://swapi.co/api/species/37/","2":"Pau'an"},{"1":"http://swapi.co/api/species/3/","2":"Wookiee"},{"1":"http://swapi.co/api/species/2/","2":"Droid"},{"1":"http://swapi.co/api/species/1/","2":"Human"},{"1":"http://swapi.co/api/species/4/","2":"Rodian"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>dmでは，<code>dm()</code>を用いて，リレーショナルデータモデルに新たにデータを追加することができます． ここでは，<code>dm_starwars_1</code>に<code>species</code>データを追加して，<code>dm_starwars_2</code>を作成してみましょう． <code>dm_draw()</code>を用いることで，モデルが更新されたことがわかります．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1">dm_starwars_2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> dm_starwars_1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb17-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dm</span>(species) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb17-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dm_add_pk</span>(species, url) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb17-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dm_add_fk</span>(people, species, species)</span>
<span id="cb17-5"></span>
<span id="cb17-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dm_draw</span>(dm_starwars_2)</span></code></pre></div>
<div class="cell-output-display">
<div class="grViz html-widget html-fill-item" id="htmlwidget-aa7f90c9438cbfb0b290" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-aa7f90c9438cbfb0b290">{"x":{"diagram":"#data_model\ndigraph {\ngraph [rankdir=LR tooltip=\"Data Model\" ]\n\nnode [margin=0 fontcolor = \"#444444\" ]\n\nedge [color = \"#555555\", arrowsize = 1, ]\n\npack=true\npackmode= \"node\"\n\n  \"films\" [id = \"films\", label = <<TABLE ALIGN=\"LEFT\" BORDER=\"1\" CELLBORDER=\"0\" CELLSPACING=\"0\" COLOR=\"#555555\">\n    <TR>\n      <TD COLSPAN=\"1\" BGCOLOR=\"#EFEBDD\" BORDER=\"0\"><FONT COLOR=\"#000000\">films<\/FONT>\n<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"url\"><U>url<\/U><\/TD>\n    <\/TR>\n  <\/TABLE>>, shape = \"plaintext\"] \n\n  \"films_x_characters\" [id = \"films_x_characters\", label = <<TABLE ALIGN=\"LEFT\" BORDER=\"1\" CELLBORDER=\"0\" CELLSPACING=\"0\" COLOR=\"#555555\">\n    <TR>\n      <TD COLSPAN=\"1\" BGCOLOR=\"#EFEBDD\" BORDER=\"0\"><FONT COLOR=\"#000000\">films_x_characters<\/FONT>\n<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"url\">url<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"characters\">characters<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"url, characters\"><U>url, characters<\/U><\/TD>\n    <\/TR>\n  <\/TABLE>>, shape = \"plaintext\"] \n\n  \"people\" [id = \"people\", label = <<TABLE ALIGN=\"LEFT\" BORDER=\"1\" CELLBORDER=\"0\" CELLSPACING=\"0\" COLOR=\"#555555\">\n    <TR>\n      <TD COLSPAN=\"1\" BGCOLOR=\"#EFEBDD\" BORDER=\"0\"><FONT COLOR=\"#000000\">people<\/FONT>\n<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"url\"><U>url<\/U><\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"homeworld\">homeworld<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"species\">species<\/TD>\n    <\/TR>\n  <\/TABLE>>, shape = \"plaintext\"] \n\n  \"planets\" [id = \"planets\", label = <<TABLE ALIGN=\"LEFT\" BORDER=\"1\" CELLBORDER=\"0\" CELLSPACING=\"0\" COLOR=\"#555555\">\n    <TR>\n      <TD COLSPAN=\"1\" BGCOLOR=\"#EFEBDD\" BORDER=\"0\"><FONT COLOR=\"#000000\">planets<\/FONT>\n<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"url\"><U>url<\/U><\/TD>\n    <\/TR>\n  <\/TABLE>>, shape = \"plaintext\"] \n\n  \"species\" [id = \"species\", label = <<TABLE ALIGN=\"LEFT\" BORDER=\"1\" CELLBORDER=\"0\" CELLSPACING=\"0\" COLOR=\"#555555\">\n    <TR>\n      <TD COLSPAN=\"1\" BGCOLOR=\"#EFEBDD\" BORDER=\"0\"><FONT COLOR=\"#000000\">species<\/FONT>\n<\/TD>\n    <\/TR>\n    <TR>\n      <TD ALIGN=\"LEFT\" BGCOLOR=\"#FFFFFF\" PORT=\"url\"><U>url<\/U><\/TD>\n    <\/TR>\n  <\/TABLE>>, shape = \"plaintext\"] \n\n\"films_x_characters\":\"url\"->\"films\":\"url\" [id=\"films_x_characters_1\"]\n\"films_x_characters\":\"characters\"->\"people\":\"url\" [id=\"films_x_characters_2\"]\n\"people\":\"homeworld\"->\"planets\":\"url\" [id=\"people_1\"]\n\"people\":\"species\"->\"species\":\"url\" [id=\"people_2\"]\n}","config":{"engine":null,"options":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>次に，結合のためのキーの整合性を確認してみましょう．こうした検証は，<code>dm_examine_constraints()</code>を用いることで可能です． ここでは，上でありがちなミスとして挙げた，2種類のミスを含んだモデルを作成して，<code>dm_examine_constraints()</code>の挙動を確認してみましょう． ここで，<code>dm_starwars_2_wrong_data</code>は，<code>species</code>データの1行目が削除されたデータで，データがMECE（「漏れなく・ダブりなく」）でないものです． また，<code>dm_starwars_2_wrong_pk</code>は，<code>species</code>データの主キーを取り違えたものです．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1">dm_starwars_2_wrong_data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> dm_starwars_1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb18-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dm</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">species =</span> species <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb18-3">       <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">slice</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb18-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dm_add_pk</span>(species, url) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb18-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dm_add_fk</span>(people, species, species)</span>
<span id="cb18-6"></span>
<span id="cb18-7">dm_starwars_2_wrong_pk <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> dm_starwars_1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb18-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dm</span>(species) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb18-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dm_add_pk</span>(species, name) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb18-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dm_add_fk</span>(people, species, species)</span></code></pre></div>
</div>
<p><code>dm_examine_constraints()</code>の結果を見てみましょう． 正しいモデルである<code>dm_starwars_2</code>では，<code>ℹ All constraints satisfied.</code>というメッセージが表示され，モデルのキーが整合していることがわかります． 一方で，<code>dm_starwars_2_wrong_data</code>と<code>dm_starwars_2_wrong_pk</code>では，<code>! Unsatisfied constraints:</code>というメッセージが表示されています． これは，<code>species</code>データの主キーに含まれるはずのデータが含まれていないことに起因します． このように，<code>dm_examine_constraints()</code>を用いることで，簡単にモデルのキーの整合性を確認することができます．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dm_examine_constraints</span>(dm_starwars_2))</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>ℹ All constraints satisfied.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dm_examine_constraints</span>(dm_starwars_2_wrong_data))</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>! Unsatisfied constraints:</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>• Table `people`: foreign key `species` into table `species`: values of `people$species` not in `species$url`: http://swapi.co/api/species/5/ (1)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dm_examine_constraints</span>(dm_starwars_2_wrong_pk))</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>! Unsatisfied constraints:</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>• Table `people`: foreign key `species` into table `species`: values of `people$species` not in `species$name`: http://swapi.co/api/species/1/ (35), http://swapi.co/api/species/2/ (5), http://swapi.co/api/species/12/ (3), http://swapi.co/api/species/15/ (2), http://swapi.co/api/species/22/ (2), …</code></pre>
</div>
</div>
<p>以上のように，<code>dm()</code>でリレーショナルデータモデルに新たなデータを追加したり，<code>dm_examine_constraints()</code>で結合のためのキーの整合性を確認したりすることができることがわかりました． 最後に，作成したリレーショナルデータモデル<code>dm_starwars_2</code>を用いて，Star Wars作品の登場人物の種族の構成比をグラフ化したものが以下の図です．ここでも，考察は割愛します．</p>
<div class="cell">
<details class="code-fold">
<summary>登場人物の種族の構成比のグラフ</summary>
<div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1">dm_starwars_2 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb27-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dm_flatten_to_tbl</span>(films_x_characters,</span>
<span id="cb27-3">                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.recursive =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb27-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">name.species =</span> name.species <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb27-5">           <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_na_value_to_level</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Other"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb27-6">           <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_lump_n</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>,</span>
<span id="cb27-7">                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ties.method =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"first"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb27-8">           <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_relevel</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Other"</span>, </span>
<span id="cb27-9">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">after =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">Inf</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb27-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">count</span>(title, name.species) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb27-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prop =</span> n <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(n),</span>
<span id="cb27-12">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.by =</span> title,</span>
<span id="cb27-13">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.keep =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"unused"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb27-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_rev</span>(title), prop,</span>
<span id="cb27-15">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> name.species)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb27-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_col</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">position =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">position_stack</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">reverse =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb27-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_text</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">if_else</span>(prop <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5e-2</span>, </span>
<span id="cb27-18">                                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>,</span>
<span id="cb27-19">                                scales<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">label_percent</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">accuracy =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)(prop))),</span>
<span id="cb27-20">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">position =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">position_stack</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">vjust =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>,</span>
<span id="cb27-21">                                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">reverse =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb27-22">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_discrete</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"作品タイトル"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb27-23">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_y_continuous</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"登場人物の種族の構成比"</span>,</span>
<span id="cb27-24">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> scales<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>percent) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb27-25">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_brewer</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"種族名"</span>,</span>
<span id="cb27-26">                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">palette =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Set2"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb27-27">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_flip</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb27-28">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bottom"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb27-29">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guides</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guide_legend</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,</span>
<span id="cb27-30">                             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">byrow =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>))</span></code></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://uchidamizuki.quarto.pub/blog/posts/2024/01/relational-data-models-with-r-s-dm_files/figure-html/plot-starwars-2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="まとめ" class="level2">
<h2 class="anchored" data-anchor-id="まとめ">まとめ</h2>
<p>この記事では，dmを使ってリレーショナルデータモデルを構築する方法を紹介しました． dmを使って，ひとたびリレーショナルデータモデルを構築してしまえば， データ間の関係を自ら管理する必要がなくなり，<code>dm_flatten_to_tbl()</code>でデータの結合を自動的に行うことができます． それ以外にも，dmでは，<code>dm()</code>によるモデル拡張や<code>dm_examine_constraints()</code>結合のためのキーの整合性の確認など， データ前処理の質を高めるための便利な機能が提供されています．</p>
</section>
<section id="参考文献" class="level2">
<h2 class="anchored" data-anchor-id="参考文献">参考文献</h2>
<ul>
<li><a href="https://dm.cynkra.com/index.html">dmパッケージのサイト</a></li>
<li><a href="https://gihyo.jp/book/2018/978-4-7741-9647-3">前処理大全［データ分析のためのSQL/R/Python実践テクニック］</a></li>
<li><a href="https://pkg.garrickadenbuie.com/starwarsdb/">starwarsdb</a>
<ul>
<li>Star WarsのリレーショナルデータモデルがCRANからダウンロードできます</li>
</ul></li>
</ul>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">脚注</h2>

<ol>
<li id="fn1"><p>幸いなことに，最近のdplyrでは，結合先のデータの”ダブり”に対して警告が出るようになりました．↩︎</p></li>
<li id="fn2"><p>その作業を行ったのが過去の自分であっても他の誰かであっても，完全に作業が正しかったという自信は持てないものです．↩︎</p></li>
<li id="fn3"><p>repurrrsiveのエクスポートするデータのうち，名前が<code>sw_</code>で始まるデータがStar Warsに関するもので，<code>sw_</code>以降の部分がデータの内容を表しています．↩︎</p></li>
<li id="fn4"><p>repurrrsiveのデータはリスト形式で提供されているため，<a href="https://tidyr.tidyverse.org/articles/rectangle.html">こちらの記事</a>を参考にデータフレームに変換しました．↩︎</p></li>
<li id="fn5"><p>ここでは，<code>sw_people</code>の<code>species</code>列は不要ですが，次の分析で使用するため選択しておきます．↩︎</p></li>
<li id="fn6"><p>ここでは，データフレーム間の関係を図示するために，mermaidを使用しました．↩︎</p></li>
<li id="fn7"><p>作品と登場人物には，明確な上下関係はありませんので，<code>characters_x_films</code>という名称でも構いません．↩︎</p></li>
<li id="fn8"><p><code>films</code>・<code>people</code>・<code>planets</code>については，<code>url</code>列が主キーとなり，<code>films_x_characters</code>については，<code>url</code>・<code>characters</code>列の2列の組合せが主キーとなります．↩︎</p></li>
<li id="fn9"><p>上のイメージの矢印に従って，<code>films_x_characters</code>の<code>url</code>・<code>characters</code>列を，それぞれ<code>films</code>・<code>people</code>の<code>url</code>列に対応付けます．さらに，<code>people</code>の<code>homeworld</code>列を<code>planets</code>の<code>url</code>列に対応付けます．↩︎</p></li>
<li id="fn10"><p>dmでは，各データを”テーブル”と呼びます．↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>dm</category>
  <category>R</category>
  <category>Japanese</category>
  <guid>https://uchidamizuki.quarto.pub/blog/posts/2024/01/relational-data-models-with-r-s-dm.html</guid>
  <pubDate>Sat, 27 Jan 2024 15:00:00 GMT</pubDate>
  <media:content url="https://uchidamizuki.quarto.pub/blog/posts/2024/01/relational-data-models-with-r-s-dm/mermaid-figure-2.png" medium="image" type="image/png" height="118" width="144"/>
</item>
<item>
  <title>Rの数値積分で円の面積を求める</title>
  <link>https://uchidamizuki.quarto.pub/blog/posts/2023/09/circle-area-by-numerical-integration-in-r.html</link>
  <description><![CDATA[ 





<section id="はじめに" class="level2">
<h2 class="anchored" data-anchor-id="はじめに">はじめに</h2>
<p>最近，R statsパッケージ<sup>1</sup>の<code>integrate()</code> 関数で一次元関数の数値積分ができることを知りました．そこで，この記事では，<a href="https://mathwords.net/enmensekibun">こちらの記事</a>を参考に積分で円の面積を計算してみました．</p>
</section>
<section id="半円を描く関数" class="level2">
<h2 class="anchored" data-anchor-id="半円を描く関数">半円を描く関数</h2>
<p>半径<img src="https://latex.codecogs.com/png.latex?r">の半円を描く関数は 式&nbsp;1 と表せます．Rで書くと<code>semicircle()</code> 関数のようになります．</p>
<p><span id="eq-semicircle"><img src="https://latex.codecogs.com/png.latex?%0Ay%20=%20%5Csqrt%7Br%5E2%20-%20x%5E2%7D%20%5Cqquad%20(-r%20%5Cle%20x%20%5Cle%20r)%0A%5Ctag%7B1%7D"></span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1">semicircle <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(x, radius) {</span>
<span id="cb1-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>(radius<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb1-3">}</span></code></pre></div>
</div>
<p>実装した<code>semicircle()</code> 関数で半径<img src="https://latex.codecogs.com/png.latex?r%20=%205">の半円を描いてみましょう．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">radius <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span></span>
<span id="cb2-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">curve</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">semicircle</span>(x, radius), <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>radius, radius,</span>
<span id="cb2-3">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">asp =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># アスペクト比を1:1にする</span></span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://uchidamizuki.quarto.pub/blog/posts/2023/09/circle-area-by-numerical-integration-in-r_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="数値積分で円の面積を求める" class="level2">
<h2 class="anchored" data-anchor-id="数値積分で円の面積を求める">数値積分で円の面積を求める</h2>
<p>次に，<code>stats::integrate()</code> 関数を用いて，さきほど書いた<code>semicircle()</code> を数値積分してみましょう．半径<img src="https://latex.codecogs.com/png.latex?r%20=%205">の場合，積分すると半円の面積<img src="https://latex.codecogs.com/png.latex?%5Cfrac%7B1%7D%7B2%7D%5Cpi%20r%5E2">とほぼ等しくなることが確認できます．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 半径を5とする</span></span>
<span id="cb3-2">radius <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span></span>
<span id="cb3-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">integrate</span>(semicircle, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>radius, radius, <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># -radiusからradiusまでの範囲で積分する</span></span>
<span id="cb3-4">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">radius =</span> radius)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>39.26991 with absolute error &lt; 2.5e-08</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1">pi <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 39.26991</code></pre>
</div>
</div>
<p>そのため，円の面積を近似的に求める<code>circle_area_approx()</code>が以下のように書けます（数値積分の結果は，<code>stats::integrate()</code> 関数の戻り値の<code>value</code> に格納されています）．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1">circle_area_approx <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(radius) {</span>
<span id="cb7-2">  out <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">integrate</span>(semicircle, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>radius, radius,</span>
<span id="cb7-3">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">radius =</span> radius)</span>
<span id="cb7-4">  out<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>value <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb7-5">}</span>
<span id="cb7-6"></span>
<span id="cb7-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">circle_area_approx</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 78.53982</code></pre>
</div>
</div>
<p>最後に，半径<img src="https://latex.codecogs.com/png.latex?1%20%5Cle%20r%20%5Cle%2010">の範囲で近似値<code>circle_area_approx()</code>と理論値<code>circle_area_true()</code>（<img src="https://latex.codecogs.com/png.latex?%5Cpi%20r%5E2">）を比較してみましょう．</p>
<p>計算の結果，近似値と理論値で円の面積がほぼ等しいことが確認できました．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1">circle_area_true <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(radius) {</span>
<span id="cb9-2">  pi <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> radius <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb9-3">}</span>
<span id="cb9-4"></span>
<span id="cb9-5">data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">radius =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span>
<span id="cb9-6">data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>circle_area_approx <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sapply</span>(data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>radius, circle_area_approx)</span>
<span id="cb9-7">data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>circle_area_true <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sapply</span>(data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>radius, circle_area_true)</span>
<span id="cb9-8">knitr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kable</span>(data)</span></code></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">radius</th>
<th style="text-align: right;">circle_area_approx</th>
<th style="text-align: right;">circle_area_true</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">3.141593</td>
<td style="text-align: right;">3.141593</td>
</tr>
<tr class="even">
<td style="text-align: right;">2</td>
<td style="text-align: right;">12.566371</td>
<td style="text-align: right;">12.566371</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3</td>
<td style="text-align: right;">28.274334</td>
<td style="text-align: right;">28.274334</td>
</tr>
<tr class="even">
<td style="text-align: right;">4</td>
<td style="text-align: right;">50.265482</td>
<td style="text-align: right;">50.265482</td>
</tr>
<tr class="odd">
<td style="text-align: right;">5</td>
<td style="text-align: right;">78.539816</td>
<td style="text-align: right;">78.539816</td>
</tr>
<tr class="even">
<td style="text-align: right;">6</td>
<td style="text-align: right;">113.097335</td>
<td style="text-align: right;">113.097335</td>
</tr>
<tr class="odd">
<td style="text-align: right;">7</td>
<td style="text-align: right;">153.938040</td>
<td style="text-align: right;">153.938040</td>
</tr>
<tr class="even">
<td style="text-align: right;">8</td>
<td style="text-align: right;">201.061930</td>
<td style="text-align: right;">201.061930</td>
</tr>
<tr class="odd">
<td style="text-align: right;">9</td>
<td style="text-align: right;">254.469005</td>
<td style="text-align: right;">254.469005</td>
</tr>
<tr class="even">
<td style="text-align: right;">10</td>
<td style="text-align: right;">314.159265</td>
<td style="text-align: right;">314.159265</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="おわりに" class="level2">
<h2 class="anchored" data-anchor-id="おわりに">おわりに</h2>
<p><code>stats::integrate()</code> 関数を使えば，簡単に一次元関数の数値積分ができることがわかりました．</p>
<section id="注意点" class="level3">
<h3 class="anchored" data-anchor-id="注意点">注意点</h3>
<p><code>stats::integrate()</code> 関数では，<img src="https://latex.codecogs.com/png.latex?-%5Cinfty%20%5Cle%20x%20%5Cle%20%5Cinfty">の範囲での数値積分も可能ですが，<img src="https://latex.codecogs.com/png.latex?10%5E%7B-6%7D%20%5Cle%20x%20%5Cle%2010%5E6">のような大きな値を代入すると数値積分が適切に行われませんのでご注意ください．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># OK</span></span>
<span id="cb10-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">integrate</span>(dnorm, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">Inf</span>, <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">Inf</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1 with absolute error &lt; 9.4e-05</code></pre>
</div>
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># NG</span></span>
<span id="cb12-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">integrate</span>(dnorm, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e6</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e6</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0 with absolute error &lt; 0</code></pre>
</div>
</div>


</section>
</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">脚注</h2>

<ol>
<li id="fn1"><p>statsパッケージは，Rにデフォルトで入っているパッケージの一つです．↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>R</category>
  <category>Japanese</category>
  <guid>https://uchidamizuki.quarto.pub/blog/posts/2023/09/circle-area-by-numerical-integration-in-r.html</guid>
  <pubDate>Sat, 09 Sep 2023 15:00:00 GMT</pubDate>
</item>
<item>
  <title>Quartoを活用してTokyo.Rで発表しました</title>
  <link>https://uchidamizuki.quarto.pub/blog/posts/2023/09/presented-at-tokyor-using-quarto.html</link>
  <description><![CDATA[ 





<section id="発表概要" class="level2">
<h2 class="anchored" data-anchor-id="発表概要">発表概要</h2>
<p><a href="https://tokyor.connpass.com/event/292545/">第108回R勉強会@東京（#TokyoR）</a>のLTにてe-Stat APIを利用するためのRパッケージであるjpstatパッケージについて紹介しました<sup>1</sup>．</p>
<p>LTとは，Lightning Talks（ライトニングトーク）の略で，短時間のプレゼンテーションのことです．Tokyo.Rでは，1人あたりの発表時間は5分でした．</p>
<p>当日のプレゼンテーション資料は<a href="https://uchidamizuki.github.io/slide-estat-with-r/">こちら</a>です．</p>
<iframe class="slide-deck" src="https://uchidamizuki.github.io/slide-estat-with-r/"></iframe>
</section>
<section id="スライド作成について" class="level2">
<h2 class="anchored" data-anchor-id="スライド作成について">スライド作成について</h2>
<p>これまでQuartoをGitHubのREADMEやサイト作成などに活用してきましたが，今回，はじめてスライド作成に挑戦してみました．</p>
<p>以下のページを参考にしながら，自作パッケージのjpstatを紹介するスライドを試しに作ってみたところ，案外，簡単にスライドが作成でき，折角なのでR勉強会で発表してみました．</p>
<ul>
<li><p><a href="https://quarto.org/docs/presentations/" class="uri">https://quarto.org/docs/presentations/</a></p></li>
<li><p><a href="https://quarto.org/docs/presentations/revealjs/" class="uri">https://quarto.org/docs/presentations/revealjs/</a></p></li>
</ul>
<p>ソースコードは<a href="https://github.com/UchidaMizuki/slide-estat-with-r">こちら</a>です．Quartoは，<a href="https://github.com/UchidaMizuki/slide-estat-with-r/blob/main/slide-estat-with-r.qmd">こちら</a>のqmd（Quarto Markdown）ファイルで記述されてます．</p>
<p>以下では，Quartoとreveal.jsによるスライド作成で今回，特に便利と感じた機能を紹介します．</p>
<section id="便利機能①コードのハイライティング機能" class="level3">
<h3 class="anchored" data-anchor-id="便利機能①コードのハイライティング機能">便利機能①：<a href="https://quarto.org/docs/presentations/revealjs/#line-highlighting">コードのハイライティング</a>機能</h3>
<p>以下のように<code>code-line-numbers</code> を指定することでコードの一部の行をハイライトすることができます．</p>
<p>ここでは，<code>code-line-numbers: "2-3"</code> で2・3行目をハイライトしています．さらに，<code>code-line-numbers: "1|2-3"</code> のように，<code>|</code> で区切ることでハイライト先を推移させることもできるようです．</p>
<p>ハイライト機能は，一部のコードのみに注目を集めたい場合に，非常に便利です．</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb1-1"><span class="in" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">```{r}</span></span>
<span id="cb1-2"><span class="in" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#| echo: true</span></span>
<span id="cb1-3"><span class="in" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#| code-line-numbers: "2-3"</span></span>
<span id="cb1-4"></span>
<span id="cb1-5"><span class="in" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">estat(statsDataId = "0003343671") |&gt; </span></span>
<span id="cb1-6"><span class="in" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  activate(cat01) |&gt; </span></span>
<span id="cb1-7"><span class="in" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">  filter(str_detect(name, "チョコレート"))</span></span>
<span id="cb1-8"><span class="in" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">```</span></span></code></pre></div>
</section>
<section id="便利機能②自動アニメーションフェードイン機能" class="level3">
<h3 class="anchored" data-anchor-id="便利機能②自動アニメーションフェードイン機能">便利機能②：<a href="https://quarto.org/docs/presentations/revealjs/advanced.html#auto-animate">自動アニメーション</a>・フェードイン機能</h3>
<p><code>##</code> から始まる各スライドのタイトルの右などに<code>{auto-animate="true"}</code> をつけることで次のページの記述と共通する記述を自動で探し出してアニメーション化してくれます．</p>
<p>前後のスライドで記述の繰り返しがある場合には，自動アニメーション機能を使うことで文脈のつながりがわかりやすくなるのではないかと感じました．</p>
<p>また，<code>::: {.fragment .fade-in}</code> を使用することで，スライドの途中で記述を表示させることもできます．こちらも特定の記述に注目してほしい場合に有用かと思います．</p>
</section>
<section id="便利機能③タイトルフッター設定機能" class="level3">
<h3 class="anchored" data-anchor-id="便利機能③タイトルフッター設定機能">便利機能③：タイトル・フッター設定機能</h3>
<p>タイトルスライドや全スライド共通のフッターは，qmdファイルの上部に以下のように記載することで自動でレイアウトされます．</p>
<p>ここでは，タイトル以外にも，サブタイトル・著者・日付も設定していますが，これらのフォントサイズなどを別途指定しなくても大丈夫でした．</p>
<p>また，今回はreveal.jsのデフォルトのテーマを使用しましたが，<a href="https://quarto.org/docs/presentations/revealjs/themes.html">こちら</a>のようにテーマを変更することもできます．</p>
<pre><code>---
title: "e-Stat🤝R"
subtitle: "Tokyo.R #108"
author: UchidaMizuki
date: "2023-09-02"
footer: &lt;https://github.com/UchidaMizuki/jpstat&gt;
format: 
  revealjs
---</code></pre>
</section>
</section>
<section id="まとめ" class="level2">
<h2 class="anchored" data-anchor-id="まとめ">まとめ</h2>
<p>Quartoを使うことでLT発表にちょうどよいプレゼンテーション資料を簡単につくれることが実感できました．</p>
<p>ちなみに，これまでもQuartoで作成したページのGitHub Pagesへの公開を行ってきましたが，今回のreveal.jsのスライドも<a href="https://quarto.org/docs/publishing/github-pages.html#publish-command">Publish Command</a>を利用することで簡単に公開することができました<sup>2</sup>．</p>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">脚注</h2>

<ol>
<li id="fn1"><p>第108回Tokyo.Rのイベント申込者はちょうど108人だったようです．↩︎</p></li>
<li id="fn2"><p>GitHub Actionsによる自動更新はうまくいかなったため，今回は，RStudioのTerminalから手動で<code>quarto publish gh-pages</code> を実行しました．↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>e-Stat</category>
  <category>LT</category>
  <category>Tokyo.R</category>
  <category>R</category>
  <category>Japanese</category>
  <guid>https://uchidamizuki.quarto.pub/blog/posts/2023/09/presented-at-tokyor-using-quarto.html</guid>
  <pubDate>Sat, 02 Sep 2023 15:00:00 GMT</pubDate>
</item>
<item>
  <title>なぜベイズの定理が重要なのかーPCR検査を例にー</title>
  <link>https://uchidamizuki.quarto.pub/blog/posts/2023/04/why-is-bayes-theorem-important.html</link>
  <description><![CDATA[ 





<section id="ベイズの定理とは" class="level2">
<h2 class="anchored" data-anchor-id="ベイズの定理とは">ベイズの定理とは？</h2>
<p>この記事では，コロナ禍で普及したPCR検査を例に，統計学において最も有名な定理の一つであるベイズの定理の重要性について説明したいと思います．</p>
<p>ベイズの定理は， 式&nbsp;1 のように表すことができます．</p>
<p><span id="eq-bayes"><img src="https://latex.codecogs.com/png.latex?%0AP(A%7CB)%20%5Cpropto%20P(B%7CA)%20P(A)%0A%5Ctag%7B1%7D"></span></p>
<p>式&nbsp;1 は，以下のことを示しています．</p>
<ul>
<li>ある結果<img src="https://latex.codecogs.com/png.latex?B">が生じた場合に，それが原因<img src="https://latex.codecogs.com/png.latex?A">によるものである確率<img src="https://latex.codecogs.com/png.latex?P(A%7CB)">は</li>
<li>ある原因<img src="https://latex.codecogs.com/png.latex?A">の生じる確率<img src="https://latex.codecogs.com/png.latex?P(A)">とある原因<img src="https://latex.codecogs.com/png.latex?A">のもとで結果<img src="https://latex.codecogs.com/png.latex?B">が生じる確率<img src="https://latex.codecogs.com/png.latex?P(B%7CA)">の掛け算に比例（<img src="https://latex.codecogs.com/png.latex?%5Cpropto">）する</li>
</ul>
<p>もっと身近なもので例えてみましょう． たとえば，</p>
<ul>
<li>原因<img src="https://latex.codecogs.com/png.latex?A">：新型コロナへの感染の有無</li>
<li>結果<img src="https://latex.codecogs.com/png.latex?B">：PCR検査などでの診断結果</li>
</ul>
<p>と考えれば， 式&nbsp;1 を 式&nbsp;2 のように置き換えることができます．</p>
<p><span id="eq-bayes-covid19"><img src="https://latex.codecogs.com/png.latex?%0AP(%E6%84%9F%E6%9F%93%E3%81%AE%E6%9C%89%E7%84%A1%7C%E8%A8%BA%E6%96%AD%E7%B5%90%E6%9E%9C)%20%5Cpropto%20P(%E8%A8%BA%E6%96%AD%E7%B5%90%E6%9E%9C%7C%E6%84%9F%E6%9F%93%E3%81%AE%E6%9C%89%E7%84%A1)%20P(%E6%84%9F%E6%9F%93%E3%81%AE%E6%9C%89%E7%84%A1)%0A%5Ctag%7B2%7D"></span></p>
</section>
<section id="なぜベイズの定理が重要なのか" class="level2">
<h2 class="anchored" data-anchor-id="なぜベイズの定理が重要なのか">なぜベイズの定理が重要なのか？</h2>
<p>式&nbsp;2 に基づき，ベイズの定理の重要性について考えてみましょう． 実は， 式&nbsp;2 に示したベイズの定理に出てくる3つの確率は，どれも非常に重要な指標と対応しています（下表参照）． つまり， 式&nbsp;2 からは，検査の精度（感度・特異度）が高くても，検査前確率が低ければ陽性的中率が低くなることなどがわかります．</p>
<table class="table">
<colgroup>
<col style="width: 29%">
<col style="width: 70%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">確率</th>
<th style="text-align: center;"><strong>医療分野で対応する指標</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"><img src="https://latex.codecogs.com/png.latex?P(%E8%A8%BA%E6%96%AD%E7%B5%90%E6%9E%9C%7C%E6%84%9F%E6%9F%93%E3%81%AE%E6%9C%89%E7%84%A1)"></td>
<td style="text-align: center;"><p><strong>検査後確率</strong>：統計学では<strong>事後確率</strong>と呼ばれる</p>
<ul>
<li><strong>陽性的中率</strong>：陽性と診断されたとき実際に感染</li>
<li><strong>陰性的中率</strong>：陰性と診断されたとき実際に未感染</li>
</ul></td>
</tr>
<tr class="even">
<td style="text-align: center;"><img src="https://latex.codecogs.com/png.latex?P(%E8%A8%BA%E6%96%AD%E7%B5%90%E6%9E%9C%7C%E6%84%9F%E6%9F%93%E3%81%AE%E6%9C%89%E7%84%A1)"></td>
<td style="text-align: center;"><ul>
<li><strong>感度</strong>：感染者が陽性と診断される確率↔︎<strong>偽陰性</strong>に関連</li>
<li><strong>特異度</strong>：未感染者が陰性と診断される確率↔︎<strong>偽陽性</strong>に関連</li>
</ul></td>
</tr>
<tr class="odd">
<td style="text-align: center;"><img src="https://latex.codecogs.com/png.latex?P(%E6%84%9F%E6%9F%93%E3%81%AE%E6%9C%89%E7%84%A1)"></td>
<td style="text-align: center;"><p><strong>検査前確率</strong>：統計学では<strong>事前確率</strong>と呼ばれる</p>
<ul>
<li>検査対象者のなかでの感染者の割合</li>
</ul></td>
</tr>
</tbody>
</table>
<p>たとえば，以下のような状況を考えてみましょう．</p>
<ul>
<li>感度・特異度はともに99 %（偽陰性・偽陽性がいずれも1 %の確率で生じる）</li>
<li>検査前確率は1 %（感染者は100 人中1 人で残りの99 人は未感染者）</li>
</ul>
<p>この場合，陽性と診断された場合に感染者である確率<img src="https://latex.codecogs.com/png.latex?P(%E6%84%9F%E6%9F%93%7C%E9%99%BD%E6%80%A7)">と，陽性と診断された場合に未感染者である確率<img src="https://latex.codecogs.com/png.latex?P(%E6%9C%AA%E6%84%9F%E6%9F%93%7C%E9%99%BD%E6%80%A7)">は， それぞれ 式&nbsp;3 となります．</p>
<p><span id="eq-bayes-covid19-positive"><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign%7D%0A%20%20P(%E6%84%9F%E6%9F%93%7C%E9%99%BD%E6%80%A7)%20%5Cpropto%20P(%E9%99%BD%E6%80%A7%7C%E6%84%9F%E6%9F%93)P(%E6%84%9F%E6%9F%93)%20&amp;=%200.99%20%5Ctimes%200.01%20=%200.0099%20%5C%5C%0A%20%20P(%E6%9C%AA%E6%84%9F%E6%9F%93%7C%E9%99%BD%E6%80%A7)%20%5Cpropto%20P(%E9%99%BD%E6%80%A7%7C%E6%9C%AA%E6%84%9F%E6%9F%93)P(%E6%9C%AA%E6%84%9F%E6%9F%93)%20&amp;=%20(1%20-%200.99)%20%5Ctimes%20(1%20-%200.01)%20=%200.0099%0A%5Cend%7Balign%7D%0A%5Ctag%7B3%7D"></span></p>
<p>式&nbsp;3 より，<img src="https://latex.codecogs.com/png.latex?P(%E6%84%9F%E6%9F%93%7C%E9%99%BD%E6%80%A7)">と<img src="https://latex.codecogs.com/png.latex?P(%E6%9C%AA%E6%84%9F%E6%9F%93%7C%E9%99%BD%E6%80%A7)">は等しいことがわかり， 陽性的中率は50 %となります． つまり，陽性と診断された検査対象者のなかで，実際に，感染者である人は2人に1人しかいないことがわかります．</p>
<p>このように，ベイズの定理を用いることで 「検査の精度（感度・特異度）が高くても検査前確率が低ければ陽性的中率が低くなってしまう」といった 重要な関係性が明らかとなります．</p>
</section>
<section id="まとめ" class="level2">
<h2 class="anchored" data-anchor-id="まとめ">まとめ</h2>
<p>コロナ禍で普及したPCR検査を例に，ベイズの定理の重要性について説明しました．</p>
<p>現実に即した計算事例に興味がある場合は， <a href="https://www.stat.go.jp/library/pdf/cgogai3102.pdf" target="_blank">統計局の公開しているコラム</a>もご一読されることをおすすめします．</p>


</section>

 ]]></description>
  <category>Bayes</category>
  <category>R</category>
  <category>Japanese</category>
  <guid>https://uchidamizuki.quarto.pub/blog/posts/2023/04/why-is-bayes-theorem-important.html</guid>
  <pubDate>Sat, 29 Apr 2023 15:00:00 GMT</pubDate>
  <media:content url="https://uchidamizuki.quarto.pub/blog/posts/2023/04/why-is-bayes-theorem-important/bayes-theorem.png" medium="image" type="image/png" height="14" width="144"/>
</item>
<item>
  <title>世代間の「1票の格差」を定量化してみる</title>
  <link>https://uchidamizuki.quarto.pub/blog/posts/2023/04/quantify-vote-disparity-between-generations.html</link>
  <description><![CDATA[ 





<section id="票の格差とは" class="level2">
<h2 class="anchored" data-anchor-id="票の格差とは">「1票の格差」とは？</h2>
<p>ちょうど選挙シーズンですので<sup>1</sup>，オープンデータを使って，しばしば問題になる「1票の格差」を定量化してみたいと思います．</p>
<p>「1票の格差」は，通常，議員1人あたりの有権者数が地域（選挙区）によって異なる（≒議員1人を当選させるために必要な票数が地域によって異なる）ことを指します．たとえば，2022年の参議院選挙では，「1票の格差」が最大で3.03倍であったとされています<sup>2</sup>．</p>
<p>現在，日本の都市部と地方は以下の表のような関係にあるとされ，「1票の格差」が「地方で新幹線が整備される一方で東京の通勤ラッシュが解消されない」といった経済効率性の低下などを引き起こすことが問題視されています<sup>3</sup>．</p>
<table class="table">
<colgroup>
<col style="width: 15%">
<col style="width: 50%">
<col style="width: 33%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">地域</th>
<th style="text-align: center;">お金の流れ（<u>地方交付税</u>など）</th>
<th style="text-align: center;">政治的平等（「1票の格差」）</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">都市部</td>
<td style="text-align: center;">地方にお金を「支払う」</td>
<td style="text-align: center;"><p>「1票の価値」が軽く</p>
<p>都市部「冷遇」</p></td>
</tr>
<tr class="even">
<td style="text-align: center;">地方</td>
<td style="text-align: center;">都市部からお金を「受け取る」</td>
<td style="text-align: center;"><p>「1票の価値」が重く</p>
<p>地方「優遇」</p></td>
</tr>
</tbody>
</table>
<p>一方で，今後，東京一極集中などにより地方の社会課題が一層深刻になることが予想されます．そのため，「1票の価値」を完全に等しくすれば，むしろ地方の「冷遇」につながるといった懸念もあります．</p>
<p>このように，「1票の格差」の是正は，決して簡単な道のりとはいえませんが，引き続き是正に向けた取り組みを進めていく必要があるといえるでしょう．</p>
<section id="世代間の1票の格差とは" class="level3">
<h3 class="anchored" data-anchor-id="世代間の1票の格差とは">世代間の「1票の格差」とは？</h3>
<p>ここまで紹介した地域間の「1票の格差」に加えて，世代間にも「1票の格差」が存在するといわれています<sup>4</sup>．これは，少子高齢化により，若年層の有権者数に対して高齢者層の有権者数が多くなることにより引き起こされるものです<sup>5</sup>．</p>
<p>さきほど示した都市・地方部の関係と同様に，若年層と高齢者層は，以下の表のような関係にあると考えられます．地方における人口減少・人手不足が深刻となった最近になってようやく，国は，少子化対策を国の最重要課題に位置づけましたが，これまで，こうした若年層向けの政策が十分に行われなかった<sup>6</sup>のは世代間の「1票の格差」の影響によるものかもしれません．</p>
<table class="table">
<colgroup>
<col style="width: 16%">
<col style="width: 49%">
<col style="width: 32%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">世代</th>
<th style="text-align: center;">お金の流れ（<u>社会保障費</u>など）</th>
<th style="text-align: center;">政治的平等（「1票の格差」）</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">若年層</td>
<td style="text-align: center;">高齢者層にお金を「支払う」</td>
<td style="text-align: center;"><p>「1票の価値」が軽く</p>
<p>若年層「冷遇」</p></td>
</tr>
<tr class="even">
<td style="text-align: center;">高齢者層</td>
<td style="text-align: center;">若年層からお金を「受け取る」</td>
<td style="text-align: center;"><p>「1票の価値」が重く</p>
<p>高齢者層「優遇」</p></td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="世代間の1票の格差を定量化してみる" class="level2">
<h2 class="anchored" data-anchor-id="世代間の1票の格差を定量化してみる">世代間の「1票の格差」を定量化してみる</h2>
<p>地域間の「1票の格差」は，（都市部基準で）約〇倍といった定量化がなされることが一般的ですが，世代間の「1票の格差」については，これまで，あまり定量化されていないようです．</p>
<p>単純な定量化の方法としては，年齢層別の人口を何らかの基準人口で割るといったものが考えられますが，このような方法では，加齢により亡くなる方がいることが考慮されず，「人口が少ないので100歳以上の1票の価値が軽い」といった評価をすることになってしまいます．</p>
<p>そこで，2020年国勢調査人口と2020年生命表を用いて，世代間の「1票の格差」を定量化してみようと思います．生命表とは，「ある期間における死亡状況が今後変化しないとの仮定のもとで各年齢の者が1年以内に死亡する確率などの指標を表したもの」です<sup>7</sup>．</p>
<p><u><strong>以下で示す世代間の「1票の格差」は，あくまで，オープンデータに基づく簡易的な試算であることにご注意ください．</strong></u></p>
<section id="使用データについて" class="level3">
<h3 class="anchored" data-anchor-id="使用データについて">使用データについて</h3>
<p>今回は，以下の表に示すデータを使用します．ここで，表中の定常人口（nLx）とは，「一定の出生・（生命表上の）死亡率のもとで得られる年齢階級別人口」のことです<sup>8</sup>．</p>
<p>データ入手・整形方法については，下に折りたたまれているコードも参考にしてください．</p>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: center;">内容</th>
<th style="text-align: center;">出典</th>
<th style="text-align: left;">入手方法</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"><a href="https://www.e-stat.go.jp/dbview?sid=0003445139">男女・年齢別人口</a></td>
<td style="text-align: center;">2020年国勢調査</td>
<td style="text-align: left;"><p><a href="https://uchidamizuki.github.io/jpstat/">jpstat</a>パッケージで</p>
<p>e-Stat APIを使用</p></td>
</tr>
<tr class="even">
<td style="text-align: center;"><a href="https://www.e-stat.go.jp/stat-search/files?page=1&amp;layout=datalist&amp;toukei=00450012&amp;tstat=000001031336&amp;cycle=7&amp;tclass1=000001060864&amp;tclass2=000001163166&amp;tclass3val=0">男女・年齢別定常人口（nLx）</a></td>
<td style="text-align: center;">2020年生命表</td>
<td style="text-align: left;"><p>URLからエクセルファイルを</p>
<p>ダウンロード</p></td>
</tr>
</tbody>
</table>
<div class="cell">
<details class="code-fold">
<summary>パッケージのローディングなど</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse)</span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(fs)</span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(arrow)</span>
<span id="cb1-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(readxl)</span>
<span id="cb1-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(jpstat)</span>
<span id="cb1-6"></span>
<span id="cb1-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_set</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_light</span>())</span>
<span id="cb1-8"></span>
<span id="cb1-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dir_create</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"quantify-vote-disparity-between-generations"</span>)</span></code></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>2020年国勢調査人口のダウンロード・データ整形</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># jpstatパッケージを使って2020年国勢調査データをダウンロードしています</span></span>
<span id="cb2-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file_exists</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"quantify-vote-disparity-between-generations/pop_2020.parquet"</span>)) {</span>
<span id="cb2-3">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 注意: jpstatパッケージはe-Stat APIを利用するためAPIキーが必要です</span></span>
<span id="cb2-4">  census_2020 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">estat</span>(keyring<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">key_get</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"estat-api"</span>),</span>
<span id="cb2-5">                       <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://www.e-stat.go.jp/dbview?sid=0003445139"</span>)</span>
<span id="cb2-6"></span>
<span id="cb2-7">  pop_2020 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> census_2020 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb2-8">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">activate</span>(tab) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb2-9">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb2-10">  </span>
<span id="cb2-11">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">activate</span>(cat01) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb2-12">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(name <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"うち日本人"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb2-13">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb2-14">  </span>
<span id="cb2-15">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">activate</span>(cat02) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb2-16">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rekey</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sex"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb2-17">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(name <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"男"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"女"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb2-18">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(name) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb2-19">  </span>
<span id="cb2-20">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">activate</span>(cat03) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb2-21">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rekey</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"age"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb2-22">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(name) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb2-23">  </span>
<span id="cb2-24">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">activate</span>(area) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb2-25">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(name <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"全国"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb2-26">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb2-27">  </span>
<span id="cb2-28">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">activate</span>(time) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb2-29">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb2-30">  </span>
<span id="cb2-31">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">collect</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pop"</span>)</span>
<span id="cb2-32">  </span>
<span id="cb2-33">  pop_2020 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pop_2020 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb2-34">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_detect</span>(age_name, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"^</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">d+歳$"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> age_name <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"100歳以上"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb2-35">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sex =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_factor</span>(sex_name),</span>
<span id="cb2-36">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">age =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_when</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_detect</span>(age_name, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"^</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">d+歳$"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> age_name <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb2-37">                             <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_extract</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">d+"</span>),</span>
<span id="cb2-38">                           age_name <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"100歳以上"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"100--Inf"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb2-39">             <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_factor</span>(),</span>
<span id="cb2-40">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pop =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">parse_number</span>(pop),</span>
<span id="cb2-41">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.keep =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"unused"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb2-42">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">relocate</span>(sex, age, pop)</span>
<span id="cb2-43">  </span>
<span id="cb2-44">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">write_parquet</span>(pop_2020, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"quantify-vote-disparity-between-generations/pop_2020.parquet"</span>) </span>
<span id="cb2-45">}</span></code></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>2020年生命表のダウンロード</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 第23回生命表（男）</span></span>
<span id="cb3-2">file_lifetable_male_2020 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"quantify-vote-disparity-between-generations/lifetable_male_2020.xlsx"</span></span>
<span id="cb3-3"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file_exists</span>(file_lifetable_male_2020)) {</span>
<span id="cb3-4">  curl<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">curl_download</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://www.e-stat.go.jp/stat-search/file-download?statInfId=000032173232&amp;fileKind=0"</span>, file_lifetable_male_2020) </span>
<span id="cb3-5">}</span>
<span id="cb3-6"></span>
<span id="cb3-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 第23回生命表（女）</span></span>
<span id="cb3-8">file_lifetable_female_2020 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"quantify-vote-disparity-between-generations/lifetable_female_2020.xlsx"</span></span>
<span id="cb3-9"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file_exists</span>(file_lifetable_female_2020)) {</span>
<span id="cb3-10">  curl<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">curl_download</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://www.e-stat.go.jp/stat-search/file-download?statInfId=000032173233&amp;fileKind=0"</span>, file_lifetable_female_2020)</span>
<span id="cb3-11">}</span></code></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>2020年生命表の定常人口のデータ整形</summary>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">col_names_lifetable <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_excel</span>(file_lifetable_male_2020, </span>
<span id="cb4-2">                        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">range =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"B3:J5"</span>,</span>
<span id="cb4-3">                        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col_names =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.character</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb4-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb4-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_tibble</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.name_repair =</span> \(x) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"col_name_1"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"col_name_2"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"col_name_3"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb4-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unite</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"col_name"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">starts_with</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"col_name"</span>),</span>
<span id="cb4-7">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na.rm =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb4-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col_name =</span> col_name <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb4-9">           <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_remove_all</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">s"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb4-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pull</span>(col_name)</span>
<span id="cb4-11"></span>
<span id="cb4-12">range_lifetable <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"B6:J127"</span></span>
<span id="cb4-13"></span>
<span id="cb4-14">lifetable_male_2020 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_excel</span>(file_lifetable_male_2020,</span>
<span id="cb4-15">                                  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">range =</span> range_lifetable,</span>
<span id="cb4-16">                                  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col_names =</span> col_names_lifetable)</span>
<span id="cb4-17"></span>
<span id="cb4-18">lifetable_female_2020 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_excel</span>(file_lifetable_female_2020,</span>
<span id="cb4-19">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">range =</span> range_lifetable,</span>
<span id="cb4-20">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col_names =</span> col_names_lifetable)</span>
<span id="cb4-21"></span>
<span id="cb4-22">static_pop_2020 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(男 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> lifetable_male_2020,</span>
<span id="cb4-23">                        女 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> lifetable_female_2020) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb4-24">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_rows</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.id =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sex"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb4-25">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">age =</span> 年齢_x,</span>
<span id="cb4-26">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">static_pop =</span> 定常人口_nLx_人) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb4-27">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(sex, age, static_pop) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb4-28">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_ends</span>(age, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"年"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb4-29">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sex =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_factor</span>(sex),</span>
<span id="cb4-30">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">age =</span> age <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb4-31">           <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_extract</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"^</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">d+"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb4-32">           <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">parse_integer</span>(),</span>
<span id="cb4-33">         <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 100歳以上はまとめる</span></span>
<span id="cb4-34">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">age =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">if_else</span>(age <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>,</span>
<span id="cb4-35">                       <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"100--Inf"</span>,</span>
<span id="cb4-36">                       <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.character</span>(age)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb4-37">           <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_factor</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb4-38">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarise</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">static_pop =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(static_pop),</span>
<span id="cb4-39">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(sex, age))</span>
<span id="cb4-40"></span>
<span id="cb4-41"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">write_parquet</span>(static_pop_2020, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"quantify-vote-disparity-between-generations/static_pop_2020.parquet"</span>)</span></code></pre></div>
</details>
</div>
</section>
<section id="国勢調査の人口生命表の定常人口の人口ピラミッドの比較" class="level3">
<h3 class="anchored" data-anchor-id="国勢調査の人口生命表の定常人口の人口ピラミッドの比較">国勢調査の人口・生命表の定常人口の「人口ピラミッド」の比較</h3>
<p>入手・整形したデータを使って人口ピラミッドを作成してみましょう．以下のグラフは，2020年国勢調査の人口に生命表の定常人口（赤線）を重ねたものです<sup>9</sup>．ただし，定常人口は，0歳定常人口が2020年国勢調査の0歳人口と等しくなるように基準化しています<sup>10</sup>．また，100歳以上の人口・定常人口については，100歳に集計して表示しています．</p>
<div class="cell">
<details class="code-fold">
<summary>人口ピラミッドの図示</summary>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 100歳以上を数値100で置き換える</span></span>
<span id="cb5-2">as_integer_age <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(age) {</span>
<span id="cb5-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">if_else</span>(age <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"100--Inf"</span>,</span>
<span id="cb5-4">          <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>,</span>
<span id="cb5-5">          <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">parse_integer</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.character</span>(age),</span>
<span id="cb5-6">                        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"100--Inf"</span>))</span>
<span id="cb5-7">}</span>
<span id="cb5-8"></span>
<span id="cb5-9">pop_2020 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_parquet</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"quantify-vote-disparity-between-generations/pop_2020.parquet"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb5-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">age =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_integer_age</span>(age))</span>
<span id="cb5-11">static_pop_2020 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_parquet</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"quantify-vote-disparity-between-generations/static_pop_2020.parquet"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb5-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">age =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_integer_age</span>(age))</span>
<span id="cb5-13"></span>
<span id="cb5-14">ratio_pop_static_pop <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> static_pop_2020 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb5-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(age <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb5-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>age) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb5-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(pop_2020 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb5-18">              <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(age <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb5-19">              <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>age),</span>
<span id="cb5-20">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">join_by</span>(sex)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb5-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ratio_pop_static_pop =</span> pop <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> static_pop,</span>
<span id="cb5-22">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.keep =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"unused"</span>)</span>
<span id="cb5-23"></span>
<span id="cb5-24">static_pop_2020 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> static_pop_2020 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb5-25">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(ratio_pop_static_pop,</span>
<span id="cb5-26">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">join_by</span>(sex)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb5-27">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pop =</span> static_pop <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> ratio_pop_static_pop,</span>
<span id="cb5-28">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.keep =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"unused"</span>)</span>
<span id="cb5-29"></span>
<span id="cb5-30">pop_2020 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb5-31">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pop =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">if_else</span>(sex <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"男"</span>,</span>
<span id="cb5-32">                       <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>pop,</span>
<span id="cb5-33">                       pop)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb5-34">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(age, pop,</span>
<span id="cb5-35">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> sex)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-36">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_col</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-37">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> static_pop_2020 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb5-38">               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pop =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">if_else</span>(sex <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"男"</span>,</span>
<span id="cb5-39">                                    <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>pop,</span>
<span id="cb5-40">                                    pop)),</span>
<span id="cb5-41">            <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">group =</span> sex,</span>
<span id="cb5-42">                <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"定常人口</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">（参考値）"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-43">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"年齢"</span>,</span>
<span id="cb5-44">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">breaks =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-45">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_y_continuous</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"人口［千人］"</span>,</span>
<span id="cb5-46">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> \(x) {</span>
<span id="cb5-47">                       scales<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">label_comma</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scale =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-3</span>)(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">abs</span>(x))</span>
<span id="cb5-48">                     }) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-49">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_manual</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"性別"</span>,</span>
<span id="cb5-50">                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(男 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cornflowerblue"</span>,</span>
<span id="cb5-51">                               女 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lightcoral"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-52">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_manual</span>(<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,</span>
<span id="cb5-53">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">定常人口</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">（参考値）</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"red"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-54">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_flip</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-55">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guides</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guide_legend</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">order =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>),</span>
<span id="cb5-56">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guide_legend</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">order =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>))</span></code></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://uchidamizuki.quarto.pub/blog/posts/2023/04/quantify-vote-disparity-between-generations_files/figure-html/plot-pop-pyramid-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>2020年の人口ピラミッドより，70歳前半および40歳後半において人口のピークがあることがわかります．これらは，それぞれ「団塊世代」「団塊ジュニア」と呼ばれる世代にあたります<sup>11</sup>．一方で，若年層の人口は，「団塊世代」「団塊ジュニア」の人口を大きく下回っていることがわかり，近年の少子化の深刻さがみてとれます．</p>
</section>
<section id="人口ピラミッドに基づく世代間の1票の格差の定量化" class="level3">
<h3 class="anchored" data-anchor-id="人口ピラミッドに基づく世代間の1票の格差の定量化">「人口ピラミッド」に基づく世代間の「1票の格差」の定量化</h3>
<p>赤線の定常人口（参考値）に対する国勢調査人口の比を用いて，世代間の「1票の格差」を定量化してみましょう．</p>
<p>以下のグラフは，選挙権を有する18歳以上を対象に，おおよそ10歳間隔で世代間の「1票の格差」を定量化したものです．ただし，ここでは18～29歳の「1票の価値」を1として基準化しています．</p>
<p>グラフより，40代～60代の1票は，18～29歳の約1.5倍，70代の1票は，18～29歳の約1.7倍の価値を有するという試算が得られました．また，（生命表の性質によるものかもしれませんが）「団塊世代」「団塊ジュニア」ではない30代や80代以上の1票の価値は，40代～60代・70代と比べると低くなっていることがわかりました．</p>
<div class="cell">
<details class="code-fold">
<summary>世代間の「1票の格差」の定量化</summary>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1">vote_disparity <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pop_2020 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(static_pop_2020 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-3">              <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">static_pop =</span> pop),</span>
<span id="cb6-4">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">join_by</span>(sex, age)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb6-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(age <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">18</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ageclass =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_when</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">between</span>(age, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">18</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">29</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"18～29歳"</span>,</span>
<span id="cb6-7">                              <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">between</span>(age, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">39</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"30代"</span>,</span>
<span id="cb6-8">                              <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">between</span>(age, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">49</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"40代"</span>,</span>
<span id="cb6-9">                              <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">between</span>(age, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">59</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"50代"</span>,</span>
<span id="cb6-10">                              <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">between</span>(age, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">60</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">69</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"60代"</span>,</span>
<span id="cb6-11">                              <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">between</span>(age, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">70</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">79</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"70代"</span>,</span>
<span id="cb6-12">                              <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">between</span>(age, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">80</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">89</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"80代"</span>,</span>
<span id="cb6-13">                              <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">90</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> age <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"90代以上"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarise</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(pop, static_pop),</span>
<span id="cb6-15">                   sum),</span>
<span id="cb6-16">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.by =</span> ageclass) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">vote_disparity =</span> pop <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> static_pop,</span>
<span id="cb6-18">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.keep =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"unused"</span>)</span>
<span id="cb6-19"></span>
<span id="cb6-20">vote_disparity <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> vote_disparity <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_cols</span>(vote_disparity <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-22">              <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(ageclass <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"18～29歳"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-23">              <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>ageclass) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-24">              <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">vote_disparity_18to29 =</span> vote_disparity)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-25">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">vote_disparity =</span> vote_disparity <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> vote_disparity_18to29,</span>
<span id="cb6-26">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.keep =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"unused"</span>)</span>
<span id="cb6-27"></span>
<span id="cb6-28">plot_vote_disparity <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> vote_disparity <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-29">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(ageclass, vote_disparity)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb6-30">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_col</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lightblue"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb6-31">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_text</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> scales<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">label_comma</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">accuracy =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-2</span>)(vote_disparity)),</span>
<span id="cb6-32">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb6-33">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">vjust =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>,</span>
<span id="cb6-34">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"red"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb6-35">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_hline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yintercept =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb6-36">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"red"</span>,</span>
<span id="cb6-37">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dashed"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb6-38">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_discrete</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"年齢層"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb6-39">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_y_continuous</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"世代間の「1票の格差」（18～29歳基準）"</span>)</span>
<span id="cb6-40"></span>
<span id="cb6-41"></span>
<span id="cb6-42"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggsave</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"quantify-vote-disparity-between-generations/plot_vote_disparity.png"</span>,</span>
<span id="cb6-43">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot =</span> plot_vote_disparity)</span>
<span id="cb6-44"></span>
<span id="cb6-45">plot_vote_disparity</span></code></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://uchidamizuki.quarto.pub/blog/posts/2023/04/quantify-vote-disparity-between-generations_files/figure-html/get-vote-disparity-between-generation-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="まとめ" class="level2">
<h2 class="anchored" data-anchor-id="まとめ">まとめ</h2>
<p>オープンデータである国勢調査と生命表を用いて，世代間の「1票の格差」を定量化してみました．</p>
<p>実は，若者の投票率の低さも世代間の「1票の格差」の大きな要因となっているといわれています．今後は，世代間の「1票の格差」に対する議論を深めつつ，若者の投票率が上がるような魅力的な政策を多く打ち出していくことが必要であると考えられます．</p>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">脚注</h2>

<ol>
<li id="fn1"><p>地方公共団体の議員・長を決める<a href="https://www.soumu.go.jp/senkyo/20touitsu/index.html">第20回統一地方選挙</a>が，2023年4月9日（日）と2023年4月23日（日）に行われました．↩︎</p></li>
<li id="fn2"><p><a href="https://www3.nhk.or.jp/news/html/20230309/k10014002531000.html">参院選 “1票の格差 最大3.03倍” 最高裁が大法廷で審理へ</a>↩︎</p></li>
<li id="fn3"><p><a href="https://www.yokohama-cu.ac.jp/interview2/vol3/page2.html">「一票の格差」の問題点とは？</a>↩︎</p></li>
<li id="fn4"><p><a href="https://dl.ndl.go.jp/view/download/digidepo_11643610_po_20200304.pdf?contentNo=1">世代間における「1票の格差」</a>↩︎</p></li>
<li id="fn5"><p>こういった考え方は，東京一極集中に伴う都市部への人口集積のもとで，「1票の価値」を完全に等しくすれば，むしろ地方「冷遇」につながるといった考え方とも類似します．↩︎</p></li>
<li id="fn6"><p><a href="https://www5.cao.go.jp/keizai-shimon/kaigi/special/future/sentaku/s2_4.html">選択する未来 （4）少子化対策</a>↩︎</p></li>
<li id="fn7"><p><a href="https://www.mhlw.go.jp/toukei/saikin/hw/seimei/list54-57-01.html">生命表について</a>↩︎</p></li>
<li id="fn8"><p><a href="https://www.mhlw.go.jp/toukei/saikin/hw/life/life03/sanko-1.html">参考資料１生命表諸関数の定義</a>↩︎</p></li>
<li id="fn9"><p>赤線で示した定常人口（参考値）は，2020年の0歳の男女が，死亡率一定の仮定のもとで，ある年齢で何人生存しているかを表しています．↩︎</p></li>
<li id="fn10"><p>0歳人口の男女比は，おおよそ105：100となっています．↩︎</p></li>
<li id="fn11"><p><a href="https://www.stat.go.jp/info/today/114.htm">「人口ピラミッド」から日本の未来が見えてくる！？～高齢化と「団塊世代」、少子化と「団塊ジュニア」～</a>↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>Politics</category>
  <category>R</category>
  <category>Japanese</category>
  <guid>https://uchidamizuki.quarto.pub/blog/posts/2023/04/quantify-vote-disparity-between-generations.html</guid>
  <pubDate>Sat, 22 Apr 2023 15:00:00 GMT</pubDate>
  <media:content url="https://uchidamizuki.quarto.pub/blog/posts/2023/04/quantify-vote-disparity-between-generations/plot_vote_disparity.png" medium="image" type="image/png" height="103" width="144"/>
</item>
<item>
  <title>地域メッシュデータのためのWEBアプリをつくりました（R Shiny&amp;jpgrid）</title>
  <link>https://uchidamizuki.quarto.pub/blog/posts/2023/02/web-app-for-grid-square-codes-in-japan.html</link>
  <description><![CDATA[ 





<section id="このアプリについて" class="level2">
<h2 class="anchored" data-anchor-id="このアプリについて">このアプリについて</h2>
<p><a href="https://shiny.rstudio.com">R Shiny</a>を使って<a href="https://uchidamizuki.shinyapps.io/jpgrid-app/">地域メッシュデータを使うためのWEBアプリ</a>をつくってみました．</p>
<p><a href="https://www.stat.go.jp/data/mesh/m_tuite.html">地域メッシュ</a>とは，経度・緯度にもとづいて（日本の）地域をほぼ正方形のメッシュに分割したもので，統計データの集計区分としてよく利用されています．</p>
<p>今回つくったアプリは，Rパッケージの<a href="https://uchidamizuki.github.io/jpgrid/">jpgrid</a>パッケージの機能の一部を提供しています． このアプリの提供機能は以下の通りです．</p>
<ol type="1">
<li>市区町村別の地域メッシュデータ生成</li>
<li>メッシュ文字列を含む表データから地域メッシュデータ生成</li>
<li>経度・緯度を含む表データから地域メッシュデータ生成</li>
</ol>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="https://uchidamizuki.shinyapps.io/jpgrid-app/"><img src="https://uchidamizuki.quarto.pub/blog/posts/2023/02/images/about.png" class="img-fluid figure-img" alt="アプリの外観（クリックするとアプリが開きます）"></a></p>
<figcaption>アプリの外観（クリックするとアプリが開きます）</figcaption>
</figure>
</div>
</section>
<section id="アプリの提供機能について" class="level2">
<h2 class="anchored" data-anchor-id="アプリの提供機能について">アプリの提供機能について</h2>
<section id="市区町村別の地域メッシュデータ生成" class="level3">
<h3 class="anchored" data-anchor-id="市区町村別の地域メッシュデータ生成">市区町村別の地域メッシュデータ生成</h3>
<p>総務省統計局の公開する<a href="市区町村別メッシュ・コード一覧" title="https://www.stat.go.jp/data/mesh/m_itiran.html">市区町村別メッシュ・コード一覧</a>から市区町村別のメッシュを取得します．</p>
<p>以下のような手順で市区町村別のメッシュを生成・保存できます．</p>
<ol type="1">
<li>都道府県を選択（複数選択可）</li>
<li>市区町村を選択（複数選択可）</li>
<li>メッシュサイズ（1 km／10 km／80 kmのいずれか）を選択し「メッシュ表示」を押す</li>
<li>データ形式（GeoPackageまたはCSV）を選択し「ダウンロード」を押す</li>
</ol>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://uchidamizuki.quarto.pub/blog/posts/2023/02/images/grid_city.png" class="img-fluid figure-img"></p>
<figcaption>市区町村別メッシュの表示イメージ</figcaption>
</figure>
</div>
<p>jpgridパッケージでは，<code>grid_city</code> データで市区町村別メッシュデータが提供されています．</p>
<p>以下のように，市区町村別メッシュデータを図示することができます．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(jpgrid)</span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse)</span>
<span id="cb1-3"></span>
<span id="cb1-4">JGD2011 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6668</span></span>
<span id="cb1-5"></span>
<span id="cb1-6">grid_city <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb1-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(city_name_ja <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"千葉市中央区"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"千葉市花見川区"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"千葉市稲毛区"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb1-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">grid_as_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">crs =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6668</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb1-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> city_name_ja)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb1-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb1-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_brewer</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">palette =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Set2"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://uchidamizuki.quarto.pub/blog/posts/2023/02/web-app-for-grid-square-codes-in-japan_files/figure-html/unnamed-chunk-1-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="メッシュ文字列を含む表データから地域メッシュデータ生成" class="level3">
<h3 class="anchored" data-anchor-id="メッシュ文字列を含む表データから地域メッシュデータ生成">メッシュ文字列を含む表データから地域メッシュデータ生成</h3>
<p>以下のような手順でメッシュ文字列を含む表データから地域メッシュを生成・保存できます．</p>
<ol type="1">
<li>データを選択（CSVまたはExcel）</li>
<li>メッシュ文字列の列名を指定（地点IDも指定可能）し「メッシュ表示」を押す</li>
<li>データ形式（GeoPackageまたはCSV）を選択し「ダウンロード」を押す</li>
</ol>
<p>jpgridパッケージでは，<code>parse_grid()</code> で文字列から地域メッシュを生成することができます．</p>
<p><img src="https://uchidamizuki.quarto.pub/blog/posts/2023/02/images/parse_grid.png" class="img-fluid"></p>
</section>
<section id="経度緯度を含む表データから地域メッシュデータ生成" class="level3">
<h3 class="anchored" data-anchor-id="経度緯度を含む表データから地域メッシュデータ生成">経度・緯度を含む表データから地域メッシュデータ生成</h3>
<p>同様に，以下の手順で経度・緯度を含む表データから地域メッシュを生成・保存できます．</p>
<ol type="1">
<li>データを選択（CSVまたはExcel）</li>
<li>経度（X）・緯度（Y）の列名を指定（地点IDも指定可能）し「メッシュ表示」を押す</li>
<li>データ形式（GeoPackageまたはCSV）を選択し「ダウンロード」を押す</li>
</ol>
<p>jpgridパッケージでは，<code>coords_to_grid()</code> で文字列から地域メッシュを生成することができます．</p>
<p><img src="https://uchidamizuki.quarto.pub/blog/posts/2023/02/images/coords_to_grid.png" class="img-fluid"></p>
</section>
</section>
<section id="おわりに" class="level2">
<h2 class="anchored" data-anchor-id="おわりに">おわりに</h2>
<p>R Shinyで作成した地域メッシュデータのためのWEBアプリについて紹介しました．</p>
<p>WEBアプリの作成に利用したjpgridパッケージでは，このアプリで提供していない様々な機能が提供されています．詳しくは，<a href="こちら" title="https://uchidamizuki.github.io/jpgrid/">こちら</a>をご覧ください．</p>
<p>例として，ジオメトリをメッシュに変換する<code>geometry_to_grid()</code> などがあります．</p>
<p>ぜひ地域メッシュデータの分析にjpgridパッケージも活用してみてください．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">japan <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> rnaturalearth<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ne_countries</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">country =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"japan"</span>,</span>
<span id="cb2-2">                                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scale =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"medium"</span>,</span>
<span id="cb2-3">                                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">returnclass =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sf"</span>)</span>
<span id="cb2-4">grid_japan <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> japan <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb2-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geometry_to_grid</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"80km"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb2-6">  dplyr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">first</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb2-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">grid_as_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">crs =</span> sf<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_crs</span>(japan))</span>
<span id="cb2-8"></span>
<span id="cb2-9">japan <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb2-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb2-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb2-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> grid_japan,</span>
<span id="cb2-13">          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"transparent"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://uchidamizuki.quarto.pub/blog/posts/2023/02/web-app-for-grid-square-codes-in-japan_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>


</section>

 ]]></description>
  <category>Shiny</category>
  <category>jpgrid</category>
  <category>R</category>
  <category>Japanese</category>
  <guid>https://uchidamizuki.quarto.pub/blog/posts/2023/02/web-app-for-grid-square-codes-in-japan.html</guid>
  <pubDate>Wed, 15 Feb 2023 15:00:00 GMT</pubDate>
  <media:content url="https://uchidamizuki.quarto.pub/blog/posts/2023/02/images/grid_city.png" medium="image" type="image/png" height="74" width="144"/>
</item>
<item>
  <title>Rで人口ピラミッドのアニメーションを作る</title>
  <link>https://uchidamizuki.quarto.pub/blog/posts/2023/01/create-an-animation-of-a-population-pyramid-in-r.html</link>
  <description><![CDATA[ 





<section id="この記事について" class="level2">
<h2 class="anchored" data-anchor-id="この記事について">この記事について</h2>
<p>国立社会保障・人口問題研究所（社人研）の公開している<a href="https://www.ipss.go.jp/site-ad/TopPageData/Pyramid_a.html">人口ピラミッドの推移アニメーション</a>を参考に，以下のようなアニメーションをRのggplot2で作成してみました．</p>
<p><img src="https://uchidamizuki.quarto.pub/blog/posts/2023/01/poppyramid.gif" class="img-fluid"></p>
</section>
<section id="国勢調査の時系列データの取得" class="level2">
<h2 class="anchored" data-anchor-id="国勢調査の時系列データの取得">国勢調査の時系列データの取得</h2>
<p>まず，e-Statで公開されている<a href="https://www.e-stat.go.jp/dbview?sid=0003410380">国勢調査の男女・5最階級別人口の時系列データ</a>をRのjpstatパッケージを用いて取得します．</p>
<p>jpstatパッケージからe-Stat APIを用いるためには，アプリケーションID（<code>appId</code>）を取得する必要があります．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse)</span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(jpstat)</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ご自身のappIdに置き換えてください</span></span>
<span id="cb2-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Sys.setenv</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ESTAT_API_KEY =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Your appId"</span>)</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">census <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">estat</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">statsDataId =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://www.e-stat.go.jp/dbview?sid=0003410380"</span>)</span>
<span id="cb3-2"></span>
<span id="cb3-3">pop <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> census <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb3-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">activate</span>(tab) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb3-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(name <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"人口"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb3-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb3-7">  </span>
<span id="cb3-8">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 性別の抽出</span></span>
<span id="cb3-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">activate</span>(cat01) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb3-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rekey</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sex"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb3-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(name <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"男"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"女"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb3-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(name) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb3-13">  </span>
<span id="cb3-14">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 年齢階級の抽出</span></span>
<span id="cb3-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">activate</span>(cat02) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb3-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rekey</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ageclass"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb3-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_detect</span>(name, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"^</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">d+～</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">d+歳$"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span></span>
<span id="cb3-18">           name <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"85歳以上"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span></span>
<span id="cb3-19">           name <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"110歳以上"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb3-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(name) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb3-21">  </span>
<span id="cb3-22">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 年の抽出</span></span>
<span id="cb3-23">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">activate</span>(time) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb3-24">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rekey</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"year"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb3-25">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_detect</span>(name, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"^</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">d+年$"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb3-26">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(name) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb3-27">  </span>
<span id="cb3-28">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># e-Statデータの取得</span></span>
<span id="cb3-29">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">collect</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pop"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb3-30">  </span>
<span id="cb3-31">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename_with</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> .x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb3-32">                <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_remove</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"_name$"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb3-33">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sex =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_factor</span>(sex),</span>
<span id="cb3-34">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">year =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">parse_number</span>(year),</span>
<span id="cb3-35">         </span>
<span id="cb3-36">         <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 各年齢階級の最低年齢を取得</span></span>
<span id="cb3-37">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">age_from =</span> ageclass <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb3-38">           <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_extract</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"^</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">d+"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb3-39">           stringi<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stri_trans_nfkc</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb3-40">           <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.integer</span>(),</span>
<span id="cb3-41">         </span>
<span id="cb3-42">         <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 最高の年齢階級を「85歳以上」とする</span></span>
<span id="cb3-43">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ageclass =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_when</span>(age_from <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">85</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"85歳以上"</span>,</span>
<span id="cb3-44">                              <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> ageclass) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb3-45">           <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_factor</span>(),</span>
<span id="cb3-46">         </span>
<span id="cb3-47">         <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 年齢層を追加</span></span>
<span id="cb3-48">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">agegroup =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_when</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">between</span>(age_from, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"年少人口"</span>,</span>
<span id="cb3-49">                              <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">between</span>(age_from, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">60</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"生産年齢人口"</span>,</span>
<span id="cb3-50">                              <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">between</span>(age_from, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">65</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">70</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"前期老年人口"</span>,</span>
<span id="cb3-51">                              age_from <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">75</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"後期老年人口"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb3-52">           <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_factor</span>(),</span>
<span id="cb3-53">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pop =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">parse_number</span>(pop)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb3-54">  </span>
<span id="cb3-55">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 「85歳以上」人口を集計</span></span>
<span id="cb3-56">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(year, sex, ageclass, agegroup) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb3-57">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarise</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pop =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(pop),</span>
<span id="cb3-58">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.groups =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"drop"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>The total number of data is 796.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1">knitr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kable</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(pop))</span></code></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">year</th>
<th style="text-align: left;">sex</th>
<th style="text-align: left;">ageclass</th>
<th style="text-align: left;">agegroup</th>
<th style="text-align: right;">pop</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1920</td>
<td style="text-align: left;">男</td>
<td style="text-align: left;">０～４歳</td>
<td style="text-align: left;">年少人口</td>
<td style="text-align: right;">3752627</td>
</tr>
<tr class="even">
<td style="text-align: right;">1920</td>
<td style="text-align: left;">男</td>
<td style="text-align: left;">５～９歳</td>
<td style="text-align: left;">年少人口</td>
<td style="text-align: right;">3467156</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1920</td>
<td style="text-align: left;">男</td>
<td style="text-align: left;">10～14歳</td>
<td style="text-align: left;">年少人口</td>
<td style="text-align: right;">3089225</td>
</tr>
<tr class="even">
<td style="text-align: right;">1920</td>
<td style="text-align: left;">男</td>
<td style="text-align: left;">15～19歳</td>
<td style="text-align: left;">生産年齢人口</td>
<td style="text-align: right;">2749022</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1920</td>
<td style="text-align: left;">男</td>
<td style="text-align: left;">20～24歳</td>
<td style="text-align: left;">生産年齢人口</td>
<td style="text-align: right;">2316479</td>
</tr>
<tr class="even">
<td style="text-align: right;">1920</td>
<td style="text-align: left;">男</td>
<td style="text-align: left;">25～29歳</td>
<td style="text-align: left;">生産年齢人口</td>
<td style="text-align: right;">2008005</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="人口ピラミッドアニメーションの作成" class="level2">
<h2 class="anchored" data-anchor-id="人口ピラミッドアニメーションの作成">人口ピラミッドアニメーションの作成</h2>
<p>Rのgganimateパッケージを用いることでggplot2のグラフをアニメーションにすることができます．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(gganimate)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'gganimate' was built under R version 4.3.1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 年齢層を表示するためのデータ</span></span>
<span id="cb8-2">agegroup <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pop <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb8-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(sex, agegroup) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb8-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarise</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ageclass =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.integer</span>(ageclass)),</span>
<span id="cb8-5">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.groups =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"drop"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb8-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_when</span>(sex <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"男"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.25</span>,</span>
<span id="cb8-7">                           sex <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"女"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>))</span>
<span id="cb8-8"></span>
<span id="cb8-9">poppyramid <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pop <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb8-10">  </span>
<span id="cb8-11">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 人口ピラミッドを作成するため男性人口をマイナスに変換</span></span>
<span id="cb8-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pop =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">if_else</span>(sex <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"男"</span>, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>pop, pop)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb8-13">  </span>
<span id="cb8-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(ageclass, pop,</span>
<span id="cb8-15">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">group =</span> sex,</span>
<span id="cb8-16">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> agegroup)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb8-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_col</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">show.legend =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb8-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> agegroup,</span>
<span id="cb8-19">            <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> agegroup,</span>
<span id="cb8-20">                <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> hjust),</span>
<span id="cb8-21">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb8-22">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_discrete</span>(<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb8-23">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_y_continuous</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"人口［千人］"</span>,</span>
<span id="cb8-24">                     </span>
<span id="cb8-25">                     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ラベルを絶対値・千人単位に変換</span></span>
<span id="cb8-26">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> purrr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">compose</span>(scales<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">label_comma</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scale =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-3</span>), abs)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb8-27">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_brewer</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">palette =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Set2"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb8-28">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_flip</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb8-29">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> sex,</span>
<span id="cb8-30">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scales =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"free_x"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb8-31">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"{frame_time %/% 5 * 5}年"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb8-32">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.title =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb8-33">  </span>
<span id="cb8-34">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># アニメーションに変換</span></span>
<span id="cb8-35">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">transition_time</span>(year)</span>
<span id="cb8-36"></span>
<span id="cb8-37"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 幅・高さを変更</span></span>
<span id="cb8-38"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">animate</span>(poppyramid, </span>
<span id="cb8-39">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">800</span>,</span>
<span id="cb8-40">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">height =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">600</span>,</span>
<span id="cb8-41">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">res =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">150</span>,</span>
<span id="cb8-42">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">renderer =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gifski_renderer</span>())</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://uchidamizuki.quarto.pub/blog/posts/2023/01/create-an-animation-of-a-population-pyramid-in-r_files/figure-html/create-gif-1.gif" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>


</section>

 ]]></description>
  <category>ggplot2</category>
  <category>gganimate</category>
  <category>e-Stat</category>
  <category>jpstat</category>
  <category>R</category>
  <category>Japanese</category>
  <guid>https://uchidamizuki.quarto.pub/blog/posts/2023/01/create-an-animation-of-a-population-pyramid-in-r.html</guid>
  <pubDate>Sat, 31 Dec 2022 15:00:00 GMT</pubDate>
  <media:content url="https://uchidamizuki.quarto.pub/blog/posts/2023/01/poppyramid.gif" medium="image" type="image/gif"/>
</item>
<item>
  <title>Rで日本の統計データを効率的に取得しよう（e-Stat APIとjpstatパッケージで）</title>
  <link>https://uchidamizuki.quarto.pub/blog/posts/2022/12/call-e-stat-api-in-r.html</link>
  <description><![CDATA[ 





<section id="この記事について" class="level2">
<h2 class="anchored" data-anchor-id="この記事について">この記事について</h2>
<p>この記事は「<a href="https://qiita.com/advent-calendar/2022/rlang"><strong>R Advent Calendar 2022</strong></a>」の12日目の記事です．</p>
<p>昨年，日本で政府統計の整備が始まってから150年を迎えました（<a href="https://www.stat.go.jp/museum/toukei150/img/nenpyo/pdf/nenpyo_heisei_reiwa.pdf">平成・令和の統計年表</a>）．最近では，<a href="https://www.e-stat.go.jp">政府統計の総合窓口（e-Stat）</a>で，様々な政府統計データを閲覧・ダウンロードすることができるようになりました．</p>
<p>e-Statには，便利な<a href="https://www.e-stat.go.jp/api/">API機能</a>も提供されています（利用ガイドは<a href="https://www.e-stat.go.jp/api/api-info/api-guide">こちら</a>．あらかじめ<a href="https://www.e-stat.go.jp/api/agreement/">利用規約</a>を確認してください．API機能を利用する際は，事前に<a href="https://www.e-stat.go.jp/mypage/user/preregister">ユーザ登録</a>を行ってください）．</p>
<p>この記事では，Rの<a href="https://uchidamizuki.github.io/jpstat/"><strong>jpstat</strong></a><strong>パッケージを使って，e-Stat APIを効率的に用いる</strong>方法を紹介します．</p>
</section>
<section id="e-statについて" class="level2">
<h2 class="anchored" data-anchor-id="e-statについて">e-Statについて</h2>
<p>e-Statには，様々な政府統計のデータベースが整理されていますが，ここでは，2015年国民健康・栄養調査の調査結果から<a href="https://www.e-stat.go.jp/dbview?sid=0003224282"><strong>睡眠時間に関するデータベース</strong></a>を見てみましょう．</p>
<p>データベースを開くと以下のように統計表が表示され，右上の「<strong>ダウンロード</strong>」ボタンからデータをダウンロードすることができます．</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://uchidamizuki.quarto.pub/blog/posts/2022/12/images/estat_1.png" class="img-fluid figure-img" style="width:75.0%"></p>
<figcaption>e-Statデータベース：統計表表示画面</figcaption>
</figure>
</div>
<p>画面左上の「<strong>表示項目選択</strong>」ボタンをクリックすると，表示するデータの項目（年齢階級・性別など）を選択することができます．</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://uchidamizuki.quarto.pub/blog/posts/2022/12/images/estat_2.png" class="img-fluid figure-img" style="width:75.0%"></p>
<figcaption>e-Statデータベース：表示項目選択画面</figcaption>
</figure>
</div>
<p>たとえば，年齢階級を選択したい場合は，年齢階級の「<strong>項目を選択</strong>」ボタンをクリックすると以下のような画面で年齢階級を選択することができます．</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://uchidamizuki.quarto.pub/blog/posts/2022/12/images/estat_3.png" class="img-fluid figure-img" style="width:75.0%"></p>
<figcaption>e-Statデータベース：表示項目の設定画面</figcaption>
</figure>
</div>
<p>表示項目を選択した後に，「<strong>ダウンロード</strong>」ボタンをクリックすると，選択した項目のデータのみをダウンロードすることができます．</p>
<p>このように，e-Statでは，簡単にデータを抽出・ダウンロードすることができます．しかし，<strong>データ取得作業の再現性</strong>を高めたり，<strong>プログラムを用いたデータ抽出・取得の効率化</strong>を行ったりしたい場合は，<strong>e-Stat API</strong>を用いるのがおすすめです．</p>
</section>
<section id="jpstatパッケージでe-stat-apiを使う" class="level2">
<h2 class="anchored" data-anchor-id="jpstatパッケージでe-stat-apiを使う">jpstatパッケージでe-Stat APIを使う</h2>
<p>上で説明したe-Statでのデータの抽出・ダウンロードをe-Stat APIで行うためには，以下のようなステップを踏む必要があります．</p>
<ol type="1">
<li><a href="https://www.e-stat.go.jp/api/api-info/e-stat-manual3-0#api_2_2"><strong>メタ情報取得</strong></a>・パラメータ設定：表示項目データを取得・選択，選択項目に対応する<a href="https://www.e-stat.go.jp/api/api-info/e-stat-manual3-0#api_3_4">APIパラメータ</a>を設定</li>
<li><a href="https://www.e-stat.go.jp/api/api-info/e-stat-manual3-0#api_2_3"><strong>統計データ取得</strong></a>：選択したデータを取得・表データに整形する</li>
</ol>
<p><a href="https://uchidamizuki.github.io/jpstat/">jpstat</a>パッケージは，これらの一連の作業をR上で効率的に行うため開発されたものです<sup>1</sup>．jpstatパッケージは，CRANからインストールすることができます．</p>
<p>ここでは，<strong>男女・年齢階級別の睡眠時間をグラフ化</strong>することを目標として，さきほど取り上げた<a href="https://www.e-stat.go.jp/dbview?sid=0003224282">睡眠時間に関するデータベース</a>（2015年）からデータを取得してみましょう．まず，必要なパッケージを読み込みます．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">install.packages</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jpstat"</span>)</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse)</span>
<span id="cb2-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(jpstat)</span></code></pre></div>
</div>
<section id="ステップ1メタ情報表示項目を表示抽出する" class="level3">
<h3 class="anchored" data-anchor-id="ステップ1メタ情報表示項目を表示抽出する">ステップ1：メタ情報（表示項目）を表示・抽出する</h3>
<p>e-Stat APIを用いるためには，事前に<a href="https://www.e-stat.go.jp/mypage/user/preregister"><strong>ユーザ登録</strong></a>を行い，<strong><code>appId</code> と呼ばれるアプリケーションIDを取得</strong>する必要があります<sup>2</sup>．</p>
<p><code>estat()</code> 関数に，<code>appId</code> とデータベースのURL（または統計表ID：<code>statsDataId</code>）を入力することでメタ情報（表示項目）を取得することができます<sup>3</sup>．</p>
<p>はじめに，メタ情報のうち「年齢階級（<code>cat01</code>）」のデータを見てみましょう（<code>cat01</code>はAPI上での分類名です）．<code>activate()</code> 関数によりメタ情報を表示することができます．さらに，<code>filter()</code> 関数により項目を選択することができます．ここでは，年齢階級別データのみが必要であるため，「総数」データを削除します<sup>4</sup>．</p>
<p>パイプ演算子<code>|&gt;</code> を使うことで，以下のように，<code>cat01</code>以外のメタ情報のデータ抽出を続けて行うことができます．ここでは，<strong>男女・年齢階級・睡眠時間別の回答者数</strong>データを抽出しています．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ご自身のappIdに置き換えてください</span></span>
<span id="cb3-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Sys.setenv</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ESTAT_API_KEY =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Your appId"</span>)</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">estat_sleeptime_2015 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">estat</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">statsDataId =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://www.e-stat.go.jp/dbview?sid=0003224282"</span>)</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># メタ情報の閲覧・選択</span></span>
<span id="cb5-2">estat_sleeptime_2015 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb5-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">activate</span>(cat01) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb5-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(name <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"総数"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># ☐ tab:   表章項目     [2] &lt;code, name, level, unit&gt;
# ☒ cat01: 年齢階級     [6] &lt;code, name, level, parentCode&gt;
# ☐ cat02: 睡眠の質     [8] &lt;code, name, level, parentCode&gt;
# ☐ cat03: 性別         [3] &lt;code, name, level, parentCode&gt;
# ☐ cat04: 平均睡眠時間 [6] &lt;code, name, level, parentCode&gt;
# ☐ time:  時間軸(年次) [1] &lt;code, name, level&gt;
# 
# A tibble: 6 × 4
  code  name      level parentCode
  &lt;chr&gt; &lt;chr&gt;     &lt;chr&gt; &lt;chr&gt;     
1 160   20歳-29歳 2     100       
2 170   30歳-39歳 2     100       
3 180   40歳-49歳 2     100       
4 190   50歳-59歳 2     100       
5 210   60歳-69歳 2     100       
6 220   70歳以上  2     100       </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1">estat_sleeptime_2015_filtered <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> estat_sleeptime_2015 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb7-2">  </span>
<span id="cb7-3">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 表章項目</span></span>
<span id="cb7-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">activate</span>(tab) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb7-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(name <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"人数"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb7-6">  </span>
<span id="cb7-7">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 年齢階級</span></span>
<span id="cb7-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">activate</span>(cat01) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb7-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(name <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"総数"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb7-10">  </span>
<span id="cb7-11">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 睡眠の質</span></span>
<span id="cb7-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">activate</span>(cat02) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb7-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(name <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"総数"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb7-14">  </span>
<span id="cb7-15">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 性別</span></span>
<span id="cb7-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">activate</span>(cat03) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb7-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(name <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"男性"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"女性"</span>))</span></code></pre></div>
</div>
</section>
<section id="ステップ2統計データを取得ダウンロードする" class="level3">
<h3 class="anchored" data-anchor-id="ステップ2統計データを取得ダウンロードする">ステップ2：統計データを取得（ダウンロード）する</h3>
<p>データの抽出後に<code>collect()</code> を適用することで統計データを取得することができます．また，<code>collect()</code>の<code>n</code>引数で，取得するデータの列を名付けることができます．ここでは，<code>"person"</code>と名付けます．</p>
<p>取得したデータ<code>data_sleeptime_2015</code>を見ると，（たくさんの列が存在する）分析しづらいデータになっていることがわかります．<strong>ステップ2+α</strong>で，データ取得とデータ整形を同時に行う方法について説明します．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1">data_sleeptime_2015 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> estat_sleeptime_2015_filtered <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb8-2">  </span>
<span id="cb8-3">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># データ取得・数値に変換</span></span>
<span id="cb8-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">collect</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"person"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb8-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">person =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">parse_number</span>(person))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>The total number of data is 72.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1">knitr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kable</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(data_sleeptime_2015, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>))</span></code></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 4%">
<col style="width: 5%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 4%">
<col style="width: 5%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 4%">
<col style="width: 5%">
<col style="width: 3%">
<col style="width: 7%">
<col style="width: 4%">
<col style="width: 5%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 2%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">tab_code</th>
<th style="text-align: left;">tab_name</th>
<th style="text-align: left;">tab_level</th>
<th style="text-align: left;">tab_unit</th>
<th style="text-align: left;">cat01_code</th>
<th style="text-align: left;">cat01_name</th>
<th style="text-align: left;">cat01_level</th>
<th style="text-align: left;">cat01_parentCode</th>
<th style="text-align: left;">cat02_code</th>
<th style="text-align: left;">cat02_name</th>
<th style="text-align: left;">cat02_level</th>
<th style="text-align: left;">cat02_parentCode</th>
<th style="text-align: left;">cat03_code</th>
<th style="text-align: left;">cat03_name</th>
<th style="text-align: left;">cat03_level</th>
<th style="text-align: left;">cat03_parentCode</th>
<th style="text-align: left;">cat04_code</th>
<th style="text-align: left;">cat04_name</th>
<th style="text-align: left;">cat04_level</th>
<th style="text-align: left;">cat04_parentCode</th>
<th style="text-align: left;">time_code</th>
<th style="text-align: left;">time_name</th>
<th style="text-align: left;">time_level</th>
<th style="text-align: right;">person</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">100</td>
<td style="text-align: left;">人数</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">人</td>
<td style="text-align: left;">160</td>
<td style="text-align: left;">20歳-29歳</td>
<td style="text-align: left;">2</td>
<td style="text-align: left;">100</td>
<td style="text-align: left;">100</td>
<td style="text-align: left;">総数</td>
<td style="text-align: left;">1</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">110</td>
<td style="text-align: left;">男性</td>
<td style="text-align: left;">2</td>
<td style="text-align: left;">100</td>
<td style="text-align: left;">110</td>
<td style="text-align: left;">５時間未満</td>
<td style="text-align: left;">2</td>
<td style="text-align: left;">100</td>
<td style="text-align: left;">2015000000</td>
<td style="text-align: left;">2015年</td>
<td style="text-align: left;">1</td>
<td style="text-align: right;">23</td>
</tr>
<tr class="even">
<td style="text-align: left;">100</td>
<td style="text-align: left;">人数</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">人</td>
<td style="text-align: left;">160</td>
<td style="text-align: left;">20歳-29歳</td>
<td style="text-align: left;">2</td>
<td style="text-align: left;">100</td>
<td style="text-align: left;">100</td>
<td style="text-align: left;">総数</td>
<td style="text-align: left;">1</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">110</td>
<td style="text-align: left;">男性</td>
<td style="text-align: left;">2</td>
<td style="text-align: left;">100</td>
<td style="text-align: left;">120</td>
<td style="text-align: left;">５時間以上６時間未満</td>
<td style="text-align: left;">2</td>
<td style="text-align: left;">100</td>
<td style="text-align: left;">2015000000</td>
<td style="text-align: left;">2015年</td>
<td style="text-align: left;">1</td>
<td style="text-align: right;">86</td>
</tr>
<tr class="odd">
<td style="text-align: left;">100</td>
<td style="text-align: left;">人数</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">人</td>
<td style="text-align: left;">160</td>
<td style="text-align: left;">20歳-29歳</td>
<td style="text-align: left;">2</td>
<td style="text-align: left;">100</td>
<td style="text-align: left;">100</td>
<td style="text-align: left;">総数</td>
<td style="text-align: left;">1</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">110</td>
<td style="text-align: left;">男性</td>
<td style="text-align: left;">2</td>
<td style="text-align: left;">100</td>
<td style="text-align: left;">130</td>
<td style="text-align: left;">６時間以上７時間未満</td>
<td style="text-align: left;">2</td>
<td style="text-align: left;">100</td>
<td style="text-align: left;">2015000000</td>
<td style="text-align: left;">2015年</td>
<td style="text-align: left;">1</td>
<td style="text-align: right;">88</td>
</tr>
<tr class="even">
<td style="text-align: left;">100</td>
<td style="text-align: left;">人数</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">人</td>
<td style="text-align: left;">160</td>
<td style="text-align: left;">20歳-29歳</td>
<td style="text-align: left;">2</td>
<td style="text-align: left;">100</td>
<td style="text-align: left;">100</td>
<td style="text-align: left;">総数</td>
<td style="text-align: left;">1</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">110</td>
<td style="text-align: left;">男性</td>
<td style="text-align: left;">2</td>
<td style="text-align: left;">100</td>
<td style="text-align: left;">140</td>
<td style="text-align: left;">７時間以上８時間未満</td>
<td style="text-align: left;">2</td>
<td style="text-align: left;">100</td>
<td style="text-align: left;">2015000000</td>
<td style="text-align: left;">2015年</td>
<td style="text-align: left;">1</td>
<td style="text-align: right;">37</td>
</tr>
<tr class="odd">
<td style="text-align: left;">100</td>
<td style="text-align: left;">人数</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">人</td>
<td style="text-align: left;">160</td>
<td style="text-align: left;">20歳-29歳</td>
<td style="text-align: left;">2</td>
<td style="text-align: left;">100</td>
<td style="text-align: left;">100</td>
<td style="text-align: left;">総数</td>
<td style="text-align: left;">1</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">110</td>
<td style="text-align: left;">男性</td>
<td style="text-align: left;">2</td>
<td style="text-align: left;">100</td>
<td style="text-align: left;">150</td>
<td style="text-align: left;">８時間以上９時間未満</td>
<td style="text-align: left;">2</td>
<td style="text-align: left;">100</td>
<td style="text-align: left;">2015000000</td>
<td style="text-align: left;">2015年</td>
<td style="text-align: left;">1</td>
<td style="text-align: right;">19</td>
</tr>
<tr class="even">
<td style="text-align: left;">100</td>
<td style="text-align: left;">人数</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">人</td>
<td style="text-align: left;">160</td>
<td style="text-align: left;">20歳-29歳</td>
<td style="text-align: left;">2</td>
<td style="text-align: left;">100</td>
<td style="text-align: left;">100</td>
<td style="text-align: left;">総数</td>
<td style="text-align: left;">1</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">110</td>
<td style="text-align: left;">男性</td>
<td style="text-align: left;">2</td>
<td style="text-align: left;">100</td>
<td style="text-align: left;">160</td>
<td style="text-align: left;">９時間以上</td>
<td style="text-align: left;">2</td>
<td style="text-align: left;">100</td>
<td style="text-align: left;">2015000000</td>
<td style="text-align: left;">2015年</td>
<td style="text-align: left;">1</td>
<td style="text-align: right;">3</td>
</tr>
<tr class="odd">
<td style="text-align: left;">100</td>
<td style="text-align: left;">人数</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">人</td>
<td style="text-align: left;">160</td>
<td style="text-align: left;">20歳-29歳</td>
<td style="text-align: left;">2</td>
<td style="text-align: left;">100</td>
<td style="text-align: left;">100</td>
<td style="text-align: left;">総数</td>
<td style="text-align: left;">1</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">120</td>
<td style="text-align: left;">女性</td>
<td style="text-align: left;">2</td>
<td style="text-align: left;">100</td>
<td style="text-align: left;">110</td>
<td style="text-align: left;">５時間未満</td>
<td style="text-align: left;">2</td>
<td style="text-align: left;">100</td>
<td style="text-align: left;">2015000000</td>
<td style="text-align: left;">2015年</td>
<td style="text-align: left;">1</td>
<td style="text-align: right;">28</td>
</tr>
<tr class="even">
<td style="text-align: left;">100</td>
<td style="text-align: left;">人数</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">人</td>
<td style="text-align: left;">160</td>
<td style="text-align: left;">20歳-29歳</td>
<td style="text-align: left;">2</td>
<td style="text-align: left;">100</td>
<td style="text-align: left;">100</td>
<td style="text-align: left;">総数</td>
<td style="text-align: left;">1</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">120</td>
<td style="text-align: left;">女性</td>
<td style="text-align: left;">2</td>
<td style="text-align: left;">100</td>
<td style="text-align: left;">120</td>
<td style="text-align: left;">５時間以上６時間未満</td>
<td style="text-align: left;">2</td>
<td style="text-align: left;">100</td>
<td style="text-align: left;">2015000000</td>
<td style="text-align: left;">2015年</td>
<td style="text-align: left;">1</td>
<td style="text-align: right;">106</td>
</tr>
<tr class="odd">
<td style="text-align: left;">100</td>
<td style="text-align: left;">人数</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">人</td>
<td style="text-align: left;">160</td>
<td style="text-align: left;">20歳-29歳</td>
<td style="text-align: left;">2</td>
<td style="text-align: left;">100</td>
<td style="text-align: left;">100</td>
<td style="text-align: left;">総数</td>
<td style="text-align: left;">1</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">120</td>
<td style="text-align: left;">女性</td>
<td style="text-align: left;">2</td>
<td style="text-align: left;">100</td>
<td style="text-align: left;">130</td>
<td style="text-align: left;">６時間以上７時間未満</td>
<td style="text-align: left;">2</td>
<td style="text-align: left;">100</td>
<td style="text-align: left;">2015000000</td>
<td style="text-align: left;">2015年</td>
<td style="text-align: left;">1</td>
<td style="text-align: right;">94</td>
</tr>
<tr class="even">
<td style="text-align: left;">100</td>
<td style="text-align: left;">人数</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">人</td>
<td style="text-align: left;">160</td>
<td style="text-align: left;">20歳-29歳</td>
<td style="text-align: left;">2</td>
<td style="text-align: left;">100</td>
<td style="text-align: left;">100</td>
<td style="text-align: left;">総数</td>
<td style="text-align: left;">1</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">120</td>
<td style="text-align: left;">女性</td>
<td style="text-align: left;">2</td>
<td style="text-align: left;">100</td>
<td style="text-align: left;">140</td>
<td style="text-align: left;">７時間以上８時間未満</td>
<td style="text-align: left;">2</td>
<td style="text-align: left;">100</td>
<td style="text-align: left;">2015000000</td>
<td style="text-align: left;">2015年</td>
<td style="text-align: left;">1</td>
<td style="text-align: right;">55</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="ステップ2αデータ取得とデータ整形を同時に行う" class="level3">
<h3 class="anchored" data-anchor-id="ステップ2αデータ取得とデータ整形を同時に行う">ステップ2+α：データ取得とデータ整形を同時に行う</h3>
<p>jpstatでe-Statのデータを取得すると，パラメータ名（<code>cat01</code>など）と各項目の列名（<code>code</code>， <code>name</code>など）から列（<code>cat01_code</code>，<code>cat01_name</code>など）が作成されます．</p>
<p>jpstatでは，<code>rekey()</code> 関数によりパラメータ名を変更したり，<code>select()</code> 関数で項目別に列を選択したりすることでデータを整理することができます<sup>5</sup>．以下のように書くことで，すっきりとしたデータを作成することができます．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1">data_sleeptime_2015 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> estat_sleeptime_2015 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb11-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">activate</span>(tab) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb11-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(name <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"人数"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb11-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb11-5">  </span>
<span id="cb11-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">activate</span>(cat01) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb11-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rekey</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ageclass"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb11-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(name <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"総数"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb11-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(name) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb11-10">  </span>
<span id="cb11-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">activate</span>(cat02) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb11-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(name <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"総数"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb11-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb11-14">  </span>
<span id="cb11-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">activate</span>(cat03) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb11-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rekey</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sex"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb11-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(name <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"男性"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"女性"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb11-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(name) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb11-19">  </span>
<span id="cb11-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">activate</span>(cat04) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb11-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rekey</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sleeptime"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb11-22">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(name) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb11-23">  </span>
<span id="cb11-24">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">activate</span>(time) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb11-25">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb11-26">  </span>
<span id="cb11-27">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">collect</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"person"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb11-28">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">person =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">parse_number</span>(person))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>The total number of data is 72.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1">knitr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kable</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(data_sleeptime_2015, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>))</span></code></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">ageclass_name</th>
<th style="text-align: left;">sex_name</th>
<th style="text-align: left;">sleeptime_name</th>
<th style="text-align: right;">person</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">20歳-29歳</td>
<td style="text-align: left;">男性</td>
<td style="text-align: left;">５時間未満</td>
<td style="text-align: right;">23</td>
</tr>
<tr class="even">
<td style="text-align: left;">20歳-29歳</td>
<td style="text-align: left;">男性</td>
<td style="text-align: left;">５時間以上６時間未満</td>
<td style="text-align: right;">86</td>
</tr>
<tr class="odd">
<td style="text-align: left;">20歳-29歳</td>
<td style="text-align: left;">男性</td>
<td style="text-align: left;">６時間以上７時間未満</td>
<td style="text-align: right;">88</td>
</tr>
<tr class="even">
<td style="text-align: left;">20歳-29歳</td>
<td style="text-align: left;">男性</td>
<td style="text-align: left;">７時間以上８時間未満</td>
<td style="text-align: right;">37</td>
</tr>
<tr class="odd">
<td style="text-align: left;">20歳-29歳</td>
<td style="text-align: left;">男性</td>
<td style="text-align: left;">８時間以上９時間未満</td>
<td style="text-align: right;">19</td>
</tr>
<tr class="even">
<td style="text-align: left;">20歳-29歳</td>
<td style="text-align: left;">男性</td>
<td style="text-align: left;">９時間以上</td>
<td style="text-align: right;">3</td>
</tr>
<tr class="odd">
<td style="text-align: left;">20歳-29歳</td>
<td style="text-align: left;">女性</td>
<td style="text-align: left;">５時間未満</td>
<td style="text-align: right;">28</td>
</tr>
<tr class="even">
<td style="text-align: left;">20歳-29歳</td>
<td style="text-align: left;">女性</td>
<td style="text-align: left;">５時間以上６時間未満</td>
<td style="text-align: right;">106</td>
</tr>
<tr class="odd">
<td style="text-align: left;">20歳-29歳</td>
<td style="text-align: left;">女性</td>
<td style="text-align: left;">６時間以上７時間未満</td>
<td style="text-align: right;">94</td>
</tr>
<tr class="even">
<td style="text-align: left;">20歳-29歳</td>
<td style="text-align: left;">女性</td>
<td style="text-align: left;">７時間以上８時間未満</td>
<td style="text-align: right;">55</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="おまけ取得したデータのグラフ化" class="level3">
<h3 class="anchored" data-anchor-id="おまけ取得したデータのグラフ化">おまけ：取得したデータのグラフ化</h3>
<p>最後に，取得した<strong>2015年の男女・年齢階級別の睡眠時間</strong>データをグラフ化してみましょう．グラフより，男性と女性では年齢階級別の睡眠時間の傾向が異なることがわかります．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1">data_sleeptime_2015 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb14-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ageclass_name =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_factor</span>(ageclass_name),</span>
<span id="cb14-3">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sex_name =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_factor</span>(sex_name),</span>
<span id="cb14-4">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sleeptime_name =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_factor</span>(sleeptime_name)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb14-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(ageclass_name, sex_name) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb14-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prop =</span> person <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(person)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb14-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb14-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(ageclass_name, prop,</span>
<span id="cb14-9">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fct_rev</span>(sleeptime_name))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb14-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_col</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb14-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_text</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">if_else</span>(prop <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>,</span>
<span id="cb14-12">                                scales<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">label_percent</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">accuracy =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)(prop),</span>
<span id="cb14-13">                                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>)),</span>
<span id="cb14-14">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">position =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">position_stack</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">vjust =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb14-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_discrete</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"年齢階級"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb14-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_y_continuous</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"割合"</span>, </span>
<span id="cb14-17">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> scales<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">label_percent</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">accuracy =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb14-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_brewer</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"睡眠時間"</span>,</span>
<span id="cb14-19">                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">palette =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Spectral"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb14-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> sex_name) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb14-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guides</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guide_axis</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n.dodge =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>))</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://uchidamizuki.quarto.pub/blog/posts/2022/12/call-e-stat-api-in-r_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="まとめ" class="level2">
<h2 class="anchored" data-anchor-id="まとめ">まとめ</h2>
<p>本記事では，e-Stat APIと<a href="https://uchidamizuki.github.io/jpstat/">jpstat</a>パッケージで日本の統計データを効率的に取得する方法について紹介しました．</p>
<p>Rで統計データを取得することで，作業の再現性や効率性を高めることができます．また，jpstatパッケージを使うことで，データ取得とデータ整形を同時に行うことができるため便利です．みなさんもぜひ使ってみてください．</p>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">脚注</h2>

<ol>
<li id="fn1"><p>e-Stat APIでは，メタ情報取得・統計データ取得以外にも，様々な機能が提供されています（<a href="https://www.e-stat.go.jp/api/api-info/e-stat-manual3-0">API仕様</a>）．↩︎</p></li>
<li id="fn2"><p>アプリケーションIDの取得には，URLを登録する必要があります．公開サイトで利用しない場合には，<code>http://test.localhost/</code>などのローカルアドレスを入力することが推奨されています（詳しくは<a href="https://www.e-stat.go.jp/api/api-info/api-guide">利用ガイド</a>を参照）．↩︎</p></li>
<li id="fn3"><p>e-Statのページの右上の「<strong>API</strong>」ボタンを押すとAPIのクエリが表示されます．クエリ内の<code>statsDataId</code> を直接入力することでメタ情報を取得することもできます．↩︎</p></li>
<li id="fn4"><p>ただし，各パラメータの項目数には，100件という上限が設定されているため，フィルタリング後の項目数が多くなる場合には，フィルタリングを行わず，全ての項目を選択することをおすすめします．↩︎</p></li>
<li id="fn5"><p><code>select()</code> 関数である項目の列を全て削除することもできます．これは，「総数」のみを選択する場合など，分析に不要な項目を削除する場合に便利です．↩︎</p></li>
</ol>
</section></div> ]]></description>
  <category>e-Stat</category>
  <category>jpstat</category>
  <category>R</category>
  <category>Japanese</category>
  <guid>https://uchidamizuki.quarto.pub/blog/posts/2022/12/call-e-stat-api-in-r.html</guid>
  <pubDate>Sun, 11 Dec 2022 15:00:00 GMT</pubDate>
  <media:content url="https://github.com/UchidaMizuki/jpstat/blob/main/man/figures/logo.png?raw=true" medium="image"/>
</item>
<item>
  <title>CSVの代わりにParquetを使ってみよう</title>
  <link>https://uchidamizuki.quarto.pub/blog/posts/2022/06/use-parquet-instead-of-csv-ja.html</link>
  <description><![CDATA[ 





<p>本記事では，<strong>CSVの代替として有望かつビッグデータ分析にも適している<a href="https://parquet.apache.org">Parquet</a></strong>を紹介します．</p>
<p>さて，<strong>データフレーム</strong>（Data Frames）は，データ分析において最も基本的なデータ構造の1つです．<strong>Rの<a href="https://tibble.tidyverse.org">tibble</a>・<a href="https://dplyr.tidyverse.org">dplyr</a></strong>や<strong>Pythonの<a href="https://pandas.pydata.org">pandas</a></strong>などのデータフレーム操作のためのパッケージを使えば，これまで<strong>Excelなどの表計算ソフトで行っていたデータ分析をさらに効率的に行う</strong>ことができます．</p>
<p>このようにデータ分析ツールが充実している一方で，データの保存には<strong>Excelなどとの互換性が高いCSV</strong>が未だに広く使われています．しかし，CSVは，必ずしもデータ分析に適したファイル形式とは言えません．そこで，<strong>CSVの代替</strong>として使われることが多くなっているParquetをCSVと比較してみましょう．</p>
<section id="サンプルデータの準備" class="level2">
<h2 class="anchored" data-anchor-id="サンプルデータの準備">サンプルデータの準備</h2>
<p>CSVとParquetを比較するため，まずは，データ分析にありがちなサンプルデータを用意しましょう．今回は，tidyrパッケージで提供されている<code>who</code> （<a href="https://www.who.int/teams/global-tuberculosis-programme/data">世界保健機関（WHO）結核データ</a>）からサンプルデータをつくります．</p>
<p>近年，データ分析では，<strong>整然データ（<a href="https://ja.wikipedia.org/wiki/Tidy_data">tidy data</a>）</strong>の概念が普及しています．tidy dataは，個々の変数が1つの列をなし，個々の観測（値）が1つの行をなすようなデータです．</p>
<p>それでは，<code>who</code>は，tidy dataと言えるでしょうか？<code>who</code>には，<code>"new_sp_m014"</code> ～<code>"newrel_f65"</code> といったたくさんの列が存在しますが，これらには，1列ごとに，診断結果（<code>sp</code>や<code>sel</code>）・性別（<code>m</code>と<code>f</code>）・年齢階級（<code>014</code>や<code>65</code>）といった複数の変数が含まれています．そのため，<strong><code>who</code> は，tidy dataでない</strong>といえます．そこで，<a href="https://tidyr.tidyverse.org/articles/pivot.html">こちら</a>に従って<strong>tidy dataである<code>who_longer</code>に変形</strong>します．</p>
<p>データ分析では，<code>who</code> よりtidy dataである<code>who_longer</code> のほうを分析が行いやすい一方で，行数は<code>who</code>（約7,000行）より<code>who_longer</code> （約400,000行）のほうが約50倍多いことがわかります．そのため，tidy dataである<code>who_longer</code>のようなデータをテキストファイルであるCSVで保存すると容量が増大してしまいます．</p>
<p>このように，<strong>tidy dataはデータ分析に適している一方で，CSVのようなテキストファイルでの保存に適していない</strong>ことがわかります．しかし，このような<strong>データ保存上の課題はParquetを使えば解決する</strong>ことができます．</p>
<p>ここで，tidy dataでない<code>who</code> とtidy dataである<code>who_longer</code> を見比べてみましょう．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'ggplot2' was built under R version 4.2.3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'tibble' was built under R version 4.2.3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'dplyr' was built under R version 4.2.3</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(fs)</span></code></pre></div>
</div>
<div class="cell">
<details class="code-fold">
<summary>コード</summary>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1">levels_gender <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"f"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"m"</span>)</span>
<span id="cb6-2">levels_age <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"014"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1524"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2534"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"3544"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"4554"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"5564"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"65"</span>)</span>
<span id="cb6-3"></span>
<span id="cb6-4">who_longer <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> who <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_longer</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cols =</span> new_sp_m014<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>newrel_f65,</span>
<span id="cb6-6">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_to =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"diagnosis"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gender"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"age"</span>), </span>
<span id="cb6-7">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_pattern =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"new_?(.*)_(.)(.*)"</span>,</span>
<span id="cb6-8">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_transform =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">gender =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> .x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-9">                                        readr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">parse_factor</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">levels =</span> levels_gender),</span>
<span id="cb6-10">                                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">age =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> .x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-11">                                        readr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">parse_factor</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">levels =</span> levels_age,</span>
<span id="cb6-12">                                                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ordered =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)),</span>
<span id="cb6-13">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"count"</span>)</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># データ整形前</span></span>
<span id="cb7-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(who, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 7,240 × 60
  country   iso2  iso3   year new_sp_m014 new_sp_m1524 new_sp_m2534 new_sp_m3544
  &lt;chr&gt;     &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;        &lt;dbl&gt;        &lt;dbl&gt;
1 Afghanis… AF    AFG    1980          NA           NA           NA           NA
2 Afghanis… AF    AFG    1981          NA           NA           NA           NA
3 Afghanis… AF    AFG    1982          NA           NA           NA           NA
4 Afghanis… AF    AFG    1983          NA           NA           NA           NA
5 Afghanis… AF    AFG    1984          NA           NA           NA           NA
# ℹ 7,235 more rows
# ℹ 52 more variables: new_sp_m4554 &lt;dbl&gt;, new_sp_m5564 &lt;dbl&gt;,
#   new_sp_m65 &lt;dbl&gt;, new_sp_f014 &lt;dbl&gt;, new_sp_f1524 &lt;dbl&gt;,
#   new_sp_f2534 &lt;dbl&gt;, new_sp_f3544 &lt;dbl&gt;, new_sp_f4554 &lt;dbl&gt;,
#   new_sp_f5564 &lt;dbl&gt;, new_sp_f65 &lt;dbl&gt;, new_sn_m014 &lt;dbl&gt;,
#   new_sn_m1524 &lt;dbl&gt;, new_sn_m2534 &lt;dbl&gt;, new_sn_m3544 &lt;dbl&gt;,
#   new_sn_m4554 &lt;dbl&gt;, new_sn_m5564 &lt;dbl&gt;, new_sn_m65 &lt;dbl&gt;, …</code></pre>
</div>
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># データ整形後</span></span>
<span id="cb9-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(who_longer, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 405,440 × 8
  country     iso2  iso3   year diagnosis gender age   count
  &lt;chr&gt;       &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt; &lt;chr&gt;     &lt;fct&gt;  &lt;ord&gt; &lt;dbl&gt;
1 Afghanistan AF    AFG    1980 sp        m      014      NA
2 Afghanistan AF    AFG    1980 sp        m      1524     NA
3 Afghanistan AF    AFG    1980 sp        m      2534     NA
4 Afghanistan AF    AFG    1980 sp        m      3544     NA
5 Afghanistan AF    AFG    1980 sp        m      4554     NA
# ℹ 405,435 more rows</code></pre>
</div>
</div>
</section>
<section id="csvparquetの保存方法" class="level2">
<h2 class="anchored" data-anchor-id="csvparquetの保存方法">CSV・Parquetの保存方法</h2>
<p>Rでは，<code>write_csv()</code> でCSVを保存できます．同様に，arrowパッケージの<code>write_parquet()</code> でParquetを保存することができます．<code>who_longer</code>をCSVとParquetで保存してみましょう．</p>
<p>CSVとParquetでは，どちらも簡単にデータ保存ができることがわかります．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(arrow)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'arrow' was built under R version 4.2.3</code></pre>
</div>
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># CSVを保存</span></span>
<span id="cb13-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">write_csv</span>(who_longer, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"who_longer.csv"</span>)</span>
<span id="cb13-3"></span>
<span id="cb13-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Parquetを保存</span></span>
<span id="cb13-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">write_parquet</span>(who_longer, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"who_longer.parquet"</span>)</span></code></pre></div>
</div>
</section>
<section id="parquetのメリットcsvとの比較" class="level2">
<h2 class="anchored" data-anchor-id="parquetのメリットcsvとの比較">Parquetのメリット・CSVとの比較</h2>
<p>ここからは，保存した<code>who_longer</code> のCSV・Parquetファイルを比較して，CSVに対するParquetのメリットを紹介していきます．</p>
<section id="メリット1csvよりデータ容量が軽い" class="level3">
<h3 class="anchored" data-anchor-id="メリット1csvよりデータ容量が軽い">メリット1：CSVよりデータ容量が軽い</h3>
<p>tidy dataは行数が多くなるため，CSVでの保存に適しておらず，Parquetを使ったほうがよいことを既に述べました．</p>
<p>実際に，<code>who_longer</code> のCSV・Parquetのデータ容量は，それぞれ，14.1 MBと154 KBとなり，<strong>ParquetはCSVの約1 %のデータ容量</strong>しかないことがわかります．</p>
<p>どのようなケースでもこのようなデータ容量の削減が見込めるわけではありませんが，<strong>Parquetは列指向でデータ圧縮</strong>を行うため，Rなどでよく用いられる<strong>tidy dataの保存に適したデータ形式</strong>であるといえます．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># CSV</span></span>
<span id="cb14-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file_size</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"who_longer.csv"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>14.1M</code></pre>
</div>
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Parquet</span></span>
<span id="cb16-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file_size</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"who_longer.parquet"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>156K</code></pre>
</div>
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1">units<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set_units</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file_size</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"who_longer.parquet"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file_size</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"who_longer.csv"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb18-2">  units<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set_units</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">%</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1.080502 [%]</code></pre>
</div>
</div>
</section>
<section id="メリット2csvより読み込みが簡単" class="level3">
<h3 class="anchored" data-anchor-id="メリット2csvより読み込みが簡単">メリット2：CSVより読み込みが簡単</h3>
<p><code>write_csv()</code>・<code>write_parquet()</code> でデータを書き込めるのと同様に，<strong><code>read_csv()</code>・<code>read_parquet()</code> でCSV・Parquetデータを読み込む</strong>ことができます．</p>
<p><strong>CSV</strong>はテキスト形式であるため，<strong>読み込み時に<code>col_types</code>で各列の型を指定する必要</strong>があります（デフォルトでは自動で型を推測）．</p>
<p>一方，<strong>Parquet</strong>は，書き込み時に各列の型情報も保存されているため読み込み時に<strong>型を指定する必要がありません</strong>．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># CSVの読み込み</span></span>
<span id="cb20-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_csv</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"who_longer.csv"</span>,</span>
<span id="cb20-3">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col_types =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cols</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.default =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"c"</span>,</span>
<span id="cb20-4">                          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">year =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"i"</span>,</span>
<span id="cb20-5">                          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">count =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"i"</span>))</span>
<span id="cb20-6"></span>
<span id="cb20-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Parquetの読み込み</span></span>
<span id="cb20-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_parquet</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"who_longer.parquet"</span>)</span></code></pre></div>
</div>
</section>
<section id="メリット3csvよりビッグデータの読み込み集計に適している" class="level3">
<h3 class="anchored" data-anchor-id="メリット3csvよりビッグデータの読み込み集計に適している">メリット3：CSVよりビッグデータの読み込み・集計に適している</h3>
<p>CSVはビッグデータの保存に適しておらず，これまでは，ビッグデータの保存にはSQLを用いるなどの使い分けが必要でした．</p>
<p>Rでは，dplyr（dbplyr）・DBIなどのパッケージで簡単にSQLが使えますが，データベースへの接続・切断などが必要なSQLは，CSVと使い勝手が異なり，初学者にとってはハードルがあるかもしれません．</p>
<p>また，（ほとんどの？）<strong>SQLは行指向</strong>であるため，<strong>データの追加・更新・削除などに適しています</strong>が，データ分析に用いられる<strong>データの保存・集計には列指向であるParquetのほうが適している</strong>と思われます．</p>
<p>CSVファイルを用いてビッグデータを集計する場合には，一度，全データをメモリに移す必要があります．そのため，データの読み込みでメモリが逼迫するおそれがあります．</p>
<p>Parquetでは，<strong>読み込み時に<code>as_data_frame = FALSE</code></strong>とすることで，SQLと同様に<strong>メモリにデータを移すことなくデータのフィルタリング・集計などが可能</strong>です．</p>
<p>ここでは，日本の年・症例別の患者数を計算してみましょう．<strong>dplyrの<code>filter()</code> ・<code>group_by()</code> ・<code>summarise()</code> などを使って効率的にクエリを作成</strong>することができます．<strong>最後に<code>collect()</code> を行えばデータフレームを出力</strong>することができます．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_parquet</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"who_longer.parquet"</span>,</span>
<span id="cb21-2">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">as_data_frame =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb21-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(country <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Japan"</span>,</span>
<span id="cb21-4">         <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(count)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb21-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(country, year, diagnosis) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb21-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarise</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">count =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(count),</span>
<span id="cb21-7">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.groups =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"drop"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb21-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">collect</span>()</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 33 × 4
   country  year diagnosis count
   &lt;chr&gt;   &lt;dbl&gt; &lt;chr&gt;     &lt;dbl&gt;
 1 Japan    1995 sp        14367
 2 Japan    1996 sp        12867
 3 Japan    1997 sp        13571
 4 Japan    1998 sp        11935
 5 Japan    2001 sp        11408
 6 Japan    2002 sp        10807
 7 Japan    2003 sp        10843
 8 Japan    2004 sp        10471
 9 Japan    1999 sp        12909
10 Japan    2000 sp        11853
# ℹ 23 more rows</code></pre>
</div>
</div>
</section>
<section id="メリット4複数のデータからなるデータセットを扱える" class="level3">
<h3 class="anchored" data-anchor-id="メリット4複数のデータからなるデータセットを扱える">メリット4：複数のデータからなるデータセットを扱える</h3>
<p>Parquetは列指向であるため，行指向であるSQLと違い，データの追加・更新・削除などに適していません．しかし，<strong>Parquetでは，複数のデータからなるデータセットの読み込みが簡単に行える</strong>ため，このようなデメリットを簡単に解決することができます．</p>
<p>ここでは，<code>who_longer</code>を年齢階級別に分割したParquetファイルを格納した<code>"who_longer_byage"</code> フォルダをデータセットのサンプルとして用いましょう．</p>
<p><strong><code>open_dataset("who_longer_byage")</code></strong> とすることで，複数のParquetファイルを含むにもかかわらず，さきほどと同様の<strong>データ集計を簡単に行うことができます</strong>．</p>
<div class="cell">
<details class="code-fold">
<summary>コード</summary>
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dir_create</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"who_longer_byage"</span>)</span>
<span id="cb23-2">who_longer <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb23-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(age) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb23-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_walk</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> .x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb23-5">               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">write_parquet</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_glue</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"who_longer_byage/who_longer_{.y$age}.parquet"</span>)),</span>
<span id="cb23-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.keep =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">open_dataset</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"who_longer_byage"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb24-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(country <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Japan"</span>,</span>
<span id="cb24-3">         <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(count)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb24-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(country, year, diagnosis) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb24-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarise</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">count =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(count),</span>
<span id="cb24-6">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.groups =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"drop"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb24-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">collect</span>()</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 33 × 4
   country  year diagnosis count
   &lt;chr&gt;   &lt;dbl&gt; &lt;chr&gt;     &lt;dbl&gt;
 1 Japan    1995 sp        14367
 2 Japan    1996 sp        12867
 3 Japan    1997 sp        13571
 4 Japan    1998 sp        11935
 5 Japan    2001 sp        11408
 6 Japan    2002 sp        10807
 7 Japan    2003 sp        10843
 8 Japan    2004 sp        10471
 9 Japan    2005 sp        10931
10 Japan    2006 sp        10159
# ℹ 23 more rows</code></pre>
</div>
</div>
</section>
<section id="メリット5rpython間でのデータのやり取りに適している" class="level3">
<h3 class="anchored" data-anchor-id="メリット5rpython間でのデータのやり取りに適している">メリット5：R・Python間でのデータのやり取りに適している</h3>
<p>PythonのpandasパッケージはParquetの読み書きに対応しているため，Parquetは，R・Python間でのデータのやり取りにも適しています．</p>
<p>Rで作成した<code>'who_longer.parquet'</code> をpandasで読み込んでみましょう．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pandas <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pd</span>
<span id="cb26-2"></span>
<span id="cb26-3">pd.read_parquet(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'who_longer.parquet'</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>            country iso2 iso3    year diagnosis gender   age   count
0       Afghanistan   AF  AFG  1980.0        sp      m   014     NaN
1       Afghanistan   AF  AFG  1980.0        sp      m  1524     NaN
2       Afghanistan   AF  AFG  1980.0        sp      m  2534     NaN
3       Afghanistan   AF  AFG  1980.0        sp      m  3544     NaN
4       Afghanistan   AF  AFG  1980.0        sp      m  4554     NaN
...             ...  ...  ...     ...       ...    ...   ...     ...
405435     Zimbabwe   ZW  ZWE  2013.0       rel      f  2534  4649.0
405436     Zimbabwe   ZW  ZWE  2013.0       rel      f  3544  3526.0
405437     Zimbabwe   ZW  ZWE  2013.0       rel      f  4554  1453.0
405438     Zimbabwe   ZW  ZWE  2013.0       rel      f  5564   811.0
405439     Zimbabwe   ZW  ZWE  2013.0       rel      f    65   725.0

[405440 rows x 8 columns]</code></pre>
</div>
</div>
</section>
</section>
<section id="まとめ" class="level2">
<h2 class="anchored" data-anchor-id="まとめ">まとめ</h2>
<p>ここまで，R・Pythonで利用可能なParquetのメリットを紹介しました．Parquetは，近年，データ分析で普及しているtidy dataの保存・集計に適しています．</p>
<p>また，最近では，地理データを扱えるsfパッケージのデータをparquetとして保存できる<a href="https://wcjochem.github.io/sfarrow/">sfarrow</a>なども登場しています．</p>
<p>CSVの代わりにParquetを用いることでデータ分析がさらに簡単になることが期待されます．</p>


</section>

 ]]></description>
  <category>parquet</category>
  <category>arrow</category>
  <category>R</category>
  <category>Python</category>
  <category>Japanese</category>
  <guid>https://uchidamizuki.quarto.pub/blog/posts/2022/06/use-parquet-instead-of-csv-ja.html</guid>
  <pubDate>Sat, 11 Jun 2022 15:00:00 GMT</pubDate>
</item>
<item>
  <title>Rで日本地図を描いてみよう</title>
  <link>https://uchidamizuki.quarto.pub/blog/posts/2022/06/draw-a-map-of-japan-in-r-ja.html</link>
  <description><![CDATA[ 





<p>Rでは，ggplot2などのパッケージを利用するだけで，きれいな日本地図（都道府県別）を描くことができます．</p>
<p>ここでは，日本地図をggplot2で描画する方法をいくつか紹介します．</p>
<section id="地図描画用のサンプルデータ" class="level2">
<h2 class="anchored" data-anchor-id="地図描画用のサンプルデータ">地図描画用のサンプルデータ</h2>
<p>ここでは，<a href="https://www.e-stat.go.jp/dbview?sid=0000010201">こちら</a>からダウンロードできる社会・人口統計体系の2015年の都道府県別外国人人口比率データ（10万人あたり外国人人口）を地図描画用のサンプルデータとしました．</p>
<div class="cell">
<details class="code-fold">
<summary>パッケージの読み込み</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse)</span></code></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>データのダウンロード</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(jpstat)</span>
<span id="cb2-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(arrow)</span>
<span id="cb2-3"></span>
<span id="cb2-4">appId <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> keyring<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">key_get</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"estat-api"</span>)</span>
<span id="cb2-5">foreigner_ratio_2015 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">estat</span>(appId, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://www.e-stat.go.jp/en/dbview?sid=0000010201"</span>,</span>
<span id="cb2-6">                              <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lang =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"E"</span>)</span>
<span id="cb2-7">foreigner_ratio_2015 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> foreigner_ratio_2015 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb2-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">activate</span>(tab) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb2-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb2-10">  </span>
<span id="cb2-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">activate</span>(cat01) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb2-12">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Ratio of population of foreigners (per 100,000 persons)</span></span>
<span id="cb2-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(code <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#A01601"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb2-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb2-15">  </span>
<span id="cb2-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">activate</span>(area) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb2-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(name <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"All Japan"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb2-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(code, name) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb2-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rekey</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pref"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb2-20">  </span>
<span id="cb2-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">activate</span>(time) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb2-22">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(name <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2015"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb2-23">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>()</span>
<span id="cb2-24">foreigner_ratio_2015 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> foreigner_ratio_2015 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb2-25">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">collect</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"foreigners_per_100K"</span>)</span>
<span id="cb2-26"></span>
<span id="cb2-27"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">write_parquet</span>(foreigner_ratio_2015, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"foreigner_ratio_2015.parquet"</span>)</span></code></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>データの読み込み</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(arrow)</span>
<span id="cb3-2"></span>
<span id="cb3-3">foreigner_ratio_2015 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_parquet</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"foreigner_ratio_2015.parquet"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb3-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pref_code =</span> pref_code <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb3-5">           <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_extract</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"^</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">d{2}"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb3-6">           <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">parse_integer</span>(),</span>
<span id="cb3-7">         </span>
<span id="cb3-8">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pref_name =</span> pref_name <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb3-9">           <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_remove</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"-.+$"</span>),</span>
<span id="cb3-10">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pref_name =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_when</span>(pref_name <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Gumma"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Gunma"</span>,</span>
<span id="cb3-11">                               <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> pref_name),</span>
<span id="cb3-12">         </span>
<span id="cb3-13">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">foreigner_ratio =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">parse_number</span>(foreigners_per_100K) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e5</span>,</span>
<span id="cb3-14">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.keep =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"unused"</span>)</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">foreigner_ratio_2015</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 47 × 3
   pref_code pref_name foreigner_ratio
       &lt;int&gt; &lt;chr&gt;               &lt;dbl&gt;
 1         1 Hokkaido          0.00403
 2         2 Aomori            0.00264
 3         3 Iwate             0.00392
 4         4 Miyagi            0.00599
 5         5 Akita             0.00285
 6         6 Yamagata          0.00490
 7         7 Fukushima         0.00456
 8         8 Ibaraki           0.0142 
 9         9 Tochigi           0.0134 
10        10 Gunma             0.0188 
# ℹ 37 more rows</code></pre>
</div>
</div>
</section>
<section id="geom_map-を使って日本地図を描く" class="level2">
<h2 class="anchored" data-anchor-id="geom_map-を使って日本地図を描く"><code>geom_map()</code> を使って日本地図を描く</h2>
<p>ggplot2では，<code>map_data()</code> や<code>geom_map()</code> を使うことで，世界の国々を描画することができます．これには，mapsパッケージを予めダウンロードする必要があります．また，日本地図を利用するには，mapsパッケージに加えて，mapdataパッケージが必要になります．</p>
<p><code>map_data("japan")</code> とすることで，mapsパッケージの地図データがデータフレームに変換されます．このデータフレームの<code>region</code> 列が都道府県のIDとなるため，<code>aes(map_id = region)</code>を設定した上で，<code>geom_map()</code> することで，描画したいデータの<code>region</code> 列と都道府県ジオメトリがリンクします．</p>
<p>ただし，<code>map_data("japan")</code> は，以下の点に注意が必要です．</p>
<ul>
<li><p><code>region</code> 列はすべてアルファベット表記である</p></li>
<li><p>他の都道府県と違い，奈良県だけがが<code>NARA</code> と大文字表記になっているなど，元データに問題あり</p>
<ul>
<li>ここでは，<code>str_to_title()</code>で修正</li>
</ul></li>
</ul>
<p>また，日本地図全体を表示するためには，<code>expand_limits()</code> などで軸を設定すること必要になります．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># pak::pak("maps")</span></span>
<span id="cb6-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># pak::pak("mapdata")</span></span>
<span id="cb6-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse)</span>
<span id="cb6-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(mapdata)</span>
<span id="cb6-5"></span>
<span id="cb6-6">map_data_japan <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map_data</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"japan"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_tibble</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb6-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">region =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_to_title</span>(region))</span>
<span id="cb6-9">map_data_japan</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 46,975 × 6
    long   lat group order region   subregion
   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt; &lt;chr&gt;    &lt;chr&gt;    
 1  140.  42.3     1     1 Hokkaido &lt;NA&gt;     
 2  140.  42.3     1     2 Hokkaido &lt;NA&gt;     
 3  140.  42.3     1     3 Hokkaido &lt;NA&gt;     
 4  140.  42.3     1     4 Hokkaido &lt;NA&gt;     
 5  140.  42.3     1     5 Hokkaido &lt;NA&gt;     
 6  140.  42.3     1     6 Hokkaido &lt;NA&gt;     
 7  140.  42.3     1     7 Hokkaido &lt;NA&gt;     
 8  140.  42.3     1     8 Hokkaido &lt;NA&gt;     
 9  140.  42.3     1     9 Hokkaido &lt;NA&gt;     
10  140.  42.3     1    10 Hokkaido &lt;NA&gt;     
# ℹ 46,965 more rows</code></pre>
</div>
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(foreigner_ratio_2015 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb8-2">         <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">region =</span> pref_name),</span>
<span id="cb8-3">       <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">map_id =</span> region)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb8-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_map</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> foreigner_ratio),</span>
<span id="cb8-5">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">map =</span> map_data_japan) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb8-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">expand_limits</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> map_data_japan<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>long,</span>
<span id="cb8-7">                <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> map_data_japan<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>lat) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb8-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_viridis_c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"外国人人口比率"</span>,</span>
<span id="cb8-9">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">limits =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.03</span>),</span>
<span id="cb8-10">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> scales<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">label_percent</span>(),</span>
<span id="cb8-11">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">option =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"turbo"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://uchidamizuki.quarto.pub/blog/posts/2022/06/draw-a-map-of-japan-in-r-ja_files/figure-html/geom_map-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="sfパッケージを使って日本地図を描く" class="level2">
<h2 class="anchored" data-anchor-id="sfパッケージを使って日本地図を描く">sfパッケージを使って日本地図を描く</h2>
<p>最近では，sfパッケージのジオメトリがggplot2で簡単に描画できるようになっています．</p>
<p>また，maps・mapdataパッケージの提供する地図データは，sfパッケージの<code>st_as_sf()</code> でsfのジオメトリデータに変換することができます．</p>
<p>日本地図データをsfに変換することで，先ほどよりも直感的に地図を描くことができます．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(sf)</span>
<span id="cb9-2"></span>
<span id="cb9-3">map_japan <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> maps<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"japan"</span>, </span>
<span id="cb9-4">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>,</span>
<span id="cb9-5">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb9-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">st_as_sf</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb9-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pref_name =</span> ID) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb9-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pref_name =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_to_title</span>(pref_name))</span>
<span id="cb9-9"></span>
<span id="cb9-10">map_japan <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb9-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(foreigner_ratio_2015,</span>
<span id="cb9-12">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pref_name"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb9-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> foreigner_ratio)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"transparent"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_viridis_c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"外国人人口比率"</span>,</span>
<span id="cb9-16">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">limits =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.03</span>),</span>
<span id="cb9-17">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> scales<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">label_percent</span>(),</span>
<span id="cb9-18">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">option =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"turbo"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://uchidamizuki.quarto.pub/blog/posts/2022/06/draw-a-map-of-japan-in-r-ja_files/figure-html/sf-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="もっと簡単に日本地図を描く" class="level2">
<h2 class="anchored" data-anchor-id="もっと簡単に日本地図を描く">もっと簡単に日本地図を描く</h2>
<p><a href="https://github.com/UchidaMizuki/jpmap">jpmap</a>は，ggplot2による日本地図の描画をより簡単にするためのパッケージです．</p>
<p>jpmapは，以下の2つの機能を持ちます．</p>
<ul>
<li><p>日本語の都道府県名や都道府県コードが含む都道府県データを提供（<code>jpmap::prefecture</code>）</p></li>
<li><p>琉球諸島・小笠原諸島を再配置したレイアウトを可能に（<code>jpmap::layout_islands()</code>）</p></li>
</ul>
<p><code>jpmap::layout_islands()</code> で地図のレイアウトを変更することで，都道府県ごとの傾向がよりわかりやすくなります．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># pak::pak("UchidaMizuki/jpmap")</span></span>
<span id="cb10-2">jpmap<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>prefecture</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 47 features and 3 fields
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: 122.9382 ymin: 24.2121 xmax: 153.9856 ymax: 45.52041
Geodetic CRS:  JGD2011
# A tibble: 47 × 4
   pref_code pref_name pref_name_ja                                     geometry
       &lt;int&gt; &lt;chr&gt;     &lt;chr&gt;                                  &lt;MULTIPOLYGON [°]&gt;
 1         1 Hokkaido  北海道       (((143.8965 44.15815, 143.9118 44.15229, 14…
 2         2 Aomori    青森県       (((139.9438 40.42928, 139.9426 40.43439, 13…
 3         3 Iwate     岩手県       (((141.681 40.45101, 141.6909 40.44229, 141…
 4         4 Miyagi    宮城県       (((141.6403 38.9675, 141.6406 38.9652, 141.…
 5         5 Akita     秋田県       (((139.8809 39.11511, 139.8919 39.13321, 13…
 6         6 Yamagata  山形県       (((139.5487 38.545, 139.5801 38.60688, 139.…
 7         7 Fukushima 福島県       (((140.9332 37.8898, 140.9334 37.88923, 140…
 8         8 Ibaraki   茨城県       (((140.7973 36.84649, 140.7931 36.83755, 14…
 9         9 Tochigi   栃木県       (((139.6537 36.20314, 139.6385 36.22575, 13…
10        10 Gunma     群馬県       (((138.6795 36.73065, 138.7227 36.74918, 13…
# ℹ 37 more rows</code></pre>
</div>
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1">plot <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> jpmap<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>prefecture <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb12-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(foreigner_ratio_2015,</span>
<span id="cb12-3">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pref_code"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pref_name"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb12-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> foreigner_ratio)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb12-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_sf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"transparent"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb12-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_viridis_c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"外国人人口比率"</span>,</span>
<span id="cb12-7">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">limits =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.03</span>),</span>
<span id="cb12-8">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> scales<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">label_percent</span>(),</span>
<span id="cb12-9">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">option =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"turbo"</span>)</span>
<span id="cb12-10"></span>
<span id="cb12-11">jpmap<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">layout_islands</span>(plot,</span>
<span id="cb12-12">                      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ogasawara =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: `layout_islands()` was deprecated in jpmap 0.2.0.
ℹ Please use `layout_japan()` instead.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://uchidamizuki.quarto.pub/blog/posts/2022/06/draw-a-map-of-japan-in-r-ja_files/figure-html/jpmap-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="まとめ地図からわかったこと" class="level2">
<h2 class="anchored" data-anchor-id="まとめ地図からわかったこと">まとめ（地図からわかったこと）</h2>
<p>2015年の都道府県別外国人人口比率に関する日本地図から以下のことがわかりました．</p>
<ul>
<li><p>2015年では<strong>どの都道府県でも外国人人口比率が3％以下</strong>である</p></li>
<li><p><strong>東京都</strong>は外国人人口比率が最も多く，<strong>愛知県</strong>や<strong>群馬県</strong>なども外国人口比率が高い．</p></li>
</ul>
<p>ここまで，ggplot2などのパッケージを活用した日本地図の描画を試してみました．</p>
<p>その結果，Rを使えば，自前でデータを整備しなくても，簡単に日本地図を描けることがわかりました．みなさんもぜひ，ggplot2を使って，色々な地図を使ってみてください！</p>


</section>

 ]]></description>
  <category>ggplot2</category>
  <category>sf</category>
  <category>jpmap</category>
  <category>R</category>
  <category>Japanese</category>
  <guid>https://uchidamizuki.quarto.pub/blog/posts/2022/06/draw-a-map-of-japan-in-r-ja.html</guid>
  <pubDate>Fri, 10 Jun 2022 15:00:00 GMT</pubDate>
  <media:content url="https://uchidamizuki.quarto.pub/blog/posts/2022/06/foreigner_ratio_2015.png" medium="image" type="image/png" height="144" width="144"/>
</item>
<item>
  <title>Rで産業連関分析</title>
  <link>https://uchidamizuki.quarto.pub/blog/posts/2022/05/ioanalysis-in-r-ja.html</link>
  <description><![CDATA[ 





<p>産業連関分析は，経済波及効果の算出に広く用いられている分析手法です． 日本では，国や都道府県によって，約5年に1度，産業連関表と呼ばれる統計データが 作成・公開されており，産業連関分析における基礎データとなっています．</p>
<p>これまで，産業連関分析では，Excel・VBAが用いられることが多かったようです．</p>
<p>一方で，近年は，Python・R・Juliaなどのプログラミング言語の普及が進んでいます． これらのプログラミング言語は以下のような特長を持っています．</p>
<ul>
<li>無料で利用することができる</li>
<li>作業の再現性が高まりミスが修正しやすい・他者がミスに気づきやすい</li>
<li>高度な分析手法が簡単に利用できる</li>
</ul>
<p>そのため今後は，産業連関分析においても，これらのプログラミング言語の利用が 進むのではないかと思われます．</p>
<p>ここでは，Rを用いて産業連関分析を行います． Rでは近年，tidyverseなどモダンなデータ分析を行うためのパッケージが 多く提供されており，プログラミング初心者でも習得しやすい言語であると思います．</p>
<p>産業連関表として，e-Statのデータベースで公開されている日本（国）の 2013年・13部門産業連関表を用います． ここで使用するデータは， <a href="https://github.com/UchidaMizuki/blog-ioanalysis-in-r">こちら</a> からダウンロードできます．</p>
<section id="産業連関分析の基礎" class="level2">
<h2 class="anchored" data-anchor-id="産業連関分析の基礎">産業連関分析の基礎</h2>
<p>産業連関分析は一般的に以下の流れに従って行われます．</p>
<ol type="1">
<li><strong>産業連関表</strong>の整形</li>
<li><strong>投入係数行列</strong>の算出</li>
<li><strong>レオンチェフ逆行列</strong>の算出</li>
<li><strong>経済波及効果</strong>の算出</li>
</ol>
<p>まず，産業連関分析において重要な投入係数行列・レオンチェフ逆行列・経済波及効果の算出方法について解説します．</p>
<section id="投入係数行列とは" class="level3">
<h3 class="anchored" data-anchor-id="投入係数行列とは">投入係数行列とは</h3>
<p>投入係数は，産業の「<strong>クッキングレシピ</strong>」として呼ばれており，産業<img src="https://latex.codecogs.com/png.latex?j">の生産物を1単位生産するのに必要な産業<img src="https://latex.codecogs.com/png.latex?i">の生産物の量を表すものです．具体的には，以下のように中間投入<img src="https://latex.codecogs.com/png.latex?x_%7Bij%7D">を生産額<img src="https://latex.codecogs.com/png.latex?X_j">（産出額）で割ることで算出できます．</p>
<p><img src="https://latex.codecogs.com/png.latex?%0Aa_%7Bij%7D=%5Cfrac%7Bx_%7Bij%7D%7D%7BX_j%7D%0A"></p>
<p>産業連関分析では，「クッキングレシピ」に相当する投入係数<img src="https://latex.codecogs.com/png.latex?a_%7Bij%7D">に基づく生産額のバランス式（行方向）を連立方程式として解きます．そこで，以下のように，<strong>投入係数行列</strong>（通常，<img src="https://latex.codecogs.com/png.latex?A">と表される）と呼ばれる行列を作成することで，連立方程式が簡単に解けるようになります．</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AA%20=%20%5Cbegin%7Bpmatrix%7D%0A%20%20a_%7B11%7D%20&amp;%20%5Ccdots%20&amp;%20a_%7B1n%7D%20%5C%5C%0A%20%20%5Cvdots%20&amp;%20%5Cddots%20&amp;%20%5Cvdots%20%5C%5C%0A%20%20a_%7Bn1%7D%20&amp;%20%5Ccdots%20&amp;%20a_%7Bnn%7D%20%5C%5C%0A%5Cend%7Bpmatrix%7D%0A"></p>
</section>
<section id="レオンチェフ逆行列による経済波及効果の推計について" class="level3">
<h3 class="anchored" data-anchor-id="レオンチェフ逆行列による経済波及効果の推計について">レオンチェフ逆行列による経済波及効果の推計について</h3>
<p>生産額のバランス式（行方向）は，行列を用いて以下のように表せます．変数の意味は以下の表の通りです．</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AAX%20+%20F%20+%20E%20-%20M%20=%20X%0A"></p>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: center;">変数</th>
<th style="text-align: center;">意味</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"><img src="https://latex.codecogs.com/png.latex?A"></td>
<td style="text-align: center;">投入係数行列</td>
</tr>
<tr class="even">
<td style="text-align: center;"><img src="https://latex.codecogs.com/png.latex?X%20=%20(X_1,%20%5Ccdots,%20X_n)%20%5E%20%5Ctop"></td>
<td style="text-align: center;">生産額ベクトル</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><img src="https://latex.codecogs.com/png.latex?F%20=%20(F_1,%20%5Ccdots,%20F_n)%20%5E%20%5Ctop"></td>
<td style="text-align: center;">最終需要ベクトル</td>
</tr>
<tr class="even">
<td style="text-align: center;"><img src="https://latex.codecogs.com/png.latex?E%20=%20(E_1,%20%5Ccdots,%20E_n)%20%5E%20%5Ctop"></td>
<td style="text-align: center;">移輸出ベクトル</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><img src="https://latex.codecogs.com/png.latex?M%20=%20(M_1,%20%5Ccdots,%20M_n)%20%5E%20%5Ctop"></td>
<td style="text-align: center;">移輸入ベクトル</td>
</tr>
</tbody>
</table>
<p>経済波及効果の推計では，<strong>最終需要の変化が生産額に与える波及効果</strong>を算出します．</p>
<p>特に，日本の産業連関表での経済波及効果の推計では，<strong>移輸入</strong><img src="https://latex.codecogs.com/png.latex?M"><strong>の扱いに注意が必要</strong>です（これは，日本表の多くが競争移輸入型表と呼ばれる形式を採用しており，投入係数に移輸入分が含まれているためです）．</p>
<p>最終需要による経済波及効果は，域内の生産額だけでなく域外からの移輸入を誘発すると考えられます．この効果を無視すると経済波及効果を過大評価することにつながるため，通常，<strong>投入係数から移輸入相当分を差し引く</strong>という処理が行われます．</p>
<p>移輸入は域内需要におおよそ比例すると考えられるため，以下のように，移輸入係数<img src="https://latex.codecogs.com/png.latex?%5Chat%7BM_i%7D">が算出できます．</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Chat%7BM_i%7D%20=%20%5Cfrac%7BM_i%7D%7B%5Csum_%7Bj%7Da_%7Bij%7DX_j%20+%20F_i%7D%0A"></p>
<p>さらに，行列での計算に適した移輸入係数行列<img src="https://latex.codecogs.com/png.latex?%5Chat%7BM%7D">が，以下のように定義されます．</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Chat%7BM%7D%20=%0A%5Cbegin%7Bpmatrix%7D%0A%20%20%5Chat%7BM_1%7D%20&amp;%20&amp;%200%20%5C%5C%0A%20%20&amp;%20%5Cddots%20&amp;%20%5C%5C%0A%20%200%20&amp;%20&amp;%20%5Chat%7BM_n%7D%20%5C%5C%0A%5Cend%7Bpmatrix%7D%0A"></p>
<p>以上より，生産額のバランス式（行方向）は，移輸入係数行列<img src="https://latex.codecogs.com/png.latex?%5Chat%7BM%7D">を用いて，以下のように変形されます．ただし，<img src="https://latex.codecogs.com/png.latex?I">は単位行列（対角成分が1，それ以外が0の正方行列）です．</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign%7D%0A%20%20AX%20+%20F%20+%20E%20-%20%5Chat%7BM%7D%20(AX%20+%20F)%20&amp;=%20X%20%5C%5C%0A%20%20(I%20-%20%5Chat%7BM%7D)%20(AX%20+%20F)%20+%20E%20&amp;=%20X%0A%5Cend%7Balign%7D%0A"></p>
<p>上のバランス式より，経済波及効果の算出式が，以下のように導出されます．ここで，<img src="https://latex.codecogs.com/png.latex?%5CDelta%20X">，<img src="https://latex.codecogs.com/png.latex?%5CDelta%20F">は，それぞれ，生産額の変化量，最終需要の変化量です．</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign%7D%0A%20%20X%20&amp;=%20(I%20-%20%5Chat%7BM%7D)%20(AX%20+%20F)%20+%20E%20%5C%5C%0A%20%20%5BI%20-%20(I%20-%20%5Chat%7BM%7D)%20A%5D%20X%20&amp;=%20(I%20-%20%5Chat%7BM%7D)%20F%20+%20E%20%5C%5C%0A%20%20X%20&amp;=%20%5BI%20-%20(I%20-%20%5Chat%7BM%7D)%20A%5D%20%5E%20%7B-1%7D%20%5B(I%20-%20%5Chat%7BM%7D)%20F%20+%20E%5D%20%5C%5C%0A%20%20%5CDelta%20X%20&amp;=%20%5BI%20-%20(I%20-%20%5Chat%7BM%7D)%20A%5D%20%5E%20%7B-1%7D%20(I%20-%20%5Chat%7BM%7D)%20%5CDelta%20F%0A%5Cend%7Balign%7D%0A"></p>
<p>生産額の変化量<img src="https://latex.codecogs.com/png.latex?%5CDelta%20X">の式の右辺の<img src="https://latex.codecogs.com/png.latex?(I%20-%20%5Chat%7BM%7D)%20%5CDelta%20F">は，最終需要の変化量に自給率<img src="https://latex.codecogs.com/png.latex?I%20-%20%5Chat%7BM%7D">を掛けた値となっています．</p>
<p>また，<img src="https://latex.codecogs.com/png.latex?%5BI%20-%20(I%20-%20%5Chat%7BM%7D)%20A%5D%20%5E%20%7B-1%7D">は，最終需要の変化による直接・間接の波及効果を表す行列であり（開放型または競争移輸入型の）<strong>レオンチェフ逆行列</strong>と呼ばれています．</p>
<p>以上のように，最終需要の変化量<img src="https://latex.codecogs.com/png.latex?%5CDelta%20F">から生産額の変化量<img src="https://latex.codecogs.com/png.latex?%5CDelta%20X">を推計するというのが，最も一般的な産業連関分析の方法となっています．</p>
</section>
</section>
<section id="rによる産業連関分析" class="level2">
<h2 class="anchored" data-anchor-id="rによる産業連関分析">Rによる産業連関分析</h2>
<section id="産業連関表の整形" class="level3">
<h3 class="anchored" data-anchor-id="産業連関表の整形">産業連関表の整形</h3>
<p>ここでは， <a href="https://github.com/UchidaMizuki/blog-ioanalysis-in-r">こちら</a> からダウンロードできる日本の2011年の3部門表（<code>iotable_3sector_2011_wider.csv</code>）を使用します．</p>
<p>こちらの表は，以下のように，日本の2011年の13部門表より作成したもので，<strong>単位は「百万円」</strong>です．</p>
<ul>
<li>13部門の産業分類を<strong>第1次・第2次・第3次産業に集計</strong>（注：「分類不明」を第3次産業に分類）</li>
<li>付加価値部門を1部門に集計</li>
<li>最終需要部門を域内最終需要（<code>finaldemand</code>）・輸出（<code>export</code>）・輸入（<code>import</code>）の3部門に集計</li>
</ul>
<p>産業連関表のデータ形式は，e-Statのデータベースで提供されている表などを除いて， 行に投入部門（<code>input</code>）・列に産出部門（<code>output</code>）を持つ「横長データ」であることが多いと思われます．</p>
<p>ここでも，以下の通り，まずは横長の産業連関表データを読み込みます．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'ggplot2' was built under R version 4.2.3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'tibble' was built under R version 4.2.3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'dplyr' was built under R version 4.2.3</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1">iotable_wider <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_csv</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"iotable_3sector_2011_wider.csv"</span>,</span>
<span id="cb5-2">                          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col_types =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cols</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.default =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"c"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb5-3">  </span>
<span id="cb5-4">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># input (投入) 列以外を数値に変換</span></span>
<span id="cb5-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>input, parse_number))</span>
<span id="cb5-6"></span>
<span id="cb5-7">knitr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kable</span>(iotable_wider)</span></code></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 16%">
<col style="width: 13%">
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 18%">
<col style="width: 11%">
<col style="width: 11%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">input</th>
<th style="text-align: right;">industry/01_primary</th>
<th style="text-align: right;">industry/02_secondary</th>
<th style="text-align: right;">industry/03_tertiary</th>
<th style="text-align: right;">finaldemand/04_finaldemand</th>
<th style="text-align: right;">export/05_export</th>
<th style="text-align: right;">import/06_import</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">industry/01_primary</td>
<td style="text-align: right;">1456611</td>
<td style="text-align: right;">7850628</td>
<td style="text-align: right;">1373767</td>
<td style="text-align: right;">3869875</td>
<td style="text-align: right;">47890</td>
<td style="text-align: right;">-2562809</td>
</tr>
<tr class="even">
<td style="text-align: left;">industry/02_secondary</td>
<td style="text-align: right;">2715710</td>
<td style="text-align: right;">161897553</td>
<td style="text-align: right;">62841827</td>
<td style="text-align: right;">132924323</td>
<td style="text-align: right;">54473273</td>
<td style="text-align: right;">-71673715</td>
</tr>
<tr class="odd">
<td style="text-align: left;">industry/03_tertiary</td>
<td style="text-align: right;">2025270</td>
<td style="text-align: right;">66811645</td>
<td style="text-align: right;">155796589</td>
<td style="text-align: right;">352324555</td>
<td style="text-align: right;">16423417</td>
<td style="text-align: right;">-8921553</td>
</tr>
<tr class="even">
<td style="text-align: left;">valueadded/04_valueadded</td>
<td style="text-align: right;">5838371</td>
<td style="text-align: right;">106619145</td>
<td style="text-align: right;">364447740</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>データ分析においては，「横長データ」よりも，以下のような「縦長データ」のほうが， 分析しやすい場合が多くあります． ここでも，横長の産業連関表を「縦長データ」に変換します．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1">iotable <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> iotable_wider <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb6-2">  </span>
<span id="cb6-3">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># input (投入) 列を分類・名称に分割</span></span>
<span id="cb6-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">separate</span>(input, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"input_type"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"input_name"</span>),</span>
<span id="cb6-5">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sep =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb6-6">  </span>
<span id="cb6-7">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># input (投入) と同様にoutput (産出) の分類・名称列を追加し縦長データに</span></span>
<span id="cb6-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_longer</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(input_type, input_name),</span>
<span id="cb6-9">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_to =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"output_type"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"output_name"</span>),</span>
<span id="cb6-10">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_sep =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/"</span>,</span>
<span id="cb6-11">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"value_M"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb6-12">  </span>
<span id="cb6-13">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 数値が存在しない行を削除</span></span>
<span id="cb6-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">drop_na</span>(value_M)</span>
<span id="cb6-15"></span>
<span id="cb6-16">knitr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kable</span>(iotable)</span></code></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">input_type</th>
<th style="text-align: left;">input_name</th>
<th style="text-align: left;">output_type</th>
<th style="text-align: left;">output_name</th>
<th style="text-align: right;">value_M</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">industry</td>
<td style="text-align: left;">01_primary</td>
<td style="text-align: left;">industry</td>
<td style="text-align: left;">01_primary</td>
<td style="text-align: right;">1456611</td>
</tr>
<tr class="even">
<td style="text-align: left;">industry</td>
<td style="text-align: left;">01_primary</td>
<td style="text-align: left;">industry</td>
<td style="text-align: left;">02_secondary</td>
<td style="text-align: right;">7850628</td>
</tr>
<tr class="odd">
<td style="text-align: left;">industry</td>
<td style="text-align: left;">01_primary</td>
<td style="text-align: left;">industry</td>
<td style="text-align: left;">03_tertiary</td>
<td style="text-align: right;">1373767</td>
</tr>
<tr class="even">
<td style="text-align: left;">industry</td>
<td style="text-align: left;">01_primary</td>
<td style="text-align: left;">finaldemand</td>
<td style="text-align: left;">04_finaldemand</td>
<td style="text-align: right;">3869875</td>
</tr>
<tr class="odd">
<td style="text-align: left;">industry</td>
<td style="text-align: left;">01_primary</td>
<td style="text-align: left;">export</td>
<td style="text-align: left;">05_export</td>
<td style="text-align: right;">47890</td>
</tr>
<tr class="even">
<td style="text-align: left;">industry</td>
<td style="text-align: left;">01_primary</td>
<td style="text-align: left;">import</td>
<td style="text-align: left;">06_import</td>
<td style="text-align: right;">-2562809</td>
</tr>
<tr class="odd">
<td style="text-align: left;">industry</td>
<td style="text-align: left;">02_secondary</td>
<td style="text-align: left;">industry</td>
<td style="text-align: left;">01_primary</td>
<td style="text-align: right;">2715710</td>
</tr>
<tr class="even">
<td style="text-align: left;">industry</td>
<td style="text-align: left;">02_secondary</td>
<td style="text-align: left;">industry</td>
<td style="text-align: left;">02_secondary</td>
<td style="text-align: right;">161897553</td>
</tr>
<tr class="odd">
<td style="text-align: left;">industry</td>
<td style="text-align: left;">02_secondary</td>
<td style="text-align: left;">industry</td>
<td style="text-align: left;">03_tertiary</td>
<td style="text-align: right;">62841827</td>
</tr>
<tr class="even">
<td style="text-align: left;">industry</td>
<td style="text-align: left;">02_secondary</td>
<td style="text-align: left;">finaldemand</td>
<td style="text-align: left;">04_finaldemand</td>
<td style="text-align: right;">132924323</td>
</tr>
<tr class="odd">
<td style="text-align: left;">industry</td>
<td style="text-align: left;">02_secondary</td>
<td style="text-align: left;">export</td>
<td style="text-align: left;">05_export</td>
<td style="text-align: right;">54473273</td>
</tr>
<tr class="even">
<td style="text-align: left;">industry</td>
<td style="text-align: left;">02_secondary</td>
<td style="text-align: left;">import</td>
<td style="text-align: left;">06_import</td>
<td style="text-align: right;">-71673715</td>
</tr>
<tr class="odd">
<td style="text-align: left;">industry</td>
<td style="text-align: left;">03_tertiary</td>
<td style="text-align: left;">industry</td>
<td style="text-align: left;">01_primary</td>
<td style="text-align: right;">2025270</td>
</tr>
<tr class="even">
<td style="text-align: left;">industry</td>
<td style="text-align: left;">03_tertiary</td>
<td style="text-align: left;">industry</td>
<td style="text-align: left;">02_secondary</td>
<td style="text-align: right;">66811645</td>
</tr>
<tr class="odd">
<td style="text-align: left;">industry</td>
<td style="text-align: left;">03_tertiary</td>
<td style="text-align: left;">industry</td>
<td style="text-align: left;">03_tertiary</td>
<td style="text-align: right;">155796589</td>
</tr>
<tr class="even">
<td style="text-align: left;">industry</td>
<td style="text-align: left;">03_tertiary</td>
<td style="text-align: left;">finaldemand</td>
<td style="text-align: left;">04_finaldemand</td>
<td style="text-align: right;">352324555</td>
</tr>
<tr class="odd">
<td style="text-align: left;">industry</td>
<td style="text-align: left;">03_tertiary</td>
<td style="text-align: left;">export</td>
<td style="text-align: left;">05_export</td>
<td style="text-align: right;">16423417</td>
</tr>
<tr class="even">
<td style="text-align: left;">industry</td>
<td style="text-align: left;">03_tertiary</td>
<td style="text-align: left;">import</td>
<td style="text-align: left;">06_import</td>
<td style="text-align: right;">-8921553</td>
</tr>
<tr class="odd">
<td style="text-align: left;">valueadded</td>
<td style="text-align: left;">04_valueadded</td>
<td style="text-align: left;">industry</td>
<td style="text-align: left;">01_primary</td>
<td style="text-align: right;">5838371</td>
</tr>
<tr class="even">
<td style="text-align: left;">valueadded</td>
<td style="text-align: left;">04_valueadded</td>
<td style="text-align: left;">industry</td>
<td style="text-align: left;">02_secondary</td>
<td style="text-align: right;">106619145</td>
</tr>
<tr class="odd">
<td style="text-align: left;">valueadded</td>
<td style="text-align: left;">04_valueadded</td>
<td style="text-align: left;">industry</td>
<td style="text-align: left;">03_tertiary</td>
<td style="text-align: right;">364447740</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>上で構築した表データは，各行のフィルタリングなどが容易にできる一方で， 産業連関分析に用いられる行列計算などに適していません．</p>
<p>そこで，表データの基本的な演算と行列計算を同時に行えるdibbleパッケージを用います． 以下のように，産業連関表をdibbleに変換します．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># pak::pak("UchidaMizuki/dibble")</span></span>
<span id="cb7-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dibble)</span>
<span id="cb7-3"></span>
<span id="cb7-4">iotable <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> iotable <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb7-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dibble_by</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">input =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(input_type, input_name),</span>
<span id="cb7-6">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">output =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(output_type, output_name),</span>
<span id="cb7-7">            </span>
<span id="cb7-8">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># "_"で列名を分割してinput (投入)・output (産出) 軸を設定</span></span>
<span id="cb7-9">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.names_sep =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"_"</span>)</span>
<span id="cb7-10"></span>
<span id="cb7-11">iotable</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A dibble:   24 x 1
# Dimensions: input [4], output [6]
# Measures:   value_M
   input$type $name        output$type $name            value_M
   &lt;chr&gt;      &lt;chr&gt;        &lt;chr&gt;       &lt;chr&gt;              &lt;dbl&gt;
 1 industry   01_primary   industry    01_primary       1456611
 2 industry   01_primary   industry    02_secondary     7850628
 3 industry   01_primary   industry    03_tertiary      1373767
 4 industry   01_primary   finaldemand 04_finaldemand   3869875
 5 industry   01_primary   export      05_export          47890
 6 industry   01_primary   import      06_import       -2562809
 7 industry   02_secondary industry    01_primary       2715710
 8 industry   02_secondary industry    02_secondary   161897553
 9 industry   02_secondary industry    03_tertiary     62841827
10 industry   02_secondary finaldemand 04_finaldemand 132924323
# ℹ 14 more rows</code></pre>
</div>
</div>
</section>
<section id="投入係数行列の算出" class="level3">
<h3 class="anchored" data-anchor-id="投入係数行列の算出">投入係数行列の算出</h3>
<p>産業の「クッキングレシピ」と呼ばれる投入係数行列<img src="https://latex.codecogs.com/png.latex?A">を以下のように中間投入を生産額で割って算出します．</p>
<p>注：dibbleではブロードキャストが自動で行われますが，安全のため，ブロードキャストを行う際に，警告を発するように設計されています．そのため，<code>broadcast()</code>でブロードキャスト後の軸名<code>c("input", "output")</code>を与えて警告が出ないようにする必要があります．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 生産額</span></span>
<span id="cb9-2">total_input <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> iotable <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb9-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(output<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"industry"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb9-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">apply</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"output"</span>, sum)</span>
<span id="cb9-5"></span>
<span id="cb9-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 中間投入</span></span>
<span id="cb9-7">interindustry <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> iotable <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb9-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(input<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"industry"</span>,</span>
<span id="cb9-9">         output<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"industry"</span>)</span>
<span id="cb9-10"></span>
<span id="cb9-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 投入係数</span></span>
<span id="cb9-12">inputcoeff <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">broadcast</span>(interindustry <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> total_input,</span>
<span id="cb9-13">                        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"input"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"output"</span>))</span>
<span id="cb9-14"></span>
<span id="cb9-15">inputcoeff</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A dibble:   9
# Dimensions: input [3], output [3]
  input$type $name        output$type $name              .
  &lt;chr&gt;      &lt;chr&gt;        &lt;chr&gt;       &lt;chr&gt;          &lt;dbl&gt;
1 industry   01_primary   industry    01_primary   0.121  
2 industry   01_primary   industry    02_secondary 0.0229 
3 industry   01_primary   industry    03_tertiary  0.00235
4 industry   02_secondary industry    01_primary   0.226  
5 industry   02_secondary industry    02_secondary 0.472  
6 industry   02_secondary industry    03_tertiary  0.108  
7 industry   03_tertiary  industry    01_primary   0.168  
8 industry   03_tertiary  industry    02_secondary 0.195  
9 industry   03_tertiary  industry    03_tertiary  0.267  </code></pre>
</div>
</div>
</section>
<section id="レオンチェフ逆行列の算出" class="level3">
<h3 class="anchored" data-anchor-id="レオンチェフ逆行列の算出">レオンチェフ逆行列の算出</h3>
<p>経済波及効果を表すレオンチェフ逆行列は以下のように，移輸入係数と投入係数を用いて算出できます．</p>
<p>注：<code>solve()</code>で逆行列を算出すると行列の軸名が入れ替わるため注意してください．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 域内需要</span></span>
<span id="cb11-2">localdemand <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> iotable <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb11-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(input<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"industry"</span>,</span>
<span id="cb11-4">         <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>output<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"export"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"import"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb11-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">apply</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"input"</span>, sum)</span>
<span id="cb11-6"></span>
<span id="cb11-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (移) 輸入</span></span>
<span id="cb11-8">import <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> iotable <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb11-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(input<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"industry"</span>,</span>
<span id="cb11-10">         output<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>type <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"import"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb11-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">apply</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"input"</span>, sum)</span>
<span id="cb11-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 符号を正に</span></span>
<span id="cb11-13">import <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>import</span>
<span id="cb11-14"></span>
<span id="cb11-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (移) 輸入係数</span></span>
<span id="cb11-16">importcoeff <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> import <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> localdemand</span>
<span id="cb11-17"></span>
<span id="cb11-18">I <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">eye</span>(inputcoeff) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 単位行列</span></span>
<span id="cb11-19">M <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> importcoeff     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 移輸入係数ベクトル (broadcastが行われるため行列でなくてよい)</span></span>
<span id="cb11-20">A <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> inputcoeff      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 投入係数行列</span></span>
<span id="cb11-21"></span>
<span id="cb11-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># レオンチェフ逆行列</span></span>
<span id="cb11-23">leontiefinv <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">broadcast</span>(I <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> M) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> A,</span>
<span id="cb11-24">                         <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"input"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"output"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb11-25">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">solve</span>()</span>
<span id="cb11-26"></span>
<span id="cb11-27">leontiefinv</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A dibble:   9
# Dimensions: output [3], input [3]
  output$type $name        input$type $name              .
  &lt;chr&gt;       &lt;chr&gt;        &lt;chr&gt;      &lt;chr&gt;          &lt;dbl&gt;
1 industry    01_primary   industry   01_primary   1.12   
2 industry    01_primary   industry   02_secondary 0.0361 
3 industry    01_primary   industry   03_tertiary  0.00716
4 industry    02_secondary industry   01_primary   0.374  
5 industry    02_secondary industry   02_secondary 1.68   
6 industry    02_secondary industry   03_tertiary  0.197  
7 industry    03_tertiary  industry   01_primary   0.348  
8 industry    03_tertiary  industry   02_secondary 0.445  
9 industry    03_tertiary  industry   03_tertiary  1.41   </code></pre>
</div>
</div>
</section>
<section id="経済波及効果の算出" class="level3">
<h3 class="anchored" data-anchor-id="経済波及効果の算出">経済波及効果の算出</h3>
<p><a href="https://github.com/UchidaMizuki/blog-ioanalysis-in-r">こちら</a> からダウンロードできる最終需要がそれぞれ百万円ずつ増加する（<code>finaldemand_change_3sector.csv</code>）ケースで経済波及効果を算出しています．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 最終需要変化量</span></span>
<span id="cb13-2">finaldemand_change <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_csv</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"finaldemand_change_3sector.csv"</span>,</span>
<span id="cb13-3">                               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col_types =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cols</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.default =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"c"</span>,</span>
<span id="cb13-4">                                                <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">value_M =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb13-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dibble_by</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">input =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(input_type, input_name),</span>
<span id="cb13-6">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.names_sep =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"_"</span>)</span>
<span id="cb13-7"></span>
<span id="cb13-8">L <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> leontiefinv         <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># レオンチェフ逆行列</span></span>
<span id="cb13-9">M <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> importcoeff         <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 移輸入係数</span></span>
<span id="cb13-10">FD <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> finaldemand_change <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 最終需要変化量</span></span>
<span id="cb13-11"></span>
<span id="cb13-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 経済波及効果</span></span>
<span id="cb13-13">spillover <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> L <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%*%</span> ((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> M) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> FD)</span>
<span id="cb13-14"></span>
<span id="cb13-15">spillover</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A dibble:   3
# Dimensions: output [3]
  output$type $name            .
  &lt;chr&gt;       &lt;chr&gt;        &lt;dbl&gt;
1 industry    01_primary   0.958
2 industry    02_secondary 1.85 
3 industry    03_tertiary  2.03 </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_set</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_light</span>())</span>
<span id="cb15-2"></span>
<span id="cb15-3">spillover <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb15-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_tibble</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"value_M"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb15-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unpack</span>(output, </span>
<span id="cb15-6">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_sep =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"_"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb15-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(output_name, value_M,</span>
<span id="cb15-8">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> output_name)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_col</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">show.legend =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb15-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_brewer</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">palette =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Set2"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://uchidamizuki.quarto.pub/blog/posts/2022/05/ioanalysis-in-r-ja_files/figure-html/plot-spillover-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="まとめ" class="level2">
<h2 class="anchored" data-anchor-id="まとめ">まとめ</h2>
<p>Rを用いた産業連関分析の方法について紹介しました．</p>
<p>ここまでの計算を，<a href="https://github.com/UchidaMizuki/jpio">jpio</a>にパッケージ形式でまとめました．以下のように，ここまでの計算と同様の計算を行うことができます．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># pak::pak("UchidaMizuki/jpio")</span></span>
<span id="cb16-2"></span>
<span id="cb16-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 産業連関表</span></span>
<span id="cb16-4">iotable <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_csv</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"iotable_3sector_2011.csv"</span>,</span>
<span id="cb16-5">                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col_types =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cols</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.default =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"c"</span>,</span>
<span id="cb16-6">                                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">value_M =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb16-7">  jpio<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_iotable</span>()</span>
<span id="cb16-8"></span>
<span id="cb16-9">iotable</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A dibble:   24
# Dimensions: input [4], output [6]
   input$type $name        output$type $name                  .
   &lt;fct&gt;      &lt;chr&gt;        &lt;fct&gt;       &lt;chr&gt;              &lt;dbl&gt;
 1 industry   01_primary   industry    01_primary       1456611
 2 industry   01_primary   industry    02_secondary     7850628
 3 industry   01_primary   industry    03_tertiary      1373767
 4 industry   01_primary   finaldemand 04_finaldemand   3869875
 5 industry   01_primary   export      05_export          47890
 6 industry   01_primary   import      06_import       -2562809
 7 industry   02_secondary industry    01_primary       2715710
 8 industry   02_secondary industry    02_secondary   161897553
 9 industry   02_secondary industry    03_tertiary     62841827
10 industry   02_secondary finaldemand 04_finaldemand 132924323
# ℹ 14 more rows</code></pre>
</div>
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 投入係数</span></span>
<span id="cb18-2">jpio<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">input_coef</span>(iotable)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A dibble:   9
# Dimensions: input [3], output [3]
  input$type $name        output$type $name              .
  &lt;fct&gt;      &lt;chr&gt;        &lt;fct&gt;       &lt;chr&gt;          &lt;dbl&gt;
1 industry   01_primary   industry    01_primary   0.121  
2 industry   01_primary   industry    02_secondary 0.0229 
3 industry   01_primary   industry    03_tertiary  0.00235
4 industry   02_secondary industry    01_primary   0.226  
5 industry   02_secondary industry    02_secondary 0.472  
6 industry   02_secondary industry    03_tertiary  0.108  
7 industry   03_tertiary  industry    01_primary   0.168  
8 industry   03_tertiary  industry    02_secondary 0.195  
9 industry   03_tertiary  industry    03_tertiary  0.267  </code></pre>
</div>
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># レオンチェフ逆行列</span></span>
<span id="cb20-2">jpio<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">leontief_inv</span>(iotable)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A dibble:   9
# Dimensions: output [3], input [3]
  output$type $name        input$type $name              .
  &lt;fct&gt;       &lt;chr&gt;        &lt;fct&gt;      &lt;chr&gt;          &lt;dbl&gt;
1 industry    01_primary   industry   01_primary   1.12   
2 industry    01_primary   industry   02_secondary 0.0361 
3 industry    01_primary   industry   03_tertiary  0.00716
4 industry    02_secondary industry   01_primary   0.374  
5 industry    02_secondary industry   02_secondary 1.68   
6 industry    02_secondary industry   03_tertiary  0.197  
7 industry    03_tertiary  industry   01_primary   0.348  
8 industry    03_tertiary  industry   02_secondary 0.445  
9 industry    03_tertiary  industry   03_tertiary  1.41   </code></pre>
</div>
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 経済波及効果</span></span>
<span id="cb22-2">jpio<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">spillover_effect</span>(iotable,</span>
<span id="cb22-3">                       <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">01_primary</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb22-4">                            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">02_secondary</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb22-5">                            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">03_tertiary</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A dibble:   3
# Dimensions: output [3]
  output$type $name            .
  &lt;fct&gt;       &lt;chr&gt;        &lt;dbl&gt;
1 industry    01_primary   0.958
2 industry    02_secondary 1.85 
3 industry    03_tertiary  2.03 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># スカイラインチャート</span></span>
<span id="cb24-2">jpio<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">skyline_chart</span>(iotable, </span>
<span id="cb24-3">                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylim =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>))</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://uchidamizuki.quarto.pub/blog/posts/2022/05/ioanalysis-in-r-ja_files/figure-html/jpio-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>


</section>

 ]]></description>
  <category>ioanalysis</category>
  <category>dibble</category>
  <category>R</category>
  <category>Japanese</category>
  <guid>https://uchidamizuki.quarto.pub/blog/posts/2022/05/ioanalysis-in-r-ja.html</guid>
  <pubDate>Mon, 30 May 2022 15:00:00 GMT</pubDate>
  <media:content url="https://uchidamizuki.quarto.pub/blog/posts/2022/05/skyline_chart.png" medium="image" type="image/png" height="103" width="144"/>
</item>
</channel>
</rss>
