---
title: "ğŸ—¾Rã§åœ°åŸŸãƒ¡ãƒƒã‚·ãƒ¥çµ±è¨ˆï¼ˆjpgridãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ï¼‰"
lang: ja
date: "2022-06-04"
categories: [grid-square-stats, jpgrid, R, Japanese]
fig-align: center
image: station_main_grid500m.png
---

**åœ°åŸŸãƒ¡ãƒƒã‚·ãƒ¥**ï¼ˆ**Grid Squares**ï¼‰ã¨ã¯ã€Œ**ç·¯åº¦ãƒ»çµŒåº¦ã«åŸºã¥ã„ã¦æ—¥æœ¬ã®å›½åœŸã‚’ã»ã¼æ­£æ–¹å½¢ã®åŒºç”»ã«åˆ†å‰²ã—ãŸã‚‚ã®**ã€ã§ï¼Œç´„80 kmå››æ–¹ï½ç´„100 må››æ–¹ãªã©æ§˜ã€…ãªå¤§ãã•ã®ãƒ¡ãƒƒã‚·ãƒ¥ã«å¯¾ã—ã¦ãã‚Œãã‚Œãƒ¡ãƒƒã‚·ãƒ¥ã‚³ãƒ¼ãƒ‰ãŒå‰²ã‚ŠæŒ¯ã‚‰ã‚Œã¦ã„ã¾ã™ï¼

ã“ã‚Œã‚‰ã®ãƒ¡ãƒƒã‚·ãƒ¥ã‚³ãƒ¼ãƒ‰ã«çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’å¯¾å¿œã•ã›ãŸãƒ‡ãƒ¼ã‚¿ã¯[åœ°åŸŸãƒ¡ãƒƒã‚·ãƒ¥çµ±è¨ˆ](https://www.stat.go.jp/data/mesh/index.html)ã¨å‘¼ã°ã‚Œã¦ã„ã¾ã™ï¼

ã“ã“ã§ã¯ï¼Œåœ°åŸŸãƒ¡ãƒƒã‚·ãƒ¥ã‚’æ‰±ã†ãŸã‚ã®Rãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§ã‚ã‚‹[jpgrid](https://github.com/UchidaMizuki/jpgrid)ã®ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’ç´¹ä»‹ã—ã¾ã™ï¼

ä½¿ç”¨ã—ãŸã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã¯ï¼Œ[ã“ã¡ã‚‰](https://github.com/UchidaMizuki/blog-grid-square-stats-in-r)ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ï¼

## æ±äº¬ã®ä¸»è¦é§…å‘¨è¾ºã®ãƒ¡ãƒƒã‚·ãƒ¥äººå£

æ±äº¬ã®ä¸»è¦é§…å‘¨è¾ºã®ãƒ¡ãƒƒã‚·ãƒ¥äººå£ã‚’å›³ç¤ºã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼ã“ã“ã§ã¯ï¼Œé§…ã®ä½ç½®ãƒ‡ãƒ¼ã‚¿ï¼ˆ`station_5339_2019.gpkg`ï¼‰ã¨500 mãƒ¡ãƒƒã‚·ãƒ¥äººå£ãƒ‡ãƒ¼ã‚¿ï¼ˆ`pop_grid500m_5339_2015`ï¼‰ã‚’åˆ©ç”¨ã—ã¾ã™ï¼

ï¼»ãƒ‡ãƒ¼ã‚¿å‡ºå…¸ï¼½

-   `station_5339_2019.gpkg`ï¼š[å›½åœŸæ•°å€¤æƒ…å ±ã®2019å¹´é‰„é“ãƒ‡ãƒ¼ã‚¿](https://nlftp.mlit.go.jp/ksj/gml/datalist/KsjTmplt-N02-v2_3.html)ã‚ˆã‚Šä½œæˆï¼ˆ80 kmãƒ¡ãƒƒã‚·ãƒ¥ï¼š5339ã®ã¿ï¼‰

-   `pop_grid500m_5339_2015.parquet`ï¼š[åœ°å›³ã§è¦‹ã‚‹çµ±è¨ˆã®2015å¹´å›½å‹¢èª¿æŸ»ã®4æ¬¡ãƒ¡ãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿](https://www.e-stat.go.jp/gis/statmap-search?page=5&type=1&toukeiCode=00200521&toukeiYear=2015&aggregateUnit=H&serveyId=H002005112015&statsId=T000847)ã‚ˆã‚Šä½œæˆ

### é§…ã®ä½ç½®ãƒ‡ãƒ¼ã‚¿

`station_5339_2019.gpkg` ã«ã¯æ±äº¬éƒ½è¿‘è¾ºï¼ˆ80 kmãƒ¡ãƒƒã‚·ãƒ¥ï¼š5339ï¼‰ã®2019å¹´ã®é§…ãƒ‡ãƒ¼ã‚¿ãŒæ ¼ç´ã•ã‚Œã¦ã„ã¾ã™ï¼

```{r}
#| label: station
#| message: false
#| warning: false

# pak::pak("UchidaMizuki/jpgrid")
library(tidyverse)
library(sf)
library(arrow)
library(jpgrid)

# crs
WGS84 <- 4326

# ggspatial
annotation_map_tile <- function(zoomin = -1, 
                                progress = "none", ...) {
  list(ggspatial::annotation_map_tile(zoomin = zoomin, 
                                      progress = progress, ...),
       labs(caption = "Â© OpenStreetMap contributors"))
}

station <- read_sf("station_5339_2019.gpkg")

ggplot(station,
       aes(color = line)) +
  annotation_map_tile() +
  geom_sf(show.legend = FALSE) +
  scale_color_viridis_d(option = "turbo")
```

### æ±äº¬ä¸»è¦é§…ã®500 mãƒ¡ãƒƒã‚·ãƒ¥é§…å‹¢åœã®ä½œæˆ

æ±äº¬ã®ä¸»è¦é§…ã§ã‚ã‚‹æ–°å®¿é§…ãƒ»æ¸‹è°·é§…ãƒ»æ± è¢‹é§…ãƒ»æ±äº¬é§…ã®4ã¤ã®é§…ã«å¯¾ã—ã¦ï¼Œ500 mãƒ¡ãƒƒã‚·ãƒ¥ã§é§…å‹¢åœã‚’ä½œæˆã—ã¦ã¿ã¾ã™ï¼ã“ã“ã§ã¯ï¼Œé§…ã®ä»£è¡¨ç‚¹ã‹ã‚‰ç´„1.5 kmã‚’é§…å‹¢åœã¨ã—ã¾ã™ï¼

jpgridã§ã¯ï¼Œ`geometry_to_grid()` ã§**sfãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¸ã‚ªãƒ¡ãƒˆãƒªã‚’ãƒ¡ãƒƒã‚·ãƒ¥ã‚³ãƒ¼ãƒ‰ã«å¤‰æ›**ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼ã¾ãŸï¼Œé€†ã«ï¼Œ`grid_as_sf()` ã§**ãƒ¡ãƒƒã‚·ãƒ¥ã‚³ãƒ¼ãƒ‰ã‚’æŒã¤ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’sfãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¸ã‚ªãƒ¡ãƒˆãƒªãƒ‡ãƒ¼ã‚¿ã«å¤‰æ›**ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ï¼

```{r}
#| label: station_main_grid500m
#| message: false
#| warning: false
#| fig-height: 8

# é§…å‹¢åœã®è·é›¢
dist_station <- units::set_units(1.5, km)

# ä¸»è¦é§…ã®ä»£è¡¨ç‚¹ã‚’ä¸­å¿ƒã¨ã™ã‚‹é§…å‹¢åœã‚¸ã‚ªãƒ¡ãƒˆãƒª
station_main <- station |>
  filter(station %in% c("æ–°å®¿", "æ¸‹è°·", "æ± è¢‹", "æ±äº¬")) |>
  group_by(station = as_factor(station)) |>
  summarise(.groups = "drop") |>
  
  # é‡å¿ƒç‚¹ã‚’ä½œæˆ
  st_centroid() |>
  
  # é‡å¿ƒç‚¹ã‚’ä¸­å¿ƒã¨ã™ã‚‹å††ã‚’ä½œæˆ
  st_buffer(dist_station)

# é§…å‹¢åœã®500 mãƒ¡ãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿
station_main_grid500m <- station_main |>
  mutate(grid500m = geom |>
           
           # sfã‚¸ã‚ªãƒ¡ãƒˆãƒª -> 500 mãƒ¡ãƒƒã‚·ãƒ¥
           geometry_to_grid("500m")) |>
  st_drop_geometry() |>
  unnest(grid500m) |>
  
  # 500 mãƒ¡ãƒƒã‚·ãƒ¥ -> sfã‚¸ã‚ªãƒ¡ãƒˆãƒª
  grid_as_sf(crs = WGS84)

ggplot(station_main,
       aes(fill = station,
           label = station)) +
  annotation_map_tile() +
  geom_sf(data = station_main_grid500m,
          alpha = 0.5) +
  geom_sf(fill = "transparent",
          linetype = "dashed") +
  geom_sf_text() +
  scale_fill_brewer(palette = "Set2") +
  theme(legend.position = "none")
```

## æ±äº¬ä¸»è¦é§…ã®é§…å‹¢åœã«ãŠã‘ã‚‹ãƒ¡ãƒƒã‚·ãƒ¥äººå£

æ±äº¬ã®ä¸»è¦é§…ã®é§…å‹¢åœã«ãŠã‘ã‚‹2015å¹´ã®ãƒ¡ãƒƒã‚·ãƒ¥äººå£ï¼ˆ`pop_grid500m_5339_2015.parquet`ï¼‰ã‚’å›³ç¤ºã—ã¦ã¿ã¾ã™ï¼`grid_500m()` ãªã©ã®é–¢æ•°ã‚’ç”¨ã„ã‚‹ã“ã¨ã§æ–‡å­—åˆ—ã®ãƒ¡ãƒƒã‚·ãƒ¥ã‚³ãƒ¼ãƒ‰ï¼ˆ`"533900054"`ãªã©ï¼‰ã‚’jpgridã®ãƒ¡ãƒƒã‚·ãƒ¥ã‚³ãƒ¼ãƒ‰ã«å¤‰æ›ã§ãã¾ã™ï¼

ã‚°ãƒ©ãƒ•ã‚ˆã‚Šä»¥ä¸‹ã®ã“ã¨ãŒç¢ºèªã§ãã¾ã—ãŸï¼

-   4ã¤ã®é§…ã®é§…å‹¢åœäººå£ã¯æ± è¢‹é§…ã§æœ€ã‚‚å¤šãæ±äº¬é§…ã§æœ€ã‚‚å°‘ãªã„

-   é§…ã‚„çš‡å±…ãƒ»å…¬åœ’ãªã©ã®å‘¨è¾ºã§äººå£ãŒå°‘ãªã„ã“ã¨ãŒåœ°å›³ã‹ã‚‰ã‚‚ç¢ºèªã§ãã‚‹

```{r}
#| label: pop-station_main_grid500m
#| message: false
#| fig-height: 8

# 500 mãƒ¡ãƒƒã‚·ãƒ¥äººå£
pop_grid500m <- read_parquet("pop_grid500m_5339_2015.parquet") |> 
  mutate(grid500m = grid_500m(grid500m))

# 500 mãƒ¡ãƒƒã‚·ãƒ¥é§…å‹¢åœãƒ‡ãƒ¼ã‚¿ã«äººå£ã‚’ä»˜ä¸
station_main_grid500m <- station_main_grid500m |> 
  left_join(pop_grid500m,
            by = "grid500m") |> 
  replace_na(list(pop = 0))

limits <- c(0, max(station_main_grid500m$pop))

station_main_grid500m |> 
  group_by(station) |> 
  group_map(~ {
    ggplot(.x,
           aes(fill = pop)) +
      annotation_map_tile() +
      geom_sf(alpha = 0.5) +
      scale_fill_viridis_c("äººå£",
                           limits = limits,
                           option = "turbo") +
      ggtitle(.y$station) +
      theme(plot.title = element_text(hjust = 0.5),
            axis.text = element_blank())
  }) |> 
  patchwork::wrap_plots() +
  patchwork::plot_layout(guides = "collect")
```

```{r}
#| label: save-plot-station_main_grid500m
#| include: false

ggsave("station_main_grid500m.png",
       width = 7,
       height = 7)
```

```{r}
#| label: plot-station_main_grid500m
#| fig-width: 4
#| fig-height: 3
#| out-width: 100%

station_main_grid500m |> 
  st_drop_geometry() |> 
  group_by(station) |> 
  summarise(pop = sum(pop)) |> 
  ggplot(aes(station, pop)) +
  geom_col(aes(fill = station),
           show.legend = FALSE) +
  geom_text(aes(label = scales::label_comma(suffix = "äºº")(pop)),
            vjust = 2) +
  scale_x_discrete("æ±äº¬ã®ä¸»è¦é§…") +
  scale_y_continuous("é§…å‹¢åœãƒ¡ãƒƒã‚·ãƒ¥äººå£ [åƒäºº]",
                     labels = scales::label_comma(scale = 1e-3)) +
  scale_fill_brewer(palette = "Set2")
```

## ã¾ã¨ã‚

Rãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®jpgridã«ã‚ˆã‚‹åœ°åŸŸãƒ¡ãƒƒã‚·ãƒ¥çµ±è¨ˆã®ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’ç´¹ä»‹ã—ã¾ã—ãŸï¼

jpgridã‚’ä½¿ã†ã“ã¨ã§ï¼Œ**ç·¯åº¦çµŒåº¦ã‚„ã‚¸ã‚ªãƒ¡ãƒˆãƒªã®ãƒ‡ãƒ¼ã‚¿ã‚’ç°¡å˜ã«åœ°åŸŸãƒ¡ãƒƒã‚·ãƒ¥çµ±è¨ˆã¨ç´ã¥ã‘ã‚‰ã‚Œã¾ã™**ï¼çš†ã•ã‚“ã‚‚ãœã²ä½¿ã£ã¦ã¿ã¦ãã ã•ã„ï¼
