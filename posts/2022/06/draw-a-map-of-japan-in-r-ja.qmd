---
title: "ğŸ—¾Rã§æ—¥æœ¬åœ°å›³ã‚’æã„ã¦ã¿ã‚ˆã†"
lang: ja
date: "2022-06-11"
categories: [ggplot2, sf, jpmap, R, Japanese]
fig-align: center
out-width: 100%
image: foreigner_ratio_2015.png
---

Rã§ã¯ï¼Œggplot2ãªã©ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’åˆ©ç”¨ã™ã‚‹ã ã‘ã§ï¼Œãã‚Œã„ãªæ—¥æœ¬åœ°å›³ï¼ˆéƒ½é“åºœçœŒåˆ¥ï¼‰ã‚’æãã“ã¨ãŒã§ãã¾ã™ï¼

ã“ã“ã§ã¯ï¼Œæ—¥æœ¬åœ°å›³ã‚’ggplot2ã§æç”»ã™ã‚‹æ–¹æ³•ã‚’ã„ãã¤ã‹ç´¹ä»‹ã—ã¾ã™ï¼

## åœ°å›³æç”»ç”¨ã®ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿

ã“ã“ã§ã¯ï¼Œ[ã“ã¡ã‚‰](https://www.e-stat.go.jp/dbview?sid=0000010201)ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã‚‹ç¤¾ä¼šãƒ»äººå£çµ±è¨ˆä½“ç³»ã®2015å¹´ã®éƒ½é“åºœçœŒåˆ¥å¤–å›½äººäººå£æ¯”ç‡ãƒ‡ãƒ¼ã‚¿ï¼ˆ10ä¸‡äººã‚ãŸã‚Šå¤–å›½äººäººå£ï¼‰ã‚’åœ°å›³æç”»ç”¨ã®ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¾ã—ãŸï¼

```{r}
#| label: library
#| message: false

library(tidyverse)
```

ãƒ‡ãƒ¼ã‚¿ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰

```{r}
#| label: collect-data
#| code-fold: true
#| eval: false

library(jpstat)
library(arrow)

appId <- keyring::key_get("estat-api")
foreigner_ratio_2015 <- estat(appId, "https://www.e-stat.go.jp/en/dbview?sid=0000010201",
                              lang = "E")
foreigner_ratio_2015 <- foreigner_ratio_2015 |> 
  activate(tab) |> 
  select() |> 
  
  activate(cat01) |> 
  # Ratio of population of foreigners (per 100,000 persons)
  filter(code == "#A01601") |> 
  select() |> 
  
  activate(area) |> 
  filter(name != "All Japan") |> 
  select(code, name) |> 
  rekey("pref") |> 
  
  activate(time) |> 
  filter(name == "2015") |> 
  select()
foreigner_ratio_2015 <- foreigner_ratio_2015 |> 
  collect("foreigners_per_100K")

write_parquet(foreigner_ratio_2015, "foreigner_ratio_2015.parquet")

```

ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿

```{r}
#| label: read-data
#| message: false
#| code-fold: true

library(arrow)

foreigner_ratio_2015 <- read_parquet("foreigner_ratio_2015.parquet") |> 
  mutate(pref_code = pref_code |> 
           str_extract("^\\d{2}") |> 
           parse_integer(),
         
         pref_name = pref_name |> 
           str_remove("-.+$"),
         pref_name = case_when(pref_name == "Gumma" ~ "Gunma",
                               TRUE ~ pref_name),
         
         foreigner_ratio = parse_number(foreigners_per_100K) / 1e5,
         .keep = "unused")

```

```{r}
#| label: data

foreigner_ratio_2015

```

## `geom_map()` ã‚’ä½¿ã£ã¦æ—¥æœ¬åœ°å›³ã‚’æã

ggplot2ã§ã¯ï¼Œ`map_data()` ã‚„`geom_map()` ã‚’ä½¿ã†ã“ã¨ã§ï¼Œä¸–ç•Œã®å›½ã€…ã‚’æç”»ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼ã“ã‚Œã«ã¯ï¼Œmapsãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’äºˆã‚ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼ã¾ãŸï¼Œæ—¥æœ¬åœ°å›³ã‚’åˆ©ç”¨ã™ã‚‹ã«ã¯ï¼Œmapsãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã«åŠ ãˆã¦ï¼Œmapdataãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒå¿…è¦ã«ãªã‚Šã¾ã™ï¼

`map_data("japan")` ã¨ã™ã‚‹ã“ã¨ã§ï¼Œmapsãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®åœ°å›³ãƒ‡ãƒ¼ã‚¿ãŒãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã«å¤‰æ›ã•ã‚Œã¾ã™ï¼ã“ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã®`region` åˆ—ãŒéƒ½é“åºœçœŒã®IDã¨ãªã‚‹ãŸã‚ï¼Œ`aes(map_id = region)`ã‚’è¨­å®šã—ãŸä¸Šã§ï¼Œ`geom_map()` ã™ã‚‹ã“ã¨ã§ï¼Œæç”»ã—ãŸã„ãƒ‡ãƒ¼ã‚¿ã®`region` åˆ—ã¨éƒ½é“åºœçœŒã‚¸ã‚ªãƒ¡ãƒˆãƒªãŒãƒªãƒ³ã‚¯ã—ã¾ã™ï¼

ãŸã ã—ï¼Œ`map_data("japan")` ã¯ï¼Œä»¥ä¸‹ã®ç‚¹ã«æ³¨æ„ãŒå¿…è¦ã§ã™ï¼

-   `region` åˆ—ã¯ã™ã¹ã¦ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆè¡¨è¨˜ã§ã‚ã‚‹

-   ä»–ã®éƒ½é“åºœçœŒã¨é•ã„ï¼Œå¥ˆè‰¯çœŒã ã‘ãŒãŒ`NARA` ã¨å¤§æ–‡å­—è¡¨è¨˜ã«ãªã£ã¦ã„ã‚‹ãªã©ï¼Œå…ƒãƒ‡ãƒ¼ã‚¿ã«å•é¡Œã‚ã‚Š

    -   ã“ã“ã§ã¯ï¼Œ`str_to_title()`ã§ä¿®æ­£

ã¾ãŸï¼Œæ—¥æœ¬åœ°å›³å…¨ä½“ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã«ã¯ï¼Œ`expand_limits()` ãªã©ã§è»¸ã‚’è¨­å®šã™ã‚‹ã“ã¨å¿…è¦ã«ãªã‚Šã¾ã™ï¼

```{r}
#| label: geom_map
#| message: false

# pak::pak("maps")
# pak::pak("mapdata")
library(tidyverse)
library(mapdata)

map_data_japan <- map_data("japan") |> 
  as_tibble() |> 
  mutate(region = str_to_title(region))
map_data_japan

ggplot(foreigner_ratio_2015 |> 
         rename(region = pref_name),
       aes(map_id = region)) +
  geom_map(aes(fill = foreigner_ratio),
           map = map_data_japan) +
  expand_limits(x = map_data_japan$long,
                y = map_data_japan$lat) +
  scale_fill_viridis_c("å¤–å›½äººäººå£æ¯”ç‡",
                       limits = c(0, 0.03),
                       labels = scales::label_percent(),
                       option = "turbo")
```

## sfãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½¿ã£ã¦æ—¥æœ¬åœ°å›³ã‚’æã

æœ€è¿‘ã§ã¯ï¼Œsfãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¸ã‚ªãƒ¡ãƒˆãƒªãŒggplot2ã§ç°¡å˜ã«æç”»ã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ï¼

ã¾ãŸï¼Œmapsãƒ»mapdataãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®æä¾›ã™ã‚‹åœ°å›³ãƒ‡ãƒ¼ã‚¿ã¯ï¼Œsfãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®`st_as_sf()` ã§sfã®ã‚¸ã‚ªãƒ¡ãƒˆãƒªãƒ‡ãƒ¼ã‚¿ã«å¤‰æ›ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼

æ—¥æœ¬åœ°å›³ãƒ‡ãƒ¼ã‚¿ã‚’sfã«å¤‰æ›ã™ã‚‹ã“ã¨ã§ï¼Œå…ˆã»ã©ã‚ˆã‚Šã‚‚ç›´æ„Ÿçš„ã«åœ°å›³ã‚’æãã“ã¨ãŒã§ãã¾ã™ï¼

```{r}
#| label: sf

library(sf)

map_japan <- maps::map("japan", 
                       plot = FALSE,
                       fill = TRUE) |> 
  st_as_sf() |> 
  rename(pref_name = ID) |> 
  mutate(pref_name = str_to_title(pref_name))

map_japan |> 
  left_join(foreigner_ratio_2015,
            by = "pref_name") |> 
  ggplot(aes(fill = foreigner_ratio)) +
  geom_sf(color = "transparent") +
  scale_fill_viridis_c("å¤–å›½äººäººå£æ¯”ç‡",
                       limits = c(0, 0.03),
                       labels = scales::label_percent(),
                       option = "turbo")

```

## ã‚‚ã£ã¨ç°¡å˜ã«æ—¥æœ¬åœ°å›³ã‚’æã

[jpmap](https://github.com/UchidaMizuki/jpmap)ã¯ï¼Œggplot2ã«ã‚ˆã‚‹æ—¥æœ¬åœ°å›³ã®æç”»ã‚’ã‚ˆã‚Šç°¡å˜ã«ã™ã‚‹ãŸã‚ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§ã™ï¼

jpmapã¯ï¼Œä»¥ä¸‹ã®2ã¤ã®æ©Ÿèƒ½ã‚’æŒã¡ã¾ã™ï¼

-   æ—¥æœ¬èªã®éƒ½é“åºœçœŒåã‚„éƒ½é“åºœçœŒã‚³ãƒ¼ãƒ‰ãŒå«ã‚€éƒ½é“åºœçœŒãƒ‡ãƒ¼ã‚¿ã‚’æä¾›ï¼ˆ`jpmap::prefecture`ï¼‰

-   ç‰çƒè«¸å³¶ãƒ»å°ç¬ åŸè«¸å³¶ã‚’å†é…ç½®ã—ãŸãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’å¯èƒ½ã«ï¼ˆ`jpmap::layout_islands()`ï¼‰

`jpmap::layout_islands()` ã§åœ°å›³ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ã§ï¼Œéƒ½é“åºœçœŒã”ã¨ã®å‚¾å‘ãŒã‚ˆã‚Šã‚ã‹ã‚Šã‚„ã™ããªã‚Šã¾ã™ï¼

```{r}
#| label: jpmap

# pak::pak("UchidaMizuki/jpmap")
jpmap::prefecture

plot <- jpmap::prefecture |> 
  left_join(foreigner_ratio_2015,
            by = c("pref_code", "pref_name")) |> 
  ggplot(aes(fill = foreigner_ratio)) +
  geom_sf(color = "transparent") +
  scale_fill_viridis_c("å¤–å›½äººäººå£æ¯”ç‡",
                       limits = c(0, 0.03),
                       labels = scales::label_percent(),
                       option = "turbo")

jpmap::layout_islands(plot,
                      ogasawara = FALSE)
```

```{r}
#| label: save-plot
#| include: false

jpmap::layout_islands(plot,
                      ogasawara = FALSE) +
  theme(legend.position = "bottom")

ggsave("foreigner_ratio_2015.png",
       width = 5,
       height = 5)

```

## ã¾ã¨ã‚ï¼ˆåœ°å›³ã‹ã‚‰ã‚ã‹ã£ãŸã“ã¨ï¼‰

2015å¹´ã®éƒ½é“åºœçœŒåˆ¥å¤–å›½äººäººå£æ¯”ç‡ã«é–¢ã™ã‚‹æ—¥æœ¬åœ°å›³ã‹ã‚‰ä»¥ä¸‹ã®ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸï¼

-   2015å¹´ã§ã¯**ã©ã®éƒ½é“åºœçœŒã§ã‚‚å¤–å›½äººäººå£æ¯”ç‡ãŒ3ï¼…ä»¥ä¸‹**ã§ã‚ã‚‹

-   **æ±äº¬éƒ½**ã¯å¤–å›½äººäººå£æ¯”ç‡ãŒæœ€ã‚‚å¤šãï¼Œ**æ„›çŸ¥çœŒ**ã‚„**ç¾¤é¦¬çœŒ**ãªã©ã‚‚å¤–å›½äººå£æ¯”ç‡ãŒé«˜ã„ï¼

ã“ã“ã¾ã§ï¼Œggplot2ãªã©ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’æ´»ç”¨ã—ãŸæ—¥æœ¬åœ°å›³ã®æç”»ã‚’è©¦ã—ã¦ã¿ã¾ã—ãŸï¼

ãã®çµæœï¼ŒRã‚’ä½¿ãˆã°ï¼Œè‡ªå‰ã§ãƒ‡ãƒ¼ã‚¿ã‚’æ•´å‚™ã—ãªãã¦ã‚‚ï¼Œç°¡å˜ã«æ—¥æœ¬åœ°å›³ã‚’æã‘ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸï¼ã¿ãªã•ã‚“ã‚‚ãœã²ï¼Œggplot2ã‚’ä½¿ã£ã¦ï¼Œè‰²ã€…ãªåœ°å›³ã‚’ä½¿ã£ã¦ã¿ã¦ãã ã•ã„ï¼
