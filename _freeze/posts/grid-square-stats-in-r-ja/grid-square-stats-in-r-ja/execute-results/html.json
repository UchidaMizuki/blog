{
  "hash": "f6448a45ae7c5e05377d82726b05edee",
  "result": {
    "markdown": "---\ntitle: \"ğŸ—¾Rã§åœ°åŸŸãƒ¡ãƒƒã‚·ãƒ¥çµ±è¨ˆï¼ˆjpgridãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ï¼‰\"\nlang: ja\ndate: \"2022-06-04\"\ncategories: [grid-square-stats, jpgrid, R, Japanese]\nfig-align: center\nimage: station_main_grid500m.png\n---\n\n\n**åœ°åŸŸãƒ¡ãƒƒã‚·ãƒ¥**ï¼ˆ**Grid Squares**ï¼‰ã¨ã¯ã€Œ**ç·¯åº¦ãƒ»çµŒåº¦ã«åŸºã¥ã„ã¦æ—¥æœ¬ã®å›½åœŸã‚’ã»ã¼æ­£æ–¹å½¢ã®åŒºç”»ã«åˆ†å‰²ã—ãŸã‚‚ã®**ã€ã§ï¼Œç´„80 kmå››æ–¹ï½ç´„100 må››æ–¹ãªã©æ§˜ã€…ãªå¤§ãã•ã®ãƒ¡ãƒƒã‚·ãƒ¥ã«å¯¾ã—ã¦ãã‚Œãã‚Œãƒ¡ãƒƒã‚·ãƒ¥ã‚³ãƒ¼ãƒ‰ãŒå‰²ã‚ŠæŒ¯ã‚‰ã‚Œã¦ã„ã¾ã™ï¼\n\nã“ã‚Œã‚‰ã®ãƒ¡ãƒƒã‚·ãƒ¥ã‚³ãƒ¼ãƒ‰ã«çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’å¯¾å¿œã•ã›ãŸãƒ‡ãƒ¼ã‚¿ã¯[åœ°åŸŸãƒ¡ãƒƒã‚·ãƒ¥çµ±è¨ˆ](https://www.stat.go.jp/data/mesh/index.html)ã¨å‘¼ã°ã‚Œã¦ã„ã¾ã™ï¼\n\nã“ã“ã§ã¯ï¼Œåœ°åŸŸãƒ¡ãƒƒã‚·ãƒ¥ã‚’æ‰±ã†ãŸã‚ã®Rãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§ã‚ã‚‹[jpgrid](https://github.com/UchidaMizuki/jpgrid)ã®ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’ç´¹ä»‹ã—ã¾ã™ï¼\n\nä½¿ç”¨ã—ãŸã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã¯ï¼Œ[ã“ã¡ã‚‰](https://github.com/UchidaMizuki/blog-grid-square-stats-in-r)ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ï¼\n\n## æ±äº¬ã®ä¸»è¦é§…å‘¨è¾ºã®ãƒ¡ãƒƒã‚·ãƒ¥äººå£\n\næ±äº¬ã®ä¸»è¦é§…å‘¨è¾ºã®ãƒ¡ãƒƒã‚·ãƒ¥äººå£ã‚’å›³ç¤ºã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼ã“ã“ã§ã¯ï¼Œé§…ã®ä½ç½®ãƒ‡ãƒ¼ã‚¿ï¼ˆ`station_5339_2019.gpkg`ï¼‰ã¨500 mãƒ¡ãƒƒã‚·ãƒ¥äººå£ãƒ‡ãƒ¼ã‚¿ï¼ˆ`pop_grid500m_5339_2015`ï¼‰ã‚’åˆ©ç”¨ã—ã¾ã™ï¼\n\nï¼»ãƒ‡ãƒ¼ã‚¿å‡ºå…¸ï¼½\n\n-   `station_5339_2019.gpkg`ï¼š[å›½åœŸæ•°å€¤æƒ…å ±ã®2019å¹´é‰„é“ãƒ‡ãƒ¼ã‚¿](https://nlftp.mlit.go.jp/ksj/gml/datalist/KsjTmplt-N02-v2_3.html)ã‚ˆã‚Šä½œæˆï¼ˆ80 kmãƒ¡ãƒƒã‚·ãƒ¥ï¼š5339ã®ã¿ï¼‰\n\n-   `pop_grid500m_5339_2015.parquet`ï¼š[åœ°å›³ã§è¦‹ã‚‹çµ±è¨ˆã®2015å¹´å›½å‹¢èª¿æŸ»ã®4æ¬¡ãƒ¡ãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿](https://www.e-stat.go.jp/gis/statmap-search?page=5&type=1&toukeiCode=00200521&toukeiYear=2015&aggregateUnit=H&serveyId=H002005112015&statsId=T000847)ã‚ˆã‚Šä½œæˆ\n\n### é§…ã®ä½ç½®ãƒ‡ãƒ¼ã‚¿\n\n`station_5339_2019.gpkg` ã«ã¯æ±äº¬éƒ½è¿‘è¾ºï¼ˆ80 kmãƒ¡ãƒƒã‚·ãƒ¥ï¼š5339ï¼‰ã®2019å¹´ã®é§…ãƒ‡ãƒ¼ã‚¿ãŒæ ¼ç´ã•ã‚Œã¦ã„ã¾ã™ï¼\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# pak::pak(\"UchidaMizuki/jpgrid\")\nlibrary(tidyverse)\nlibrary(sf)\nlibrary(arrow)\nlibrary(jpgrid)\n\n# crs\nWGS84 <- 4326\n\n# ggspatial\nannotation_map_tile <- function(zoomin = -1, \n                                progress = \"none\", ...) {\n  list(ggspatial::annotation_map_tile(zoomin = zoomin, \n                                      progress = progress, ...),\n       labs(caption = \"Â© OpenStreetMap contributors\"))\n}\n\nstation <- read_sf(\"station_5339_2019.gpkg\")\n\nggplot(station,\n       aes(color = line)) +\n  annotation_map_tile() +\n  geom_sf(show.legend = FALSE) +\n  scale_color_viridis_d(option = \"turbo\")\n```\n\n::: {.cell-output-display}\n![](grid-square-stats-in-r-ja_files/figure-html/unnamed-chunk-1-1.png){width=672}\n:::\n:::\n\n\n### æ±äº¬ä¸»è¦é§…ã®500 mãƒ¡ãƒƒã‚·ãƒ¥é§…å‹¢åœã®ä½œæˆ\n\næ±äº¬ã®ä¸»è¦é§…ã§ã‚ã‚‹æ–°å®¿é§…ãƒ»æ¸‹è°·é§…ãƒ»æ± è¢‹é§…ãƒ»æ±äº¬é§…ã®4ã¤ã®é§…ã«å¯¾ã—ã¦ï¼Œ500 mãƒ¡ãƒƒã‚·ãƒ¥ã§é§…å‹¢åœã‚’ä½œæˆã—ã¦ã¿ã¾ã™ï¼ã“ã“ã§ã¯ï¼Œé§…ã®ä»£è¡¨ç‚¹ã‹ã‚‰ç´„1.5 kmã‚’é§…å‹¢åœã¨ã—ã¾ã™ï¼\n\njpgridã§ã¯ï¼Œ`geometry_to_grid()` ã§**sfãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¸ã‚ªãƒ¡ãƒˆãƒªã‚’ãƒ¡ãƒƒã‚·ãƒ¥ã‚³ãƒ¼ãƒ‰ã«å¤‰æ›**ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼ã¾ãŸï¼Œé€†ã«ï¼Œ`grid_as_sf()` ã§**ãƒ¡ãƒƒã‚·ãƒ¥ã‚³ãƒ¼ãƒ‰ã‚’æŒã¤ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’sfãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¸ã‚ªãƒ¡ãƒˆãƒªãƒ‡ãƒ¼ã‚¿ã«å¤‰æ›**ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ï¼\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# é§…å‹¢åœã®è·é›¢\ndist_station <- units::set_units(1.5, km)\n\n# ä¸»è¦é§…ã®ä»£è¡¨ç‚¹ã‚’ä¸­å¿ƒã¨ã™ã‚‹é§…å‹¢åœã‚¸ã‚ªãƒ¡ãƒˆãƒª\nstation_main <- station |>\n  filter(station %in% c(\"æ–°å®¿\", \"æ¸‹è°·\", \"æ± è¢‹\", \"æ±äº¬\")) |>\n  group_by(station = as_factor(station)) |>\n  summarise(.groups = \"drop\") |>\n  \n  # é‡å¿ƒç‚¹ã‚’ä½œæˆ\n  st_centroid() |>\n  \n  # é‡å¿ƒç‚¹ã‚’ä¸­å¿ƒã¨ã™ã‚‹å††ã‚’ä½œæˆ\n  st_buffer(dist_station)\n\n# é§…å‹¢åœã®500 mãƒ¡ãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿\nstation_main_grid500m <- station_main |>\n  mutate(grid500m = geom |>\n           \n           # sfã‚¸ã‚ªãƒ¡ãƒˆãƒª -> 500 mãƒ¡ãƒƒã‚·ãƒ¥\n           geometry_to_grid(\"500m\")) |>\n  st_drop_geometry() |>\n  unnest(grid500m) |>\n  \n  # 500 mãƒ¡ãƒƒã‚·ãƒ¥ -> sfã‚¸ã‚ªãƒ¡ãƒˆãƒª\n  grid_as_sf(crs = WGS84)\n\nggplot(station_main,\n       aes(fill = station,\n           label = station)) +\n  annotation_map_tile() +\n  geom_sf(data = station_main_grid500m,\n          alpha = 0.5) +\n  geom_sf(fill = \"transparent\",\n          linetype = \"dashed\") +\n  geom_sf_text() +\n  scale_fill_brewer(palette = \"Set2\") +\n  theme(legend.position = \"none\")\n```\n\n::: {.cell-output-display}\n![](grid-square-stats-in-r-ja_files/figure-html/unnamed-chunk-2-1.png){width=672}\n:::\n:::\n\n\n## æ±äº¬ä¸»è¦é§…ã®é§…å‹¢åœã«ãŠã‘ã‚‹ãƒ¡ãƒƒã‚·ãƒ¥äººå£\n\næ±äº¬ã®ä¸»è¦é§…ã®é§…å‹¢åœã«ãŠã‘ã‚‹2015å¹´ã®ãƒ¡ãƒƒã‚·ãƒ¥äººå£ï¼ˆ`pop_grid500m_5339_2015.parquet`ï¼‰ã‚’å›³ç¤ºã—ã¦ã¿ã¾ã™ï¼`grid_500m()` ãªã©ã®é–¢æ•°ã‚’ç”¨ã„ã‚‹ã“ã¨ã§æ–‡å­—åˆ—ã®ãƒ¡ãƒƒã‚·ãƒ¥ã‚³ãƒ¼ãƒ‰ï¼ˆ`\"533900054\"`ãªã©ï¼‰ã‚’jpgridã®ãƒ¡ãƒƒã‚·ãƒ¥ã‚³ãƒ¼ãƒ‰ã«å¤‰æ›ã§ãã¾ã™ï¼\n\nã‚°ãƒ©ãƒ•ã‚ˆã‚Šä»¥ä¸‹ã®ã“ã¨ãŒç¢ºèªã§ãã¾ã—ãŸï¼\n\n-   4ã¤ã®é§…ã®é§…å‹¢åœäººå£ã¯æ± è¢‹é§…ã§æœ€ã‚‚å¤šãæ±äº¬é§…ã§æœ€ã‚‚å°‘ãªã„\n\n-   é§…ã‚„çš‡å±…ãƒ»å…¬åœ’ãªã©ã®å‘¨è¾ºã§äººå£ãŒå°‘ãªã„ã“ã¨ãŒåœ°å›³ã‹ã‚‰ã‚‚ç¢ºèªã§ãã‚‹\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 500 mãƒ¡ãƒƒã‚·ãƒ¥äººå£\npop_grid500m <- read_parquet(\"pop_grid500m_5339_2015.parquet\") |> \n  mutate(grid500m = grid_500m(grid500m))\n\n# 500 mãƒ¡ãƒƒã‚·ãƒ¥é§…å‹¢åœãƒ‡ãƒ¼ã‚¿ã«äººå£ã‚’ä»˜ä¸\nstation_main_grid500m <- station_main_grid500m |> \n  left_join(pop_grid500m,\n            by = \"grid500m\") |> \n  replace_na(list(pop = 0))\n\nlimits <- c(0, max(station_main_grid500m$pop))\n\nstation_main_grid500m |> \n  group_by(station) |> \n  group_map(~ {\n    ggplot(.x,\n           aes(fill = pop)) +\n      annotation_map_tile() +\n      geom_sf(alpha = 0.5) +\n      scale_fill_viridis_c(\"äººå£\",\n                           limits = limits,\n                           option = \"turbo\") +\n      ggtitle(.y$station) +\n      theme(plot.title = element_text(hjust = 0.5),\n            axis.text = element_blank())\n  }) |> \n  patchwork::wrap_plots() +\n  patchwork::plot_layout(guides = \"collect\")\n```\n\n::: {.cell-output-display}\n![](grid-square-stats-in-r-ja_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstation_main_grid500m |> \n  st_drop_geometry() |> \n  group_by(station) |> \n  summarise(pop = sum(pop)) |> \n  ggplot(aes(station, pop)) +\n  geom_col(aes(fill = station),\n           show.legend = FALSE) +\n  geom_text(aes(label = scales::label_comma(suffix = \"äºº\")(pop)),\n            vjust = 2) +\n  scale_x_discrete(\"æ±äº¬ã®ä¸»è¦é§…\") +\n  scale_y_continuous(\"é§…å‹¢åœãƒ¡ãƒƒã‚·ãƒ¥äººå£ [åƒäºº]\",\n                     labels = scales::label_comma(scale = 1e-3)) +\n  scale_fill_brewer(palette = \"Set2\")\n```\n\n::: {.cell-output-display}\n![](grid-square-stats-in-r-ja_files/figure-html/unnamed-chunk-5-1.png){width=100%}\n:::\n:::\n\n\n## ã¾ã¨ã‚\n\nRãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®jpgridã«ã‚ˆã‚‹åœ°åŸŸãƒ¡ãƒƒã‚·ãƒ¥çµ±è¨ˆã®ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’ç´¹ä»‹ã—ã¾ã—ãŸï¼\n\njpgridã‚’ä½¿ã†ã“ã¨ã§ï¼Œ**ç·¯åº¦çµŒåº¦ã‚„ã‚¸ã‚ªãƒ¡ãƒˆãƒªã®ãƒ‡ãƒ¼ã‚¿ã‚’ç°¡å˜ã«åœ°åŸŸãƒ¡ãƒƒã‚·ãƒ¥çµ±è¨ˆã¨ç´ã¥ã‘ã‚‰ã‚Œã¾ã™**ï¼çš†ã•ã‚“ã‚‚ãœã²ä½¿ã£ã¦ã¿ã¦ãã ã•ã„ï¼\n",
    "supporting": [
      "grid-square-stats-in-r-ja_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}