{
  "hash": "16397517888d3d3b76eb44a37e8d203d",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"rvestで動的サイトをスクレイピングする（Seleniumを使わずに）\"\nlang: ja\ncategories: [rvest, R, Japanese]\ndate: \"2024-02-15\"\nformat:\n  html:\n    df-print: paged\nimage: scraping-dynamic-sites-with-rvest/html-view.png\n---\n\n\n## RにおけるWebスクレイピングのこれまで\n\nRにおけるWebスクレイピングの定番パッケージにrvestがありますが，これまでブラウザ上の操作によってコンテンツが変化する動的サイトのスクレイピングにはrvestを用いることができませんでした．そのため，Rで動的サイトのスクレイピングには，RSeleniumなどの他のパッケージと組み合わせて利用する必要があり，以下のような課題が生じていました．\n\n- Seleniumを用いる場合には，事前にドライバをダウンロードする必要があるなど環境構築が面倒\n- 他のパッケージで取得したHTMLに対してrvestの関数をシームレスに適用できない\n\nしかし，[rvest 1.0.4](https://cran.r-project.org/web/packages/rvest/news/news.html)では，[`read_html_live()`](https://rvest.tidyverse.org/reference/read_html_live.html)という新たな関数が追加され，動的サイトのスクレイピングが可能となりました．`read_html_live()`を用いることで，`$click()`や`$type()`などのメソッドを用いたブラウザ上の操作の自動化が可能となるだけでなく，`html_elements()`や`html_attr()`などの一般的なrvestの関数をシームレスに呼ぶことができるようになります．\n\n`read_html_live()`は，Google Chromeの自動化を行う[chromote](https://rstudio.github.io/chromote/)というパッケージを利用しています．そのため，`read_html_live()`を使うには，事前にGoogle Chrome（ブラウザ）とchromote（Rパッケージ）をインストールしておく必要があります．\n\n## `read_html_live()`を使ってみよう\n\nここからは，[こちらのRSeleniumのチュートリアル](https://joshuamccrain.com/tutorials/web_scraping_R_selenium.html)で紹介されているものと同じ処理を`read_html_live()`で行ってみましょう．\n\nこちらのチュートリアルでは，[こちらのサイト](https://www.fcc.gov/media/engineering/dtvmaps)にアメリカの郵便番号（ZIP code）を入力して地元テレビ局の情報を取得するという一連の処理を自動化しています．\n`read_html_live()`を使えば，RSeleniumでのサイトのアクセスを以下のように書き換えられます．\n\n``` r\n# RSelenium\n# Source: https://joshuamccrain.com/tutorials/web_scraping_R_selenium.html\nlibrary(RSelenium)\n\nrD <- rsDriver(browser=\"firefox\", port=4545L, verbose=F)\nremDr <- rD[[\"client\"]]\nremDr$navigate(\"https://www.fcc.gov/media/engineering/dtvmaps\")\n```\n\n⏬\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# rvest\nlibrary(rvest)\nlibrary(tidyverse)\n\nhtml <- read_html_live(\"https://www.fcc.gov/media/engineering/dtvmaps\")\n```\n:::\n\n\n読み込まれたオブジェクトは，`$view()`でブラウザで確認することができます．サイト上のエレメントを選択（`Ctrl+Shift+C`）したのち，該当箇所を右クリック⏩`Copy`⏩`Copy selector`でCSSセレクタをコピーすれば，`$type()`や`$click()`の引数として使うことができます．\n\n``` r\n# rvest\nhtml$view()\n```\n\n![](scraping-dynamic-sites-with-rvest/html-view.png)\n\n次に，中央のフォームに郵便番号（ZIP code）を入力⏩`Go!`ボタンをクリックし地元テレビ局の情報を表示させるコードは以下のように書き換えられます．\n\n``` r\n# RSelenium\n# Source: https://joshuamccrain.com/tutorials/web_scraping_R_selenium.html\nzip <- \"30308\"\nremDr$findElement(using = \"id\", value = \"startpoint\")$sendKeysToElement(list(zip))\nremDr$findElements(\"id\", \"btnSub\")[[1]]$clickElement()\n```\n\n⏬\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# rvest\nzip <- \"30308\"\nhtml$type(\"#startpoint\", zip)\nhtml$click(\"#btnSub\")\n```\n:::\n\n\n最後に，上記のRSeleniumのチュートリアルと同じデータが取得できたことを確認しましょう．\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# rvest\nhtml |> \n  html_elements(\"table.tbl_mapReception\") |> \n  insistently(chuck)(3) |> \n  html_table() |> \n  select(!c(1, IA)) |> \n  rename_with(str_to_lower) |> \n  rename(ch_num = `ch#`) |> \n  slice_tail(n = -1) |> \n  filter(callsign != \"\")\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"callsign\"],\"name\":[1],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"network\"],\"name\":[2],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"ch_num\"],\"name\":[3],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"band\"],\"name\":[4],\"type\":[\"chr\"],\"align\":[\"left\"]}],\"data\":[{\"1\":\"WXIA-TV\",\"2\":\"NBC\",\"3\":\"11\",\"4\":\"Hi-V\"},{\"1\":\"WSB-TV\",\"2\":\"ABC\",\"3\":\"2\",\"4\":\"UHF\"},{\"1\":\"WUVG-DT\",\"2\":\"UNIV\",\"3\":\"34\",\"4\":\"UHF\"},{\"1\":\"WHSG-TV\",\"2\":\"TRIN\",\"3\":\"63\",\"4\":\"UHF\"},{\"1\":\"WAGA-TV\",\"2\":\"FOX\",\"3\":\"5\",\"4\":\"UHF\"},{\"1\":\"WANF\",\"2\":\"CBS\",\"3\":\"46\",\"4\":\"UHF\"},{\"1\":\"WUPA\",\"2\":\"THE\",\"3\":\"69\",\"4\":\"UHF\"},{\"1\":\"WPCH-TV\",\"2\":\"IND\",\"3\":\"17\",\"4\":\"UHF\"},{\"1\":\"WATL\",\"2\":\"MY N\",\"3\":\"36\",\"4\":\"UHF\"},{\"1\":\"WIRE-CD\",\"2\":\"\",\"3\":\"\",\"4\":\"UHF\"},{\"1\":\"WABE-TV\",\"2\":\"PBS\",\"3\":\"30\",\"4\":\"UHF\"},{\"1\":\"WATC-DT\",\"2\":\"ETV\",\"3\":\"57\",\"4\":\"UHF\"},{\"1\":\"WYGA-CD\",\"2\":\"\",\"3\":\"\",\"4\":\"UHF\"},{\"1\":\"WGTV\",\"2\":\"PBS\",\"3\":\"8\",\"4\":\"Hi-V\"},{\"1\":\"WANN-CD\",\"2\":\"\",\"3\":\"\",\"4\":\"UHF\"},{\"1\":\"WPXA-TV\",\"2\":\"ION\",\"3\":\"14\",\"4\":\"UHF\"},{\"1\":\"WKTB-CD\",\"2\":\"\",\"3\":\"\",\"4\":\"UHF\"},{\"1\":\"WSKC-CD\",\"2\":\"\",\"3\":\"\",\"4\":\"UHF\"},{\"1\":\"WNGH-TV\",\"2\":\"PBS\",\"3\":\"18\",\"4\":\"Lo-V\"},{\"1\":\"WJSP-TV\",\"2\":\"PBS\",\"3\":\"28\",\"4\":\"Lo-V\"},{\"1\":\"WCIQ\",\"2\":\"PBS\",\"3\":\"7\",\"4\":\"Hi-V\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n\n## まとめ\n\n以上のようにrvest 1.0.4で追加された`read_html_live()`を使うことで，rvestだけでシームレスに静的サイトと動的サイトのスクレイピングが可能となるだけでなく，RSeleniumと比べてシンプルなコードでブラウザ上の操作を再現することができることがわかりました．\n\nRには，rvestの他にも[selenider](https://ashbythorpe.github.io/selenider/)というWebスクレイピング用のパッケージも開発されているようです．こういったパッケージの開発が進むことで，RでのWebスクレイピングがさらに便利になることが期待されます．\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"../../../site_libs/pagedtable-1.1/css/pagedtable.css\" rel=\"stylesheet\" />\n<script src=\"../../../site_libs/pagedtable-1.1/js/pagedtable.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}