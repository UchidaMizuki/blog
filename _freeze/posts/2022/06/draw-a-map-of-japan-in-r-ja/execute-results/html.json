{
  "hash": "a5cb7d490a40a536fedd03dc174e4578",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Rで日本地図を描いてみよう\"\nlang: ja\ndate: \"2022-06-11\"\ndate-modified: \"2024-04-27\"\ncategories: [ggplot2, sf, jpmap, R, Japanese]\nfig-align: center\nout-width: 100%\nimage: foreigner_ratio_2015.png\nformat:\n  html:\n    df-print: paged\n---\n\n\nRでは，ggplot2などのパッケージを利用するだけで，都道府県別の日本地図を描くことができます．ここでは，日本地図をggplot2で描画する方法をいくつか紹介します．\n\n## 地図描画用のサンプルデータ\n\nここでは，[こちら](https://www.e-stat.go.jp/dbview?sid=0000010201)からダウンロードできる社会・人口統計体系の2015年の都道府県別外国人人口比率データ（10万人あたり外国人人口）を地図描画用のサンプルデータとしました．\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\" code-summary=\"パッケージの読み込み\"}\nlibrary(tidyverse)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\" code-summary=\"データのダウンロード\"}\nlibrary(jpstat)\nlibrary(arrow)\n\nforeigner_ratio_2015 <- estat(statsDataId = \"https://www.e-stat.go.jp/en/dbview?sid=0000010201\",\n                              lang = \"E\")\nforeigner_ratio_2015 <- foreigner_ratio_2015 |> \n  activate(tab) |> \n  select() |> \n  \n  activate(cat01) |> \n  # Ratio of population of foreigners (per 100,000 persons)\n  filter(code == \"#A01601\") |> \n  select() |> \n  \n  activate(area) |> \n  filter(name != \"All Japan\") |> \n  select(code, name) |> \n  rekey(\"pref\") |> \n  \n  activate(time) |> \n  filter(name == \"2015\") |> \n  select()\nforeigner_ratio_2015 <- foreigner_ratio_2015 |> \n  collect(\"foreigners_per_100K\")\n\nwrite_parquet(foreigner_ratio_2015, \"foreigner_ratio_2015.parquet\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\" code-summary=\"データの読み込み\"}\nlibrary(arrow)\n\nforeigner_ratio_2015 <- read_parquet(\"foreigner_ratio_2015.parquet\") |> \n  mutate(pref_code = pref_code |> \n           str_extract(\"^\\\\d{2}\") |> \n           parse_integer(),\n         \n         pref_name = pref_name |> \n           str_remove(\"-.+$\"),\n         pref_name = case_when(pref_name == \"Gumma\" ~ \"Gunma\",\n                               TRUE ~ pref_name),\n         \n         foreigner_ratio = parse_number(foreigners_per_100K) / 1e5,\n         .keep = \"unused\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# 地図描画用のサンプルデータ\nhead(foreigner_ratio_2015)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"pref_code\"],\"name\":[1],\"type\":[\"int\"],\"align\":[\"right\"]},{\"label\":[\"pref_name\"],\"name\":[2],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"foreigner_ratio\"],\"name\":[3],\"type\":[\"dbl\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"1\",\"2\":\"Hokkaido\",\"3\":\"0.004028\"},{\"1\":\"2\",\"2\":\"Aomori\",\"3\":\"0.002635\"},{\"1\":\"3\",\"2\":\"Iwate\",\"3\":\"0.003921\"},{\"1\":\"4\",\"2\":\"Miyagi\",\"3\":\"0.005994\"},{\"1\":\"5\",\"2\":\"Akita\",\"3\":\"0.002848\"},{\"1\":\"6\",\"2\":\"Yamagata\",\"3\":\"0.004896\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n\n## `geom_map()` で日本地図を描く\n\nggplot2で`map_data()` や`geom_map()` を使って世界の国々の地図を描画することができます．これには，あらかじめmapsパッケージとmapdataパッケージをダウンロードしておく必要があります（mapdataパッケージに日本地図が格納されています）．\n\n`map_data(\"japan\")` とすることで，mapsパッケージの地図データがデータフレームに変換されます．このデータフレームの`region` 列が都道府県のIDとなるため，`aes(map_id = region)`を設定した上で，`geom_map()` することで，描画したいデータの`region` 列と都道府県ジオメトリがリンクします．\n\nただし，`map_data(\"japan\")` は，以下の点に注意が必要です．\n\n-   あらかじめ`library(mapdata)` を実行してください（実行しないとデータが読み込めないようです）\n\n-   `region` 列はすべてアルファベット表記である\n\n-   他の都道府県と異なり奈良県だけが`NARA` と大文字表記になっているなど元データにやや問題があるようです（今回は`str_to_title()`で修正しました）\n\nまた，日本地図全体を表示するためには，`expand_limits()` などで軸を設定すること必要になります．\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# pak::pak(\"maps\")\n# pak::pak(\"mapdata\")\nlibrary(tidyverse)\nlibrary(mapdata)\n\nmap_data_japan <- map_data(\"japan\") |> \n  as_tibble() |> \n  mutate(region = str_to_title(region))\nhead(map_data_japan)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"long\"],\"name\":[1],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"lat\"],\"name\":[2],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"group\"],\"name\":[3],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"order\"],\"name\":[4],\"type\":[\"int\"],\"align\":[\"right\"]},{\"label\":[\"region\"],\"name\":[5],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"subregion\"],\"name\":[6],\"type\":[\"chr\"],\"align\":[\"left\"]}],\"data\":[{\"1\":\"139.7707\",\"2\":\"42.3018\",\"3\":\"1\",\"4\":\"1\",\"5\":\"Hokkaido\",\"6\":\"NA\"},{\"1\":\"139.7706\",\"2\":\"42.3001\",\"3\":\"1\",\"4\":\"2\",\"5\":\"Hokkaido\",\"6\":\"NA\"},{\"1\":\"139.7773\",\"2\":\"42.2956\",\"3\":\"1\",\"4\":\"3\",\"5\":\"Hokkaido\",\"6\":\"NA\"},{\"1\":\"139.7783\",\"2\":\"42.2916\",\"3\":\"1\",\"4\":\"4\",\"5\":\"Hokkaido\",\"6\":\"NA\"},{\"1\":\"139.7829\",\"2\":\"42.2838\",\"3\":\"1\",\"4\":\"5\",\"5\":\"Hokkaido\",\"6\":\"NA\"},{\"1\":\"139.7819\",\"2\":\"42.2833\",\"3\":\"1\",\"4\":\"6\",\"5\":\"Hokkaido\",\"6\":\"NA\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n\n```{.r .cell-code}\nggplot(foreigner_ratio_2015 |> \n         rename(region = pref_name),\n       aes(map_id = region)) +\n  geom_map(aes(fill = foreigner_ratio),\n           map = map_data_japan) +\n  expand_limits(x = map_data_japan$long,\n                y = map_data_japan$lat) +\n  scale_fill_viridis_c(\"外国人人口比率\",\n                       limits = c(0, 0.03),\n                       labels = scales::label_percent(),\n                       option = \"turbo\")\n```\n\n::: {.cell-output-display}\n![](draw-a-map-of-japan-in-r-ja_files/figure-html/geom_map-1.png){width=672}\n:::\n:::\n\n\n## sfパッケージで日本地図を描く\n\nggplot2の`geom_sf()`を使えばsfパッケージのジオメトリを簡単に描画できます．\n\nsfパッケージの`st_as_sf()` を使えば，maps・mapdataパッケージの提供する地図データをsfオブジェクトに変換することができます．日本地図データをsfに変換することで，先ほどのコードよりも直感的に地図を描くことができます．\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(sf)\n\nmap_japan <- maps::map(\"japan\", \n                       plot = FALSE,\n                       fill = TRUE) |> \n  st_as_sf() |> \n  rename(pref_name = ID) |> \n  mutate(pref_name = str_to_title(pref_name))\n\nmap_japan |> \n  left_join(foreigner_ratio_2015,\n            by = join_by(pref_name)) |> \n  ggplot(aes(fill = foreigner_ratio)) +\n  geom_sf(color = \"transparent\") +\n  scale_fill_viridis_c(\"外国人人口比率\",\n                       limits = c(0, 0.03),\n                       labels = scales::label_percent(),\n                       option = \"turbo\")\n```\n\n::: {.cell-output-display}\n![](draw-a-map-of-japan-in-r-ja_files/figure-html/sf-1.png){width=672}\n:::\n:::\n\n\n### さらに詳細な地図情報を入手可能なrnaturalearthについて\n\n世界地図のデータを取得可能なパッケージにはrnaturalearthパッケージもあります．\n\n都道府県別地図を取得するにはrnaturalearthの`ne_states(\"japan\")` を実行します．`ne_states(\"japan\")` の出力には英語の都道府県名に加えて日本語の都道府県名も含まれており便利です．\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmap_japan <- rnaturalearth::ne_states(\"japan\") |> \n  as_tibble() |> \n  st_as_sf() |> \n  select(iso_3166_2, name_ja, name_en) |> \n  arrange(iso_3166_2)\nhead(map_japan)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"iso_3166_2\"],\"name\":[1],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"name_ja\"],\"name\":[2],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"name_en\"],\"name\":[3],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"geometry\"],\"name\":[4],\"type\":[\"s_MULTIP\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"JP-01\",\"2\":\"北海道\",\"3\":\"Hokkaidō\",\"4\":\"<s_MULTIP>\"},{\"1\":\"JP-02\",\"2\":\"青森県\",\"3\":\"Aomori Prefecture\",\"4\":\"<s_MULTIP>\"},{\"1\":\"JP-03\",\"2\":\"岩手県\",\"3\":\"Iwate Prefecture\",\"4\":\"<s_MULTIP>\"},{\"1\":\"JP-04\",\"2\":\"宮城県\",\"3\":\"Miyagi Prefecture\",\"4\":\"<s_MULTIP>\"},{\"1\":\"JP-05\",\"2\":\"秋田県\",\"3\":\"Akita Prefecture\",\"4\":\"<s_MULTIP>\"},{\"1\":\"JP-06\",\"2\":\"山形県\",\"3\":\"Yamagata Prefecture\",\"4\":\"<s_MULTIP>\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n\n## 日本地図をレイアウトするためのjpmapパッケージ\n\n日本地図の描画では，日本列島を大きく描画するために琉球諸島や小笠原諸島を地図上の左上や右下に配置したいケースがあります．ggplot2で作成した日本地図のレイアウトを簡単に行えるように[jpmap](https://github.com/UchidaMizuki/jpmap)を作成しました．\n\njpmapは，以下の機能を持っています．\n\n-   琉球諸島・小笠原諸島を再配置したレイアウトを可能にする`jpmap::layout_japan()`\n\n    -   ただし再配置される琉球諸島・小笠原諸島の縮尺は厳密ではありませんのでご注意ください\n\n    -   `ryukyu = FALSE`や`ogasawara = FALSE` を指定することで琉球諸島・小笠原諸島を非表示にすることが可能です\n\n-   日本語の都道府県名や都道府県コードが含む都道府県データを提供する`jpmap::prefecture`（rnaturalearthのデータがベースです）\n\n    -   ただし，英語の都道府県名（`pref_name`）がHokkaidoではなくHokkaidōといった表記なっているためご注意ください．\n\n`jpmap::layout_japan()` で地図のレイアウトを変更することで，都道府県ごとの傾向がよりわかりやすくなります．\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# pak::pak(\"UchidaMizuki/jpmap\")\njpmap::prefecture\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"pref_code\"],\"name\":[1],\"type\":[\"int\"],\"align\":[\"right\"]},{\"label\":[\"pref_name\"],\"name\":[2],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"pref_name_ja\"],\"name\":[3],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"geometry\"],\"name\":[4],\"type\":[\"s_MULTIP\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"1\",\"2\":\"Hokkaidō\",\"3\":\"北海道\",\"4\":\"<s_MULTIP>\"},{\"1\":\"2\",\"2\":\"Aomori\",\"3\":\"青森県\",\"4\":\"<s_MULTIP>\"},{\"1\":\"3\",\"2\":\"Iwate\",\"3\":\"岩手県\",\"4\":\"<s_MULTIP>\"},{\"1\":\"4\",\"2\":\"Miyagi\",\"3\":\"宮城県\",\"4\":\"<s_MULTIP>\"},{\"1\":\"5\",\"2\":\"Akita\",\"3\":\"秋田県\",\"4\":\"<s_MULTIP>\"},{\"1\":\"6\",\"2\":\"Yamagata\",\"3\":\"山形県\",\"4\":\"<s_MULTIP>\"},{\"1\":\"7\",\"2\":\"Fukushima\",\"3\":\"福島県\",\"4\":\"<s_MULTIP>\"},{\"1\":\"8\",\"2\":\"Ibaraki\",\"3\":\"茨城県\",\"4\":\"<s_MULTIP>\"},{\"1\":\"9\",\"2\":\"Tochigi\",\"3\":\"栃木県\",\"4\":\"<s_MULTIP>\"},{\"1\":\"10\",\"2\":\"Gunma\",\"3\":\"群馬県\",\"4\":\"<s_MULTIP>\"},{\"1\":\"11\",\"2\":\"Saitama\",\"3\":\"埼玉県\",\"4\":\"<s_MULTIP>\"},{\"1\":\"12\",\"2\":\"Chiba\",\"3\":\"千葉県\",\"4\":\"<s_MULTIP>\"},{\"1\":\"13\",\"2\":\"Tokyo\",\"3\":\"東京都\",\"4\":\"<s_MULTIP>\"},{\"1\":\"14\",\"2\":\"Kanagawa\",\"3\":\"神奈川県\",\"4\":\"<s_MULTIP>\"},{\"1\":\"15\",\"2\":\"Niigata\",\"3\":\"新潟県\",\"4\":\"<s_MULTIP>\"},{\"1\":\"16\",\"2\":\"Toyama\",\"3\":\"富山県\",\"4\":\"<s_MULTIP>\"},{\"1\":\"17\",\"2\":\"Ishikawa\",\"3\":\"石川県\",\"4\":\"<s_MULTIP>\"},{\"1\":\"18\",\"2\":\"Fukui\",\"3\":\"福井県\",\"4\":\"<s_MULTIP>\"},{\"1\":\"19\",\"2\":\"Yamanashi\",\"3\":\"山梨県\",\"4\":\"<s_MULTIP>\"},{\"1\":\"20\",\"2\":\"Nagano\",\"3\":\"長野県\",\"4\":\"<s_MULTIP>\"},{\"1\":\"21\",\"2\":\"Gifu\",\"3\":\"岐阜県\",\"4\":\"<s_MULTIP>\"},{\"1\":\"22\",\"2\":\"Shizuoka\",\"3\":\"静岡県\",\"4\":\"<s_MULTIP>\"},{\"1\":\"23\",\"2\":\"Aichi\",\"3\":\"愛知県\",\"4\":\"<s_MULTIP>\"},{\"1\":\"24\",\"2\":\"Mie\",\"3\":\"三重県\",\"4\":\"<s_MULTIP>\"},{\"1\":\"25\",\"2\":\"Shiga\",\"3\":\"滋賀県\",\"4\":\"<s_MULTIP>\"},{\"1\":\"26\",\"2\":\"Kyōto\",\"3\":\"京都府\",\"4\":\"<s_MULTIP>\"},{\"1\":\"27\",\"2\":\"Ōsaka\",\"3\":\"大阪府\",\"4\":\"<s_MULTIP>\"},{\"1\":\"28\",\"2\":\"Hyōgo\",\"3\":\"兵庫県\",\"4\":\"<s_MULTIP>\"},{\"1\":\"29\",\"2\":\"Nara\",\"3\":\"奈良県\",\"4\":\"<s_MULTIP>\"},{\"1\":\"30\",\"2\":\"Wakayama\",\"3\":\"和歌山県\",\"4\":\"<s_MULTIP>\"},{\"1\":\"31\",\"2\":\"Tottori\",\"3\":\"鳥取県\",\"4\":\"<s_MULTIP>\"},{\"1\":\"32\",\"2\":\"Shimane\",\"3\":\"島根県\",\"4\":\"<s_MULTIP>\"},{\"1\":\"33\",\"2\":\"Okayama\",\"3\":\"岡山県\",\"4\":\"<s_MULTIP>\"},{\"1\":\"34\",\"2\":\"Hiroshima\",\"3\":\"広島県\",\"4\":\"<s_MULTIP>\"},{\"1\":\"35\",\"2\":\"Yamaguchi\",\"3\":\"山口県\",\"4\":\"<s_MULTIP>\"},{\"1\":\"36\",\"2\":\"Tokushima\",\"3\":\"徳島県\",\"4\":\"<s_MULTIP>\"},{\"1\":\"37\",\"2\":\"Kagawa\",\"3\":\"香川県\",\"4\":\"<s_MULTIP>\"},{\"1\":\"38\",\"2\":\"Ehime\",\"3\":\"愛媛県\",\"4\":\"<s_MULTIP>\"},{\"1\":\"39\",\"2\":\"Kōchi\",\"3\":\"高知県\",\"4\":\"<s_MULTIP>\"},{\"1\":\"40\",\"2\":\"Fukuoka\",\"3\":\"福岡県\",\"4\":\"<s_MULTIP>\"},{\"1\":\"41\",\"2\":\"Saga\",\"3\":\"佐賀県\",\"4\":\"<s_MULTIP>\"},{\"1\":\"42\",\"2\":\"Nagasaki\",\"3\":\"長崎県\",\"4\":\"<s_MULTIP>\"},{\"1\":\"43\",\"2\":\"Kumamoto\",\"3\":\"熊本県\",\"4\":\"<s_MULTIP>\"},{\"1\":\"44\",\"2\":\"Ōita\",\"3\":\"大分県\",\"4\":\"<s_MULTIP>\"},{\"1\":\"45\",\"2\":\"Miyazaki\",\"3\":\"宮崎県\",\"4\":\"<s_MULTIP>\"},{\"1\":\"46\",\"2\":\"Kagoshima\",\"3\":\"鹿児島県\",\"4\":\"<s_MULTIP>\"},{\"1\":\"47\",\"2\":\"Okinawa\",\"3\":\"沖縄県\",\"4\":\"<s_MULTIP>\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n\n```{.r .cell-code}\nplot <- jpmap::prefecture |> \n  left_join(foreigner_ratio_2015 |> \n              select(!pref_name),\n            by = join_by(pref_code)) |> \n  ggplot(aes(fill = foreigner_ratio)) +\n  geom_sf(color = \"transparent\") +\n  scale_fill_viridis_c(\"外国人人口比率\",\n                       limits = c(0, 0.03),\n                       labels = scales::label_percent(),\n                       option = \"turbo\")\n\njpmap::layout_japan(plot)\n```\n\n::: {.cell-output-display}\n![](draw-a-map-of-japan-in-r-ja_files/figure-html/jpmap-1.png){width=672}\n:::\n:::\n\n\n\n\n## まとめ\n\n2015年の都道府県別外国人人口比率に関する日本地図から以下のことがわかりました．\n\n-   2015年では**どの都道府県でも外国人人口比率が3％以下**である\n\n-   **東京都**は外国人人口比率が最も多く，**愛知県**や**群馬県**なども外国人口比率が高い．\n\nここまで，ggplot2などのパッケージを活用した日本地図の描画を試してみました．\n\nその結果，Rを使えば，自前でデータを整備しなくても，簡単に日本地図を描けることがわかりました．みなさんもぜひ，ggplot2を使って，色々な地図を使ってみてください！\n",
    "supporting": [
      "draw-a-map-of-japan-in-r-ja_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"../../../site_libs/pagedtable-1.1/css/pagedtable.css\" rel=\"stylesheet\" />\n<script src=\"../../../site_libs/pagedtable-1.1/js/pagedtable.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}