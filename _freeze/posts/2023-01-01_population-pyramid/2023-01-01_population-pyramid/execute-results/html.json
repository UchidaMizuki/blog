{
  "hash": "f03d177d539c323af866f9432013c8e7",
  "result": {
    "markdown": "---\ntitle: \"Rで人口ピラミッドのアニメーションを作る\"\nlang: ja\ndate: \"2023-01-01\"\ncategories: [jpstat, R, Python, Japanese]\nfig-align: center\n---\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(jpstat)\nlibrary(gganimate)\n\ntheme_set(theme_light())\n```\n:::\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nappId <- \"Your e-Stat appId\"\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ncensus <- estat(appId, \"https://www.e-stat.go.jp/dbview?sid=0003410380\")\n\npop <- census |> \n  activate(tab) |> \n  filter(name == \"人口\") |> \n  select() |> \n  \n  activate(cat01) |> \n  rekey(\"sex\") |> \n  filter(name %in% c(\"男\", \"女\")) |> \n  select(name) |> \n  \n  activate(cat02) |> \n  rekey(\"ageclass\") |> \n  filter(str_detect(name, \"^\\\\d+～\\\\d+歳$\") |\n           name == \"85歳以上\" |\n           name == \"110歳以上\") |> \n  select(name) |> \n  \n  activate(time) |> \n  rekey(\"year\") |> \n  filter(str_detect(name, \"^\\\\d+年$\")) |> \n  select(name) |> \n  \n  collect(n = \"pop\") |> \n  rename_with(~ .x |> \n                str_remove(\"_name$\")) |> \n  mutate(sex = as_factor(sex),\n         year = parse_number(year),\n         age_from = ageclass |> \n           str_extract(\"^\\\\d+\") |> \n           stringi::stri_trans_nfkc() |> \n           as.integer(),\n         ageclass = case_when(age_from >= 85 ~ \"85歳以上\",\n                              TRUE ~ ageclass) |> \n           as_factor(),\n         agegroup = case_when(between(age_from, 0, 10) ~ \"年少人口\",\n                              between(age_from, 15, 60) ~ \"生産年齢人口\",\n                              between(age_from, 65, 70) ~ \"前期老年人口\",\n                              age_from >= 75 ~ \"後期老年人口\") |> \n           as_factor(),\n         pop = parse_number(pop)) |> \n  group_by(year, sex, ageclass, agegroup) |> \n  summarise(pop = sum(pop),\n            .groups = \"drop\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nThe total number of data is 796.\n```\n:::\n\n```{.r .cell-code}\nknitr::kable(head(pop))\n```\n\n::: {.cell-output-display}\n| year|sex |ageclass |agegroup     |     pop|\n|----:|:---|:--------|:------------|-------:|\n| 1920|男  |０～４歳 |年少人口     | 3752627|\n| 1920|男  |５～９歳 |年少人口     | 3467156|\n| 1920|男  |10～14歳 |年少人口     | 3089225|\n| 1920|男  |15～19歳 |生産年齢人口 | 2749022|\n| 1920|男  |20～24歳 |生産年齢人口 | 2316479|\n| 1920|男  |25～29歳 |生産年齢人口 | 2008005|\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nagegroup <- pop |> \n  group_by(sex, agegroup) |>\n  summarise(ageclass = mean(as.integer(ageclass)),\n            .groups = \"drop\") |> \n  mutate(hjust = case_when(sex == \"男\" ~ 1.25,\n                           sex == \"女\" ~ -0.25))\n\npop |> \n  mutate(pop = if_else(sex == \"男\",\n                       -pop,\n                       pop)) |> \n  \n  ggplot(aes(ageclass, pop,\n             group = sex,\n             fill = agegroup)) +\n  geom_col(show.legend = FALSE) +\n  geom_text(data = agegroup,\n            aes(label = agegroup,\n                hjust = hjust),\n            y = 0) +\n  scale_x_discrete(NULL) +\n  scale_y_continuous(\"人口［千人］\",\n                     labels = purrr::compose(scales::label_comma(scale = 1e-3), abs)) +\n  scale_fill_brewer(palette = \"Set2\") +\n  coord_flip() +\n  facet_wrap(~ sex,\n             scales = \"free_x\") +\n  labs(title = \"{frame_time %/% 5 * 5}年\") +\n  theme(plot.title = element_text(hjust = 0.5)) +\n  transition_time(year)\n```\n\n::: {.cell-output-display}\n![](2023-01-01_population-pyramid_files/figure-html/unnamed-chunk-5-1.gif)\n:::\n:::\n",
    "supporting": [
      "2023-01-01_population-pyramid_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}