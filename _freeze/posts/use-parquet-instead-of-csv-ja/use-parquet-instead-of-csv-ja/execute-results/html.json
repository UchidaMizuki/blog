{
  "hash": "ea90f9416dffdcbf6de3f0b753021a9e",
  "result": {
    "markdown": "---\ntitle: \"ğŸ—¾CSVã®ä»£ã‚ã‚Šã«Parquetã‚’ä½¿ã£ã¦ã¿ã‚ˆã†\"\nlang: ja\ndate: \"2022-06-12\"\ncategories: [parquet, arrow, R, Python, Japanese]\nfig-align: center\nimage: \"https://www.apache.org/logos/res/parquet/parquet.png\"\n---\n\n\næœ¬è¨˜äº‹ã§ã¯ï¼Œ**CSVã®ä»£æ›¿ã¨ã—ã¦æœ‰æœ›ã‹ã¤ãƒ“ãƒƒã‚°ãƒ‡ãƒ¼ã‚¿åˆ†æã«ã‚‚é©ã—ã¦ã„ã‚‹[Parquet](https://parquet.apache.org)**ã‚’ç´¹ä»‹ã—ã¾ã™ï¼\n\nã•ã¦ï¼Œ**ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ **ï¼ˆData Framesï¼‰ã¯ï¼Œãƒ‡ãƒ¼ã‚¿åˆ†æã«ãŠã„ã¦æœ€ã‚‚åŸºæœ¬çš„ãªãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®1ã¤ã§ã™ï¼**Rã®[tibble](https://tibble.tidyverse.org)ãƒ»[dplyr](https://dplyr.tidyverse.org)**ã‚„**Pythonã®[pandas](https://pandas.pydata.org)**ãªã©ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ æ“ä½œã®ãŸã‚ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½¿ãˆã°ï¼Œã“ã‚Œã¾ã§**Excelãªã©ã®è¡¨è¨ˆç®—ã‚½ãƒ•ãƒˆã§è¡Œã£ã¦ã„ãŸãƒ‡ãƒ¼ã‚¿åˆ†æã‚’ã•ã‚‰ã«åŠ¹ç‡çš„ã«è¡Œã†**ã“ã¨ãŒã§ãã¾ã™ï¼\n\nã“ã®ã‚ˆã†ã«ãƒ‡ãƒ¼ã‚¿åˆ†æãƒ„ãƒ¼ãƒ«ãŒå……å®Ÿã—ã¦ã„ã‚‹ä¸€æ–¹ã§ï¼Œãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«ã¯**Excelãªã©ã¨ã®äº’æ›æ€§ãŒé«˜ã„CSV**ãŒæœªã ã«åºƒãä½¿ã‚ã‚Œã¦ã„ã¾ã™ï¼ã—ã‹ã—ï¼ŒCSVã¯ï¼Œå¿…ãšã—ã‚‚ãƒ‡ãƒ¼ã‚¿åˆ†æã«é©ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã¨ã¯è¨€ãˆã¾ã›ã‚“ï¼ãã“ã§ï¼Œ**CSVã®ä»£æ›¿**ã¨ã—ã¦ä½¿ã‚ã‚Œã‚‹ã“ã¨ãŒå¤šããªã£ã¦ã„ã‚‹Parquetã‚’CSVã¨æ¯”è¼ƒã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼\n\n## ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã®æº–å‚™\n\nCSVã¨Parquetã‚’æ¯”è¼ƒã™ã‚‹ãŸã‚ï¼Œã¾ãšã¯ï¼Œãƒ‡ãƒ¼ã‚¿åˆ†æã«ã‚ã‚ŠãŒã¡ãªã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ç”¨æ„ã—ã¾ã—ã‚‡ã†ï¼ä»Šå›ã¯ï¼Œtidyrãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§æä¾›ã•ã‚Œã¦ã„ã‚‹`who` ï¼ˆ[ä¸–ç•Œä¿å¥æ©Ÿé–¢ï¼ˆWHOï¼‰çµæ ¸ãƒ‡ãƒ¼ã‚¿](https://www.who.int/teams/global-tuberculosis-programme/data)ï¼‰ã‹ã‚‰ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ã¤ãã‚Šã¾ã™ï¼\n\nè¿‘å¹´ï¼Œãƒ‡ãƒ¼ã‚¿åˆ†æã§ã¯ï¼Œ**æ•´ç„¶ãƒ‡ãƒ¼ã‚¿ï¼ˆ[tidy data](https://ja.wikipedia.org/wiki/Tidy_data)ï¼‰**ã®æ¦‚å¿µãŒæ™®åŠã—ã¦ã„ã¾ã™ï¼tidy dataã¯ï¼Œå€‹ã€…ã®å¤‰æ•°ãŒ1ã¤ã®åˆ—ã‚’ãªã—ï¼Œå€‹ã€…ã®è¦³æ¸¬ï¼ˆå€¤ï¼‰ãŒ1ã¤ã®è¡Œã‚’ãªã™ã‚ˆã†ãªãƒ‡ãƒ¼ã‚¿ã§ã™ï¼\n\nãã‚Œã§ã¯ï¼Œ`who`ã¯ï¼Œtidy dataã¨è¨€ãˆã‚‹ã§ã—ã‚‡ã†ã‹ï¼Ÿ`who`ã«ã¯ï¼Œ`\"new_sp_m014\"` ï½`\"newrel_f65\"` ã¨ã„ã£ãŸãŸãã•ã‚“ã®åˆ—ãŒå­˜åœ¨ã—ã¾ã™ãŒï¼Œã“ã‚Œã‚‰ã«ã¯ï¼Œ1åˆ—ã”ã¨ã«ï¼Œè¨ºæ–­çµæœï¼ˆ`sp`ã‚„`sel`ï¼‰ãƒ»æ€§åˆ¥ï¼ˆ`m`ã¨`f`ï¼‰ãƒ»å¹´é½¢éšç´šï¼ˆ`014`ã‚„`65`ï¼‰ã¨ã„ã£ãŸè¤‡æ•°ã®å¤‰æ•°ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ï¼ãã®ãŸã‚ï¼Œ**`who` ã¯ï¼Œtidy dataã§ãªã„**ã¨ã„ãˆã¾ã™ï¼ãã“ã§ï¼Œ[ã“ã¡ã‚‰](https://tidyr.tidyverse.org/articles/pivot.html)ã«å¾“ã£ã¦**tidy dataã§ã‚ã‚‹`who_longer`ã«å¤‰å½¢**ã—ã¾ã™ï¼\n\nãƒ‡ãƒ¼ã‚¿åˆ†æã§ã¯ï¼Œ`who` ã‚ˆã‚Štidy dataã§ã‚ã‚‹`who_longer` ã®ã»ã†ã‚’åˆ†æãŒè¡Œã„ã‚„ã™ã„ä¸€æ–¹ã§ï¼Œè¡Œæ•°ã¯`who`ï¼ˆç´„7,000è¡Œï¼‰ã‚ˆã‚Š`who_longer` ï¼ˆç´„400,000è¡Œï¼‰ã®ã»ã†ãŒç´„50å€å¤šã„ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ï¼ãã®ãŸã‚ï¼Œtidy dataã§ã‚ã‚‹`who_longer`ã®ã‚ˆã†ãªãƒ‡ãƒ¼ã‚¿ã‚’ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã§ã‚ã‚‹CSVã§ä¿å­˜ã™ã‚‹ã¨å®¹é‡ãŒå¢—å¤§ã—ã¦ã—ã¾ã„ã¾ã™ï¼\n\nã“ã®ã‚ˆã†ã«ï¼Œ**tidy dataã¯ãƒ‡ãƒ¼ã‚¿åˆ†æã«é©ã—ã¦ã„ã‚‹ä¸€æ–¹ã§ï¼ŒCSVã®ã‚ˆã†ãªãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã§ã®ä¿å­˜ã«é©ã—ã¦ã„ãªã„**ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ï¼ã—ã‹ã—ï¼Œã“ã®ã‚ˆã†ãª**ãƒ‡ãƒ¼ã‚¿ä¿å­˜ä¸Šã®èª²é¡Œã¯Parquetã‚’ä½¿ãˆã°è§£æ±ºã™ã‚‹**ã“ã¨ãŒã§ãã¾ã™ï¼\n\nã“ã“ã§ï¼Œtidy dataã§ãªã„`who` ã¨tidy dataã§ã‚ã‚‹`who_longer` ã‚’è¦‹æ¯”ã¹ã¦ã¿ã¾ã—ã‚‡ã†ï¼\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(fs)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\nlevels_gender <- c(\"f\", \"m\")\nlevels_age <- c(\"014\", \"1524\", \"2534\", \"3544\", \"4554\", \"5564\", \"65\")\n\nwho_longer <- who |> \n  pivot_longer(cols = new_sp_m014:newrel_f65,\n               names_to = c(\"diagnosis\", \"gender\", \"age\"), \n               names_pattern = \"new_?(.*)_(.)(.*)\",\n               names_transform = list(gender = ~ .x |> \n                                        readr::parse_factor(levels = levels_gender),\n                                      age = ~ .x |> \n                                        readr::parse_factor(levels = levels_age,\n                                                            ordered = TRUE)),\n               values_to = \"count\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# ãƒ‡ãƒ¼ã‚¿æ•´å½¢å‰\nprint(who, n = 5)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 7,240 Ã— 60\n  country     iso2  iso3   year new_spâ€¦Â¹ new_sâ€¦Â² new_sâ€¦Â³ new_sâ€¦â´ new_sâ€¦âµ new_sâ€¦â¶\n  <chr>       <chr> <chr> <int>    <int>   <int>   <int>   <int>   <int>   <int>\n1 Afghanistan AF    AFG    1980       NA      NA      NA      NA      NA      NA\n2 Afghanistan AF    AFG    1981       NA      NA      NA      NA      NA      NA\n3 Afghanistan AF    AFG    1982       NA      NA      NA      NA      NA      NA\n4 Afghanistan AF    AFG    1983       NA      NA      NA      NA      NA      NA\n5 Afghanistan AF    AFG    1984       NA      NA      NA      NA      NA      NA\n# â€¦ with 7,235 more rows, 50 more variables: new_sp_m65 <int>,\n#   new_sp_f014 <int>, new_sp_f1524 <int>, new_sp_f2534 <int>,\n#   new_sp_f3544 <int>, new_sp_f4554 <int>, new_sp_f5564 <int>,\n#   new_sp_f65 <int>, new_sn_m014 <int>, new_sn_m1524 <int>,\n#   new_sn_m2534 <int>, new_sn_m3544 <int>, new_sn_m4554 <int>,\n#   new_sn_m5564 <int>, new_sn_m65 <int>, new_sn_f014 <int>,\n#   new_sn_f1524 <int>, new_sn_f2534 <int>, new_sn_f3544 <int>, â€¦\n```\n:::\n\n```{.r .cell-code}\n# ãƒ‡ãƒ¼ã‚¿æ•´å½¢å¾Œ\nprint(who_longer, n = 5)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 405,440 Ã— 8\n  country     iso2  iso3   year diagnosis gender age   count\n  <chr>       <chr> <chr> <int> <chr>     <fct>  <ord> <int>\n1 Afghanistan AF    AFG    1980 sp        m      014      NA\n2 Afghanistan AF    AFG    1980 sp        m      1524     NA\n3 Afghanistan AF    AFG    1980 sp        m      2534     NA\n4 Afghanistan AF    AFG    1980 sp        m      3544     NA\n5 Afghanistan AF    AFG    1980 sp        m      4554     NA\n# â€¦ with 405,435 more rows\n```\n:::\n:::\n\n\n## CSVãƒ»Parquetã®ä¿å­˜æ–¹æ³•\n\nRã§ã¯ï¼Œ`write_csv()` ã§CSVã‚’ä¿å­˜ã§ãã¾ã™ï¼åŒæ§˜ã«ï¼Œarrowãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®`write_parquet()` ã§Parquetã‚’ä¿å­˜ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼`who_longer`ã‚’CSVã¨Parquetã§ä¿å­˜ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼\n\nCSVã¨Parquetã§ã¯ï¼Œã©ã¡ã‚‰ã‚‚ç°¡å˜ã«ãƒ‡ãƒ¼ã‚¿ä¿å­˜ãŒã§ãã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ï¼\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(arrow)\n\n# CSVã‚’ä¿å­˜\nwrite_csv(who_longer, \"who_longer.csv\")\n\n# Parquetã‚’ä¿å­˜\nwrite_parquet(who_longer, \"who_longer.parquet\")\n```\n:::\n\n\n## Parquetã®ãƒ¡ãƒªãƒƒãƒˆãƒ»CSVã¨ã®æ¯”è¼ƒ\n\nã“ã“ã‹ã‚‰ã¯ï¼Œä¿å­˜ã—ãŸ`who_longer` ã®CSVãƒ»Parquetãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¯”è¼ƒã—ã¦ï¼ŒCSVã«å¯¾ã™ã‚‹Parquetã®ãƒ¡ãƒªãƒƒãƒˆã‚’ç´¹ä»‹ã—ã¦ã„ãã¾ã™ï¼\n\n### ãƒ¡ãƒªãƒƒãƒˆ1ï¼šCSVã‚ˆã‚Šãƒ‡ãƒ¼ã‚¿å®¹é‡ãŒè»½ã„\n\ntidy dataã¯è¡Œæ•°ãŒå¤šããªã‚‹ãŸã‚ï¼ŒCSVã§ã®ä¿å­˜ã«é©ã—ã¦ãŠã‚‰ãšï¼ŒParquetã‚’ä½¿ã£ãŸã»ã†ãŒã‚ˆã„ã“ã¨ã‚’æ—¢ã«è¿°ã¹ã¾ã—ãŸï¼\n\nå®Ÿéš›ã«ï¼Œ`who_longer` ã®CSVãƒ»Parquetã®ãƒ‡ãƒ¼ã‚¿å®¹é‡ã¯ï¼Œãã‚Œãã‚Œï¼Œ14.1 MBã¨154 KBã¨ãªã‚Šï¼Œ**Parquetã¯CSVã®ç´„1 %ã®ãƒ‡ãƒ¼ã‚¿å®¹é‡**ã—ã‹ãªã„ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ï¼\n\nã©ã®ã‚ˆã†ãªã‚±ãƒ¼ã‚¹ã§ã‚‚ã“ã®ã‚ˆã†ãªãƒ‡ãƒ¼ã‚¿å®¹é‡ã®å‰Šæ¸›ãŒè¦‹è¾¼ã‚ã‚‹ã‚ã‘ã§ã¯ã‚ã‚Šã¾ã›ã‚“ãŒï¼Œ**Parquetã¯åˆ—æŒ‡å‘ã§ãƒ‡ãƒ¼ã‚¿åœ§ç¸®**ã‚’è¡Œã†ãŸã‚ï¼ŒRãªã©ã§ã‚ˆãç”¨ã„ã‚‰ã‚Œã‚‹**tidy dataã®ä¿å­˜ã«é©ã—ãŸãƒ‡ãƒ¼ã‚¿å½¢å¼**ã§ã‚ã‚‹ã¨ã„ãˆã¾ã™ï¼\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# CSV\nfile_size(\"who_longer.csv\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n14.1M\n```\n:::\n\n```{.r .cell-code}\n# Parquet\nfile_size(\"who_longer.parquet\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n154K\n```\n:::\n\n```{.r .cell-code}\nunits::set_units(file_size(\"who_longer.parquet\") / file_size(\"who_longer.csv\")) |> \n  units::set_units(`%`)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n1.071028 [%]\n```\n:::\n:::\n\n\n### ãƒ¡ãƒªãƒƒãƒˆ2ï¼šCSVã‚ˆã‚Šèª­ã¿è¾¼ã¿ãŒç°¡å˜\n\n`write_csv()`ãƒ»`write_parquet()` ã§ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãè¾¼ã‚ã‚‹ã®ã¨åŒæ§˜ã«ï¼Œ**`read_csv()`ãƒ»`read_parquet()` ã§CSVãƒ»Parquetãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€**ã“ã¨ãŒã§ãã¾ã™ï¼\n\n**CSV**ã¯ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ã§ã‚ã‚‹ãŸã‚ï¼Œ**èª­ã¿è¾¼ã¿æ™‚ã«`col_types`ã§å„åˆ—ã®å‹ã‚’æŒ‡å®šã™ã‚‹å¿…è¦**ãŒã‚ã‚Šã¾ã™ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯è‡ªå‹•ã§å‹ã‚’æ¨æ¸¬ï¼‰ï¼\n\nä¸€æ–¹ï¼Œ**Parquet**ã¯ï¼Œæ›¸ãè¾¼ã¿æ™‚ã«å„åˆ—ã®å‹æƒ…å ±ã‚‚ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ãŸã‚èª­ã¿è¾¼ã¿æ™‚ã«**å‹ã‚’æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã›ã‚“**ï¼\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# CSVã®èª­ã¿è¾¼ã¿\nread_csv(\"who_longer.csv\",\n         col_types = cols(.default = \"c\",\n                          year = \"i\",\n                          count = \"i\"))\n\n# Parquetã®èª­ã¿è¾¼ã¿\nread_parquet(\"who_longer.parquet\")\n```\n:::\n\n\n### ãƒ¡ãƒªãƒƒãƒˆ3ï¼šCSVã‚ˆã‚Šãƒ“ãƒƒã‚°ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ãƒ»é›†è¨ˆã«é©ã—ã¦ã„ã‚‹\n\nCSVã¯ãƒ“ãƒƒã‚°ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«é©ã—ã¦ãŠã‚‰ãšï¼Œã“ã‚Œã¾ã§ã¯ï¼Œãƒ“ãƒƒã‚°ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«ã¯SQLã‚’ç”¨ã„ã‚‹ãªã©ã®ä½¿ã„åˆ†ã‘ãŒå¿…è¦ã§ã—ãŸï¼\n\nRã§ã¯ï¼Œdplyrï¼ˆdbplyrï¼‰ãƒ»DBIãªã©ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§ç°¡å˜ã«SQLãŒä½¿ãˆã¾ã™ãŒï¼Œãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®æ¥ç¶šãƒ»åˆ‡æ–­ãªã©ãŒå¿…è¦ãªSQLã¯ï¼ŒCSVã¨ä½¿ã„å‹æ‰‹ãŒç•°ãªã‚Šï¼Œåˆå­¦è€…ã«ã¨ã£ã¦ã¯ãƒãƒ¼ãƒ‰ãƒ«ãŒã‚ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ï¼\n\nã¾ãŸï¼Œï¼ˆã»ã¨ã‚“ã©ã®ï¼Ÿï¼‰**SQLã¯è¡ŒæŒ‡å‘**ã§ã‚ã‚‹ãŸã‚ï¼Œ**ãƒ‡ãƒ¼ã‚¿ã®è¿½åŠ ãƒ»æ›´æ–°ãƒ»å‰Šé™¤ãªã©ã«é©ã—ã¦ã„ã¾ã™**ãŒï¼Œãƒ‡ãƒ¼ã‚¿åˆ†æã«ç”¨ã„ã‚‰ã‚Œã‚‹**ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ãƒ»é›†è¨ˆã«ã¯åˆ—æŒ‡å‘ã§ã‚ã‚‹Parquetã®ã»ã†ãŒé©ã—ã¦ã„ã‚‹**ã¨æ€ã‚ã‚Œã¾ã™ï¼\n\nCSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”¨ã„ã¦ãƒ“ãƒƒã‚°ãƒ‡ãƒ¼ã‚¿ã‚’é›†è¨ˆã™ã‚‹å ´åˆã«ã¯ï¼Œä¸€åº¦ï¼Œå…¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ¡ãƒ¢ãƒªã«ç§»ã™å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼ãã®ãŸã‚ï¼Œãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã§ãƒ¡ãƒ¢ãƒªãŒé€¼è¿«ã™ã‚‹ãŠãã‚ŒãŒã‚ã‚Šã¾ã™ï¼\n\nParquetã§ã¯ï¼Œ**èª­ã¿è¾¼ã¿æ™‚ã«`as_data_frame = FALSE`**ã¨ã™ã‚‹ã“ã¨ã§ï¼ŒSQLã¨åŒæ§˜ã«**ãƒ¡ãƒ¢ãƒªã«ãƒ‡ãƒ¼ã‚¿ã‚’ç§»ã™ã“ã¨ãªããƒ‡ãƒ¼ã‚¿ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ãƒ»é›†è¨ˆãªã©ãŒå¯èƒ½**ã§ã™ï¼\n\nã“ã“ã§ã¯ï¼Œæ—¥æœ¬ã®å¹´ãƒ»ç—‡ä¾‹åˆ¥ã®æ‚£è€…æ•°ã‚’è¨ˆç®—ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼**dplyrã®`filter()` ãƒ»`group_by()` ãƒ»`summarise()` ãªã©ã‚’ä½¿ã£ã¦åŠ¹ç‡çš„ã«ã‚¯ã‚¨ãƒªã‚’ä½œæˆ**ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼**æœ€å¾Œã«`collect()` ã‚’è¡Œãˆã°ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’å‡ºåŠ›**ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼\n\n\n::: {.cell}\n\n```{.r .cell-code}\nread_parquet(\"who_longer.parquet\",\n             as_data_frame = FALSE) |> \n  filter(country == \"Japan\",\n         !is.na(count)) |> \n  group_by(country, year, diagnosis) |> \n  summarise(count = sum(count),\n            .groups = \"drop\") |> \n  collect()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 33 Ã— 4\n   country  year diagnosis count\n   <chr>   <int> <chr>     <int>\n 1 Japan    1995 sp        14367\n 2 Japan    1996 sp        12867\n 3 Japan    1997 sp        13571\n 4 Japan    1998 sp        11935\n 5 Japan    1999 sp        12909\n 6 Japan    2000 sp        11853\n 7 Japan    2001 sp        11408\n 8 Japan    2002 sp        10807\n 9 Japan    2003 sp        10843\n10 Japan    2004 sp        10471\n# â€¦ with 23 more rows\n```\n:::\n:::\n\n\n### ãƒ¡ãƒªãƒƒãƒˆ4ï¼šè¤‡æ•°ã®ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ãªã‚‹ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’æ‰±ãˆã‚‹\n\nParquetã¯åˆ—æŒ‡å‘ã§ã‚ã‚‹ãŸã‚ï¼Œè¡ŒæŒ‡å‘ã§ã‚ã‚‹SQLã¨é•ã„ï¼Œãƒ‡ãƒ¼ã‚¿ã®è¿½åŠ ãƒ»æ›´æ–°ãƒ»å‰Šé™¤ãªã©ã«é©ã—ã¦ã„ã¾ã›ã‚“ï¼ã—ã‹ã—ï¼Œ**Parquetã§ã¯ï¼Œè¤‡æ•°ã®ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ãªã‚‹ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®èª­ã¿è¾¼ã¿ãŒç°¡å˜ã«è¡Œãˆã‚‹**ãŸã‚ï¼Œã“ã®ã‚ˆã†ãªãƒ‡ãƒ¡ãƒªãƒƒãƒˆã‚’ç°¡å˜ã«è§£æ±ºã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼\n\nã“ã“ã§ã¯ï¼Œ`who_longer`ã‚’å¹´é½¢éšç´šåˆ¥ã«åˆ†å‰²ã—ãŸParquetãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ ¼ç´ã—ãŸ`\"who_longer_byage\"` ãƒ•ã‚©ãƒ«ãƒ€ã‚’ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®ã‚µãƒ³ãƒ—ãƒ«ã¨ã—ã¦ç”¨ã„ã¾ã—ã‚‡ã†ï¼\n\n**`open_dataset(\"who_longer_byage\")`** ã¨ã™ã‚‹ã“ã¨ã§ï¼Œè¤‡æ•°ã®Parquetãƒ•ã‚¡ã‚¤ãƒ«ã‚’å«ã‚€ã«ã‚‚ã‹ã‹ã‚ã‚‰ãšï¼Œã•ãã»ã©ã¨åŒæ§˜ã®**ãƒ‡ãƒ¼ã‚¿é›†è¨ˆã‚’ç°¡å˜ã«è¡Œã†ã“ã¨ãŒã§ãã¾ã™**ï¼\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\ndir_create(\"who_longer_byage\")\nwho_longer |> \n  group_by(age) |> \n  group_walk(~ .x |> \n               write_parquet(str_glue(\"who_longer_byage/who_longer_{.y$age}.parquet\")),\n  .keep = TRUE)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nopen_dataset(\"who_longer_byage\") |> \n  filter(country == \"Japan\",\n         !is.na(count)) |> \n  group_by(country, year, diagnosis) |> \n  summarise(count = sum(count),\n            .groups = \"drop\") |> \n  collect()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 33 Ã— 4\n   country  year diagnosis count\n   <chr>   <int> <chr>     <int>\n 1 Japan    1995 sp        14367\n 2 Japan    1996 sp        12867\n 3 Japan    1997 sp        13571\n 4 Japan    1998 sp        11935\n 5 Japan    1999 sp        12909\n 6 Japan    2000 sp        11853\n 7 Japan    2001 sp        11408\n 8 Japan    2002 sp        10807\n 9 Japan    2003 sp        10843\n10 Japan    2004 sp        10471\n# â€¦ with 23 more rows\n```\n:::\n:::\n\n\n### ãƒ¡ãƒªãƒƒãƒˆ5ï¼šRãƒ»Pythoné–“ã§ã®ãƒ‡ãƒ¼ã‚¿ã®ã‚„ã‚Šå–ã‚Šã«é©ã—ã¦ã„ã‚‹\n\nPythonã®pandasãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¯Parquetã®èª­ã¿æ›¸ãã«å¯¾å¿œã—ã¦ã„ã‚‹ãŸã‚ï¼ŒParquetã¯ï¼ŒRãƒ»Pythoné–“ã§ã®ãƒ‡ãƒ¼ã‚¿ã®ã‚„ã‚Šå–ã‚Šã«ã‚‚é©ã—ã¦ã„ã¾ã™ï¼\n\nRã§ä½œæˆã—ãŸ`'who_longer.parquet'` ã‚’pandasã§èª­ã¿è¾¼ã‚“ã§ã¿ã¾ã—ã‚‡ã†ï¼\n\n\n::: {.cell}\n\n```{.python .cell-code}\nimport pandas as pd\n\npd.read_parquet('who_longer.parquet')\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n            country iso2 iso3  year diagnosis gender   age   count\n0       Afghanistan   AF  AFG  1980        sp      m   014     NaN\n1       Afghanistan   AF  AFG  1980        sp      m  1524     NaN\n2       Afghanistan   AF  AFG  1980        sp      m  2534     NaN\n3       Afghanistan   AF  AFG  1980        sp      m  3544     NaN\n4       Afghanistan   AF  AFG  1980        sp      m  4554     NaN\n...             ...  ...  ...   ...       ...    ...   ...     ...\n405435     Zimbabwe   ZW  ZWE  2013       rel      f  2534  4649.0\n405436     Zimbabwe   ZW  ZWE  2013       rel      f  3544  3526.0\n405437     Zimbabwe   ZW  ZWE  2013       rel      f  4554  1453.0\n405438     Zimbabwe   ZW  ZWE  2013       rel      f  5564   811.0\n405439     Zimbabwe   ZW  ZWE  2013       rel      f    65   725.0\n\n[405440 rows x 8 columns]\n```\n:::\n:::\n\n\n## ã¾ã¨ã‚\n\nã“ã“ã¾ã§ï¼ŒRãƒ»Pythonã§åˆ©ç”¨å¯èƒ½ãªParquetã®ãƒ¡ãƒªãƒƒãƒˆã‚’ç´¹ä»‹ã—ã¾ã—ãŸï¼Parquetã¯ï¼Œè¿‘å¹´ï¼Œãƒ‡ãƒ¼ã‚¿åˆ†æã§æ™®åŠã—ã¦ã„ã‚‹tidy dataã®ä¿å­˜ãƒ»é›†è¨ˆã«é©ã—ã¦ã„ã¾ã™ï¼\n\nã¾ãŸï¼Œæœ€è¿‘ã§ã¯ï¼Œåœ°ç†ãƒ‡ãƒ¼ã‚¿ã‚’æ‰±ãˆã‚‹sfãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ãƒ‡ãƒ¼ã‚¿ã‚’parquetã¨ã—ã¦ä¿å­˜ã§ãã‚‹[sfarrow](https://wcjochem.github.io/sfarrow/)ãªã©ã‚‚ç™»å ´ã—ã¦ã„ã¾ã™ï¼\n\nCSVã®ä»£ã‚ã‚Šã«Parquetã‚’ç”¨ã„ã‚‹ã“ã¨ã§ãƒ‡ãƒ¼ã‚¿åˆ†æãŒã•ã‚‰ã«ç°¡å˜ã«ãªã‚‹ã“ã¨ãŒæœŸå¾…ã•ã‚Œã¾ã™ï¼\n\n\n\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}