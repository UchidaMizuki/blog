{
  "hash": "f6db458269f1cf5e63967719aec63a53",
  "result": {
    "markdown": "---\ntitle: \"ğŸ—¾CSVã®ä»£ã‚ã‚Šã«Parquetã‚’ä½¿ã£ã¦ã¿ã‚ˆã†ï¼\"\nlang: ja\ndate: \"2022-06-07\"\ncategories: [parquet, arrow, R, Japanese]\nfig-align: center\ndraft: true\n---\n\n\nãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ï¼ˆData Framesï¼‰ã¯ï¼Œãƒ‡ãƒ¼ã‚¿åˆ†æã«ãŠã„ã¦æœ€ã‚‚åŸºæœ¬çš„ãªãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®1ã¤ã§ã™ï¼\n\nRã®[tibble](https://tibble.tidyverse.org)ãƒ»[dplyr](https://dplyr.tidyverse.org)ã‚„Pythonã®[pandas](https://pandas.pydata.org)ãªã©ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ æ“ä½œã®ãŸã‚ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½¿ãˆã°ï¼Œã“ã‚Œã¾ã§Excelãªã©ã®è¡¨è¨ˆç®—ã‚½ãƒ•ãƒˆã§è¡Œã£ã¦ã„ãŸãƒ‡ãƒ¼ã‚¿åˆ†æã‚’ã•ã‚‰ã«åŠ¹ç‡çš„ã«è¡Œã†ã“ã¨ãŒã§ãã¾ã™ï¼\n\nã“ã®ã‚ˆã†ã«ãƒ‡ãƒ¼ã‚¿åˆ†æã®ãŸã‚ã®ãƒ„ãƒ¼ãƒ«ãŒå……å®Ÿã™ã‚‹ä¸€æ–¹ã§ï¼Œãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã®ä¿å­˜ã«ã¯Excelãªã©ã¨ã®äº’æ›æ€§ãŒé«˜ã„CSVãŒæœªã ã«åºƒãä½¿ã‚ã‚Œã¦ã„ã¾ã™ï¼\n\nCSVã¯ï¼Œãƒ†ã‚­ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã§ã‚ã‚‹ãŸã‚ï¼Œæ§˜ã€…ãªã‚½ãƒ•ãƒˆã¨äº’æ›æ€§ãŒã‚ã‚‹ãªã©ã®åˆ©ç‚¹ãŒã‚ã‚Šã¾ã™ãŒï¼Œå¿…ãšã—ã‚‚ãƒ‡ãƒ¼ã‚¿åˆ†æã«é©ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã¨ã¯è¨€ãˆã¾ã›ã‚“ï¼\n\nCSVã®ä»£æ›¿ã¨ã—ã¦æœ‰æœ›ãªãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã«ï¼ŒParquetã¨å‘¼ã°ã‚Œã‚‹ã‚‚ã®ãŒã‚ã‚Šã¾ã™ï¼\n\nä»¥ä¸‹ã§ã¯ï¼ŒCSVã¨Parquetã‚’æ¯”è¼ƒã—ï¼ŒParquetã®ãƒ¡ãƒªãƒƒãƒˆã‚’ç´¹ä»‹ã—ã¾ã™ï¼\n\n## ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ï¼ˆtidy dataã«ã¤ã„ã¦ï¼‰\n\nã“ã“ã§ã¯ï¼ŒRã®arrowãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ç”¨ã„ã¦Parquetã®ä¿å­˜ã‚’è¡Œã£ã¦ã¿ã¾ã™ï¼\n\nã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦ï¼Œtidyrãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§æä¾›ã•ã‚Œã¦ã„ã‚‹`who` ï¼ˆ[ä¸–ç•Œä¿å¥æ©Ÿé–¢ï¼ˆWHOï¼‰çµæ ¸ãƒ‡ãƒ¼ã‚¿](https://www.who.int/teams/global-tuberculosis-programme/data)ï¼‰ã‚’ç”¨ã„ã¾ã™ï¼\n\nãƒ‡ãƒ¼ã‚¿åˆ†æã§ã¯ï¼Œè¿‘å¹´ï¼ŒRã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã‚’ä¸­å¿ƒã«æ•´ç„¶ãƒ‡ãƒ¼ã‚¿ï¼ˆ[tidy data](https://ja.wikipedia.org/wiki/Tidy_data)ï¼‰ã®æ¦‚å¿µãŒæ™®åŠã—ã¦ã„ã¾ã™ï¼`who` ã¯ï¼Œtidy dataã«ãªã£ã¦ã„ãªã„ãŸã‚ï¼Œ[ã“ã¡ã‚‰](https://tidyr.tidyverse.org/articles/pivot.html)ã«å¾“ã£ã¦æ•´ç„¶ãƒ‡ãƒ¼ã‚¿ã§ã‚ã‚‹`who_longer`ã«å¤‰å½¢ã—ã¾ã™ï¼\n\nãƒ‡ãƒ¼ã‚¿åˆ†æã§ã¯ï¼Œ`who` ã‚ˆã‚Š`who_longer` ã®ã»ã†ãŒåˆ†æãŒè¡Œã„ã‚„ã™ã„ä¸€æ–¹ã§ï¼Œè¡Œæ•°ã¯`who`ï¼ˆç´„7,000è¡Œï¼‰ã‚ˆã‚Š`who_longer` ï¼ˆç´„400,000è¡Œï¼‰ã®ã»ã†ãŒç´„50å€å¤šã„ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ï¼ãã®ãŸã‚ï¼Œ`who_longer`ã®ã‚ˆã†ãªãƒ‡ãƒ¼ã‚¿ã‚’ï¼Œãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã§ã‚ã‚‹CSVã§ä¿å­˜ã™ã‚‹ã¨å®¹é‡ãŒå¢—å¤§ã—ã¦ã—ã¾ã„ã¾ã™ï¼\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(arrow)\nlibrary(fs)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\nlevels_gender <- c(\"f\", \"m\")\nlevels_age <- c(\"014\", \"1524\", \"2534\", \"3544\", \"4554\", \"5564\", \"65\")\n\nwho_longer <- who |> \n  pivot_longer(cols = new_sp_m014:newrel_f65,\n               names_to = c(\"diagnosis\", \"gender\", \"age\"), \n               names_pattern = \"new_?(.*)_(.)(.*)\",\n               names_transform = list(gender = ~ .x |> \n                                        readr::parse_factor(levels = levels_gender),\n                                      age = ~ .x |> \n                                        readr::parse_factor(levels = levels_age,\n                                                            ordered = TRUE)),\n               values_to = \"count\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# ãƒ‡ãƒ¼ã‚¿æ•´å½¢å‰\nwho\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 7,240 Ã— 60\n   country  iso2  iso3   year new_sp_m014 new_sp_m1524 new_sp_m2534 new_sp_m3544\n   <chr>    <chr> <chr> <int>       <int>        <int>        <int>        <int>\n 1 Afghaniâ€¦ AF    AFG    1980          NA           NA           NA           NA\n 2 Afghaniâ€¦ AF    AFG    1981          NA           NA           NA           NA\n 3 Afghaniâ€¦ AF    AFG    1982          NA           NA           NA           NA\n 4 Afghaniâ€¦ AF    AFG    1983          NA           NA           NA           NA\n 5 Afghaniâ€¦ AF    AFG    1984          NA           NA           NA           NA\n 6 Afghaniâ€¦ AF    AFG    1985          NA           NA           NA           NA\n 7 Afghaniâ€¦ AF    AFG    1986          NA           NA           NA           NA\n 8 Afghaniâ€¦ AF    AFG    1987          NA           NA           NA           NA\n 9 Afghaniâ€¦ AF    AFG    1988          NA           NA           NA           NA\n10 Afghaniâ€¦ AF    AFG    1989          NA           NA           NA           NA\n# â€¦ with 7,230 more rows, and 52 more variables: new_sp_m4554 <int>,\n#   new_sp_m5564 <int>, new_sp_m65 <int>, new_sp_f014 <int>,\n#   new_sp_f1524 <int>, new_sp_f2534 <int>, new_sp_f3544 <int>,\n#   new_sp_f4554 <int>, new_sp_f5564 <int>, new_sp_f65 <int>,\n#   new_sn_m014 <int>, new_sn_m1524 <int>, new_sn_m2534 <int>,\n#   new_sn_m3544 <int>, new_sn_m4554 <int>, new_sn_m5564 <int>,\n#   new_sn_m65 <int>, new_sn_f014 <int>, new_sn_f1524 <int>, â€¦\n```\n:::\n\n```{.r .cell-code}\n# ãƒ‡ãƒ¼ã‚¿æ•´å½¢å¾Œ\nwho_longer\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 405,440 Ã— 8\n   country     iso2  iso3   year diagnosis gender age   count\n   <chr>       <chr> <chr> <int> <chr>     <fct>  <ord> <int>\n 1 Afghanistan AF    AFG    1980 sp        m      014      NA\n 2 Afghanistan AF    AFG    1980 sp        m      1524     NA\n 3 Afghanistan AF    AFG    1980 sp        m      2534     NA\n 4 Afghanistan AF    AFG    1980 sp        m      3544     NA\n 5 Afghanistan AF    AFG    1980 sp        m      4554     NA\n 6 Afghanistan AF    AFG    1980 sp        m      5564     NA\n 7 Afghanistan AF    AFG    1980 sp        m      65       NA\n 8 Afghanistan AF    AFG    1980 sp        f      014      NA\n 9 Afghanistan AF    AFG    1980 sp        f      1524     NA\n10 Afghanistan AF    AFG    1980 sp        f      2534     NA\n# â€¦ with 405,430 more rows\n```\n:::\n:::\n\n\n## Parquetã®ä¿å­˜æ–¹æ³•\n\n`write_csv()` ã§CSVã‚’ä¿å­˜ã§ãã‚‹ã¨ã®åŒæ§˜ã«`write_parquet()` ã§ç°¡å˜ã«ï¼ŒParquetã‚’ä¿å­˜ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼tidy dataã§ã‚ã‚‹`who_longer`ã‚’ä¿å­˜ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# CSVã‚’ä¿å­˜\nwrite_csv(who_longer, \"who_longer.csv\")\n\n# Parquetã‚’ä¿å­˜\nwrite_parquet(who_longer, \"who_longer.parquet\")\n```\n:::\n\n\n## Parquetã®ãƒ¡ãƒªãƒƒãƒˆ\n\n### ãƒ¡ãƒªãƒƒãƒˆ1: CSVã¨æ¯”ã¹ã¦ãƒ•ã‚¡ã‚¤ãƒ«å®¹é‡ãŒè»½ã„\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# CSV\nfile_size(\"who_longer.csv\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n14.1M\n```\n:::\n\n```{.r .cell-code}\n# Parquet\nfile_size(\"who_longer.parquet\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n154K\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# file_size_csv <- file_size(\"who_longer.csv\")\n# file_size_parquet <- file_size(\"who_longer.parquet\")\n# \n# file_size_csv / file_size_parquet\n# \n# dir_create(\"who_longer\")\n# who_longer_splitted <- who_longer |> \n#   group_by(age) |> \n#   group_walk(~ .x |> \n#                write_parquet(str_glue(\"who_longer/who_longer_{.y$age}.parquet\")),\n#   .keep = TRUE)\n# \n# read_parquet(\"who_longer.parquet\")\n# \n# open_dataset(\"who_longer\") |> \n#   collect()\n```\n:::\n\n::: {.cell}\n\n```{.python .cell-code}\n# import pandas as pd\n# \n# pd.read_parquet('who_longer.parquet')\n```\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}