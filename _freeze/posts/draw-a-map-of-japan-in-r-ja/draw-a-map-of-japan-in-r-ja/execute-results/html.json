{
  "hash": "fcfb149a0152bc7144f0fbc5071d8e18",
  "result": {
    "markdown": "---\ntitle: \"ğŸ—¾Rã§æ—¥æœ¬åœ°å›³ã‚’æã„ã¦ã¿ã‚ˆã†\"\nlang: ja\ndate: \"2022-06-11\"\ncategories: [ggplot2, sf, jpmap, R, Japanese]\nfig-align: center\nout-width: 100%\nimage: foreigner_ratio_2015.png\n---\n\n\nRã§ã¯ï¼Œggplot2ãªã©ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’åˆ©ç”¨ã™ã‚‹ã ã‘ã§ï¼Œãã‚Œã„ãªæ—¥æœ¬åœ°å›³ï¼ˆéƒ½é“åºœçœŒåˆ¥ï¼‰ã‚’æãã“ã¨ãŒã§ãã¾ã™ï¼\n\nã“ã“ã§ã¯ï¼Œæ—¥æœ¬åœ°å›³ã‚’ggplot2ã§æç”»ã™ã‚‹æ–¹æ³•ã‚’ã„ãã¤ã‹ç´¹ä»‹ã—ã¾ã™ï¼\n\n## åœ°å›³æç”»ç”¨ã®ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿\n\nã“ã“ã§ã¯ï¼Œ[ã“ã¡ã‚‰](https://www.e-stat.go.jp/dbview?sid=0000010201)ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã‚‹ç¤¾ä¼šãƒ»äººå£çµ±è¨ˆä½“ç³»ã®2015å¹´ã®éƒ½é“åºœçœŒåˆ¥å¤–å›½äººäººå£æ¯”ç‡ãƒ‡ãƒ¼ã‚¿ï¼ˆ10ä¸‡äººã‚ãŸã‚Šå¤–å›½äººäººå£ï¼‰ã‚’åœ°å›³æç”»ç”¨ã®ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¾ã—ãŸï¼\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\n```\n:::\n\n\nãƒ‡ãƒ¼ã‚¿ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\nlibrary(jpstat)\nlibrary(arrow)\n\nappId <- keyring::key_get(\"estat-api\")\nforeigner_ratio_2015 <- estat(appId, \"https://www.e-stat.go.jp/en/dbview?sid=0000010201\",\n                              lang = \"E\")\nforeigner_ratio_2015 <- foreigner_ratio_2015 |> \n  activate(tab) |> \n  select() |> \n  \n  activate(cat01) |> \n  # Ratio of population of foreigners (per 100,000 persons)\n  filter(code == \"#A01601\") |> \n  select() |> \n  \n  activate(area) |> \n  filter(name != \"All Japan\") |> \n  select(code, name) |> \n  rekey(\"pref\") |> \n  \n  activate(time) |> \n  filter(name == \"2015\") |> \n  select()\nforeigner_ratio_2015 <- foreigner_ratio_2015 |> \n  collect(\"foreigners_per_100K\")\n\nwrite_parquet(foreigner_ratio_2015, \"foreigner_ratio_2015.parquet\")\n```\n:::\n\n\nãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\nlibrary(arrow)\n\nforeigner_ratio_2015 <- read_parquet(\"foreigner_ratio_2015.parquet\") |> \n  mutate(pref_code = pref_code |> \n           str_extract(\"^\\\\d{2}\") |> \n           parse_integer(),\n         \n         pref_name = pref_name |> \n           str_remove(\"-.+$\"),\n         pref_name = case_when(pref_name == \"Gumma\" ~ \"Gunma\",\n                               TRUE ~ pref_name),\n         \n         foreigner_ratio = parse_number(foreigners_per_100K) / 1e5,\n         .keep = \"unused\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nforeigner_ratio_2015\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 47 Ã— 3\n   pref_code pref_name foreigner_ratio\n       <int> <chr>               <dbl>\n 1         1 Hokkaido          0.00403\n 2         2 Aomori            0.00264\n 3         3 Iwate             0.00392\n 4         4 Miyagi            0.00599\n 5         5 Akita             0.00285\n 6         6 Yamagata          0.00490\n 7         7 Fukushima         0.00456\n 8         8 Ibaraki           0.0142 \n 9         9 Tochigi           0.0134 \n10        10 Gunma             0.0188 \n# â€¦ with 37 more rows\n```\n:::\n:::\n\n\n## `geom_map()` ã‚’ä½¿ã£ã¦æ—¥æœ¬åœ°å›³ã‚’æã\n\nggplot2ã§ã¯ï¼Œ`map_data()` ã‚„`geom_map()` ã‚’ä½¿ã†ã“ã¨ã§ï¼Œä¸–ç•Œã®å›½ã€…ã‚’æç”»ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼ã“ã‚Œã«ã¯ï¼Œmapsãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’äºˆã‚ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼ã¾ãŸï¼Œæ—¥æœ¬åœ°å›³ã‚’åˆ©ç”¨ã™ã‚‹ã«ã¯ï¼Œmapsãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã«åŠ ãˆã¦ï¼Œmapdataãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒå¿…è¦ã«ãªã‚Šã¾ã™ï¼\n\n`map_data(\"japan\")` ã¨ã™ã‚‹ã“ã¨ã§ï¼Œmapsãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®åœ°å›³ãƒ‡ãƒ¼ã‚¿ãŒãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã«å¤‰æ›ã•ã‚Œã¾ã™ï¼ã“ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã®`region` åˆ—ãŒéƒ½é“åºœçœŒã®IDã¨ãªã‚‹ãŸã‚ï¼Œ`aes(map_id = region)`ã‚’è¨­å®šã—ãŸä¸Šã§ï¼Œ`geom_map()` ã™ã‚‹ã“ã¨ã§ï¼Œæç”»ã—ãŸã„ãƒ‡ãƒ¼ã‚¿ã®`region` åˆ—ã¨éƒ½é“åºœçœŒã‚¸ã‚ªãƒ¡ãƒˆãƒªãŒãƒªãƒ³ã‚¯ã—ã¾ã™ï¼\n\nãŸã ã—ï¼Œ`map_data(\"japan\")` ã¯ï¼Œä»¥ä¸‹ã®ç‚¹ã«æ³¨æ„ãŒå¿…è¦ã§ã™ï¼\n\n-   `region` åˆ—ã¯ã™ã¹ã¦ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆè¡¨è¨˜ã§ã‚ã‚‹\n\n-   ä»–ã®éƒ½é“åºœçœŒã¨é•ã„ï¼Œå¥ˆè‰¯çœŒã ã‘ãŒãŒ`NARA` ã¨å¤§æ–‡å­—è¡¨è¨˜ã«ãªã£ã¦ã„ã‚‹ãªã©ï¼Œå…ƒãƒ‡ãƒ¼ã‚¿ã«å•é¡Œã‚ã‚Š\n\n    -   ã“ã“ã§ã¯ï¼Œ`str_to_title()`ã§ä¿®æ­£\n\nã¾ãŸï¼Œæ—¥æœ¬åœ°å›³å…¨ä½“ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã«ã¯ï¼Œ`expand_limits()` ãªã©ã§è»¸ã‚’è¨­å®šã™ã‚‹ã“ã¨å¿…è¦ã«ãªã‚Šã¾ã™ï¼\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# pak::pak(\"maps\")\n# pak::pak(\"mapdata\")\nlibrary(tidyverse)\nlibrary(mapdata)\n\nmap_data_japan <- map_data(\"japan\") |> \n  as_tibble() |> \n  mutate(region = str_to_title(region))\nmap_data_japan\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 46,975 Ã— 6\n    long   lat group order region   subregion\n   <dbl> <dbl> <dbl> <int> <chr>    <chr>    \n 1  140.  42.3     1     1 Hokkaido <NA>     \n 2  140.  42.3     1     2 Hokkaido <NA>     \n 3  140.  42.3     1     3 Hokkaido <NA>     \n 4  140.  42.3     1     4 Hokkaido <NA>     \n 5  140.  42.3     1     5 Hokkaido <NA>     \n 6  140.  42.3     1     6 Hokkaido <NA>     \n 7  140.  42.3     1     7 Hokkaido <NA>     \n 8  140.  42.3     1     8 Hokkaido <NA>     \n 9  140.  42.3     1     9 Hokkaido <NA>     \n10  140.  42.3     1    10 Hokkaido <NA>     \n# â€¦ with 46,965 more rows\n```\n:::\n\n```{.r .cell-code}\nggplot(foreigner_ratio_2015 |> \n         rename(region = pref_name),\n       aes(map_id = region)) +\n  geom_map(aes(fill = foreigner_ratio),\n           map = map_data_japan) +\n  expand_limits(x = map_data_japan$long,\n                y = map_data_japan$lat) +\n  scale_fill_viridis_c(\"å¤–å›½äººäººå£æ¯”ç‡\",\n                       limits = c(0, 0.03),\n                       labels = scales::label_percent(),\n                       option = \"turbo\")\n```\n\n::: {.cell-output-display}\n![](draw-a-map-of-japan-in-r-ja_files/figure-html/geom_map-1.png){width=672}\n:::\n:::\n\n\n## sfãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½¿ã£ã¦æ—¥æœ¬åœ°å›³ã‚’æã\n\næœ€è¿‘ã§ã¯ï¼Œsfãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¸ã‚ªãƒ¡ãƒˆãƒªãŒggplot2ã§ç°¡å˜ã«æç”»ã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ï¼\n\nã¾ãŸï¼Œmapsãƒ»mapdataãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®æä¾›ã™ã‚‹åœ°å›³ãƒ‡ãƒ¼ã‚¿ã¯ï¼Œsfãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®`st_as_sf()` ã§sfã®ã‚¸ã‚ªãƒ¡ãƒˆãƒªãƒ‡ãƒ¼ã‚¿ã«å¤‰æ›ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼\n\næ—¥æœ¬åœ°å›³ãƒ‡ãƒ¼ã‚¿ã‚’sfã«å¤‰æ›ã™ã‚‹ã“ã¨ã§ï¼Œå…ˆã»ã©ã‚ˆã‚Šã‚‚ç›´æ„Ÿçš„ã«åœ°å›³ã‚’æãã“ã¨ãŒã§ãã¾ã™ï¼\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(sf)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nLinking to GEOS 3.9.1, GDAL 3.3.2, PROJ 7.2.1; sf_use_s2() is TRUE\n```\n:::\n\n```{.r .cell-code}\nmap_japan <- maps::map(\"japan\", \n                       plot = FALSE,\n                       fill = TRUE) |> \n  st_as_sf() |> \n  rename(pref_name = ID) |> \n  mutate(pref_name = str_to_title(pref_name))\n\nmap_japan |> \n  left_join(foreigner_ratio_2015,\n            by = \"pref_name\") |> \n  ggplot(aes(fill = foreigner_ratio)) +\n  geom_sf(color = \"transparent\") +\n  scale_fill_viridis_c(\"å¤–å›½äººäººå£æ¯”ç‡\",\n                       limits = c(0, 0.03),\n                       labels = scales::label_percent(),\n                       option = \"turbo\")\n```\n\n::: {.cell-output-display}\n![](draw-a-map-of-japan-in-r-ja_files/figure-html/sf-1.png){width=672}\n:::\n:::\n\n\n## ã‚‚ã£ã¨ç°¡å˜ã«æ—¥æœ¬åœ°å›³ã‚’æã\n\n[jpmap](https://github.com/UchidaMizuki/jpmap)ã¯ï¼Œggplot2ã«ã‚ˆã‚‹æ—¥æœ¬åœ°å›³ã®æç”»ã‚’ã‚ˆã‚Šç°¡å˜ã«ã™ã‚‹ãŸã‚ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§ã™ï¼\n\njpmapã¯ï¼Œä»¥ä¸‹ã®2ã¤ã®æ©Ÿèƒ½ã‚’æŒã¡ã¾ã™ï¼\n\n-   æ—¥æœ¬èªã®éƒ½é“åºœçœŒåã‚„éƒ½é“åºœçœŒã‚³ãƒ¼ãƒ‰ãŒå«ã‚€éƒ½é“åºœçœŒãƒ‡ãƒ¼ã‚¿ã‚’æä¾›ï¼ˆ`jpmap::prefecture`ï¼‰\n\n-   ç‰çƒè«¸å³¶ãƒ»å°ç¬ åŸè«¸å³¶ã‚’å†é…ç½®ã—ãŸãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’å¯èƒ½ã«ï¼ˆ`jpmap::layout_islands()`ï¼‰\n\n`jpmap::layout_islands()` ã§åœ°å›³ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ã§ï¼Œéƒ½é“åºœçœŒã”ã¨ã®å‚¾å‘ãŒã‚ˆã‚Šã‚ã‹ã‚Šã‚„ã™ããªã‚Šã¾ã™ï¼\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# pak::pak(\"UchidaMizuki/jpmap\")\njpmap::prefecture\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nSimple feature collection with 47 features and 3 fields\nGeometry type: MULTIPOLYGON\nDimension:     XY\nBounding box:  xmin: 122.935 ymin: 24.0433 xmax: 148.8678 ymax: 45.5386\nGeodetic CRS:  WGS 84\n# A tibble: 47 Ã— 4\n   pref_code pref_name pref_name_ja                                         geom\n       <int> <chr>     <chr>                                  <MULTIPOLYGON [Â°]>\n 1         1 Hokkaido  åŒ—æµ·é“       (((145.2498 43.6126, 145.1639 43.6385, 145.â€¦\n 2         2 Aomori    é’æ£®çœŒ       (((139.8692 40.5863, 139.8745 40.5802, 139.â€¦\n 3         3 Iwate     å²©æ‰‹çœŒ       (((140.6595 39.3864, 140.6785 39.3829, 140.â€¦\n 4         4 Miyagi    å®®åŸçœŒ       (((141.0347 38.2792, 141.0384 38.2868, 141.â€¦\n 5         5 Akita     ç§‹ç”°çœŒ       (((139.8725 39.1156, 139.9496 39.1106, 139.â€¦\n 6         6 Yamagata  å±±å½¢çœŒ       (((139.5506 38.5498, 139.5527 38.5508, 139.â€¦\n 7         7 Fukushima ç¦å³¶çœŒ       (((139.208 37.1909, 139.2164 37.1969, 139.2â€¦\n 8         8 Ibaraki   èŒ¨åŸçœŒ       (((139.6911 36.1965, 139.6988 36.1541, 139.â€¦\n 9         9 Tochigi   æ ƒæœ¨çœŒ       (((139.3358 36.6239, 139.3489 36.6227, 139.â€¦\n10        10 Gunma     ç¾¤é¦¬çœŒ       (((138.4448 36.4195, 138.4606 36.4156, 138.â€¦\n# â€¦ with 37 more rows\n```\n:::\n\n```{.r .cell-code}\nplot <- jpmap::prefecture |> \n  left_join(foreigner_ratio_2015,\n            by = c(\"pref_code\", \"pref_name\")) |> \n  ggplot(aes(fill = foreigner_ratio)) +\n  geom_sf(color = \"transparent\") +\n  scale_fill_viridis_c(\"å¤–å›½äººäººå£æ¯”ç‡\",\n                       limits = c(0, 0.03),\n                       labels = scales::label_percent(),\n                       option = \"turbo\")\n\njpmap::layout_islands(plot,\n                      ogasawara = FALSE)\n```\n\n::: {.cell-output-display}\n![](draw-a-map-of-japan-in-r-ja_files/figure-html/jpmap-1.png){width=672}\n:::\n:::\n\n\n\n\n## ã¾ã¨ã‚ï¼ˆåœ°å›³ã‹ã‚‰ã‚ã‹ã£ãŸã“ã¨ï¼‰\n\n2015å¹´ã®éƒ½é“åºœçœŒåˆ¥å¤–å›½äººäººå£æ¯”ç‡ã«é–¢ã™ã‚‹æ—¥æœ¬åœ°å›³ã‹ã‚‰ä»¥ä¸‹ã®ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸï¼\n\n-   2015å¹´ã§ã¯**ã©ã®éƒ½é“åºœçœŒã§ã‚‚å¤–å›½äººäººå£æ¯”ç‡ãŒ3ï¼…ä»¥ä¸‹**ã§ã‚ã‚‹\n\n-   **æ±äº¬éƒ½**ã¯å¤–å›½äººäººå£æ¯”ç‡ãŒæœ€ã‚‚å¤šãï¼Œ**æ„›çŸ¥çœŒ**ã‚„**ç¾¤é¦¬çœŒ**ãªã©ã‚‚å¤–å›½äººå£æ¯”ç‡ãŒé«˜ã„ï¼\n\nã“ã“ã¾ã§ï¼Œggplot2ãªã©ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’æ´»ç”¨ã—ãŸæ—¥æœ¬åœ°å›³ã®æç”»ã‚’è©¦ã—ã¦ã¿ã¾ã—ãŸï¼\n\nãã®çµæœï¼ŒRã‚’ä½¿ãˆã°ï¼Œè‡ªå‰ã§ãƒ‡ãƒ¼ã‚¿ã‚’æ•´å‚™ã—ãªãã¦ã‚‚ï¼Œç°¡å˜ã«æ—¥æœ¬åœ°å›³ã‚’æã‘ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸï¼ã¿ãªã•ã‚“ã‚‚ãœã²ï¼Œggplot2ã‚’ä½¿ã£ã¦ï¼Œè‰²ã€…ãªåœ°å›³ã‚’ä½¿ã£ã¦ã¿ã¦ãã ã•ã„ï¼\n",
    "supporting": [
      "draw-a-map-of-japan-in-r-ja_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}