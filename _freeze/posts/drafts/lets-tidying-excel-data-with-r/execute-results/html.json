{
  "hash": "cc0fa67db2cdea0368202ff068b0970d",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"RでExcelデータを整形するためのTips\"\nlang: ja\ncategories: [Japanese]\ndraft: true\nformat:\n  html:\n    df-print: paged\n---\n\n\n-   <https://www.e-stat.go.jp/stat-search/files?page=1&layout=datalist&toukei=00200521&tstat=000001011777&cycle=0&tclass1=000001011778&tclass2val=0>\n-   FIXME: 元データに列の重複の問題あり\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(fs)\nlibrary(readxl)\n```\n:::\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nfile <- \"lets-tidying-excel-data-with-r/population_by_year_sex_age_class.xlsx\"\nsheet <- \"da03\"\n\ndata_col_names <- read_excel(file,\n                             sheet = sheet,\n                             skip = 10,\n                             n_max = 5,\n                             col_names = FALSE,\n                             col_types = \"text\",\n                             .name_repair = \"minimal\") |> \n  t() |> \n  as_tibble(.name_repair = ~c(\"year\", \"value_type\", \"sex\", \"\", \"value_unit\")) |> \n  select(year, value_type, sex, value_unit)\nhead(data_col_names)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"year\"],\"name\":[1],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"value_type\"],\"name\":[2],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"sex\"],\"name\":[3],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"value_unit\"],\"name\":[4],\"type\":[\"chr\"],\"align\":[\"left\"]}],\"data\":[{\"1\":\"地域\",\"2\":\"NA\",\"3\":\"NA\",\"4\":\"NA\"},{\"1\":\"年齢（5歳階級）\",\"2\":\"NA\",\"3\":\"NA\",\"4\":\"NA\"},{\"1\":\"1920年\",\"2\":\"人口\",\"3\":\"総数\",\"4\":\"（人）\"},{\"1\":\"大正9年\",\"2\":\"NA\",\"3\":\"男\",\"4\":\"（人）\"},{\"1\":\"NA\",\"2\":\"NA\",\"3\":\"女\",\"4\":\"（人）\"},{\"1\":\"NA\",\"2\":\"年齢，男女別割合\",\"3\":\"総数\",\"4\":\"（％）\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ncol_names <- data_col_names |> \n  mutate(year = year |> \n           \n           # 西暦の年数のみを抽出\n           str_extract(\"^\\\\d+(?=年$)\") |> \n           as.integer(),\n         value_unit = if_else(value_unit == \"-\",\n                              \"\",\n                              value_unit)) |> \n  \n  # 西暦年とvalue_typeのNAを埋める\n  fill(year, value_type) |> \n  \n  drop_na(year) |> \n  unite(\"value_type\", value_type, value_unit,\n        sep = \"\") |> \n  unite(\"col_name\", year, sex, value_type,\n        sep = \"/\") |> \n  pull(col_name)\ncol_names <- c(\"region\", \"age_class\", col_names)\n\nhead(col_names, \n     n = 9)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"region\"                           \"age_class\"                       \n[3] \"1920/総数/人口（人）\"             \"1920/男/人口（人）\"              \n[5] \"1920/女/人口（人）\"               \"1920/総数/年齢，男女別割合（％）\"\n[7] \"1920/男/年齢，男女別割合（％）\"   \"1920/女/年齢，男女別割合（％）\"  \n[9] \"1920/NA/人口性比\"                \n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndata <- read_excel(file,\n                   sheet = sheet,\n                   skip = 16,\n                   col_names = col_names,\n                   col_types = \"text\",\n                   .name_repair = \"minimal\") |>\n  \n  select(all_of(vctrs::vec_unique_loc(col_names))) |>\n  \n  pivot_longer(!c(region, age_class),\n               names_to = c(\"year\", \"sex\", \".value\"),\n               names_sep = \"/\",\n               names_transform = list(sex = \\(x) x |> \n                                        na_if(\"NA\"))) |>   \n  mutate(across(c(`人口（人）`, `年齢，男女別割合（％）`, 人口性比),\n                \\(x) {\n                  parse_number(x, \n                               na = \"-\")\n                }))\nhead(data)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"region\"],\"name\":[1],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"age_class\"],\"name\":[2],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"year\"],\"name\":[3],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"sex\"],\"name\":[4],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"人口（人）\"],\"name\":[5],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"年齢，男女別割合（％）\"],\"name\":[6],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"人口性比\"],\"name\":[7],\"type\":[\"dbl\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"01000_北海道\",\"2\":\"0～4歳\",\"3\":\"1920\",\"4\":\"総数\",\"5\":\"376676\",\"6\":\"15.966375\",\"7\":\"NA\"},{\"1\":\"01000_北海道\",\"2\":\"0～4歳\",\"3\":\"1920\",\"4\":\"男\",\"5\":\"190044\",\"6\":\"8.055501\",\"7\":\"NA\"},{\"1\":\"01000_北海道\",\"2\":\"0～4歳\",\"3\":\"1920\",\"4\":\"女\",\"5\":\"186632\",\"6\":\"7.910874\",\"7\":\"NA\"},{\"1\":\"01000_北海道\",\"2\":\"0～4歳\",\"3\":\"1920\",\"4\":\"NA\",\"5\":\"NA\",\"6\":\"NA\",\"7\":\"101.8282\"},{\"1\":\"01000_北海道\",\"2\":\"0～4歳\",\"3\":\"1925\",\"4\":\"総数\",\"5\":\"405607\",\"6\":\"16.232857\",\"7\":\"NA\"},{\"1\":\"01000_北海道\",\"2\":\"0～4歳\",\"3\":\"1925\",\"4\":\"男\",\"5\":\"204576\",\"6\":\"8.187366\",\"7\":\"NA\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n\n```{.r .cell-code}\ndata_population <- data |> \n  drop_na(sex) |> \n  select(!人口性比)\nhead(data_population)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"region\"],\"name\":[1],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"age_class\"],\"name\":[2],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"year\"],\"name\":[3],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"sex\"],\"name\":[4],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"人口（人）\"],\"name\":[5],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"年齢，男女別割合（％）\"],\"name\":[6],\"type\":[\"dbl\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"01000_北海道\",\"2\":\"0～4歳\",\"3\":\"1920\",\"4\":\"総数\",\"5\":\"376676\",\"6\":\"15.966375\"},{\"1\":\"01000_北海道\",\"2\":\"0～4歳\",\"3\":\"1920\",\"4\":\"男\",\"5\":\"190044\",\"6\":\"8.055501\"},{\"1\":\"01000_北海道\",\"2\":\"0～4歳\",\"3\":\"1920\",\"4\":\"女\",\"5\":\"186632\",\"6\":\"7.910874\"},{\"1\":\"01000_北海道\",\"2\":\"0～4歳\",\"3\":\"1925\",\"4\":\"総数\",\"5\":\"405607\",\"6\":\"16.232857\"},{\"1\":\"01000_北海道\",\"2\":\"0～4歳\",\"3\":\"1925\",\"4\":\"男\",\"5\":\"204576\",\"6\":\"8.187366\"},{\"1\":\"01000_北海道\",\"2\":\"0～4歳\",\"3\":\"1925\",\"4\":\"女\",\"5\":\"201031\",\"6\":\"8.045491\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n\n```{.r .cell-code}\ndata_sex_ratio <- data |> \n  filter(is.na(sex)) |> \n  select(!c(sex, `人口（人）`, `年齢，男女別割合（％）`))\nhead(data_sex_ratio)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"region\"],\"name\":[1],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"age_class\"],\"name\":[2],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"year\"],\"name\":[3],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"人口性比\"],\"name\":[4],\"type\":[\"dbl\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"01000_北海道\",\"2\":\"0～4歳\",\"3\":\"1920\",\"4\":\"101.8282\"},{\"1\":\"01000_北海道\",\"2\":\"0～4歳\",\"3\":\"1925\",\"4\":\"101.7634\"},{\"1\":\"01000_北海道\",\"2\":\"0～4歳\",\"3\":\"1930\",\"4\":\"101.6482\"},{\"1\":\"01000_北海道\",\"2\":\"0～4歳\",\"3\":\"1935\",\"4\":\"102.5007\"},{\"1\":\"01000_北海道\",\"2\":\"0～4歳\",\"3\":\"1940\",\"4\":\"102.0206\"},{\"1\":\"01000_北海道\",\"2\":\"0～4歳\",\"3\":\"1945\",\"4\":\"102.9747\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"../../site_libs/pagedtable-1.1/css/pagedtable.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/pagedtable-1.1/js/pagedtable.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}