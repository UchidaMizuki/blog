{
  "hash": "d4e339c52bfd5ddf00d75628aafe431f",
  "result": {
    "markdown": "---\ntitle: \"高齢化のピークはいつか？（市区町村別の簡易推定の試行）\"\nlang: ja\ndraft: true\nmessage: false\nwarning: false\ncode-fold: true\nfig-dpi: 300\n---\n\n::: {.cell}\n\n```{.r .cell-code  code-summary=\"元データのダウンロード・整形\"}\nlibrary(tidyverse)\nlibrary(fs)\nlibrary(readxl)\nlibrary(arrow)\n\ndir_create(\"when-is-the-peak-of-the-aging-population\")\n\nfile_agingrate <- \"when-is-the-peak-of-the-aging-population/agingrate.xls\"\nif (!file_exists(file_agingrate)) {\n  curl::curl_download(\"https://www.ipss.go.jp/pp-shicyoson/j/shicyoson18/2gaiyo_hyo/kekkahyo3_3.xls\",\n                      \"when-is-the-peak-of-the-aging-population/agingrate.xls\") \n}\n\nagingrate <- read_excel(\"when-is-the-peak-of-the-aging-population/agingrate.xls\",\n                        range = \"A4:K1861\") |> \n  rename_with(\\(x) c(\"city_code\", \"city_type\", \"pref_name\", \"city_name\"),\n              1:4) |> \n  pivot_longer(!starts_with(c(\"city\", \"pref\")),\n               names_to = \"year\",\n               names_transform = list(year = parse_number),\n               values_to = \"agingrate\") |> \n  mutate(city_code = city_code |> \n           str_pad(5,\n                   pad = \"0\"),\n         agingrate = agingrate |> \n           units::set_units(`%`) |> \n           units::set_units(1) |> \n           units::drop_units())\n\nwrite_parquet(agingrate, \"when-is-the-peak-of-the-aging-population/agingrate.parquet\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code  code-summary=\"パッケージのロード\"}\nlibrary(tidyverse)\nlibrary(arrow)\nlibrary(leaflet)\nlibrary(htmltools)\n\nlibrary(jpcity)\n\ntheme_set(theme_light())\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code  code-summary=\"データ読込み・傾きの計算\"}\nagingrate <- read_parquet(\"when-is-the-peak-of-the-aging-population/agingrate.parquet\") |> \n  select(city_code, year, agingrate)\n\nagingrate_logit <- agingrate |> \n  mutate(agingrate_logit = gtools::logit(agingrate),\n         .keep = \"unused\")\n\nagingrate_logit_diff <- agingrate_logit |>  \n  mutate(across(c(year, agingrate_logit),\n                list(lag = lag)),\n         .by = city_code) |> \n  drop_na(ends_with(\"lag\")) |> \n  mutate(year = (year + year_lag) / 2,\n         agingrate_logit_diff = (agingrate_logit - agingrate_logit_lag) / (year - year_lag),\n         .keep = \"unused\")\n\nagingrate_logit_diff_diff <- agingrate_logit_diff |> \n  mutate(across(c(year, agingrate_logit_diff),\n                list(lag = lag)),\n         .by = city_code) |> \n  drop_na(ends_with(\"lag\")) |> \n  mutate(year = (year + year_lag) / 2,\n         agingrate_logit_diff_diff = (agingrate_logit_diff - agingrate_logit_diff_lag) / (year - year_lag),\n         .keep = \"unused\")\n```\n:::\n\n::: {.cell tbl-cap='t検定の結果'}\n\n```{.r .cell-code  code-summary=\"t検定\"}\nt_test_agingrate_logit_diff_diff <- agingrate_logit_diff_diff |> \n  infer::t_test(response = agingrate_logit_diff_diff)\nknitr::kable(t_test_agingrate_logit_diff_diff)\n```\n\n::: {.cell-output-display}\n| statistic| t_df| p_value|alternative |   estimate|   lower_ci| upper_ci|\n|---------:|----:|-------:|:-----------|----------:|----------:|--------:|\n| -29.46549| 9284|       0|two.sided   | -0.0023247| -0.0024793| -0.00217|\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code  code-summary=\"ピークの位置と値の算出\"}\nquantile_agingrate <- function(x) {\n  quantile(x, c(0.025, 0.975)) |> \n    bind_rows() |> \n    rename_with(\\(x) c(\"lower\", \"upper\"))\n}\n\nslope_agingrate <- t_test_agingrate_logit_diff_diff$estimate / 2\naxis_agingrate <- agingrate_logit_diff |> \n  mutate(axis = year - agingrate_logit_diff / 2 / slope_agingrate,\n         .keep = \"unused\") |> \n  summarise(across(axis,\n                   list(mean = mean,\n                        sd = sd)),\n            axis |> \n              quantile_agingrate() |> \n              rename_with(\\(x) str_c(\"axis_\", x)),\n            .by = city_code) |> \n  mutate(axis_group = case_when(between(axis_mean, -Inf, 2035) ~ \"--2035\",\n                                between(axis_mean, 2035, 2055) ~ \"2035--2055\",\n                                between(axis_mean, 2055, Inf) ~ \"2055--\") |> \n           factor(c(\"--2035\", \"2035--2055\", \"2055--\")))\nvertex_agingrate <- agingrate_logit |> \n  left_join(axis_agingrate |> \n              select(city_code, axis_mean),\n            by = join_by(city_code)) |> \n  mutate(vertex = agingrate_logit - slope_agingrate * (year - axis_mean) ^ 2,\n         .keep = \"unused\") |> \n  summarise(across(vertex,\n                   list(mean = mean,\n                        sd = sd)),\n            vertex |> \n              quantile_agingrate() |> \n              rename_with(\\(x) str_c(\"vertex_\", x)),\n            .by = city_code) |> \n  mutate(vertex_group = case_when(between(vertex_mean, -Inf, gtools::logit(0.5)) ~ \"--50%\",\n                                  between(vertex_mean, gtools::logit(0.5), gtools::logit(0.75)) ~ \"50%--75%\",\n                                  between(vertex_mean, gtools::logit(0.75), Inf) ~ \"75%--\") |> \n           factor(c(\"--50%\", \"50%--75%\", \"75%--\")))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code  code-summary=\"高齢化率ピーク年のヒストグラム\"}\naxis_agingrate |> \n  ggplot(aes(axis_mean, after_stat(density))) + \n  geom_histogram(binwidth = 1) +\n  geom_vline(xintercept = mean(axis_agingrate$axis_mean),\n             color = \"red\",\n             linetype = \"dashed\") +\n  scale_x_continuous(\"高齢化率がピークとなる年\",\n                     breaks = seq(2020, 2120, 10)) +\n  scale_y_continuous(\"密度\")\n```\n\n::: {.cell-output-display}\n![高齢化率ピーク年のヒストグラム](when-is-the-peak-of-the-aging-population_files/figure-html/高齢化率ピーク年のヒストグラム-1.png){width=2100}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code  code-summary=\"高齢化率ピーク年別の高齢化率の推移\"}\nline_agingrate <- axis_agingrate |> \n  left_join(vertex_agingrate,\n            by = join_by(city_code)) |> \n  summarise(across(c(axis_mean, vertex_mean),\n                   mean),\n            .by = c(axis_group, vertex_group)) |> \n  expand_grid(year = seq(2010, 2080, 1)) |> \n  mutate(agingrate = gtools::inv.logit(slope_agingrate * (year - axis_mean) ^ 2 + vertex_mean)) |> \n  select(!c(axis_mean, vertex_mean))\n\nagingrate |> \n  left_join(axis_agingrate |> \n              select(city_code, axis_group),\n            by = join_by(city_code)) |> \n  left_join(vertex_agingrate |> \n              select(city_code, vertex_group),\n            by = join_by(city_code)) |> \n  ggplot(aes(year, agingrate)) +\n  geom_boxplot(aes(group = cut_width(year, 5))) +\n  geom_line(data = line_agingrate,\n            color = \"red\",\n            linetype = \"dashed\") +\n  scale_x_continuous(\"年\",\n                     limits = c(2010, 2080)) +\n  scale_y_continuous(\"高齢化率\",\n                     labels = scales::label_percent(),\n                     limits = c(0, NA)) +\n  facet_grid(str_glue(\"ピーク高齢化率: {vertex_group}\") ~ str_glue(\"ピーク年: {axis_group}\"))\n```\n\n::: {.cell-output-display}\n![高齢化率ピーク年別の高齢化率の推移](when-is-the-peak-of-the-aging-population_files/figure-html/高齢化率ピーク年別の高齢化率の推移-1.png){width=2100}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# kable_agingrate <- function(data) {\n#   knitr::kable(data, \"html\",\n#                table.attr = 'border=\"1\"') |> \n#     HTML()\n# }\n# \n# label_axis_agingrate <- axis_agingrate |> \n#   select(!c(axis_sd, group)) |> \n#   mutate(across(c(axis_mean, axis_lower, axis_upper),\n#                 round)) |> \n#   rename(`ピーク年（平均）` = axis_mean,\n#          `ピーク年（下限）` = axis_lower,\n#          `ピーク年（上限）` = axis_upper) |> \n#   nest(.by = city_code,\n#        .key = \"label_axis\") |> \n#   mutate(label_axis = label_axis |> \n#            map(\\(data) {\n#              tags$div(\n#                tags$h6(\"高齢化率がピークとなる年（簡易推定）\"),\n#                kable_agingrate(data)\n#              ) |> \n#                as.character() |> \n#                HTML()\n#            },\n#            .progress = TRUE))\n# \n# label_vertex_agingrate <- vertex_agingrate |> \n#   select(!vertex_sd) |> \n#   mutate(across(c(vertex_mean, vertex_lower, vertex_upper),\n#                 \\(x) {\n#                   x |> \n#                     gtools::inv.logit() |> \n#                     scales::label_percent(accuracy = 0.1)()\n#                 })) |> \n#   rename(`ピーク値（平均）` = vertex_mean,\n#          `ピーク値（下限）` = vertex_lower,\n#          `ピーク値（上限）` = vertex_upper) |> \n#   nest(.by = city_code,\n#        .key = \"label_vertex\") |> \n#   mutate(label_vertex = label_vertex |> \n#            map(\\(data) {\n#              tags$div(\n#                tags$h6(\"高齢化率のピーク値（簡易推定）\"),\n#                kable_agingrate(data)\n#              ) |> \n#                as.character() |> \n#                HTML()\n#            },\n#            .progress = TRUE))\n# \n# label_agingrate <- agingrate |> \n#   mutate(year = str_c(year, \"年\"),\n#          agingrate = scales::label_percent(accuracy = 0.1)(agingrate)) |> \n#   pivot_wider(names_from = year,\n#               values_from = agingrate) |> \n#   nest(.by = city_code,\n#        .key = \"label_agingrate\") |> \n#   mutate(label_agingrate = label_agingrate |> \n#            map(\\(data) {\n#              tags$div(\n#                tags$h6(\"高齢化率の推移（社人研2018年推計）\"),\n#                kable_agingrate(data)\n#              ) |> \n#                as.character() |> \n#                HTML()\n#            },\n#            .progress = TRUE))\n# \n# admin_boundary_agingrate <- jpadminbdry::admin_boundary(2015) |> \n#   sf::st_transform(4326) |> \n#   mutate(city = city_code |> \n#            parse_city(when = \"2015-10-01\") |> \n#            city_desig_merge()) |>\n#   group_by(city) |> \n#   summarise(do_union = FALSE) |> \n#   mutate(label_city = str_glue(\"{pref_name(city)} {city_name(city)}\") |> \n#            map(\\(x) {\n#              tags$h5(x) |> \n#                as.character() |> \n#                HTML()\n#            },\n#            .progress = TRUE),\n#          city_code = city_code(city),\n#          .keep = \"unused\") |> \n#   inner_join(axis_agingrate |> \n#                select(city_code, axis_mean),\n#              by = join_by(city_code)) |> \n#   inner_join(vertex_agingrate |> \n#                select(city_code, vertex_mean),\n#              by = join_by(city_code)) |> \n#   left_join(label_axis_agingrate,\n#             by = join_by(city_code)) |> \n#   left_join(label_vertex_agingrate,\n#             by = join_by(city_code)) |> \n#   left_join(label_agingrate,\n#             by = join_by(city_code)) |> \n#   mutate(vertex_mean = gtools::inv.logit(vertex_mean),\n#          label = list(label_city, label_axis, label_vertex, label_agingrate) |> \n#            pmap(\\(label_city, label_axis, label_vertex, label_agingrate) {\n#              tags$div(\n#                label_city,\n#                label_axis,\n#                label_vertex,\n#                label_agingrate\n#              ) |> \n#                as.character() |> \n#                HTML()\n#            },\n#            .progress = TRUE),\n#          .keep = \"unused\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# set_view_agingrate <- partial(setView,\n#                               lng = 139,\n#                               lat = 38,\n#                               zoom = 5L)\n# \n# pal <- colorNumeric(RColorBrewer::brewer.pal(11, \"Spectral\"),\n#                     domain = admin_boundary_agingrate$axis_mean,\n#                     reverse = TRUE)\n# leaflet(admin_boundary_agingrate) |>\n#   addTiles() |> \n#   addPolygons(color = \"dimgray\",\n#               weight = 0.5,\n#               fillColor = ~pal(axis_mean),\n#               fillOpacity = 0.75,\n#               label = ~list_c(label)) |> \n#   addLegend(pal = pal,\n#             values = ~axis_mean,\n#             title = \"高齢化率のピーク年（平均）\") |> \n#   set_view_agingrate()\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# pal <- colorNumeric(RColorBrewer::brewer.pal(11, \"Spectral\"),\n#                     domain = admin_boundary_agingrate$vertex_mean,\n#                     reverse = TRUE)\n# leaflet(admin_boundary_agingrate) |>\n#   addTiles() |> \n#   addPolygons(color = \"dimgray\",\n#               weight = 0.5,\n#               fillColor = ~pal(vertex_mean),\n#               fillOpacity = 0.75,\n#               label = ~list_c(label)) |> \n#   addLegend(pal = pal,\n#             values = ~vertex_mean,\n#             title = \"高齢化率のピーク値（平均）\") |> \n#   set_view_agingrate()\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# axis_agingrate\n# \n# vertex_agingrate |> \n#   arrange(-vertex_sd)\n```\n:::\n",
    "supporting": [
      "when-is-the-peak-of-the-aging-population_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}